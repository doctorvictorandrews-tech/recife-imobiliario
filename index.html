<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Recife: Modo Solo (Teste)</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rye&family=Poppins:wght@400;600;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-carnaval: linear-gradient(135deg, #ff9800 0%, #f44336 50%, #9c27b0 100%);
            --wood: #3e2723; --paper: #fff8e1; --gold: #ffca28;
            --frevo-blue: #0277bd; --frevo-red: #c62828; --frevo-green: #2e7d32;
            --shadow-deep: 0 30px 60px rgba(0,0,0,0.6);
        }
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Poppins', sans-serif; background: var(--bg-carnaval); height: 100vh; overflow: hidden; display: flex; flex-direction: column; transition: filter 2s; }
        h1, h2, h3, button, .brand { font-family: 'Rye', serif; letter-spacing: 1px; text-shadow: 2px 2px 0 rgba(0,0,0,0.2); }

        /* AMBIENTE */
        #rain-canvas { position: fixed; inset: 0; pointer-events: none; z-index: 8000; display: none; }
        .night-mode { filter: brightness(0.6) contrast(1.2); }
        .night-mode .space { box-shadow: inset 0 0 20px #ffd700; border-color: #fff; }

        /* --- TELA INICIAL --- */
        #screen-start, #screen-char { position: fixed; inset: 0; z-index: 9000; background: url('https://www.transparenttextures.com/patterns/cubes.png'), var(--bg-carnaval); display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .card-menu { background: var(--paper); width: 90%; max-width: 450px; padding: 40px; border: 8px solid var(--wood); border-radius: 15px; text-align: center; box-shadow: var(--shadow-deep); animation: popIn 0.5s; }
        
        .btn-big { width: 100%; padding: 20px; margin-top: 20px; border: none; border-radius: 50px; font-size: 1.5rem; font-weight: 900; text-transform: uppercase; cursor: pointer; box-shadow: 0 8px 0 rgba(0,0,0,0.2); color: white; background: var(--frevo-blue); font-family: 'Rye'; transition: transform 0.1s; }
        .btn-big:active { transform: translateY(4px); box-shadow: none; }

        /* CHAR SELECT */
        .char-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 20px 0; }
        .char-opt { background: rgba(255,255,255,0.2); border: 2px solid #fff; border-radius: 10px; padding: 10px; cursor: pointer; transition: 0.3s; text-align: center; }
        .char-opt:hover { transform: scale(1.1); background: rgba(255,255,255,0.5); }
        .char-opt.selected { background: var(--gold); border-color: var(--wood); transform: scale(1.15); color: black; box-shadow: 0 0 15px var(--gold); }
        .char-icon { font-size: 2.5rem; }

        /* --- JOGO --- */
        #game-layout { display: flex; width: 100%; height: 100%; opacity: 0; transition: 1s; pointer-events: none; }
        #game-layout.active { opacity: 1; pointer-events: all; }
        
        #board-viewport { flex: 1; perspective: 1500px; display: flex; align-items: center; justify-content: center; background: radial-gradient(circle at center, #4fc3f7, #01579b); overflow: hidden; }
        #board { display: grid; grid-template-columns: repeat(11, 85px); grid-template-rows: repeat(11, 85px); background: #f5f5f5; border: 20px solid var(--wood); border-radius: 12px; position: relative; transform-style: preserve-3d; transition: transform 1.5s cubic-bezier(0.25, 0.46, 0.45, 0.94); box-shadow: var(--shadow-deep); background-image: url('https://www.transparenttextures.com/patterns/white-brick-wall.png'); }
        
        .space { border: 1px solid rgba(0,0,0,0.1); background: rgba(255,255,255,0.9); font-size: 0.6rem; text-align: center; position: relative; font-weight: bold; display: flex; flex-direction: column; transition: 0.3s; backface-visibility: hidden; }
        .space:hover { transform: translateZ(15px); z-index: 100; border: 2px solid var(--gold); box-shadow: 0 10px 20px rgba(0,0,0,0.4); }
        .color-bar { height: 25%; border-bottom: 2px solid #333; position: relative; }
        
        /* Constru√ß√µes 3D */
        .build-slots { position: absolute; top: -5px; left: 0; width: 100%; display: flex; justify-content: center; gap: 2px; transform-style: preserve-3d; }
        .house-3d { width: 10px; height: 10px; background: var(--frevo-green); border: 1px solid #1b5e20; transform: translateZ(5px); box-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
        .hotel-3d { width: 15px; height: 15px; background: var(--frevo-red); border: 1px solid #b71c1c; transform: translateZ(8px); box-shadow: 2px 2px 3px rgba(0,0,0,0.5); }

        .center-hub { grid-column: 2/11; grid-row: 2/11; background: #e1f5fe; border: 5px solid var(--wood); display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; overflow: hidden; }
        .umbrella-spin { position: absolute; width: 200%; height: 200%; opacity: 0.1; background: conic-gradient(red 0deg 45deg, green 45deg 90deg, yellow 90deg 135deg, blue 135deg 180deg, red 180deg 225deg, green 225deg 270deg, yellow 270deg 315deg, blue 315deg 360deg); animation: spin 20s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        .token { width: 50px; height: 50px; position: absolute; z-index: 50; font-size: 2.5rem; text-align: center; line-height: 50px; filter: drop-shadow(0 10px 5px rgba(0,0,0,0.5)); transition: all 0.4s ease-in-out; transform-origin: bottom center; }
        .jump { animation: jump 0.4s; } @keyframes jump { 50% { transform: translateY(-40px) scale(1.1); } }

        /* HUD */
        #sidebar { width: 360px; background: rgba(255,255,255,0.95); padding: 15px; display: flex; flex-direction: column; z-index: 100; border-left: 8px solid var(--wood); box-shadow: -10px 0 30px rgba(0,0,0,0.3); }
        .hud-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 2px dashed #888; padding-bottom: 5px; }
        .turn-box { background: #333; color: var(--gold); padding: 8px; border-radius: 5px; text-align: center; font-weight: bold; margin-bottom: 10px; font-size: 0.9rem; }
        
        .btn-game { padding: 10px; border: 3px solid #000; border-radius: 8px; font-weight: bold; cursor: pointer; opacity: 0.5; pointer-events: none; transition: 0.2s; text-transform: uppercase; font-size: 0.8rem; }
        .btn-game.on { opacity: 1; pointer-events: all; transform: translateY(-2px); box-shadow: 0 4px 0 rgba(0,0,0,0.3); }
        .btn-game.on:active { transform: translateY(0); box-shadow: none; }

        .p-card { background: #fff; padding: 5px 10px; margin-bottom: 5px; border-radius: 5px; border-left: 5px solid #ccc; display: flex; justify-content: space-between; font-weight: 600; font-size: 0.9rem; align-items: center; }
        .p-card.active { background: #fff9c4; transform: scale(1.02); border-color: var(--gold); }

        #deed-list { flex: 1; overflow-y: auto; background: #fff8e1; border: 2px solid #ccc; padding: 5px; margin-top: 5px; }
        .deed-item { font-size: 0.75rem; border-bottom: 1px dashed #aaa; padding: 5px; display: flex; justify-content: space-between; align-items: center; }
        .build-btn { background: var(--frevo-green); color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.7rem; padding: 2px 5px; }

        /* OVERLAYS */
        #dice-overlay { position: fixed; inset: 0; pointer-events: none; z-index: 5000; display: none; perspective: 1000px; justify-content: center; align-items: center; }
        .hand-throw { font-size: 15rem; position: absolute; bottom: -100px; left: -100px; animation: handToss 0.8s forwards; z-index: 5001; }
        @keyframes handToss { 0% { transform: translate(0,0); } 50% { transform: translate(40vw, -40vh) rotate(45deg); } 100% { transform: translate(40vw, 100vh); } }
        .dice-wrap { width: 90px; height: 90px; position: relative; transform-style: preserve-3d; margin: 30px; }
        .cube { width: 100%; height: 100%; position: absolute; transform-style: preserve-3d; transition: transform 1.5s cubic-bezier(0.1, 0.9, 0.2, 1); }
        .face { position: absolute; width: 100%; height: 100%; background: #fff; border: 4px solid #000; border-radius: 12px; display: flex; justify-content: center; align-items: center; font-size: 3rem; font-weight: bold; backface-visibility: hidden; box-shadow: inset 0 0 15px rgba(0,0,0,0.1); }
        .face:nth-child(1) { transform: translateZ(45px); } .face:nth-child(6) { transform: rotateX(180deg) translateZ(45px); }
        .face:nth-child(2) { transform: rotateY(90deg) translateZ(45px); } .face:nth-child(5) { transform: rotateY(-90deg) translateZ(45px); }
        .face:nth-child(3) { transform: rotateX(90deg) translateZ(45px); } .face:nth-child(4) { transform: rotateX(-90deg) translateZ(45px); }
        .show-1{transform:rotateX(0) rotateY(0)} .show-6{transform:rotateX(180deg)} .show-2{transform:rotateY(-90deg)} .show-5{transform:rotateY(90deg)} .show-3{transform:rotateX(-90deg)} .show-4{transform:rotateX(90deg)}

        #card-zoom { display: none; pointer-events: auto; background: rgba(0,0,0,0.7); position: fixed; inset: 0; z-index: 6000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .big-card { width: 300px; background: #fff; border-radius: 15px; border: 4px solid #fff; box-shadow: 0 0 50px rgba(0,0,0,0.8); overflow: hidden; animation: popIn 0.3s; }
        .bc-head { padding: 20px; text-align: center; color: white; font-family: 'Rye'; font-size: 1.5rem; text-shadow: 1px 1px 0 #000; }
        .bc-body { padding: 20px; font-size: 1.1rem; text-align: center; }

        .toast { position: fixed; top: 15%; left: 50%; transform: translateX(-50%); background: #fff; padding: 15px 30px; border: 4px solid var(--frevo-blue); border-radius: 50px; font-weight: bold; z-index: 8000; animation: popIn 0.3s; font-family: 'Rye'; box-shadow: 0 10px 20px rgba(0,0,0,0.3); text-align: center; }
        @keyframes popIn { 0%{transform:scale(0)} 80%{transform:scale(1.1)} 100%{transform:scale(1)} }

        @media (min-width: 900px) { #board { transform: rotateX(25deg) scale(0.9); } }
        @media (max-width: 899px) { #game-layout { flex-direction: column; } #sidebar { order: 2; height: auto; border-top: 8px solid var(--wood); width: 100%; border-left: none; } #board { transform: scale(0.58); margin-bottom: 20px; } }
    </style>
</head>
<body>

<canvas id="rain-canvas"></canvas>

<div id="screen-start">
    <h1 style="color:#fff; font-size:3rem; margin-bottom:10px;">RECIFE DE LUXO</h1>
    <div class="card-menu">
        <h2 style="color:var(--wood); margin:0;">MODO SOLO</h2>
        <p>Teste o jogo contra o Computador</p>
        <button class="btn-big" onclick="ui.toChar()">JOGAR AGORA</button>
    </div>
</div>

<div id="screen-char" style="display:none;">
    <h1 style="color:var(--gold);">ESCOLHA SEU PE√ÉO</h1>
    <div class="card-menu" style="width:600px;">
        <div class="char-grid" id="char-grid"></div>
        <button id="btn-start-game" class="btn-big" style="background:var(--frevo-green); display:none;" onclick="game.start()">INICIAR PARTIDA</button>
    </div>
</div>

<div id="game-layout">
    <div id="board-viewport">
        <div id="board">
            <div class="center-hub">
                <div class="umbrella-spin"></div>
                <h1 style="color:var(--frevo-blue); z-index:2; text-shadow:2px 2px #fff; font-size:3rem; margin:0;">RECIFE</h1>
                <div id="weather-badge" style="z-index:2; background:#fff; padding:5px 10px; border:2px solid #000; border-radius:15px; font-weight:bold; margin-top:10px;">‚òÄÔ∏è Sol</div>
            </div>
            </div>
    </div>
    
    <div id="sidebar">
        <div class="hud-header">
            <h2 style="margin:0; color:var(--frevo-red);">Pernambuco</h2>
            <div id="my-cash" style="font-size:1.5rem; font-weight:900; color:#388e3c;">$1500</div>
        </div>
        <div id="turn-msg" class="turn-box">...</div>
        
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:15px;">
            <button id="b-roll" class="btn-game" style="background:var(--gold); color:#000; grid-column:span 2;">üé≤ ROLAR DADOS</button>
            <button id="b-buy" class="btn-game" style="background:#43a047; color:#fff;">üí∞ COMPRAR</button>
            <button id="b-trade" class="btn-game" style="background:#7b1fa2; color:#fff; opacity:0.3;">ü§ù NEGOCIAR</button>
            <button id="b-bail" class="btn-game" style="background:#607d8b; color:#fff;">üí∏ SUBORNO</button>
            <button id="b-end" class="btn-game" style="background:#d32f2f; color:#fff; grid-column:span 2;">üõë PASSAR</button>
        </div>

        <div style="font-weight:bold; font-size:0.8rem;">Jogadores:</div>
        <div id="hud-list" style="margin-bottom:10px;"></div>
        
        <div style="font-weight:bold; font-size:0.8rem;">Minhas Escrituras:</div>
        <div id="deed-list"></div>
    </div>
</div>

<div id="dice-overlay">
    <div class="hand-throw">ü´≥</div>
    <div class="dice-wrap"><div id="d1" class="cube"><div class="face">1</div><div class="face">2</div><div class="face">3</div><div class="face">4</div><div class="face">5</div><div class="face">6</div></div></div>
    <div class="dice-wrap"><div id="d2" class="cube"><div class="face">1</div><div class="face">2</div><div class="face">3</div><div class="face">4</div><div class="face">5</div><div class="face">6</div></div></div>
</div>

<div id="card-zoom">
    <div class="big-card">
        <div class="bc-head" id="card-h">Nome</div>
        <div class="bc-body" id="card-b">Detalhes</div>
        <button class="btn-game" style="width:100%; margin:0; border-radius:0; background:var(--frevo-red); color:white;" onclick="document.getElementById('card-zoom').style.display='none'">FECHAR</button>
    </div>
</div>

<script>
/* DADOS */
const CHARS=[{id:'crab',i:'ü¶Ä',n:'Caranguejo'},{id:'shark',i:'ü¶à',n:'Tubar√£o'},{id:'umb',i:'‚òÇÔ∏è',n:'Sombrinha'},{id:'sun',i:'‚òÄÔ∏è',n:'Sol'},{id:'drum',i:'ü•Å',n:'Tambor'},{id:'coco',i:'ü••',n:'Coco'},{id:'ursa',i:'üêª',n:'La Ursa'},{id:'corn',i:'üåΩ',n:'Milho'}];
const BD=[
    {t:'st',n:'MARCO ZERO'}, {t:'pr',g:'#795548',n:'Coque',p:60,h:50,r:[2,10,30,90,160,250]},{t:'ch',n:'Sorte'},{t:'pr',g:'#795548',n:'Ibura',p:60,h:50,r:[4,20,60,180,320,450]},{t:'tx',n:'IPTU',p:200},{t:'rr',n:'Metr√¥ Centro'},{t:'pr',g:'#03a9f4',n:'Santo Amaro',p:100,h:50,r:[6,30,90,270,400,550]},{t:'ch',n:'Rev√©s'},{t:'pr',g:'#03a9f4',n:'Afogados',p:100,h:50,r:[6,30,90,270,400,550]},{t:'pr',g:'#03a9f4',n:'Mustardinha',p:120,h:50,r:[8,40,100,300,450,600]},
    {t:'jl',n:'Tr√¢nsito'}, {t:'pr',g:'#e91e63',n:'Iputinga',p:140,h:100,r:[10,50,150,450,750,950]},{t:'ut',n:'Neoenergia',p:150},{t:'pr',g:'#e91e63',n:'Cordeiro',p:140,h:100,r:[10,50,150,450,750,950]},{t:'pr',g:'#e91e63',n:'V√°rzea',p:160,h:100,r:[12,60,180,500,700,900]},{t:'rr',n:'Metr√¥ Oeste'},{t:'pr',g:'#ff5722',n:'Imbiribeira',p:180,h:100,r:[14,70,200,550,750,950]},{t:'ch',n:'Sorte'},{t:'pr',g:'#ff5722',n:'Encruzilhada',p:180,h:100,r:[14,70,200,550,750,950]},{t:'pr',g:'#ff5722',n:'Torre',p:200,h:100,r:[16,80,220,600,800,1000]},
    {t:'pk',n:'Parque Jaqueira'}, {t:'pr',g:'#d32f2f',n:'Aflitos',p:220,h:150,r:[18,90,250,700,875,1050]},{t:'ch',n:'Rev√©s'},{t:'pr',g:'#d32f2f',n:'Espinheiro',p:220,h:150,r:[18,90,250,700,875,1050]},{t:'pr',g:'#d32f2f',n:'Madalena',p:240,h:150,r:[20,100,300,750,925,1100]},{t:'rr',n:'Via Mangue'},{t:'pr',g:'#fbc02d',n:'Gra√ßas',p:260,h:150,r:[22,110,330,800,975,1150]},{t:'pr',g:'#fbc02d',n:'Po√ßo da Panela',p:260,h:150,r:[22,110,330,800,975,1150]},{t:'ut',n:'Compesa',p:150},{t:'pr',g:'#fbc02d',n:'Casa Forte',p:280,h:150,r:[24,120,360,850,1025,1200]},
    {t:'gj',n:'Blitz!'}, {t:'pr',g:'#388e3c',n:'Apipucos',p:300,h:200,r:[26,130,390,900,1100,1275]},{t:'pr',g:'#388e3c',n:'Parnamirim',p:300,h:200,r:[26,130,390,900,1100,1275]},{t:'ch',n:'Sorte'},{t:'pr',g:'#388e3c',n:'Paiva',p:320,h:200,r:[28,150,450,1000,1200,1400]},{t:'rr',n:'Aeroporto'},{t:'ch',n:'Rev√©s'},{t:'pr',g:'#1565c0',n:'Boa Viagem',p:350,h:200,r:[35,175,500,1100,1300,1500]},{t:'tx',n:'Taxa Luxo',p:100},{t:'pr',g:'#1565c0',n:'Jaqueira',p:400,h:200,r:[50,200,600,1400,1700,2000]}
];
const SFX={dice:new Audio('https://www.soundjay.com/misc/sounds/dice-roll-1.mp3'),cash:new Audio('https://www.soundjay.com/misc/sounds/coins-in-hand-2.mp3')};
const play=(k)=>{try{SFX[k].currentTime=0;SFX[k].play().catch(()=>{})}catch(e){}};

/* ESTADO DO JOGO */
let state = {
    players: [
        {id:'human', name:'Voc√™', char:null, money:1500, pos:0, jailed:false, color:'#d32f2f'},
        {id:'cpu', name:'Z√© do C√≥digo (IA)', char:null, money:1500, pos:0, jailed:false, color:'#0288d1'}
    ],
    turn: 0,
    rolled: false,
    props: BD.map(()=>({owner:null, level:0, mtg:false})),
    weather: 'sun',
    doubles: 0
};
let isAnimating = false;

/* UI & GAMEPLAY */
const ui = {
    toChar: () => {
        document.getElementById('screen-start').style.display='none';
        document.getElementById('screen-char').style.display='flex';
        const g = document.getElementById('char-grid');
        g.innerHTML = '';
        CHARS.forEach(c => {
            g.innerHTML += `<div class="char-opt" onclick="ui.pickChar('${c.id}')"><div class="char-icon">${c.i}</div><div>${c.n}</div></div>`;
        });
    },
    pickChar: (cid) => {
        state.players[0].char = cid;
        // CPU picks random other
        const others = CHARS.filter(c=>c.id!==cid);
        state.players[1].char = others[Math.floor(Math.random()*others.length)].id;
        document.getElementById('screen-char').style.display='none';
        game.start();
    },
    genBoard: () => {
        const b = document.getElementById('board');
        BD.forEach((s,i)=>{
            const d=document.createElement('div');d.className='space';d.id=`s${i}`;
            let r,c;if(i<=10){r=11;c=11-i;}else if(i<=20){r=11-(i-10);c=1;}else if(i<=30){r=1;c=1+(i-20);}else{r=1+(i-30);c=11;}
            d.style.gridRow=r;d.style.gridColumn=c;
            d.innerHTML=s.t==='pr'?`<div class="color-bar" style="background:${s.g}"></div><div>${s.n}<br>$${s.p}</div><div class="build-slots" id="bl${i}"></div>`:`<div style="margin:auto">${s.n}</div>`;
            b.appendChild(d);
        });
    },
    render: () => {
        const p = state.players[state.turn];
        document.getElementById('turn-msg').innerText = `Vez de: ${p.name}`;
        document.getElementById('my-cash').innerText = `$${state.players[0].money}`;
        
        // Buttons: Only active if Human Turn and Not Animating
        const isHuman = state.turn === 0;
        const canAct = isHuman && !isAnimating;
        const curProp = BD[state.players[0].pos];
        
        ui.btn('b-roll', canAct && (!state.rolled || state.doubles > 0));
        ui.btn('b-buy', canAct && state.rolled && curProp.t==='pr' && state.props[state.players[0].pos].owner===null);
        ui.btn('b-end', canAct && state.rolled && state.doubles===0);
        ui.btn('b-bail', canAct && state.players[0].jailed);

        // Players List
        document.getElementById('hud-list').innerHTML = state.players.map((pl,i) => {
            const charObj = CHARS.find(c=>c.id===pl.char);
            return `<div class="p-card ${state.turn===i?'active':''}"><span>${charObj.i} ${pl.name}</span><span>$${pl.money}</span></div>`;
        }).join('');

        // Tokens
        document.querySelectorAll('.token').forEach(e=>e.remove());
        state.players.forEach((pl, i) => {
            const charObj = CHARS.find(c=>c.id===pl.char);
            const t = document.createElement('div'); t.className='token'; t.innerText=charObj.i;
            const sp = document.getElementById(`s${pl.pos}`);
            const br = document.getElementById('board').getBoundingClientRect();
            const sr = sp.getBoundingClientRect();
            t.style.left = (sr.left - br.left + 15 + (i*10)) + 'px';
            t.style.top = (sr.top - br.top + 10 + (i*10)) + 'px';
            document.getElementById('board').appendChild(t);
        });

        // Deeds & Builds
        const dl = document.getElementById('deed-list'); dl.innerHTML='';
        state.props.forEach((pr, i) => {
            const sp = document.getElementById(`s${i}`);
            if(pr.owner !== null) sp.style.border = `4px solid ${state.players[pr.owner].color}`;
            if(pr.mtg) sp.classList.add('mortgaged'); else sp.classList.remove('mortgaged');
            
            const bz=document.getElementById(`bl${i}`);
            if(bz){bz.innerHTML=''; if(pr.level==5)bz.innerHTML='<div class="hotel-3d"></div>'; else for(let k=0;k<pr.level;k++)bz.innerHTML+='<div class="house-3d"></div>';}

            if(pr.owner === 0) { // Human owned
                const g=BD[i].g;
                const mono = g && BD.map((b,x)=>b.g===g?x:-1).filter(x=>x!==-1).every(x=>state.props[x].owner===0);
                dl.innerHTML += `<div class="deed-item" onclick="game.toggleMtg(${i})">
                    <span>${BD[i].n} ${pr.mtg?'(Hip.)':''}</span>
                    ${!pr.mtg && mono && pr.level<5 ? `<button class="build-btn" onclick="event.stopPropagation();game.build(${i})">+Casa $${BD[i].h}</button>` : ''}
                </div>`;
            }
        });
    },
    btn: (id, on) => { const b=document.getElementById(id); if(on){b.classList.add('on');b.disabled=false;}else{b.classList.remove('on');b.disabled=true;} },
    diceAnim: (d1, d2) => {
        const o=document.getElementById('dice-overlay'); o.style.display='flex'; play('dice');
        const c1=document.querySelector('#d1 .cube'), c2=document.querySelector('#d2 .cube');
        c1.className='cube'; c2.className='cube'; void c1.offsetWidth;
        c1.style.transition='transform 1.5s'; c2.style.transition='transform 1.5s';
        setTimeout(()=>{c1.classList.add('show-'+d1); c2.classList.add('show-'+d2);},50);
        setTimeout(()=>{o.style.display='none';}, 2500);
    },
    card: (i) => {
        const s=BD[i], ov=document.getElementById('card-zoom');
        document.getElementById('card-h').innerText=s.n; document.getElementById('card-h').style.background=s.g||'#333';
        document.getElementById('card-b').innerHTML=`Pre√ßo: $${s.p}<br>Aluguel: $${s.r?s.r[0]:50}`;
        ov.style.display='flex';
    },
    toast: (m) => {
        const d=document.createElement('div');d.className='toast';d.innerText=m;document.body.appendChild(d);setTimeout(()=>d.remove(),3000);
    }
};

/* GAME LOGIC */
const game = {
    start: () => {
        document.getElementById('game-layout').classList.add('active');
        ui.genBoard();
        ui.render();
        confetti();
    },
    roll: () => {
        if(isAnimating) return;
        isAnimating = true;
        const d1 = Math.ceil(Math.random()*6), d2 = Math.ceil(Math.random()*6);
        ui.diceAnim(d1, d2);
        
        setTimeout(async () => {
            const p = state.players[state.turn];
            if(d1===d2){ state.doubles++; state.rolled=false; ui.toast("DADOS IGUAIS!"); }
            else { state.doubles=0; state.rolled=true; }

            if(state.doubles >= 3) {
                p.jailed=true; p.pos=10; state.rolled=true; state.doubles=0; ui.toast("PRESO!");
            } else {
                if(p.jailed) {
                    if(d1===d2){ p.jailed=false; await game.moveToken(p, d1+d2); state.rolled=true; }
                    else { state.rolled=true; ui.toast("Continua preso..."); }
                } else {
                    await game.moveToken(p, d1+d2);
                }
            }
            isAnimating = false;
            ui.render();
            // If doubles, AI rolls again automatically? No, lets keep turns clear.
            if(state.turn === 1 && !state.rolled) setTimeout(ai.play, 1000); // AI doubles
            else if(state.turn === 1 && state.rolled) setTimeout(game.endTurn, 1000); // AI finish
        }, 2500);
    },
    moveToken: async (p, steps) => {
        for(let i=0; i<steps; i++){
            p.pos++; if(p.pos>=40){p.pos=0; p.money+=200; ui.toast("Sal√°rio +$200");}
            ui.render(); await new Promise(r=>setTimeout(r, 200));
        }
        // Arrival
        const s = BD[p.pos], pr = state.props[p.pos];
        if(s.t==='pr' || s.t==='rr' || s.t==='ut') ui.card(p.pos);
        if(pr.owner !== null && pr.owner !== state.turn && !pr.mtg) {
            let r = s.r ? s.r[pr.level] : 50;
            p.money -= r; state.players[pr.owner].money += r;
            play('cash'); ui.toast(`Pagou aluguel $${r}`);
        }
        if(s.t==='tx') { p.money-=s.p; ui.toast("Imposto!"); }
    },
    buy: () => {
        const p = state.players[state.turn];
        const idx = p.pos;
        if(p.money >= BD[idx].p && state.props[idx].owner === null) {
            p.money -= BD[idx].p;
            state.props[idx].owner = state.turn;
            play('cash'); ui.render();
        }
    },
    build: (i) => {
        const p = state.players[0];
        if(p.money >= BD[i].h) { p.money -= BD[i].h; state.props[i].level++; ui.render(); play('cash'); }
    },
    toggleMtg: (i) => {
        const pr = state.props[i];
        const p = state.players[0];
        if(pr.mtg) {
            let cost = Math.round(BD[i].p * 0.6);
            if(p.money >= cost) { p.money -= cost; pr.mtg = false; }
        } else {
            p.money += Math.round(BD[i].p * 0.5); pr.mtg = true;
        }
        ui.render();
    },
    endTurn: () => {
        state.turn = (state.turn + 1) % 2;
        state.rolled = false;
        state.doubles = 0;
        
        // Environment Check
        if(Math.random()<0.2) {
            state.weather = state.weather==='sun'?'rain':'sun';
            document.getElementById('rain-canvas').style.display = state.weather==='rain'?'block':'none';
            document.body.classList.toggle('night-mode', state.weather==='rain');
        }

        ui.render();
        if(state.turn === 1) setTimeout(ai.play, 1500);
    }
};

/* AI LOGIC */
const ai = {
    play: () => {
        game.roll();
        // Decisions happen after roll animation in game.roll logic via timeout or check?
        // Actually game.roll is generic. We need to hook into the post-move.
        // Let's modify game.roll to handle AI flow better or just observe state.
        // For simplicity: The timeouts in game.roll will handle the movement.
        // We just need to check "Did AI land?" and decide to buy/end.
        
        // We can hook a "post-move" check in moveToken or add a listener.
        // Simple hack: Wait enough time for roll + move.
        setTimeout(() => {
            const p = state.players[1];
            const s = BD[p.pos];
            // Buy?
            if(s.t==='pr' && state.props[p.pos].owner === null && p.money > s.p + 200) {
                game.buy();
            }
            // End Turn if rolled
            if(state.rolled) game.endTurn();
            // If doubles, roll again is triggered by game.roll recursion logic if we structured it, 
            // but here we simply rely on the fact that if doubles, rolled=false, so we call play again?
            if(!state.rolled && state.turn === 1) setTimeout(ai.play, 1000);
        }, 4000); // 2.5s roll + approx move time
    }
};

/* BINDINGS */
document.getElementById('b-roll').onclick = () => game.roll();
document.getElementById('b-buy').onclick = () => game.buy();
document.getElementById('b-end').onclick = () => game.endTurn();
</script>
</body>
</html>
