<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recife V10: PeÃµes e Dados</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rye&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0277bd; --wood: #5d4037; --gold: #ffca28; }
        * { box-sizing: border-box; user-select: none; }
        body { margin: 0; font-family: 'Roboto', sans-serif; background: var(--bg); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        h1, h2, button { font-family: 'Rye', serif; }

        /* TELAS */
        .screen { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; }
        .card { background: #fff; color: #000; padding: 30px; border: 5px solid var(--wood); text-align: center; width: 90%; max-width: 500px; border-radius: 10px; }
        
        /* INPUTS E BOTOES */
        input { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #000; font-size: 1.1rem; text-align: center; }
        button { width: 100%; padding: 15px; margin-top: 10px; background: var(--gold); border: 2px solid #000; font-weight: bold; cursor: pointer; font-size: 1rem; transition: 0.2s; }
        button:hover { transform: scale(1.02); }
        button:disabled { background: #ccc; cursor: not-allowed; transform: none; }

        /* SELEÃ‡ÃƒO DE PEÃ•ES */
        .char-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 20px 0; }
        .char-opt { border: 2px solid #ccc; padding: 10px; border-radius: 8px; cursor: pointer; transition: 0.3s; }
        .char-opt:hover { background: #eee; }
        .char-opt.selected { background: var(--gold); border-color: black; transform: scale(1.1); }
        .char-opt.taken { opacity: 0.3; filter: grayscale(1); cursor: not-allowed; }
        .char-icon { font-size: 2.5rem; }

        /* JOGO */
        #game-ui { display: none; width: 100%; height: 100%; }
        #board-area { flex: 1; display: flex; align-items: center; justify-content: center; background: radial-gradient(#4fc3f7, #01579b); perspective: 1000px; overflow: hidden; }
        
        #board { 
            display: grid; grid-template-columns: repeat(11, 80px); grid-template-rows: repeat(11, 80px); 
            background: #f5f5f5; border: 15px solid var(--wood); position: relative; 
            transform: rotateX(20deg) scale(0.9); transform-style: preserve-3d; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        
        .space { border: 1px solid #ccc; background: #fff; font-size: 0.6rem; text-align: center; font-weight: bold; display: flex; flex-direction: column; position: relative; }
        .color-bar { height: 25%; border-bottom: 2px solid #000; }
        
        .token { width: 40px; height: 40px; position: absolute; z-index: 50; font-size: 2.5rem; display: flex; justify-content: center; align-items: center; transition: all 0.5s ease; text-shadow: 0 5px 5px rgba(0,0,0,0.5); }

        /* SIDEBAR */
        #sidebar { width: 320px; background: #fff; padding: 15px; display: flex; flex-direction: column; border-left: 5px solid var(--wood); }
        .hud-p { padding: 5px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
        .hud-p.turn { background: #fff9c4; font-weight: bold; border-left: 5px solid var(--gold); }

        /* DADOS 3D */
        #dice-overlay { position: fixed; inset: 0; pointer-events: none; z-index: 200; display: none; justify-content: center; align-items: center; perspective: 1000px; }
        .dice-box { display: flex; gap: 50px; }
        .cube { width: 80px; height: 80px; position: relative; transform-style: preserve-3d; transition: transform 1.5s ease-out; }
        .face { position: absolute; width: 100%; height: 100%; background: #fff; border: 4px solid #000; border-radius: 10px; display: flex; justify-content: center; align-items: center; font-size: 3rem; font-weight: bold; }
        .f1 { transform: translateZ(40px); } .f6 { transform: rotateX(180deg) translateZ(40px); }
        .f2 { transform: rotateY(90deg) translateZ(40px); } .f5 { transform: rotateY(-90deg) translateZ(40px); }
        .f3 { transform: rotateX(90deg) translateZ(40px); } .f4 { transform: rotateX(-90deg) translateZ(40px); }
        
        /* Classes de RotaÃ§Ã£o do Dado */
        .r1 { transform: rotateX(0deg) rotateY(0deg); } .r6 { transform: rotateX(180deg) rotateY(0deg); }
        .r2 { transform: rotateY(-90deg); } .r5 { transform: rotateY(90deg); }
        .r3 { transform: rotateX(-90deg); } .r4 { transform: rotateX(90deg); }

        @media (max-width: 900px) { #game-ui { flex-direction: column; } #sidebar { width: 100%; height: auto; order: 2; } #board { transform: scale(0.6); } }
    </style>
</head>
<body>

<div id="lobby" class="screen">
    <div class="card">
        <h1>RECIFE V10</h1>
        <p>Passo 1: ConexÃ£o</p>
        <input id="my-name" placeholder="Seu Apelido">
        <button onclick="net.host()">CRIAR SALA</button>
        <p>- OU -</p>
        <input id="host-id" placeholder="CÃ³digo da Sala">
        <button onclick="net.join()">ENTRAR</button>
        <div id="lobby-wait" style="display:none; margin-top:15px; border-top:1px dashed #ccc; padding-top:10px;">
            <p>Sala: <b id="disp-id" style="background:#eee; padding:5px;">...</b></p>
            <p>Aguardando jogadores...</p>
            <div id="p-list"></div>
            <button id="btn-to-char" style="display:none; background:#d32f2f; color:white;" onclick="net.toChar()">IR PARA SELEÃ‡ÃƒO DE PEÃ•ES</button>
        </div>
    </div>
</div>

<div id="char-select" class="screen" style="display:none;">
    <div class="card">
        <h1>ESCOLHA SEU PEÃƒO</h1>
        <div class="char-grid" id="char-grid"></div>
        <p id="char-status">Aguardando escolhas...</p>
        <button id="btn-start" style="display:none; background:#43a047; color:white;" onclick="net.start()">INICIAR JOGO</button>
    </div>
</div>

<div id="game-ui">
    <div id="board-area">
        <div id="board">
            </div>
    </div>
    <div id="sidebar">
        <h2>Pernambuco</h2>
        <div id="turn-txt" style="font-weight:bold; margin-bottom:10px;">...</div>
        <button id="btn-roll" onclick="game.act('roll')">ðŸŽ² ROLAR</button>
        <button id="btn-buy" onclick="game.act('buy')">ðŸ’° COMPRAR</button>
        <button id="btn-pass" onclick="game.act('pass')">ðŸ›‘ PASSAR</button>
        <div style="margin-top:20px; font-weight:bold;">Jogadores:</div>
        <div id="hud-list"></div>
    </div>
</div>

<div id="dice-overlay">
    <div class="dice-box">
        <div id="d1" class="cube"><div class="face f1">1</div><div class="face f2">2</div><div class="face f3">3</div><div class="face f4">4</div><div class="face f5">5</div><div class="face f6">6</div></div>
        <div id="d2" class="cube"><div class="face f1">1</div><div class="face f2">2</div><div class="face f3">3</div><div class="face f4">4</div><div class="face f5">5</div><div class="face f6">6</div></div>
    </div>
</div>

<script>
/* DADOS */
const CHARS = [
    {id:'crab', i:'ðŸ¦€', n:'Caranguejo'}, {id:'shark', i:'ðŸ¦ˆ', n:'TubarÃ£o'},
    {id:'sun', i:'â˜€ï¸', n:'Sol'}, {id:'umb', i:'â˜‚ï¸', n:'Sombrinha'},
    {id:'coco', i:'ðŸ¥¥', n:'Coco'}, {id:'drum', i:'ðŸ¥', n:'Tambor'},
    {id:'corn', i:'ðŸŒ½', n:'Milho'}, {id:'suru', i:'ðŸ»', n:'La Ursa'}
];
const COLS = { br:'#795548', lb:'#03a9f4', pk:'#e91e63', or:'#ff5722', rd:'#d32f2f', yl:'#fbc02d', gr:'#388e3c', bl:'#1565c0' };
const BD = [
    {t:'st',n:'MARCO ZERO'}, {t:'pr',g:'br',n:'Coque',p:60}, {t:'ch',n:'Sorte'}, {t:'pr',g:'br',n:'Ibura',p:60}, {t:'tx',n:'IPTU',p:200}, {t:'rr',n:'MetrÃ´',p:200}, {t:'pr',g:'lb',n:'Santo Amaro',p:100}, {t:'ch',n:'RevÃ©s'}, {t:'pr',g:'lb',n:'Afogados',p:100}, {t:'pr',g:'lb',n:'Mustardinha',p:120},
    {t:'jl',n:'TrÃ¢nsito'}, {t:'pr',g:'pk',n:'Iputinga',p:140}, {t:'ut',n:'Neoenergia',p:150}, {t:'pr',g:'pk',n:'Cordeiro',p:140}, {t:'pr',g:'pk',n:'VÃ¡rzea',p:160}, {t:'rr',n:'MetrÃ´ Oeste',p:200}, {t:'pr',g:'or',n:'Imbiribeira',p:180}, {t:'ch',n:'Sorte'}, {t:'pr',g:'or',n:'Encruzilhada',p:180}, {t:'pr',g:'or',n:'Torre',p:200},
    {t:'pk',n:'Jaqueira'}, {t:'pr',g:'rd',n:'Aflitos',p:220}, {t:'ch',n:'RevÃ©s'}, {t:'pr',g:'rd',n:'Espinheiro',p:220}, {t:'pr',g:'rd',n:'Madalena',p:240}, {t:'rr',n:'Via Mangue',p:200}, {t:'pr',g:'yl',n:'GraÃ§as',p:260}, {t:'pr',g:'yl',n:'PoÃ§o',p:260}, {t:'ut',n:'Compesa',p:150}, {t:'pr',g:'yl',n:'Casa Forte',p:280},
    {t:'gj',n:'Blitz!'}, {t:'pr',g:'gr',n:'Apipucos',p:300}, {t:'pr',g:'gr',n:'Parnamirim',p:300}, {t:'ch',n:'Sorte'}, {t:'pr',g:'gr',n:'Paiva',p:320}, {t:'rr',n:'Aeroporto',p:200}, {t:'ch',n:'RevÃ©s'}, {t:'pr',g:'bl',n:'Boa Viagem',p:350}, {t:'tx',n:'Taxa',p:100}, {t:'pr',g:'bl',n:'Jaqueira',p:400}
];

let myId=null, hostConn=null, conns=[], isHost=false;
let state = { phase:'LOBBY', players:[], turn:0, rolled:false, props:BD.map(()=>({owner:null})) };

/* NETWORKING */
const net = {
    peer: new Peer(null),
    init: () => {
        net.peer.on('open', id => myId = id);
        net.peer.on('connection', c => {
            if(isHost) {
                conns.push(c);
                c.on('open', () => c.send({t:'WELCOME', l:state.players}));
                c.on('data', d => net.handleHost(d, c));
            }
        });
    },
    host: () => {
        const n = document.getElementById('my-name').value || "Host";
        if(!myId) return alert("Aguarde ID...");
        isHost=true;
        state.players.push({id:myId, name:n, char:null, money:1500, pos:0});
        ui.screen('lobby-wait');
    },
    join: () => {
        const n = document.getElementById('my-name').value || "Guest";
        const id = document.getElementById('host-id').value;
        if(!id) return alert("Cole o ID!");
        hostConn = net.peer.connect(id);
        hostConn.on('open', () => hostConn.send({t:'JOIN', name:n}));
        hostConn.on('data', d => net.handleCli(d));
    },
    toChar: () => {
        if(state.players.length < 2) return alert("Precisa de 2 jogadores!");
        net.bc({t:'PHASE', p:'CHARS'}); ui.screen('chars'); ui.renderChars();
    },
    start: () => {
        if(state.players.some(p => !p.char)) return alert("Todos precisam escolher!");
        net.bc({t:'PHASE', p:'GAME', st:state}); ui.startGame();
    },
    handleHost: (d, c) => {
        if(d.t==='JOIN') {
            if(!state.players.find(p=>p.id===c.peer)){
                state.players.push({id:c.peer, name:d.name, char:null, money:1500, pos:0});
                net.bc({t:'UPD', l:state.players}); ui.renderLobby(state.players);
            }
        } else if (d.t==='PICK') {
            const p = state.players.find(x=>x.id===d.pid);
            if(p && !state.players.find(x=>x.char===d.char)){ p.char = d.char; net.bc({t:'UPD', l:state.players}); ui.renderChars(); }
        } else if (d.t==='ACT') game.proc(d);
    },
    handleCli: (d) => {
        if(d.t==='WELCOME'||d.t==='UPD') { state.players = d.l; if(state.phase==='LOBBY') ui.renderLobby(d.l); if(state.phase==='CHARS') ui.renderChars(); }
        else if(d.t==='PHASE') { state.phase = d.p; if(d.p==='CHARS') {ui.screen('chars'); ui.renderChars();} if(d.p==='GAME') {state=d.st; ui.startGame();} }
        else if(d.t==='STATE') { state = d.st; ui.renderGame(); }
        else if(d.t==='ANIM') ui.dice(d.d1, d.d2);
    },
    bc: (m) => { if(isHost){conns.forEach(c=>c.send(m));} else {hostConn.send(m);} }
};

/* GAME */
const game = {
    act: (a) => { const d={t:'ACT', act:a, pid:myId}; if(isHost) game.proc(d); else hostConn.send(d); },
    proc: (d) => {
        const idx = state.players.findIndex(p=>p.id===d.pid), p=state.players[idx];
        if(state.turn !== idx) return;

        if(d.act==='roll') {
            if(state.rolled) return;
            const d1=Math.ceil(Math.random()*6), d2=Math.ceil(Math.random()*6);
            net.bc({t:'ANIM', d1, d2}); 
            if(isHost) ui.dice(d1, d2);
            
            setTimeout(() => {
                p.pos += (d1+d2); if(p.pos>=40){p.pos-=40;p.money+=200;}
                const prop = state.props[p.pos];
                if(prop.owner !== null && prop.owner !== idx) {
                    let r = BD[p.pos].r ? BD[p.pos].r[0] : 50;
                    p.money -= r; state.players[prop.owner].money += r;
                }
                state.rolled = true;
                net.bc({t:'STATE', st:state}); if(isHost) ui.renderGame();
            }, 2500);
        }
        else if(d.act==='buy') {
            const s=BD[p.pos];
            if(p.money >= s.p && state.props[p.pos].owner === null) {
                p.money -= s.p; state.props[p.pos].owner = idx;
                net.bc({t:'STATE', st:state}); if(isHost) ui.renderGame();
            }
        }
        else if(d.act==='pass') {
            state.rolled = false; state.turn = (state.turn+1)%state.players.length;
            net.bc({t:'STATE', st:state}); if(isHost) ui.renderGame();
        }
    }
};

/* UI */
const ui = {
    screen: (k) => {
        document.getElementById('lobby').style.display = k==='lobby' || k==='lobby-wait' ? 'flex' : 'none';
        if(k==='lobby-wait') {
            document.querySelector('#lobby input').style.display='none'; // Hide inputs
            document.querySelectorAll('#lobby button').forEach(b=>b.style.display='none');
            document.getElementById('lobby-wait').style.display='block';
            document.getElementById('disp-id').innerText = myId;
            if(isHost) document.getElementById('btn-to-char').style.display='block';
            ui.renderLobby(state.players);
        }
        document.getElementById('char-select').style.display = k==='chars' ? 'flex' : 'none';
        document.getElementById('game-ui').style.display = k==='game' ? 'flex' : 'none';
    },
    renderLobby: (l) => { document.getElementById('p-list').innerHTML = l.map(p=>`<b>${p.name}</b>`).join(', '); },
    renderChars: () => {
        const g = document.getElementById('char-grid'); g.innerHTML='';
        CHARS.forEach(c => {
            const taken = state.players.find(p=>p.char===c.id);
            const isMe = taken && taken.id===myId;
            g.innerHTML += `<div class="char-opt ${taken?'taken':''} ${isMe?'selected':''}" onclick="${!taken?`ui.pick('${c.id}')`:''}"><div class="char-icon">${c.i}</div><div>${c.n}</div></div>`;
        });
        const ready = state.players.every(p=>p.char);
        document.getElementById('char-status').innerText = ready ? "Todos Prontos!" : "Aguardando escolhas...";
        if(isHost && ready) document.getElementById('btn-start').style.display='block';
    },
    pick: (id) => { if(isHost) { state.players.find(x=>x.id===myId).char=id; net.bc({t:'UPD', l:state.players}); ui.renderChars(); } else hostConn.send({t:'PICK', pid:myId, char:id}); },
    startGame: () => { ui.screen('game'); ui.genBoard(); ui.renderGame(); },
    genBoard: () => {
        const b = document.getElementById('board');
        BD.forEach((s,i) => {
            const d = document.createElement('div'); d.className='space';
            let r, c; if (i<=10) { r=11; c=11-i; } else if (i<=20) { r=11-(i-10); c=1; } else if (i<=30) { r=1; c=1+(i-20); } else { r=1+(i-30); c=11; }
            d.style.gridRow=r; d.style.gridColumn=c;
            d.innerHTML = s.t==='pr' ? `<div class="color-bar" style="background:${COLS[s.g]}"></div><div>${s.n}<br>$${s.p}</div>` : `<div style="margin:auto">${s.n}</div>`;
            b.appendChild(d);
        });
    },
    renderGame: () => {
        const meP = state.players.find(p=>p.id===myId);
        const trnP = state.players[state.turn];
        document.getElementById('turn-txt').innerText = `Vez de: ${trnP.name}`;
        
        const myT = trnP.id===myId;
        document.getElementById('btn-roll').disabled = !(myT && !state.rolled);
        document.getElementById('btn-buy').disabled = !(myT && state.rolled && BD[meP.pos].t==='pr' && state.props[meP.pos].owner===null);
        document.getElementById('btn-pass').disabled = !(myT && state.rolled);

        document.getElementById('hud-list').innerHTML = state.players.map((p,i) => `
            <div class="hud-p ${state.turn===i?'turn':''}">
                <span>${CHARS.find(c=>c.id===p.char).i} ${p.name}</span>
                <span>$${p.money}</span>
            </div>`).join('');

        document.querySelectorAll('.token').forEach(e=>e.remove());
        state.players.forEach((p,i) => {
            const t = document.createElement('div'); t.className='token';
            t.innerText = CHARS.find(c=>c.id===p.char).i;
            // Simplificado para V10
            const sp = document.querySelectorAll('.space')[p.pos];
            const br = document.getElementById('board').getBoundingClientRect();
            const sr = sp.getBoundingClientRect();
            t.style.left = (sr.left - br.left + 15 + (i*5)) + 'px';
            t.style.top = (sr.top - br.top + 10 + (i*5)) + 'px';
            document.getElementById('board').appendChild(t);
        });
    },
    dice: (d1, d2) => {
        const o = document.getElementById('dice-overlay'); o.style.display='flex';
        const c1=document.querySelector('#d1 .cube'), c2=document.querySelector('#d2 .cube');
        c1.className='cube'; c2.className='cube'; void c1.offsetWidth;
        c1.style.transition='transform 1.5s'; c2.style.transition='transform 1.5s';
        setTimeout(()=>{ c1.classList.add('r'+d1); c2.classList.add('r'+d2); }, 50);
        setTimeout(()=>{ o.style.display='none'; }, 2500);
    }
};

net.init();
</script>
</body>
</html>
