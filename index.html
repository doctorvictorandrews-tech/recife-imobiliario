<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Recife Imobili√°rio: Vers√£o Segura</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Titan+One&family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --wood: #5d4037; --paper: #fff8e1;
            --c-blue: #0277bd; --c-red: #d32f2f; --c-green: #2e7d32; --c-yel: #fbc02d;
            --c-dark: #263238; --board-bg: #c5e1a5; --space-bg: #ffffff; --border-col: #1a1a1a;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; font-family: 'Nunito', sans-serif; 
            background: linear-gradient(120deg, #1565c0, #fbc02d, #c62828, #1565c0);
            background-size: 400% 400%; animation: frevoBG 15s ease infinite;
            height: 100vh; width: 100vw; overflow: hidden; display: flex; flex-direction: column;
        }
        @keyframes frevoBG { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }

        h1, h2, h3, button, .brand { font-family: 'Titan One', cursive; letter-spacing: 1px; text-shadow: 2px 2px 0 rgba(0,0,0,0.2); }

        /* DEBUG PANEL */
        #debug-panel {
            position: fixed; top: 0; left: 0; width: 100%; height: 100px; 
            background: rgba(0,0,0,0.9); color: #0f0; font-family: monospace; 
            font-size: 10px; z-index: 10000; overflow-y: scroll; padding: 5px;
            pointer-events: none; opacity: 0.8;
        }
        #emergency-btn {
            position: fixed; top: 105px; left: 10px; z-index: 10000;
            background: red; color: white; border: 2px solid white; padding: 5px;
            font-weight: bold; cursor: pointer; display: none;
        }

        /* SCREENS */
        #screen-lobby, #screen-char, #screen-end { position: fixed; inset: 0; z-index: 9000; background: rgba(0,0,0,0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; overflow-y: auto; }
        #screen-end { display: none; }
        
        .card-menu { background: #fff; border: 8px solid var(--c-dark); border-radius: 30px; padding: 25px; text-align: center; width: 90%; max-width: 450px; box-shadow: 0 20px 0 var(--c-yel); margin: auto; }
        input { width: 100%; padding: 12px; border: 3px solid var(--c-dark); font-family: 'Nunito'; font-weight: 800; font-size: 1rem; border-radius: 10px; margin-bottom: 10px; text-align: center;}
        .btn-main { width: 100%; padding: 15px; margin-top: 15px; border: none; border-radius: 50px; font-size: 1.5rem; background: var(--c-green); color: #fff; cursor: pointer; box-shadow: 0 6px 0 #1b5e20; transition: 0.1s; text-transform: uppercase; }
        .btn-main:active { transform: translateY(4px); box-shadow: 0 3px 0 #1b5e20; }
        
        /* CHAR SELECT */
        .char-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 15px; max-height: 40vh; overflow-y: auto; }
        .char-opt { border: 2px solid #ccc; border-radius: 12px; padding: 5px; cursor: pointer; background: #fff; font-size: 2rem; text-align: center; }
        .char-opt.taken { opacity: 0.3; background: #eee; pointer-events: none; }
        .char-opt.selected { background: #c8e6c9; border-color: green; transform: scale(1.1); }

        /* GAME LAYOUT */
        #game-layout { display: none; width: 100%; height: 100%; overflow: hidden; flex-direction: column; }
        #game-layout.active { display: flex; }

        /* BOARD AREA - FIXO PARA EVITAR SUMIR */
        #board-area { 
            position: relative; overflow: hidden; 
            flex: 1; width: 100%; display: flex; align-items: center; justify-content: center;
            background: rgba(255,255,255,0.1);
        }
        #board-container { 
            width: 900px; height: 1050px; /* Tamanho Fixo Base */
            position: relative; transform-origin: center center; 
            box-shadow: 0 0 50px rgba(0,0,0,0.5); 
        }
        #board { 
            width: 100%; height: 100%; 
            display: grid; grid-template-columns: repeat(11, 1fr); grid-template-rows: repeat(11, 1fr); 
            background: var(--board-bg); border: 4px solid var(--border-col); 
        }

        /* HUD */
        #hud-panel { 
            background: #fff; display: flex; flex-direction: column; z-index: 5000; 
            box-shadow: 0 -5px 20px rgba(0,0,0,0.2); flex-shrink: 0; 
            width: 100%; border-top: 4px solid var(--c-dark);
            padding: 10px; padding-bottom: calc(10px + env(safe-area-inset-bottom));
        }
        
        /* CONTROLS */
        #action-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; width: 100%; margin-bottom: 10px; }
        .btn-game { 
            border: none; border-radius: 10px; font-family: 'Titan One'; cursor: pointer; color: #fff; 
            box-shadow: 0 3px 0 rgba(0,0,0,0.3); text-transform: uppercase; 
            height: 50px; font-size: 1rem; display: flex; align-items: center; justify-content: center;
        }
        .btn-game:disabled { background: #cfd8dc !important; color: #999 !important; box-shadow: none; transform:translateY(3px); }
        .btn-roll { background: var(--c-yel); color: var(--c-dark); }
        .btn-buy { background: var(--c-green); }
        .btn-pass { background: var(--c-red); }
        .btn-trade { background: #1976d2; }

        /* PLAYERS LIST */
        #players-bar { display: flex; gap: 5px; overflow-x: auto; padding-bottom: 5px; }
        .p-badge { background: #fff; border: 1px solid #ccc; border-radius: 5px; padding: 5px; font-size: 0.8rem; font-weight: bold; min-width: 80px; text-align: center; }
        .p-badge.active { border: 2px solid blue; background: #e3f2fd; }

        /* SPACES & TOKENS */
        .space { background: #fff; border: 1px solid #000; position: relative; font-size: 0.7rem; font-weight: 800; text-align: center; display: flex; flex-direction: column; overflow: hidden; }
        .space.owned { border: 4px solid; }
        .color-strip { height: 20%; width: 100%; border-bottom: 1px solid #000; }
        .sp-content { flex: 1; display: flex; align-items: center; justify-content: center; flex-direction: column; padding: 2px; }
        
        .token { width: 40px; height: 40px; position: absolute; font-size: 2rem; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease-out; z-index: 50; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5)); }

        /* DESKTOP */
        @media (min-width: 900px) {
            #game-layout { flex-direction: row; }
            #hud-panel { width: 350px; height: 100%; border-left: 5px solid #000; border-top:none; }
            #action-btns { grid-template-columns: 1fr; }
        }

        /* MODALS */
        #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 9500; display: none; align-items: center; justify-content: center; }
        .modal-card { background: #fff; padding: 20px; border-radius: 20px; max-width: 90%; text-align: center; border: 5px solid var(--c-blue); }
        
        .toast { position: fixed; top: 120px; left: 50%; transform: translateX(-50%); background: #fff; padding: 10px 20px; border-radius: 20px; border: 3px solid #000; font-weight: bold; z-index: 9999; animation: fadeUp 3s forwards; }
        @keyframes fadeUp { 0%{opacity:0;transform:translate(-50%,20px)} 10%{opacity:1;transform:translate(-50%,0)} 90%{opacity:1} 100%{opacity:0;transform:translate(-50%,-20px)} }
    </style>
</head>
<body>

<div id="debug-panel">DEBUG LOG INICIADO...<br></div>
<button id="emergency-btn" onclick="net.forcePass()">‚ö†Ô∏è DESTRAVAR TURNO</button>

<div id="screen-lobby">
    <div class="card-menu">
        <h1>RECIFE IMOBILI√ÅRIO<br><small>MULTIPLAYER V3</small></h1>
        <div id="lobby-start">
            <input type="text" id="p-name" placeholder="Seu Nome" maxlength="10">
            <button class="btn-main" onclick="net.create()">CRIAR SALA</button>
            <p>OU</p>
            <input type="text" id="room-code" placeholder="C√ìDIGO" style="text-transform:uppercase">
            <button class="btn-main" style="background:#0277bd" onclick="net.join()">ENTRAR</button>
        </div>
        <div id="lobby-wait" style="display:none">
            <h2>SALA: <span id="code-display" style="color:red">...</span></h2>
            <div id="lobby-list" style="margin:20px 0; font-weight:bold;"></div>
            <p>Aguardando...</p>
            <button id="btn-go" class="btn-main" style="display:none" onclick="net.start()">INICIAR</button>
        </div>
    </div>
</div>

<div id="screen-char" style="display:none">
    <div class="card-menu">
        <h2>ESCOLHA SEU PERSONAGEM</h2>
        <div class="char-grid" id="char-grid"></div>
        <p id="char-msg">Aguardando...</p>
    </div>
</div>

<div id="game-layout">
    <div id="board-area">
        <div id="board-container">
            <div id="board"></div>
        </div>
    </div>
    
    <div id="hud-panel">
        <div style="background:#eee; padding:10px; border-radius:10px; margin-bottom:10px; text-align:center;">
            <div id="turn-msg" style="font-weight:900; font-size:1.2rem;">...</div>
            <div id="my-money" style="color:green; font-family:'Titan One'; font-size:1.5rem;">$1000</div>
        </div>
        
        <div id="action-btns">
            <button id="btn-roll" class="btn-game btn-roll" onclick="game.roll()">üé≤ ROLAR</button>
            <button id="btn-buy" class="btn-game btn-buy" disabled onclick="game.buy()">COMPRAR</button>
            <button id="btn-pass" class="btn-game btn-pass" disabled onclick="game.pass()">PASSAR</button>
            <button id="btn-trade" class="btn-game btn-trade" onclick="alert('Negocia√ß√£o simplificada: Mande um PIX pro amigo!')">NEGOCIAR</button>
        </div>
        
        <div id="players-bar"></div>
        <div style="margin-top:10px; font-size:0.8rem; color:#666; text-align:center;">
             Se travar, use o bot√£o vermelho no topo.
        </div>
    </div>
</div>

<div id="overlay">
    <div class="modal-card">
        <h2 id="modal-title">TITULO</h2>
        <p id="modal-desc">Descri√ß√£o</p>
        <button class="btn-main" onclick="ui.closeModal()">OK</button>
    </div>
</div>

<script>
// --- LOGGING SYSTEM ---
function log(msg) {
    const p = document.getElementById('debug-panel');
    const d = new Date();
    p.innerHTML = `[${d.toLocaleTimeString()}] ${msg}<br>` + p.innerHTML;
    console.log(msg);
}

window.onerror = function(msg, url, line) {
    log(`ERRO JS: ${msg} (Linha ${line})`);
    return false;
};

// --- CONFIG FIREBASE ---
const firebaseConfig = {
  apiKey: "AIzaSyBMRA5IwyPyv6YEqG2z4KT1e5jk7B1_Vwc",
  authDomain: "recifeimob-beb6c.firebaseapp.com",
  databaseURL: "https://recifeimob-beb6c-default-rtdb.firebaseio.com",
  projectId: "recifeimob-beb6c",
  storageBucket: "recifeimob-beb6c.firebasestorage.app",
  messagingSenderId: "1063704445620",
  appId: "1:1063704445620:web:a9ccc21171b9e3d16e4de1"
};

try {
    firebase.initializeApp(firebaseConfig);
    log("Firebase SDK Inicializado.");
} catch(e) {
    log("ERRO FATAL: Firebase n√£o iniciou. " + e.message);
}

const db = firebase.database();
const myId = 'u_' + Math.floor(Math.random()*999999);
let roomRef = null;
let myIdx = -1;
let players = [];
let gameData = {};

// --- DADOS DO JOGO ---
const CHARS = ['üíÖ','üóø','üõ∂','ü¶Ä','ü¶à','‚òÇÔ∏è','üêÄ','üåΩ','üêî','üöå','üç•','üêª'];
const SPACES = [
    {n:'IN√çCIO', t:'go'},
    {n:'Coque', p:60, g:'#795548'}, {n:'SORTE', t:'ch'}, {n:'Ibura', p:60, g:'#795548'}, {n:'IPTU', t:'tax'},
    {n:'Metr√¥', p:200, t:'rr'}, {n:'Agamenon', p:100, g:'#2196f3'}, {n:'REV√âS', t:'rev'}, {n:'Afogados', p:100, g:'#2196f3'}, {n:'Mustardinha', p:120, g:'#2196f3'},
    {n:'CADEIA', t:'jail'},
    {n:'Iputinga', p:140, g:'#e91e63'}, {n:'Celpe', p:150, t:'ut'}, {n:'Cordeiro', p:140, g:'#e91e63'}, {n:'V√°rzea', p:160, g:'#e91e63'},
    {n:'Metr√¥', p:200, t:'rr'}, {n:'Rosarinho', p:180, g:'#ff5722'}, {n:'SORTE', t:'ch'}, {n:'Encruzilhada', p:180, g:'#ff5722'}, {n:'Torre', p:200, g:'#ff5722'},
    {n:'Parque', t:'free'},
    {n:'Aflitos', p:220, g:'#f44336'}, {n:'REV√âS', t:'rev'}, {n:'Espinheiro', p:220, g:'#f44336'}, {n:'Madalena', p:240, g:'#f44336'},
    {n:'Metr√¥', p:200, t:'rr'}, {n:'Gra√ßas', p:260, g:'#ffeb3b'}, {n:'Po√ßo', p:260, g:'#ffeb3b'}, {n:'Compesa', p:150, t:'ut'}, {n:'Casa Forte', p:280, g:'#ffeb3b'},
    {n:'V√Å P/ CADEIA', t:'gotojail'},
    {n:'Apipucos', p:300, g:'#4caf50'}, {n:'Parnamirim', p:300, g:'#4caf50'}, {n:'SORTE', t:'ch'}, {n:'Paiva', p:320, g:'#4caf50'},
    {n:'Metr√¥', p:200, t:'rr'}, {n:'REV√âS', t:'rev'}, {n:'Boa Viagem', p:350, g:'#3f51b5'}, {n:'LUXO', t:'tax'}, {n:'Pina', p:400, g:'#3f51b5'}
];

// --- NETWORKING ---
const net = {
    create: () => {
        const name = document.getElementById('p-name').value || 'Player 1';
        const code = Math.random().toString(36).substr(2,4).toUpperCase();
        roomRef = db.ref('rooms_v3/' + code);
        
        const initData = {
            state: 'lobby',
            turn: 0,
            players: [{id:myId, name:name, cash:1500, pos:0, icon:'', jail:0}],
            props: Array(40).fill(-1),
            lastAction: 'Sala criada'
        };
        
        roomRef.set(initData).then(() => {
            log("Sala criada: " + code);
            net.monitor(code);
        }).catch(e => log("Erro ao criar: " + e.message));
    },

    join: () => {
        const name = document.getElementById('p-name').value || 'Player 2';
        const code = document.getElementById('room-code').value.toUpperCase();
        if(!code) return alert("Digite o c√≥digo");
        
        roomRef = db.ref('rooms_v3/' + code);
        roomRef.once('value', snap => {
            const val = snap.val();
            if(!val) return alert("Sala n√£o encontrada");
            if(val.state !== 'lobby') return alert("Jogo j√° come√ßou");
            
            const playersList = val.players || [];
            if(playersList.some(p => p.id === myId)) {
                log("Reconectando...");
            } else {
                playersList.push({id:myId, name:name, cash:1500, pos:0, icon:'', jail:0});
                roomRef.update({players: playersList});
            }
            net.monitor(code);
        });
    },

    monitor: (code) => {
        document.getElementById('screen-lobby').style.display = 'none'; // Esconde lobby inicial
        document.getElementById('lobby-wait').style.display = 'block'; // Mostra wait se ainda for lobby
        document.getElementById('code-display').innerText = code;
        document.getElementById('emergency-btn').style.display = 'block';

        roomRef.on('value', snap => {
            const val = snap.val();
            if(!val) return;
            gameData = val;
            players = val.players || [];
            myIdx = players.findIndex(p => p.id === myId);

            // Roteamento de telas
            if(val.state === 'lobby') {
                document.getElementById('screen-lobby').style.display = 'flex';
                document.getElementById('lobby-start').style.display = 'none';
                document.getElementById('lobby-wait').style.display = 'block';
                
                document.getElementById('lobby-list').innerHTML = players.map(p => 
                    `<div>${p.icon} ${p.name} ${p.id===myId?'(VOC√ä)':''}</div>`
                ).join('');
                
                if(myIdx === 0) document.getElementById('btn-go').style.display = 'block';
            
            } else if(val.state === 'char') {
                document.getElementById('screen-lobby').style.display = 'none';
                document.getElementById('screen-char').style.display = 'flex';
                ui.renderChars();
            
            } else if(val.state === 'game') {
                document.getElementById('screen-char').style.display = 'none';
                document.getElementById('game-layout').classList.add('active');
                
                // Renderizar uma √∫nica vez ou se estiver vazio
                const b = document.getElementById('board');
                if(b.innerHTML === "") ui.buildBoard();
                
                ui.updateGame();
            }
        });
    },

    start: () => roomRef.update({state: 'char'}),
    
    forcePass: () => {
        if(!confirm("Isso vai pular a vez do jogador atual √† for√ßa. Certeza?")) return;
        let next = (gameData.turn + 1) % players.length;
        roomRef.update({
            turn: next,
            lastAction: 'Turno for√ßado'
        });
        alert("Turno passado!");
    }
};

// --- UI LOGIC ---
const ui = {
    renderChars: () => {
        const grid = document.getElementById('char-grid');
        grid.innerHTML = '';
        const myP = players[myIdx];
        
        // Verifica quantos est√£o prontos
        const readyCount = players.filter(p => p.icon !== '').length;
        document.getElementById('char-msg').innerText = `${readyCount}/${players.length} Prontos`;
        
        if(myIdx === 0 && readyCount === players.length) {
            setTimeout(() => roomRef.update({state:'game'}), 1000);
        }

        CHARS.forEach(emoji => {
            const taken = players.find(p => p.icon === emoji);
            const isMe = myP.icon === emoji;
            
            const div = document.createElement('div');
            div.className = `char-opt ${taken?'taken':''} ${isMe?'selected':''}`;
            div.innerText = emoji;
            div.onclick = () => {
                if(!taken) {
                    players[myIdx].icon = emoji;
                    roomRef.update({players: players});
                }
            };
            grid.appendChild(div);
        });
    },

    buildBoard: () => {
        log("Construindo tabuleiro...");
        const board = document.getElementById('board');
        board.innerHTML = '';
        
        // Centro
        const center = document.createElement('div');
        center.className = 'center-hub';
        center.innerHTML = '<h1 style="color:#0277bd; font-size:3rem; transform:rotate(-10deg);">RECIFE</h1>';
        center.style.gridColumn = "2/11"; center.style.gridRow = "2/11";
        center.style.display = "flex"; center.style.alignItems="center"; center.style.justifyContent="center";
        board.appendChild(center);

        // Casas
        SPACES.forEach((s, i) => {
            const div = document.createElement('div');
            div.className = 'space';
            div.id = 'space-' + i;
            
            // Grid logic
            let r, c;
            if(i < 11) { r = 11; c = 11 - i; }
            else if(i < 21) { r = 11 - (i - 10); c = 1; }
            else if(i < 31) { r = 1; c = 1 + (i - 20); }
            else { r = 1 + (i - 30); c = 11; }
            
            div.style.gridRow = r; div.style.gridColumn = c;
            
            let html = `<div class="sp-content">`;
            if(s.g) html = `<div class="color-strip" style="background:${s.g}"></div>` + html;
            
            html += `<div>${s.n}</div>`;
            if(s.p) html += `<div>$${s.p}</div>`;
            html += `</div>`; // fecha content
            
            div.innerHTML = html;
            board.appendChild(div);
        });

        // Tokens
        players.forEach((p, i) => {
            const t = document.createElement('div');
            t.className = 'token';
            t.id = 'token-' + i;
            t.innerText = p.icon;
            board.appendChild(t);
        });
        
        // Ajuste de tamanho
        setTimeout(resizeBoard, 100);
    },

    updateGame: () => {
        const turnP = players[gameData.turn];
        const isMyTurn = (gameData.turn === myIdx);
        const myP = players[myIdx];

        // HUD Texto
        document.getElementById('turn-msg').innerText = isMyTurn ? "SUA VEZ!" : `VEZ DE: ${turnP.name}`;
        document.getElementById('turn-msg').style.color = isMyTurn ? 'green' : 'black';
        document.getElementById('my-money').innerText = `$${myP.cash}`;

        // HUD Bot√µes (S√≥ ativa se for minha vez)
        const btnRoll = document.getElementById('btn-roll');
        const btnBuy = document.getElementById('btn-buy');
        const btnPass = document.getElementById('btn-pass');

        // Reset geral
        btnRoll.disabled = true; btnBuy.disabled = true; btnPass.disabled = true;

        if(isMyTurn) {
            // L√≥gica de estado simplificada: Se a √∫ltima a√ß√£o foi "rolar", habilita comprar/passar
            const lastAct = gameData.lastAction || "";
            const hasRolled = lastAct.includes('Rolou');
            
            if(!hasRolled) {
                btnRoll.disabled = false;
            } else {
                // J√° rolou, pode passar ou comprar
                btnPass.disabled = false;
                
                // Pode comprar?
                const s = SPACES[myP.pos];
                const propOwner = gameData.props[myP.pos];
                if(s.p && propOwner === -1 && myP.cash >= s.p) {
                    btnBuy.disabled = false;
                }
            }
        }

        // Atualizar Tokens e Propriedades
        players.forEach((p, i) => {
            // Mover token visualmente
            const el = document.getElementById('token-' + i);
            const space = document.getElementById('space-' + p.pos);
            if(el && space) {
                // Offset pequeno para n√£o sobrepor
                const offX = (i%2)*5; const offY = (i > 1 ? 5 : 0);
                el.style.left = (space.offsetLeft + 10 + offX) + 'px';
                el.style.top = (space.offsetTop + 10 + offY) + 'px';
            }
        });

        // Marcar donos
        gameData.props.forEach((ownerIdx, spaceIdx) => {
            const sp = document.getElementById('space-' + spaceIdx);
            if(ownerIdx !== -1 && sp) {
                sp.classList.add('owned');
                sp.style.borderColor = (ownerIdx === myIdx) ? 'green' : 'red';
            }
        });
        
        // Lista de Jogadores
        document.getElementById('players-bar').innerHTML = players.map((p,i) => 
            `<div class="p-badge ${gameData.turn===i?'active':''}">
                ${p.icon} ${p.name}<br>$${p.cash}
            </div>`
        ).join('');
    },
    
    showModal: (title, text) => {
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-desc').innerText = text;
        document.getElementById('overlay').style.display = 'flex';
    },
    
    closeModal: () => {
        document.getElementById('overlay').style.display = 'none';
    },
    
    toast: (msg) => {
        const d = document.createElement('div');
        d.className = 'toast'; d.innerText = msg;
        document.body.appendChild(d);
        setTimeout(() => d.remove(), 3000);
    }
};

// --- GAME LOGIC ---
const game = {
    roll: () => {
        // Rolar dados localmente e enviar resultado FINAL
        // Isso evita "teleporte" porque a gente n√£o anima passo-a-passo via rede
        // A rede s√≥ recebe o destino.
        const d1 = Math.ceil(Math.random()*6);
        const d2 = Math.ceil(Math.random()*6);
        const total = d1 + d2;
        
        let p = players[myIdx];
        
        // Se estiver preso
        if(p.jail > 0) {
            p.jail--;
            ui.toast(`Preso! Restam ${p.jail} turnos.`);
            roomRef.update({
                players: players,
                lastAction: `Rolou ${total} (Preso)`
            });
            return;
        }

        let newPos = (p.pos + total) % 40;
        if(newPos < p.pos) { // Passou pelo in√≠cio
            p.cash += 200;
            ui.toast("In√≠cio! +$200");
        }
        
        p.pos = newPos;
        
        // Checar a√ß√£o do espa√ßo IMEDIATAMENTE
        const s = SPACES[newPos];
        let msg = `Rolou ${total} -> ${s.n}`;
        
        // L√≥gica simples de aluguel autom√°tica
        const owner = gameData.props[newPos];
        if(owner !== -1 && owner !== myIdx) {
            const rent = Math.floor(s.p * 0.1) || 20;
            p.cash -= rent;
            players[owner].cash += rent;
            msg += ` (Pagou $${rent})`;
        }
        
        // Eventos especiais simples
        if(s.t === 'tax') { p.cash -= 100; msg += " (Imposto -$100)"; }
        if(s.t === 'gotojail') { p.pos = 10; p.jail = 3; msg = "FOI PRESO!"; }

        // Atualizar Firebase UMA VEZ
        roomRef.update({
            players: players,
            lastAction: msg
        });
    },

    buy: () => {
        const p = players[myIdx];
        const s = SPACES[p.pos];
        
        p.cash -= s.p;
        gameData.props[p.pos] = myIdx;
        
        roomRef.update({
            players: players,
            props: gameData.props,
            lastAction: `Comprou ${s.n}`
        });
        ui.toast("Comprado!");
    },

    pass: () => {
        const next = (gameData.turn + 1) % players.length;
        roomRef.update({
            turn: next,
            lastAction: 'Passou a vez'
        });
    }
};

function resizeBoard() {
    const el = document.getElementById('board-container');
    const area = document.getElementById('board-area');
    if(!el || !area) return;
    
    // Scale simples
    const scale = Math.min(
        area.offsetWidth / 920,
        area.offsetHeight / 1070
    );
    el.style.transform = `scale(${scale > 0 ? scale : 0.5})`;
}

window.onresize = resizeBoard;

</script>
</body>
</html>
