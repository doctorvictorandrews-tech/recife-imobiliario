<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Recife Imobili√°rio: Visual 3D</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rye&family=Poppins:wght@400;600;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-grad: radial-gradient(circle at center, #0288d1, #01579b);
            --wood: #3e2723; --paper: #fff8e1; --gold: #ffca28;
            --frevo-blue: #0277bd; --frevo-red: #c62828; --frevo-green: #2e7d32;
            --shadow: 0 30px 60px rgba(0,0,0,0.5);
        }
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Poppins', sans-serif; background: var(--bg-grad); height: 100vh; overflow: hidden; display: flex; flex-direction: column; perspective: 1200px; transition: filter 2s; }
        h1, h2, button { font-family: 'Rye', serif; letter-spacing: 1px; }

        /* AMBIENTE */
        #rain-canvas { position: fixed; inset: 0; pointer-events: none; z-index: 8000; display: none; }
        .night-mode { filter: brightness(0.6) contrast(1.2); }
        .night-mode .space { box-shadow: inset 0 0 20px #ffb300; border-color: #fff; }

        /* --- LOBBY (V9 Style mas Bonito) --- */
        #lobby { position: fixed; inset: 0; z-index: 9000; background: url('https://www.transparenttextures.com/patterns/cubes.png'), var(--bg-grad); display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .card-lobby { background: var(--paper); padding: 40px; border: 8px solid var(--wood); border-radius: 15px; text-align: center; width: 90%; max-width: 450px; box-shadow: var(--shadow); }
        .input-box { width: 100%; padding: 15px; margin: 10px 0; border: 3px solid var(--wood); font-family: 'Rye'; font-size: 1.2rem; text-align: center; border-radius: 8px; }
        .btn-main { width: 100%; padding: 15px; margin-top: 10px; border: none; border-radius: 50px; font-size: 1.2rem; font-weight: 900; text-transform: uppercase; cursor: pointer; box-shadow: 0 5px 0 rgba(0,0,0,0.3); color: white; transition: 0.1s; }
        .btn-main:active { transform: translateY(4px); box-shadow: none; }
        .bg-y { background: var(--gold); color: black; } .bg-g { background: var(--frevo-green); } .bg-r { background: var(--frevo-red); }

        /* --- JOGO --- */
        #game { display: none; width: 100%; height: 100%; }
        #game.active { display: flex; } /* Flex row default, media query handles mobile */

        #board-viewport { flex: 1; display: flex; align-items: center; justify-content: center; transform-style: preserve-3d; overflow: hidden; }
        #board { 
            display: grid; grid-template-columns: repeat(11, 85px); grid-template-rows: repeat(11, 85px); 
            background: #f5f5f5; border: 20px solid var(--wood); border-radius: 12px; position: relative; 
            transform: rotateX(25deg) scale(0.9); transform-style: preserve-3d; box-shadow: var(--shadow); 
            transition: transform 1s; background-image: url('https://www.transparenttextures.com/patterns/white-brick-wall.png');
        }

        .space { 
            border: 1px solid rgba(0,0,0,0.1); background: rgba(255,255,255,0.92); 
            font-size: 0.6rem; text-align: center; position: relative; font-weight: bold; 
            display: flex; flex-direction: column; transition: 0.3s; backface-visibility: hidden; 
        }
        .space:hover { transform: translateZ(20px); z-index: 100; border: 2px solid var(--gold); box-shadow: 0 15px 30px rgba(0,0,0,0.5); }
        .color-bar { height: 25%; border-bottom: 2px solid #333; }
        
        .center-hub { grid-column: 2/11; grid-row: 2/11; background: #e1f5fe; border: 5px solid var(--wood); display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; overflow: hidden; box-shadow: inset 0 0 50px rgba(0,0,0,0.1); }
        .umbrella { position: absolute; width: 200%; height: 200%; opacity: 0.15; background: conic-gradient(red 0deg 45deg, green 45deg 90deg, yellow 90deg 135deg, blue 135deg 180deg, red 180deg 225deg, green 225deg 270deg, yellow 270deg 315deg, blue 315deg 360deg); animation: spin 20s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        .token { width: 40px; height: 40px; position: absolute; z-index: 50; font-size: 2.5rem; text-align: center; line-height: 40px; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.5)); transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        /* SIDEBAR */
        #sidebar { width: 350px; background: rgba(255,255,255,0.95); padding: 20px; display: flex; flex-direction: column; z-index: 100; border-left: 8px solid var(--wood); box-shadow: -10px 0 30px rgba(0,0,0,0.3); }
        .hud-header { border-bottom: 2px dashed #ccc; padding-bottom: 10px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .btn-act { padding: 12px; margin-bottom: 10px; border: 3px solid #000; border-radius: 8px; font-weight: bold; cursor: pointer; text-transform: uppercase; width: 100%; opacity: 0.5; pointer-events: none; transition: 0.2s; font-size: 1rem; }
        .btn-act.on { opacity: 1; pointer-events: all; transform: translateY(-2px); box-shadow: 0 4px 0 rgba(0,0,0,0.2); }
        .btn-act.on:active { transform: translateY(0); box-shadow: none; }

        .p-item { padding: 8px; border-bottom: 1px solid #ccc; display: flex; justify-content: space-between; font-weight: bold; }
        .p-item.turn { background: #fff9c4; border-left: 5px solid var(--gold); }

        /* DADOS 3D OVERLAY */
        #dice-view { position: fixed; inset: 0; pointer-events: none; z-index: 5000; display: none; perspective: 1000px; justify-content: center; align-items: center; }
        .dice-wrap { width: 100px; height: 100px; position: relative; transform-style: preserve-3d; margin: 40px; }
        .cube { width: 100%; height: 100%; position: absolute; transform-style: preserve-3d; transition: transform 1.5s ease-out; }
        .face { position: absolute; inset: 0; background: #fff; border: 4px solid #000; border-radius: 15px; display: flex; justify-content: center; align-items: center; font-size: 3rem; font-weight: bold; backface-visibility: hidden; box-shadow: inset 0 0 20px rgba(0,0,0,0.1); }
        .f1{transform:translateZ(50px)} .f6{transform:rotateX(180deg) translateZ(50px)}
        .f2{transform:rotateY(180deg) translateZ(50px)} .f5{transform:rotateY(-90deg) translateZ(50px)} /* Fix rotation map logic later */
        .f2{transform:rotateY(90deg) translateZ(50px)} .f3{transform:rotateY(90deg) translateZ(50px)} /* Simplificando CSS para V10 */
        .face:nth-child(1) { transform: translateZ(50px); } .face:nth-child(6) { transform: rotateX(180deg) translateZ(50px); }
        .face:nth-child(2) { transform: rotateY(90deg) translateZ(50px); } .face:nth-child(5) { transform: rotateY(-90deg) translateZ(50px); }
        .face:nth-child(3) { transform: rotateX(90deg) translateZ(50px); } .face:nth-child(4) { transform: rotateX(-90deg) translateZ(50px); }
        
        .r1{transform:rotateX(0) rotateY(0)} .r6{transform:rotateX(180deg) rotateY(0)}
        .r2{transform:rotateY(-90deg)} .r5{transform:rotateY(90deg)}
        .r3{transform:rotateX(-90deg)} .r4{transform:rotateX(90deg)}

        /* RESPONSIVO */
        @media (max-width: 900px) { body { flex-direction: column; } #game { flex-direction: column; } #sidebar { order: 2; height: auto; width: 100%; border-left: none; border-top: 8px solid var(--wood); } #board { transform: scale(0.55); margin-bottom: 20px; } }
    </style>
</head>
<body>

<canvas id="rain-canvas"></canvas>

<div id="lobby">
    <div class="card-lobby">
        <h1 style="color:var(--wood); font-size:2.5rem; margin:0;">RECIFE 3D</h1>
        <p style="color:#666;">Edi√ß√£o Visual</p>
        
        <input id="my-name" class="input-box" placeholder="Seu Apelido" maxlength="12">
        <button onclick="net.host()" class="btn-main bg-y">üè† CRIAR SALA</button>
        <p style="font-weight:bold; margin:10px;">- OU -</p>
        <input id="host-id" class="input-box" placeholder="C√≥digo da Sala" style="font-size:1rem;">
        <button onclick="net.join()" class="btn-main bg-g">üîó ENTRAR</button>

        <div id="wait-area" style="display:none; margin-top:20px; border-top:2px dashed #ccc; padding-top:10px;">
            <p>Sala: <b id="disp-id" style="background:#eee; padding:5px;">...</b></p>
            <div id="p-list" style="margin-bottom:10px;"></div>
            <button id="btn-start" style="display:none;" class="btn-main bg-r" onclick="net.start()">INICIAR JOGO</button>
            <p id="msg-cli" style="display:none; color:red;">Aguardando o Host...</p>
        </div>
    </div>
</div>

<div id="game">
    <div id="board-viewport">
        <div id="board">
            <div class="center-hub">
                <div class="umbrella"></div>
                <h1 style="z-index:2; color:var(--frevo-blue); text-shadow:2px 2px #fff; font-size:3rem; margin:0;">RECIFE</h1>
                <div id="weather-tag" style="z-index:2; background:#fff; padding:5px 15px; border-radius:20px; border:2px solid #000; font-weight:bold;">‚òÄÔ∏è Sol</div>
            </div>
            </div>
    </div>
    
    <div id="sidebar">
        <div class="hud-header">
            <h2 style="margin:0; color:var(--frevo-red);">Pernambuco</h2>
            <div id="turn-txt" style="font-weight:bold;">...</div>
        </div>
        
        <button id="btn-roll" class="btn-act" style="background:var(--gold); color:black;" onclick="game.act('roll')">üé≤ ROLAR DADOS</button>
        <button id="btn-buy" class="btn-act" style="background:var(--frevo-green); color:white;" onclick="game.act('buy')">üí∞ COMPRAR</button>
        <button id="btn-pass" class="btn-act" style="background:var(--frevo-red); color:white;" onclick="game.act('pass')">üõë PASSAR VEZ</button>

        <div style="margin-top:20px; font-weight:bold;">Jogadores:</div>
        <div id="hud-players"></div>
    </div>
</div>

<div id="dice-view">
    <div style="display:flex; gap:50px;">
        <div class="dice-wrap"><div id="d1" class="cube"><div class="face">1</div><div class="face">2</div><div class="face">3</div><div class="face">4</div><div class="face">5</div><div class="face">6</div></div></div>
        <div class="dice-wrap"><div id="d2" class="cube"><div class="face">1</div><div class="face">2</div><div class="face">3</div><div class="face">4</div><div class="face">5</div><div class="face">6</div></div></div>
    </div>
</div>

<script>
/* DADOS DOS BAIRROS (V16 APROVADA) */
const COLS = { br:'#795548', lb:'#03a9f4', pk:'#e91e63', or:'#ff5722', rd:'#d32f2f', yl:'#fbc02d', gr:'#388e3c', bl:'#1565c0' };
const BD = [
    {t:'st',n:'MARCO ZERO'}, {t:'pr',g:'br',n:'Coque',p:60}, {t:'ch',n:'Sorte'}, {t:'pr',g:'br',n:'Ibura',p:60}, {t:'tx',n:'IPTU',p:200}, {t:'rr',n:'Metr√¥ Centro',p:200}, {t:'pr',g:'lb',n:'Santo Amaro',p:100}, {t:'ch',n:'Rev√©s'}, {t:'pr',g:'lb',n:'Afogados',p:100}, {t:'pr',g:'lb',n:'Mustardinha',p:120},
    {t:'jl',n:'Tr√¢nsito'}, {t:'pr',g:'pk',n:'Iputinga',p:140}, {t:'ut',n:'Neoenergia',p:150}, {t:'pr',g:'pk',n:'Cordeiro',p:140}, {t:'pr',g:'pk',n:'V√°rzea',p:160}, {t:'rr',n:'Metr√¥ Oeste',p:200}, {t:'pr',g:'or',n:'Imbiribeira',p:180}, {t:'ch',n:'Sorte'}, {t:'pr',g:'or',n:'Encruzilhada',p:180}, {t:'pr',g:'or',n:'Torre',p:200},
    {t:'pk',n:'Parque Jaqueira'}, {t:'pr',g:'rd',n:'Aflitos',p:220}, {t:'ch',n:'Rev√©s'}, {t:'pr',g:'rd',n:'Espinheiro',p:220}, {t:'pr',g:'rd',n:'Madalena',p:240}, {t:'rr',n:'Via Mangue',p:200}, {t:'pr',g:'yl',n:'Gra√ßas',p:260}, {t:'pr',g:'yl',n:'Po√ßo da Panela',p:260}, {t:'ut',n:'Compesa',p:150}, {t:'pr',g:'yl',n:'Casa Forte',p:280},
    {t:'gj',n:'Blitz!'}, {t:'pr',g:'gr',n:'Apipucos',p:300}, {t:'pr',g:'gr',n:'Parnamirim',p:300}, {t:'ch',n:'Sorte'}, {t:'pr',g:'gr',n:'Paiva',p:320}, {t:'rr',n:'Aeroporto',p:200}, {t:'ch',n:'Rev√©s'}, {t:'pr',g:'bl',n:'Boa Viagem',p:350}, {t:'tx',n:'Taxa Luxo',p:100}, {t:'pr',g:'bl',n:'Jaqueira',p:400}
];

let myId=null, hostConn=null, conns=[], isHost=false, meName="";
let state = { players:[], turn:0, rolled:false, props:BD.map(()=>({owner:null})), weather:'sun' };

/* REDE SIMPLES (V9) */
const net = {
    peer: new Peer(null),
    init: () => {
        net.peer.on('open', id => myId = id);
        net.peer.on('connection', c => {
            if(isHost) {
                conns.push(c);
                c.on('data', d => net.handleHost(d, c));
                c.send({t:'LOBBY', l:state.players});
            }
        });
    },
    host: () => {
        const n = document.getElementById('my-name').value || "Host";
        if(!myId) return alert("Aguarde ID...");
        isHost = true; meName = n;
        state.players.push({id:myId, name:n, money:1500, pos:0, color:'#d32f2f'}); // Red default
        ui.wait();
    },
    join: () => {
        const n = document.getElementById('my-name').value || "Visitante";
        const id = document.getElementById('host-id').value;
        if(!id) return alert("ID?");
        meName = n;
        hostConn = net.peer.connect(id);
        hostConn.on('open', () => { hostConn.send({t:'JOIN', name:n}); });
        hostConn.on('data', d => net.handleCli(d));
        ui.waitCli();
    },
    start: () => {
        if(state.players.length < 2) return alert("Min 2 jogadores!");
        net.bc({t:'START', s:state}); game.init(state);
    },
    handleHost: (d, c) => {
        if(d.t === 'JOIN') {
            const cl = ['#1976d2','#388e3c','#fbc02d','#7b1fa2'];
            state.players.push({id:c.peer, name:d.name, money:1500, pos:0, color:cl[state.players.length%4]});
            net.bc({t:'LOBBY', l:state.players}); ui.updLobby(state.players);
        } else if (d.t === 'ACT') game.process(d);
    },
    handleCli: (d) => {
        if(d.t === 'LOBBY') ui.updLobby(d.l);
        else if(d.t === 'START') game.init(d.s);
        else if(d.t === 'STATE') { state = d.s; ui.render(); }
        else if(d.t === 'ANIM') ui.animDice(d.d1, d.d2);
        else if(d.t === 'ENV') env.set(d.w);
    },
    bc: (m) => { if(isHost){conns.forEach(c=>c.send(m));} else {hostConn.send(m);} }
};

/* LOGICA */
const game = {
    init: (s) => {
        state = s;
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('game').classList.add('active');
        ui.genBoard(); ui.render();
        if(isHost) env.check();
    },
    act: (act) => {
        const d = {t:'ACT', act:act, pid:myId};
        if(isHost) game.process(d); else hostConn.send(d);
    },
    process: (d) => {
        const idx = state.players.findIndex(p => p.id === d.pid);
        const p = state.players[idx];
        if(state.turn !== idx) return;

        if(d.act === 'roll') {
            if(state.rolled) return;
            const r1 = Math.ceil(Math.random()*6), r2 = Math.ceil(Math.random()*6);
            net.bc({t:'ANIM', d1:r1, d2:r2}); 
            if(isHost) ui.animDice(r1, r2); // Host sees too

            setTimeout(() => {
                p.pos += (r1+r2);
                if(p.pos >= 40) { p.pos -= 40; p.money += 200; }
                const prop = state.props[p.pos];
                if(prop.owner !== null && prop.owner !== idx) {
                    let r = 50; p.money -= r; state.players[prop.owner].money += r;
                }
                state.rolled = true;
                net.bc({t:'STATE', s:state});
                if(isHost) ui.render();
            }, 2000);
        }
        else if(d.act === 'buy') {
            const s = BD[p.pos];
            if(p.money >= s.p && state.props[p.pos].owner === null) {
                p.money -= s.p; state.props[p.pos].owner = idx;
                net.bc({t:'STATE', s:state}); if(isHost) ui.render();
            }
        }
        else if(d.act === 'pass') {
            state.rolled = false;
            state.turn = (state.turn + 1) % state.players.length;
            if(isHost) env.check();
            net.bc({t:'STATE', s:state}); if(isHost) ui.render();
        }
    }
};

/* UI */
const ui = {
    wait: () => {
        document.getElementById('wait-area').style.display='block';
        document.getElementById('disp-id').innerText = myId;
        document.getElementById('btn-start').style.display = 'block';
        ui.updLobby(state.players);
    },
    waitCli: () => {
        document.getElementById('wait-area').style.display='block';
        document.getElementById('msg-cli').style.display='block';
        document.getElementById('disp-id').innerText = "CONECTADO";
    },
    updLobby: (l) => { document.getElementById('p-list').innerHTML = l.map(p => `<b>${p.name}</b>`).join(', '); },
    genBoard: () => {
        const b = document.getElementById('board');
        BD.forEach((s, i) => {
            const d = document.createElement('div'); d.className = 'space'; d.id = `s${i}`;
            let r, c; if (i<=10) { r=11; c=11-i; } else if (i<=20) { r=11-(i-10); c=1; } else if (i<=30) { r=1; c=1+(i-20); } else { r=1+(i-30); c=11; }
            d.style.gridRow = r; d.style.gridColumn = c;
            d.innerHTML = s.t==='pr' ? `<div class="color-bar" style="background:${COLS[s.g]}"></div><div>${s.n}<br>$${s.p}</div>` : `<div>${s.n}</div>`;
            b.appendChild(d);
        });
    },
    render: () => {
        const turnP = state.players[state.turn];
        const meP = state.players.find(p=>p.id===myId);
        document.getElementById('turn-txt').innerText = `Vez de: ${turnP.name}`;
        
        // Buttons
        const myTurn = turnP.id === myId;
        ui.btn('btn-roll', myTurn && !state.rolled);
        const s = BD[meP.pos];
        ui.btn('btn-buy', myTurn && state.rolled && s.t==='pr' && state.props[meP.pos].owner===null);
        ui.btn('btn-pass', myTurn && state.rolled);

        // Players
        document.getElementById('hud-players').innerHTML = state.players.map((p,i) => 
            `<div class="p-item ${state.turn===i?'turn':''}" style="border-left-color:${p.color}">${p.name}: $${p.money}</div>`
        ).join('');

        // Tokens
        document.querySelectorAll('.token').forEach(e => e.remove());
        state.players.forEach((p, i) => {
            const t = document.createElement('div'); t.className = 'token'; t.innerText = '‚ôüÔ∏è'; t.style.color = p.color;
            const sp = document.getElementById(`s${p.pos}`), br = document.getElementById('board').getBoundingClientRect(), sr = sp.getBoundingClientRect();
            t.style.left = (sr.left - br.left + 10 + (i*5)) + 'px';
            t.style.top = (sr.top - br.top + 10 + (i*5)) + 'px';
            document.getElementById('board').appendChild(t);
        });

        // Borders
        state.props.forEach((pr, i) => {
            if(pr.owner !== null) document.getElementById(`s${i}`).style.border = `4px solid ${state.players[pr.owner].color}`;
        });
    },
    btn: (id, on) => { const b=document.getElementById(id); if(on){b.classList.add('on');b.disabled=false;}else{b.classList.remove('on');b.disabled=true;} },
    animDice: (d1, d2) => {
        const o = document.getElementById('dice-view'); o.style.display='flex';
        const c1=document.querySelector('#d1 .cube'), c2=document.querySelector('#d2 .cube');
        c1.style.transition='none'; c2.style.transition='none'; c1.className='cube'; c2.className='cube'; void c1.offsetWidth;
        c1.style.transition='transform 1.5s'; c2.style.transition='transform 1.5s';
        setTimeout(()=>{c1.classList.add('r'+d1); c2.classList.add('r'+d2);}, 50);
        setTimeout(()=>{o.style.display='none';}, 2000);
    }
};

/* ENV */
const env = {
    check: () => { if(Math.random()<0.2){ state.weather = state.weather==='sun'?'rain':'sun'; net.bc({t:'ENV', w:state.weather}); } },
    set: (w) => {
        const c = document.getElementById('rain-canvas');
        c.style.display = w==='rain'?'block':'none';
        document.body.classList.toggle('night-mode', w==='rain');
        document.getElementById('weather-tag').innerText = w==='rain'?'üåßÔ∏è Chuva':'‚òÄÔ∏è Sol';
        if(w==='rain') env.rain();
    },
    rain: () => {
        const c=document.getElementById('rain-canvas'), x=c.getContext('2d'); c.width=innerWidth; c.height=innerHeight;
        const d=Array(100).fill().map(()=>({x:Math.random()*c.width, y:Math.random()*c.height, s:Math.random()*5+2}));
        const l=()=>{ x.clearRect(0,0,c.width,c.height); x.strokeStyle='#88a'; d.forEach(p=>{ x.beginPath(); x.moveTo(p.x,p.y); x.lineTo(p.x,p.y+p.s); x.stroke(); p.y+=p.s; if(p.y>c.height)p.y=0; }); requestAnimationFrame(l); }; l();
    }
};

const util = { copy: () => { navigator.clipboard.writeText(myId); alert("Copiado!"); } };
net.init();
</script>
</body>
</html>
