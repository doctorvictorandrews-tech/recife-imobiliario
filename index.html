<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Recife Imobili√°rio: GOLD (V68)</title>
    <script src="https://unpkg.com/peerjs@1.5.1/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Titan+One&family=Nunito:wght@600;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-sun: linear-gradient(135deg, #f57f17, #ffb300, #29b6f6);
            --wood: #5d4037; --paper: #fff;
            --c-blue: #0277bd; --c-red: #d32f2f; --c-green: #2e7d32; --c-yel: #fbc02d;
            --c-dark: #263238;
        }
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; font-family: 'Nunito', sans-serif; 
            background: var(--bg-sun);
            height: 100vh; overflow: hidden; display: flex; flex-direction: column;
        }

        h1, h2, h3, button, .brand { font-family: 'Titan One', cursive; letter-spacing: 1px; }

        /* FX LAYER */
        #fx-layer { position: fixed; inset: 0; pointer-events: none; z-index: 9000; overflow: hidden; }
        
        .shark-anim { position: absolute; bottom: 30%; right: -50vw; font-size: min(30vh, 30vw); filter: drop-shadow(0 10px 20px rgba(0,0,0,0.5)); display: none; transform: scaleX(-1); z-index: 9001; }
        .shark-anim.active { display: block; animation: sharkPass 4s linear forwards; }
        @keyframes sharkPass { 0% {right: -50vw;} 100% {right: 120vw;} }

        .traffic-anim { position: absolute; inset: 0; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; font-family: 'Titan One'; color: #ffeb3b; font-size: 3rem; text-align: center; animation: pulseTraffic 0.5s infinite; text-shadow: 0 0 20px red; flex-direction: column; z-index: 9002; }
        .traffic-anim.active { display: flex; }
        @keyframes pulseTraffic { 0%{opacity:0.9;} 100%{opacity:1;} }
        .emote-float { position: absolute; font-size: 3rem; animation: floatUp 2s forwards; z-index: 9100; text-shadow: 0 5px 10px rgba(0,0,0,0.5); }
        @keyframes floatUp { 0%{opacity:1; transform:translateY(0) scale(0.5);} 50%{transform:translateY(-50px) scale(1.5);} 100%{opacity:0; transform:translateY(-100px) scale(1);} }

        /* UI BASE */
        .modal-overlay { position: fixed; inset: 0; z-index: 9999; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .card-menu { background: #fff; border: none; border-radius: 30px; padding: 30px; text-align: center; width: 90%; max-width: 500px; box-shadow: 0 20px 60px rgba(0,0,0,0.4); position: relative; animation: popIn 0.4s; }
        .card-menu.large { width: 95%; max-width: 1200px; height: 90vh; display: flex; flex-direction: column; }

        .title-main { font-size: 3.5rem; line-height: 1; margin: 0 0 10px 0; background: -webkit-linear-gradient(#0277bd, #2e7d32, #fbc02d, #c62828); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(2px 2px 0px rgba(0,0,0,0.2)); }
        
        .input-box { width: 100%; padding: 15px; margin: 10px 0; border: 2px solid #ddd; font-family: 'Nunito'; font-weight: 900; font-size: 1.2rem; border-radius: 15px; text-align: center; outline: none; transition: 0.3s; background: #f9f9f9; }
        .input-box:focus { border-color: var(--c-blue); background: #fff; transform: scale(1.02); }

        .btn-main { width: 100%; padding: 18px; margin-top: 10px; border: none; border-radius: 50px; font-size: 1.4rem; font-weight: 900; cursor: pointer; color: #fff; box-shadow: 0 8px 0 rgba(0,0,0,0.2); text-transform: uppercase; transition: 0.1s; }
        .btn-main:active { transform: translateY(4px); box-shadow: 0 4px 0 rgba(0,0,0,0.2); }
        .bg-blue { background: var(--c-blue); } .bg-green { background: var(--c-green); } .bg-red { background: var(--c-red); }

        .lobby-code { background: #e3f2fd; color: var(--c-blue); border: 2px dashed var(--c-blue); padding: 15px; border-radius: 15px; font-family: monospace; font-size: 1.5rem; font-weight: bold; cursor: pointer; margin-bottom: 10px; word-break: break-all; transition: 0.2s; }
        .lobby-code:active { background: #bbdefb; transform: scale(0.98); }

        /* CHARACTERS */
        #char-grid { display: grid; gap: 15px; padding: 10px; flex: 1; overflow-y: auto; grid-template-columns: repeat(4, 1fr); }
        @media (min-width: 800px) { #char-grid { grid-template-columns: repeat(8, 1fr); } }
        .char-opt { border: 3px solid #eee; border-radius: 20px; padding: 10px; cursor: pointer; background: #fff; font-size: 3rem; text-align: center; transition: 0.2s; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .char-opt:hover { transform: scale(1.1); border-color: var(--c-yel); z-index: 10; }
        .char-opt.taken { filter: grayscale(1); opacity: 0.3; pointer-events: none; background: #eee; }
        .char-opt.selected { border-color: var(--c-green); background: #e8f5e9; box-shadow: 0 0 20px rgba(76, 175, 80, 0.4); transform: scale(1.1); }
        .char-name { font-size: 0.9rem; font-family: 'Titan One'; margin-top: 5px; color: #555; }

        /* GAME BOARD */
        #game-layout { display: none; width: 100%; height: 100%; flex-direction: column; }
        #game-layout.active { display: flex; }
        #board-area { flex: 1; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.1); }
        #board-container { width: 950px; height: 950px; position: relative; transform-origin: center center; }
        #board { width: 100%; height: 100%; display: grid; grid-template-columns: repeat(11, 1fr); grid-template-rows: repeat(11, 1fr); background: #fff; border: 25px solid var(--c-dark); border-radius: 30px; box-shadow: 0 30px 100px rgba(0,0,0,0.5); background-image: url('https://www.transparenttextures.com/patterns/cardboard.png'); }
        
        .space { border: 1px solid rgba(0,0,0,0.1); background: #fff; text-align: center; position: relative; display: flex; flex-direction: column; font-weight: 800; transition: border 0.3s; }
        .space.owned { border-width: 6px !important; z-index: 5; }
        .color-strip { height: 25%; border-bottom: 2px solid var(--c-dark); }
        .sp-name { flex: 1; display: flex; align-items: center; justify-content: center; padding: 2px; line-height: 1; font-weight: 900; font-size: 0.8rem; }
        .sp-price { font-size: 0.95rem; color: #fff; background: var(--c-dark); font-family: 'Titan One'; padding: 3px 0; }
        .sp-icon { font-size: 3.5rem; display: flex; align-items: center; justify-content: center; height: 100%; }
        .loan-badge { position: absolute; top: 0; right: 0; background: red; color: white; font-size: 0.6rem; padding: 2px 5px; font-weight: bold; border-bottom-left-radius: 5px; z-index: 10; display:none; }

        .center-hub { grid-column: 2/11; grid-row: 2/11; background: #37474f; border: 6px solid var(--c-dark); display: flex; justify-content: center; align-items: center; }
        .deck { position: absolute; width: 130px; height: 170px; background: #fff; border: 5px solid #000; border-radius: 12px; cursor: pointer; box-shadow: 6px 6px 0 rgba(0,0,0,0.4); z-index: 10; display: flex; align-items: center; justify-content: center; text-align: center; font-family: 'Titan One'; font-size: 1.6rem; color: #fff; -webkit-text-stroke: 1.5px #000; transition: 0.2s; }
        .deck:active { transform: scale(0.95) !important; }
        .deck.chance { top: 35%; left: 35%; background: var(--c-green); transform: rotate(-10deg); }
        .deck.reves { top: 45%; left: 50%; background: var(--c-red); transform: rotate(10deg); }
        .deck.active { animation: pulseDeck 1s infinite; border-color: #ffeb3b; z-index: 100; transform: scale(1.2) !important; }
        @keyframes pulseDeck { 0%{transform:scale(1.2) rotate(0);} 50%{transform:scale(1.3) rotate(0);} 100%{transform:scale(1.2) rotate(0);} }

        /* HUD */
        #hud-panel { height: auto; min-height: 240px; max-height: 40vh; background: #fff; border-top: 6px solid var(--c-dark); display: flex; flex-direction: column; z-index: 5000; box-shadow: 0 -10px 40px rgba(0,0,0,0.3); padding-bottom: env(safe-area-inset-bottom); }
        .hud-top-bar { display: flex; justify-content: space-between; align-items: center; padding: 8px 15px; background: #fafafa; border-bottom: 2px dashed #ddd; }
        .turn-badge { background: var(--c-dark); color: #fff; padding: 6px 18px; border-radius: 20px; font-size: 1rem; }
        .money-display { font-size: 1.8rem; color: var(--c-green); font-family: 'Titan One'; }
        
        .hud-content { flex: 1; display: flex; justify-content: center; width: 100%; }
        .hud-inner { display: flex; gap: 10px; padding: 10px; width: 100%; max-width: 800px; }
        #players-scroll { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 6px; padding-right: 5px; }
        .p-stat { display: flex; justify-content: space-between; padding: 8px; background: #fff; border: 2px solid #eee; border-radius: 10px; align-items: center; font-weight: 800; font-size: 0.85rem; cursor:pointer; }
        .p-stat.active { background: #e3f2fd; border-color: var(--c-blue); transform: scale(1.02); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .p-stat:active { transform:scale(0.98); }
        
        #controls-area { width: 50%; display: flex; flex-direction: column; gap: 8px; justify-content: center; }
        .btn-game { width: 100%; padding: 12px; border: none; border-radius: 12px; font-family: 'Titan One'; font-size: 1rem; cursor: pointer; color: #fff; box-shadow: 0 5px 0 rgba(0,0,0,0.2); text-transform: uppercase; position: relative; }
        .btn-game:active { transform: translateY(3px); box-shadow: 0 2px 0 rgba(0,0,0,0.2); }
        .btn-game:disabled { background: #cfd8dc !important; color: #b0bec5 !important; box-shadow: none; transform: translateY(3px); }
        .btn-roll { background: var(--c-yel); color: var(--c-dark); } .btn-buy { background: var(--c-green); } .btn-pass { background: var(--c-red); }
        .btn-card { background: linear-gradient(45deg, #ff9800, #f57c00); animation: pulseBtn 1s infinite; display: none; }
        @keyframes pulseBtn { 0%{transform:scale(1);} 50%{transform:scale(1.05);} 100%{transform:scale(1);} }
        .btn-inv { background: #607d8b; color: white; font-size: 0.8rem; padding: 8px; border-radius: 5px; margin-top: 5px; cursor: pointer; text-align: center; font-weight: bold; width: 100%; border: none; }

        .emote-bar { display: flex; gap: 5px; margin-top: 5px; justify-content: center; }
        .btn-emote { background: #eee; border: none; font-size: 1.5rem; padding: 5px; border-radius: 50%; cursor: pointer; transition: 0.1s; }
        .btn-emote:active { transform: scale(0.8); background: #ddd; }

        /* MISC */
        .token { width: 60px; height: 60px; position: absolute; z-index: 50; font-size: 3.5rem; text-align: center; line-height: 60px; transition: all 0.4s; filter: drop-shadow(0 4px 2px rgba(0,0,0,0.5)); pointer-events: none; }
        .dice-stage { position: absolute; display: flex; gap: 25px; pointer-events: none; opacity: 0; top: 30%; transition: 0.2s; z-index: 7000; }
        .dice-stage.active { opacity: 1; }
        .cube { width: 90px; height: 90px; background: #fff; border-radius: 18px; display: grid; place-items: center; font-size: 3.5rem; font-weight: bold; border: 5px solid var(--c-dark); box-shadow: 0 15px 30px rgba(0,0,0,0.4); font-family: 'Titan One'; }
        
        .toast { position: fixed; top: 12%; left: 50%; transform: translateX(-50%); background: #fff; color: #000; padding: 15px 30px; border-radius: 50px; border: 4px solid var(--c-yel); z-index: 9999; animation: slideDown 3s forwards; font-family: 'Titan One'; font-size: 1.2rem; box-shadow: 0 15px 40px rgba(0,0,0,0.4); white-space: nowrap; }
        @keyframes slideDown { 0%{opacity:0;transform:translate(-50%,-50px)} 10%{opacity:1;transform:translate(-50%,0)} 90%{opacity:1} 100%{opacity:0;transform:translate(-50%,-50px)} }
        @keyframes popIn { from{transform:scale(0)} to{transform:scale(1)} }

        #inv-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.92); z-index:9500; flex-direction:column; padding:20px; }
        #inv-list { flex:1; overflow-y:auto; width:100%; max-width:600px; margin:0 auto; display:flex; flex-direction:column; gap:10px; padding-bottom: 20px; }
        .build-area { position: absolute; top: -14px; width: 100%; display: flex; justify-content: center; gap: 3px; }
        .house-3d { width: 16px; height: 16px; background: var(--c-green); border: 1px solid #000; }
        .hotel-3d { width: 22px; height: 22px; background: var(--c-red); border: 1px solid #000; }
        
        /* CARD FLIP */
        .card-flip-container { perspective: 1000px; display: none; pointer-events: auto; z-index: 8000; width: 85%; height: 50vh; max-height: 500px; }
        .card-flip { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.6s; }
        .card-flip.flipped { transform: rotateY(180deg); }
        .cf-face { position: absolute; inset: 0; backface-visibility: hidden; border: 8px solid #fff; border-radius: 20px; background: #fff; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 25px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.6); }
        .cf-back { background: var(--c-blue); color: #fff; font-family: 'Titan One'; font-size: 6rem; transform: rotateY(0deg); }
        .cf-front { transform: rotateY(180deg); background: #fff; color: var(--c-dark); }
        .rent-table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 1rem; }
        .rent-table td { padding: 8px 15px; border-bottom: 1px dashed #ddd; font-weight: 800; }
    </style>
</head>
<body>

<div id="fx-layer">
    <div class="shark-anim">ü¶à</div>
    <div class="traffic-anim">
        <div style="font-size:6rem;">üõë</div>
        <div style="font-size:2rem;color:#fff;">ENGARRAFAMENTO!<br>PERDEU A VEZ</div>
    </div>
</div>

<div id="screen-login" class="modal-overlay">
    <div class="card-menu">
        <h1 class="title-main">RECIFE<br>ONLINE</h1>
        <p style="color:#666; font-weight:bold;">V68: Gold Master</p>
        <input id="p-name" class="input-box" placeholder="Seu Apelido" maxlength="12">
        <button class="btn-main bg-blue" onclick="net.host()">CRIAR SALA</button>
        <p style="margin:5px 0; color:#888;">- OU -</p>
        <input id="host-id" class="input-box" placeholder="Cole o C√≥digo da Sala">
        <button class="btn-main bg-green" onclick="net.join()">ENTRAR NA SALA</button>
        <div id="net-status" style="margin-top:10px; font-weight:bold; color:var(--c-yel);">Conectando...</div>
    </div>
</div>

<div id="screen-lobby" class="modal-overlay" style="display:none;">
    <div class="card-menu">
        <h2>SALA DE ESPERA</h2>
        <p style="color:#666; font-size:0.9rem;">Toque no c√≥digo para copiar</p>
        <div class="lobby-code" id="disp-id" onclick="util.copy()">...</div>
        <div id="lobby-list" style="margin:15px 0; background:#f5f5f5; padding:10px; border-radius:15px; min-height:100px; display:flex; flex-direction:column; gap:5px;"></div>
        <button id="btn-goto-char" class="btn-main bg-green" style="display:none;" onclick="net.toChars()">ESCOLHER PERSONAGENS</button>
        <p id="msg-wait" style="display:none; color:var(--c-red); font-weight:bold;">Aguardando o Mestre...</p>
    </div>
</div>

<div id="screen-char" class="modal-overlay" style="display:none;">
    <div class="card-menu large">
        <h2>ESCOLHA SUA FANTASIA</h2>
        <p style="color:#666;">Quem voc√™ ser√° no bloco?</p>
        <div id="char-grid"></div>
        <button id="btn-start" class="btn-main bg-blue" style="display:none; margin-top:20px;" onclick="net.startGame()">TOCAR O FREVO! (INICIAR)</button>
    </div>
</div>

<div id="game-layout">
    <div id="board-area">
        <div id="board-container">
            <div id="board">
                <div class="center-hub"><div class="brand" style="font-size:5rem;color:rgba(255,255,255,0.1);transform:rotate(-45deg);">RECIFE</div></div>
                <div class="deck chance" id="d-chance" onclick="game.clickDeck('ch')">SORTE<br>üçÄ</div>
                <div class="deck reves" id="d-reves" onclick="game.clickDeck('rev')">REV√âS<br>‚ö†Ô∏è</div>
            </div>
        </div>
    </div>

    <div id="hud-panel">
        <div class="hud-top-bar">
            <div class="turn-badge" id="turn-display">...</div>
            <button onclick="narrator.toggle()" style="border:none;background:none;font-size:1.5rem;" id="btn-sound">üîá</button>
            <div class="money-display" id="my-money">$1500</div>
        </div>
        <div class="hud-content">
            <div class="hud-inner">
                <div id="players-scroll"></div>
                <div style="width:50%;">
                    <div id="my-controls">
                        <button id="b-card" class="btn-game btn-card" onclick="game.forceDrawCard()">üé¥ PEGAR CARTA</button>
                        <button id="b-roll" class="btn-game bg-blue" onclick="game.act('roll')">üé≤ ROLAR</button>
                        <div style="display:flex; gap:5px; margin-top:5px;">
                            <button id="b-buy" class="btn-game bg-green" disabled onclick="game.act('buy')">üí∞</button>
                            <button id="b-pass" class="btn-game bg-red" disabled onclick="game.act('pass')">üõë</button>
                        </div>
                    </div>
                    <div id="jail-controls" style="display:none; flex-direction:column; gap:5px;">
                         <button class="btn-game bg-green" onclick="game.act('payJail')">Pagar $50</button>
                         <button class="btn-game bg-blue" onclick="game.act('roll')">Tentar Sorte</button>
                    </div>
                    <div class="emote-bar">
                        <button class="btn-emote" onclick="game.emote('üòÇ')">üòÇ</button>
                        <button class="btn-emote" onclick="game.emote('üò°')">üò°</button>
                        <button class="btn-emote" onclick="game.emote('üí∏')">üí∏</button>
                        <button class="btn-emote" onclick="game.emote('ü§ù')">ü§ù</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="prop-modal" class="modal-overlay" style="display:none;">
    <div class="card-menu">
        <h2 id="pm-name">RUA</h2>
        <div style="font-size:2rem; color:var(--c-green);" id="pm-price">$200</div>
        <div id="pm-loan-info" style="background:#ffebee; color:#b71c1c; padding:10px; border-radius:10px; margin:10px 0; display:none; font-size:0.9rem;">
            ‚ö†Ô∏è <b>EMPR√âSTIMO ATIVO</b><br>D√≠vida: <span id="pm-debt">$0</span><br>Prazo: <span id="pm-turns">5</span> rodadas
        </div>
        <div id="pm-controls" style="margin-top:15px;"></div>
        <button class="btn-main" style="background:#546e7a;margin-top:10px;" onclick="ui.closeModal()">FECHAR</button>
    </div>
</div>

<div id="trade-modal" class="modal-overlay" style="display:none;">
    <div class="card-menu">
        <h2>NEGOCIAR</h2>
        <p>Comprar <b id="tm-target-name">Rua</b> de <span id="tm-owner">Player</span></p>
        <div style="text-align:left; margin:10px 0;">
            üí∞ Oferta ($): <input type="number" id="tm-money" value="0" style="width:80px; padding:5px; border-radius:5px; border:1px solid #ccc;"><br><br>
            üè† Trocar por: <select id="tm-prop" style="width:100%;padding:10px; border-radius:5px; border:1px solid #ccc;"></select>
        </div>
        <button class="btn-main bg-green" onclick="trade.sendOffer()">ENVIAR PROPOSTA</button>
        <button class="btn-main" style="background:#546e7a;margin-top:5px;" onclick="document.getElementById('trade-modal').style.display='none'">CANCELAR</button>
    </div>
</div>

<div id="offer-modal" class="modal-overlay" style="display:none;">
    <div class="card-menu">
        <h2>üîî PROPOSTA!</h2>
        <p id="om-desc">...</p>
        <button class="btn-main bg-green" onclick="trade.reply(true)">ACEITAR</button>
        <button class="btn-main bg-blue" onclick="trade.startCounter()">PEDIR MAIS GRANA</button>
        <button class="btn-main bg-red" onclick="trade.reply(false)">RECUSAR</button>
    </div>
</div>

<div id="inv-modal" class="modal-overlay" style="display:none;">
    <div class="card-menu" style="height:80vh;">
        <h2>SUAS ESCRITURAS</h2>
        <div id="inv-list" style="overflow-y:auto; flex:1; width:100%;"></div>
        <button class="btn-main" onclick="document.getElementById('inv-modal').style.display='none'">FECHAR</button>
    </div>
</div>

<div id="host-tools" class="modal-overlay" style="display:none;">
    <div class="card-menu">
        <h2 style="color:var(--c-red)">PAINEL DO MESTRE</h2>
        <p>Gerenciar Jogador: <b id="ht-pname"></b></p>
        <button class="btn-main bg-blue" onclick="game.hostForcePass()">FOR√áAR PASSAR VEZ</button>
        <button class="btn-main bg-red" onclick="game.hostKick()">EXPULSAR DA SALA</button>
        <button class="btn-main" style="background:#546e7a" onclick="document.getElementById('host-tools').style.display='none'">FECHAR</button>
    </div>
</div>

<div id="dice-visual" class="dice-stage"><div id="d1" class="cube">1</div><div id="d2" class="cube">1</div></div>

<div id="card-flip-container" class="card-flip-container" style="display:none; position:fixed; inset:0; z-index:8000; justify-content:center; align-items:center;">
    <div class="card-flip" id="card-flipper">
        <div class="cf-face cf-back" id="cf-back-style">?</div>
        <div class="cf-face cf-front">
            <h2 class="brand" id="ev-title" style="font-size:2.8rem; margin-bottom:20px;">SORTE</h2>
            <p id="ev-desc" style="font-size:1.6rem; font-weight:bold;">Texto...</p>
            <button class="btn-game btn-roll" style="width:auto; padding:15px 50px; margin-top:30px; color:#000;" onclick="ui.closeEvent()">BELEZA</button>
        </div>
    </div>
</div>

<script>
/* DADOS */
const CHARS=[{id:'c1',i:'üíÖ',n:'Ratona'},{id:'c2',i:'üóø',n:'Bilola'},{id:'c3',i:'üõ∂',n:'Celta'},{id:'c4',i:'ü¶Ä',n:'Caranguejo'},{id:'c5',i:'ü¶à',n:'Tubar√£o'},{id:'c6',i:'‚òÇÔ∏è',n:'Sombrinha'},{id:'c7',i:'üêÄ',n:'Gabiru'},{id:'c8',i:'üåΩ',n:'Milho'},{id:'c9',i:'üêî',n:'Galo'},{id:'c10',i:'üöå',n:'BRT'},{id:'c11',i:'üç•',n:'Bolo Rolo'},{id:'c12',i:'üêª',n:'La Ursa'},{id:'c13',i:'üòé',n:'Anderson'},{id:'c14',i:'üöî',n:'Viatura'},{id:'c15',i:'ü¶Ñ',n:'M√°gico'},{id:'c16',i:'üëΩ',n:'ET'},{id:'c17',i:'üç∫',n:'Caldinho'},{id:'c18',i:'üèñÔ∏è',n:'Praieiro'},{id:'c19',i:'ü•Å',n:'Baterista'},{id:'c20',i:'üíÉ',n:'Passista'}];
const COLORS=['#ef5350','#42a5f5','#66bb6a','#ffee58','#ab47bc','#ffa726','#8d6e63','#78909c'];
const BD=[
    {t:'st',n:'MARCO ZERO'}, {t:'pr',g:'#795548',n:'Coque',p:60,h:50,r:[2,10,30,90,160,250]}, {t:'ch',n:'Sorte',i:'üçÄ'}, {t:'pr',g:'#795548',n:'Ibura',p:60,h:50,r:[4,20,60,180,320,450]}, {t:'tx',n:'TAXA 10%'}, {t:'rr',n:'Est. Joana',p:200}, {t:'pr',g:'#03a9f4',n:'Agamenon',p:100,h:50,r:[6,30,90,270,400,550]}, {t:'ch',n:'Rev√©s'}, {t:'pr',g:'#03a9f4',n:'Afogados',p:100,h:50,r:[6,30,90,270,400,550]}, {t:'pr',g:'#03a9f4',n:'Mustardinha',p:120,h:50,r:[8,40,100,300,450,600]},
    {t:'jl',n:'LEI SECA'}, {t:'pr',g:'#e91e63',n:'Iputinga',p:140,h:100,r:[10,50,150,450,750,950]}, {t:'ut',n:'Celpe',p:150}, {t:'pr',g:'#e91e63',n:'Cordeiro',p:140,h:100,r:[10,50,150,450,750,950]}, {t:'pr',g:'#e91e63',n:'V√°rzea',p:160,h:100,r:[12,60,180,500,700,900]}, {t:'rr',n:'Est. Coqueiral',p:200}, {t:'pr',g:'#ff5722',n:'Imbiribeira',p:180,h:100,r:[14,70,200,550,750,950]}, {t:'ch',n:'Sorte'}, {t:'pr',g:'#ff5722',n:'Encruzilhada',p:180,h:100,r:[14,70,200,550,750,950]}, {t:'pr',g:'#ff5722',n:'Torre',p:200,h:100,r:[16,80,220,600,800,1000]},
    {t:'pk',n:'Boa Vista'}, {t:'pr',g:'#d32f2f',n:'Aflitos',p:220,h:150,r:[18,90,250,700,875,1050]}, {t:'ch',n:'Rev√©s'}, {t:'pr',g:'#d32f2f',n:'Espinheiro',p:220,h:150,r:[18,90,250,700,875,1050]}, {t:'pr',g:'#d32f2f',n:'Madalena',p:240,h:150,r:[20,100,300,750,925,1100]}, {t:'rr',n:'Est. Barro',p:200}, {t:'pr',g:'#fbc02d',n:'Gra√ßas',p:260,h:150,r:[22,110,330,800,975,1150]}, {t:'pr',g:'#fbc02d',n:'Po√ßo',p:260,h:150,r:[22,110,330,800,975,1150]}, {t:'ut',n:'Compesa',p:150}, {t:'pr',g:'#fbc02d',n:'Casa Forte',p:280,h:150,r:[24,120,360,850,1025,1200]},
    {t:'gj',n:'CADEIA!'}, {t:'pr',g:'#388e3c',n:'Apipucos',p:300,h:200,r:[26,130,390,900,1100,1275]}, {t:'pr',g:'#388e3c',n:'Parnamirim',p:300,h:200,r:[26,130,390,900,1100,1275]}, {t:'ch',n:'Sorte'}, {t:'pr',g:'#388e3c',n:'Paiva',p:320,h:200,r:[28,150,450,1000,1200,1400]}, {t:'rr',n:'Est. Afogados',p:200}, {t:'ch',n:'Rev√©s'}, {t:'pr',g:'#1565c0',n:'Boa Viagem',p:350,h:200,r:[35,175,500,1100,1300,1500]}, {t:'tx',n:'TAXA 10%'}, {t:'pr',g:'#1565c0',n:'Jaqueira',p:400,h:200,r:[50,200,600,1400,1700,2000]}
];

const CARDS_SORTE = [{txt:"Achasse 200 conto! +200", val:200}, {txt:"Ganhasse na rifa! +50", val:50}, {txt:"V√≥ deu dinheiro. +100", val:100}, {txt:"Achou dinheiro na areia. +20", val:20}];
const CARDS_REVES = [{txt:"Multa na Agamenon. -50", val:-50}, {txt:"Perdeu a carteira. -100", val:-100}, {txt:"A R√°dio Patrulha te pegou!", act:'jail'}, {txt:"Conta de Luz Alta! -50", val:-50}];

/* STATE */
let myId=null, hostConn=null, conns=[], isHost=false, myName="";
let state={ 
    phase:'LOBBY', 
    players:[], 
    props:Array(40).fill(null), 
    turn:0, 
    rolled:false, 
    doubles:0, 
    activeTrade:null, 
    totalTurns:0,
    nextGalo: Math.floor(Math.random()*11) + 20 
}; 
let activeIdx = -1;
let pendingCardType = null;
let selectedTargetId = null; // For host tools

/* UTILS */
const util = {
    copy: () => {
        const text = myId;
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(text).then(() => ui.toast("Copiado!"));
        } else {
            let textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try { document.execCommand('copy'); ui.toast("Copiado!"); } catch (err) { alert("Copie manualmente: " + text); }
            document.body.removeChild(textArea);
        }
    }
};

const narrator = {
    on: false,
    toggle: () => { narrator.on = !narrator.on; document.getElementById('btn-sound').innerText = narrator.on ? 'üîä' : 'üîá'; },
    speak: (txt) => { if(narrator.on && 'speechSynthesis' in window) { try{const u = new SpeechSynthesisUtterance(txt); u.lang='pt-BR'; speechSynthesis.speak(u);}catch(e){} } }
};

/* NET */
const net={
    init:()=>{
        try {
            const p = new Peer(null,{debug:1});
            p.on('open',id=>{ 
                myId=id; 
                document.getElementById('net-status').innerText="‚úÖ PRONTO PARA A FOLIA"; 
                document.getElementById('net-status').style.color="#2e7d32";
                setTimeout(()=>{ confetti({particleCount: 100, spread: 70, origin: { y: 0.6 }}); }, 500);
            });
            p.on('connection',c=>{
                if(isHost){
                    c.on('open',()=> { c.send({t:'SYNC',s:state}); conns.push(c); });
                    c.on('data',d=> net.hostProcess(d));
                    c.on('close', () => { 
                        // Basic handling of disconnects: remove from list? No, might reconnect. Just toast.
                        ui.toast("Algu√©m desconectou!"); 
                    });
                }
            });
            net.me=p;
        } catch(e) { alert("Erro PeerJS: " + e); }
    },
    host:()=>{ 
        if(!myId)return alert("Aguarde a conex√£o..."); 
        isHost=true; myName=document.getElementById('p-name').value||"Mestre da Folia";
        state.players.push({id:myId, name:myName, color:COLORS[0], money:1500, pos:0, jailed:false, active:true, traded:false, sharkProt:0});
        ui.screen('lobby'); ui.lobby();
    },
    join:()=>{
        const id=document.getElementById('host-id').value.trim(); myName=document.getElementById('p-name').value||"Foli√£o";
        if(!id||!myId)return alert("Preencha o c√≥digo!");
        hostConn=net.me.connect(id);
        hostConn.on('open',()=>{ hostConn.send({t:'JOIN',name:myName}); ui.screen('lobby'); document.getElementById('msg-wait').style.display='block'; });
        hostConn.on('data',d=> net.clientProcess(d));
        hostConn.on('close',()=>alert("Desconectado do Host!"));
    },
    hostProcess:(d)=>{
        if(d.t==='JOIN'){
            if(state.players.length<8) state.players.push({id:d.conn, name:d.name, color:COLORS[state.players.length], money:1500, pos:0, jailed:false, active:true, traded:false, sharkProt:0});
            net.sync();
        }
        else if(d.t==='ACT') game.run(d);
        else if(d.t==='TRADE') trade.process(d);
        else if(d.t==='CHAR') { const p=state.players.find(x=>x.id===d.pid); if(p) p.char=d.c; net.sync(); }
    },
    clientProcess:(d)=>{
        if(d.t==='SYNC'){ state=d.s; ui.update(); }
        else if(d.t==='TOAST') { ui.toast(d.m); narrator.speak(d.m); }
        else if(d.t==='ANIM') ui.dice(d.d1,d.d2);
        else if(d.t==='EMOTE') ui.showEmote(d.pid, d.e);
        else if(d.t==='OFFER') trade.showOffer(d);
        else if(d.t==='FX') ui.fx(d.k);
    },
    sync:()=>{ conns.forEach(c=>c.send({t:'SYNC',s:state})); if(isHost) ui.update(); },
    send:(msg)=>{ if(isHost) net.hostProcess({...msg, pid:myId}); else hostConn.send({...msg, pid:myId}); },
    toChars:()=>{ state.phase='CHARS'; net.sync(); },
    startGame:()=>{ if(state.players.every(p=>p.char)){ state.phase='GAME'; net.sync(); } },
    selectChar:(cid)=>{ 
        const el = document.querySelectorAll('.char-opt'); el.forEach(e => e.classList.remove('selected'));
        if(isHost){ const p=state.players.find(x=>x.id===myId); if(!state.players.some(x=>x.char===cid)){p.char=cid; net.sync();} } 
        else hostConn.send({t:'CHAR', pid:myId, c:cid}); 
    }
};

/* GAME LOGIC (HOST) */
const game={
    act:(a, val=null)=> net.send({t:'ACT', a, val}),
    hostForcePass:() => {
        if(!selectedTargetId) return;
        // Force state.turn to next
        state.rolled=false; state.doubles=0; 
        const pIdx = state.players.findIndex(p=>p.id===selectedTargetId);
        if(pIdx !== -1 && state.turn === pIdx) {
             do { state.turn=(state.turn+1)%state.players.length; } while(!state.players[state.turn].active);
             net.broadcast({t:'TOAST', m:"O Mestre passou a vez!"});
             net.sync();
        }
        document.getElementById('host-tools').style.display='none';
    },
    hostKick:() => {
        if(!selectedTargetId) return;
        const pIdx = state.players.findIndex(p=>p.id===selectedTargetId);
        if(pIdx !== -1) {
            game.bankrupt(pIdx);
            // Optional: Remove from array? Risk of index shift. Better to set active=false (Bankrupt).
            net.broadcast({t:'TOAST', m:"Jogador removido!"});
            net.sync();
        }
        document.getElementById('host-tools').style.display='none';
    },
    run:(d)=>{
        const pIdx=state.players.findIndex(p=>p.id===d.pid);
        const p=state.players[pIdx];
        if(state.turn!==pIdx) return; // Ignore acts out of turn

        if(d.a==='roll'){
            if(state.rolled && state.doubles===0) return;
            const d1=Math.ceil(Math.random()*6), d2=Math.ceil(Math.random()*6);
            net.broadcast({t:'ANIM',d1,d2});
            
            // GALO LOGIC
            state.totalTurns++;
            if(state.totalTurns >= state.nextGalo){
                state.nextGalo = state.totalTurns + Math.floor(Math.random()*11) + 20;
                p.pos=0; p.money+=200;
                state.rolled=true; 
                net.broadcast({t:'TOAST',m:`O GALO LEVOU ${p.name} PRO MARCO ZERO!`});
                net.sync();
                return;
            }

            if(p.jailed){
                if(d1===d2){ p.jailed=false; game.move(p, d1+d2); }
                else { state.rolled=true; net.broadcast({t:'TOAST',m:"Ainda preso!"}); }
            } else {
                if(d1===d2) { state.doubles++; net.broadcast({t:'TOAST',m:"Duplos! Jogue de novo"}); } else state.doubles=0;
                if(state.doubles>=3) { p.jailed=true; p.pos=10; state.rolled=true; state.doubles=0; net.broadcast({t:'TOAST',m:"3x Duplos! Cadeia!"}); }
                else { game.move(p, d1+d2); if(d1!==d2) state.rolled=true; }
            }
            net.sync();
        }
        else if(d.a==='confirmBuy'){
            const s=BD[p.pos];
            if(p.money>=s.p && !state.props[p.pos]){
                p.money-=s.p; state.props[p.pos]={owner:pIdx, level:0, loan:null};
                net.broadcast({t:'TOAST',m:`${p.name} comprou ${s.n}`}); net.sync();
            }
        }
        else if(d.a==='pass'){
            state.props.forEach((pr, i)=>{ if(pr && pr.owner===pIdx && pr.loan){ pr.loan.val=Math.ceil(pr.loan.val*1.1); pr.loan.turns--; if(pr.loan.turns<=0) game.bankrupt(pIdx); } });
            state.rolled=false; state.doubles=0; p.traded=false;
            do { state.turn=(state.turn+1)%state.players.length; } while(!state.players[state.turn].active);
            net.sync();
        }
        else if(d.a==='payJail' && p.money>=50){ p.money-=50; p.jailed=false; net.sync(); }
        else if(d.a==='mortgage'){ const pr=state.props[d.val]; if(pr && pr.owner===pIdx && !pr.loan){ pr.loan={val:Math.floor(BD[d.val].p*0.8), turns:5}; p.money+=pr.loan.val; net.sync(); } }
        else if(d.a==='payLoan'){ const pr=state.props[d.val]; if(pr && pr.owner===pIdx && pr.loan && p.money>=pr.loan.val){ p.money-=pr.loan.val; pr.loan=null; net.sync(); } }
        else if(d.a==='emote') net.broadcast({t:'EMOTE', pid:d.pid, e:d.val});
        else if(d.a==='build'){
            const pr = state.props[d.val];
            if(pr && pr.owner===pIdx && pr.level<5){
                const cost = BD[d.val].h;
                if(p.money >= cost){ p.money-=cost; pr.level++; net.broadcast({t:'TOAST', m:"Construiu!"}); net.sync(); }
            }
        }
        else if(d.a==='drawCard'){
            const card = d.val.card;
            if(card.val) p.money += card.val;
            if(card.act === 'jail') { p.jailed=true; p.pos=10; }
            state.rolled = true; 
            if(state.doubles > 0) state.rolled = false; 
            net.sync();
        }
    },
    move:(p, steps)=>{
        p.pos=(p.pos+steps)%40;
        if(p.pos<steps && p.active) { p.money+=200; net.broadcast({t:'TOAST',m:"Sal√°rio! +$200"}); }
        
        const s=BD[p.pos]; const pr=state.props[p.pos];
        
        if(s.n==="Agamenon" && !pr){
            if(Math.random() < 0.5){
                net.broadcast({t:'FX',k:'traffic'});
                net.broadcast({t:'TOAST',m:"ENGARRAFAMENTO! Perde a vez."});
                state.rolled=true;
            } else {
                p.money += 50;
                net.broadcast({t:'TOAST',m:"CUPOM BK! Ganhou R$50"});
            }
        }
        else if(s.n==="Boa Viagem"){
            if(Math.random() < 0.5){
                if(p.sharkProt > 0){
                    p.sharkProt--;
                    net.broadcast({t:'TOAST',m:"RAT√ÉO SALVOU! (-1 Escudo)"});
                } else {
                    p.money-=50;
                    net.broadcast({t:'FX',k:'shark'});
                    net.broadcast({t:'TOAST',m:"TUBAR√ÉO MORDOU! -$50"});
                }
            } else {
                p.sharkProt++;
                net.broadcast({t:'TOAST',m:"Ganhou Prote√ß√£o Tubar√£o Rat√£o!"});
            }
        }
        else if(s.t==='tx'){
            const tax = Math.floor(p.money*0.1);
            p.money -= tax;
            net.broadcast({t:'TOAST',m:`LE√ÉO DO IR! -${tax} (10%)`});
        }
        else if((s.t==='pr'||s.t==='rr'||s.t==='ut') && pr && pr.owner!==state.players.indexOf(p) && !pr.loan){
            let rent=50;
            if(s.t==='pr') rent = s.r[pr.level];
            else if(s.t==='rr') { let c=BD.filter((b,i)=>b.t==='rr'&&state.props[i]&&state.props[i].owner===pr.owner).length; rent=25*Math.pow(2,c-1); }
            else if(s.t==='ut') { rent = (state.lastD1+state.lastD2)*4; }
            
            p.money-=rent; state.players[pr.owner].money+=rent;
            net.broadcast({t:'TOAST',m:`Pagou aluguel $${rent}`});
        }
    },
    bankrupt:(pid)=>{
        const p=state.players[pid]; p.active=false; p.money=0;
        state.props.forEach((pr,i)=>{ if(pr && pr.owner===pid) state.props[i]=null; });
        net.broadcast({t:'TOAST',m:`${p.name} FALIU!`});
    }
};
net.broadcast = (msg) => { conns.forEach(c=>c.send(msg)); if(isHost) net.clientProcess(msg); };

/* TRADE */
const trade={
    tTarget: -1,
    start:(propIdx)=>{
        if(state.players[state.turn].traded) return alert("S√≥ 1 troca por vez!");
        trade.tTarget=propIdx; const pr=state.props[propIdx];
        document.getElementById('tm-target-name').innerText=BD[propIdx].n;
        document.getElementById('tm-owner').innerText=state.players[pr.owner].name;
        const sel=document.getElementById('tm-prop'); sel.innerHTML='<option value="-1">Nada</option>';
        const myIdx=state.players.findIndex(p=>p.id===myId);
        state.props.forEach((p,i)=>{ if(p && p.owner===myIdx && !p.loan) sel.innerHTML+=`<option value="${i}">${BD[i].n}</option>`; });
        document.getElementById('trade-modal').style.display='flex';
    },
    sendOffer:()=>{
        const money=parseInt(document.getElementById('tm-money').value)||0;
        const giveProp=parseInt(document.getElementById('tm-prop').value);
        net.send({t:'TRADE', act:'offer', targetProp:trade.tTarget, money, giveProp});
        document.getElementById('trade-modal').style.display='none';
    },
    process:(d)=>{
        if(d.act==='offer'){
            state.activeTrade=d;
            const pr=state.props[d.targetProp]; const ownerId=state.players[pr.owner].id;
            const payload={t:'OFFER', ...d, fromName:state.players.find(p=>p.id===d.pid).name};
            if(ownerId===myId) trade.showOffer(payload); else conns.find(c=>c.peer===ownerId)?.send(payload);
        }
        else if(d.act==='accept'){
            const t=state.activeTrade; const buyerIdx=state.players.findIndex(p=>p.id===t.pid); const sellerIdx=state.props[t.targetProp].owner;
            state.players[buyerIdx].money-=t.money; state.players[sellerIdx].money+=t.money;
            state.props[t.targetProp].owner=buyerIdx;
            if(t.giveProp!==-1) state.props[t.giveProp].owner=sellerIdx;
            state.players[buyerIdx].traded=true; state.activeTrade=null; net.sync();
            net.broadcast({t:'TOAST',m:"NEG√ìCIO FECHADO!"});
        }
        else if(d.act==='refuse'){ state.activeTrade=null; net.broadcast({t:'TOAST',m:"RECUSADO!"}); }
        else if(d.act==='counter'){ net.broadcast({t:'TOAST',m:"QUER MAIS GRANA!"}); }
    },
    showOffer:(d)=>{
        document.getElementById('om-desc').innerHTML=`${d.fromName} quer <b>${BD[d.targetProp].n}</b><br>Oferta: $${d.money} ${d.giveProp!==-1?'+ '+BD[d.giveProp].n:''}`;
        document.getElementById('offer-modal').style.display='flex';
    },
    reply:(accept)=>{ document.getElementById('offer-modal').style.display='none'; net.send({t:'TRADE', act:accept?'accept':'refuse'}); },
    startCounter:()=>{ document.getElementById('offer-modal').style.display='none'; net.send({t:'TRADE', act:'counter'}); }
};

/* UI */
const ui={
    screen:(id)=>{ ['login','lobby','char'].forEach(x=>document.getElementById('screen-'+x).style.display='none'); if(id) document.getElementById('screen-'+id).style.display='flex'; },
    lobby:()=>{
        document.getElementById('disp-id').innerText=myId;
        document.getElementById('lobby-list').innerHTML = state.players.map(p=>`<div style="background:#fff;padding:10px;border-radius:10px;font-weight:bold;color:#333;">${p.name}</div>`).join('');
        if(isHost && state.players.length>1) document.getElementById('btn-goto-char').style.display='block';
    },
    update:()=>{
        if(state.phase==='LOBBY') ui.lobby();
        else if(state.phase==='CHARS'){
            ui.screen('char');
            document.getElementById('char-grid').innerHTML = CHARS.map(c=>{
                const t=state.players.find(p=>p.char===c.id);
                const isMe = t && t.id === myId;
                return `<div class="char-opt ${t?'taken':''} ${isMe?'selected':''}" onclick="net.selectChar('${c.id}')">${c.i}<br><span class="char-name">${t?t.name:c.n}</span></div>`
            }).join('');
            if(isHost && state.players.every(p=>p.char)) document.getElementById('btn-start').style.display='block';
        }
        else if(state.phase==='GAME'){
            document.getElementById('screen-char').style.display='none';
            document.getElementById('game-layout').classList.add('active');
            
            BD.forEach((s,i)=>{
                let d=document.getElementById(`s${i}`);
                if(!d) {
                    const b=document.getElementById('board');
                    d=document.createElement('div'); d.className='space'; d.id=`s${i}`;
                    let r,c; if(i<=10){r=11;c=11-i;}else if(i<=20){r=11-(i-10);c=1;}else if(i<=30){r=1;c=1+(i-20);}else{r=1+(i-30);c=11;}
                    d.style.gridRow=r; d.style.gridColumn=c;
                    d.onclick=()=>ui.clickSpace(i);
                    d.innerHTML += s.t==='pr'?`<div class="color-strip" style="background:${s.g}"></div><div class="sp-name">${s.n}</div><div class="sp-price">$${s.p}</div>`:`<div class="sp-icon">${s.i||''}</div>`;
                    b.appendChild(d);
                }
                const pr = state.props[i];
                if(pr) { d.classList.add('owned'); d.style.borderColor=state.players[pr.owner].color; if(pr.loan && !d.querySelector('.loan-badge')){const b=document.createElement('div');b.className='loan-badge';b.innerText='DIVIDA';d.appendChild(b);} }
                else { d.classList.remove('owned'); d.style.borderColor='rgba(0,0,0,0.1)'; const lb=d.querySelector('.loan-badge'); if(lb) lb.remove(); }
                
                if(s.t==='pr' && pr){
                    let area = d.querySelector('.build-area');
                    if(!area){ area = document.createElement('div'); area.className='build-area'; d.appendChild(area); }
                    area.innerHTML = pr.level===5 ? '<div class="hotel-3d"></div>' : Array(pr.level).fill('<div class="house-3d"></div>').join('');
                }
            });

            // Tokens
            document.querySelectorAll('.token').forEach(e=>e.remove());
            state.players.forEach((p,i)=>{
                if(!p.active) return;
                const sp=document.getElementById(`s${p.pos}`);
                if(sp){
                    const t=document.createElement('div'); t.className='token'; t.innerText=CHARS.find(c=>c.id===p.char).i; t.id=`tok${i}`;
                    const samePos = state.players.filter(x => x.active && x.pos === p.pos);
                    const idx = samePos.findIndex(x => x.id === p.id);
                    const angle = (idx / samePos.length) * Math.PI * 2;
                    const ox = samePos.length > 1 ? Math.cos(angle) * 15 : 0; const oy = samePos.length > 1 ? Math.sin(angle) * 15 : 0;
                    t.style.left=(sp.offsetLeft + 12 + ox)+'px'; t.style.top=(sp.offsetTop + 12 + oy)+'px'; t.style.transform='scale(0.8)';
                    document.getElementById('board').appendChild(t);
                }
            });

            // HUD
            const me=state.players.find(p=>p.id===myId); const turnP=state.players[state.turn];
            document.getElementById('turn-display').innerText = `VEZ DE: ${turnP.name}`;
            document.getElementById('my-money').innerText = `$${me.money}`;
            const isMyTurn = turnP.id === myId;
            const btnRoll = document.getElementById('b-roll');
            const btnCard = document.getElementById('b-card');
            
            if(pendingCardType && isMyTurn) {
                btnRoll.style.display = 'none';
                btnCard.style.display = 'block';
            } else {
                btnRoll.style.display = 'block';
                btnCard.style.display = 'none';
            }
            
            btnRoll.disabled = !(isMyTurn && !state.rolled);
            document.getElementById('b-buy').disabled = !(isMyTurn && state.rolled && !state.props[me.pos] && BD[me.pos].t==='pr');
            document.getElementById('b-pass').disabled = !(isMyTurn && state.rolled && !pendingCardType);
            
            document.getElementById('jail-controls').style.display = (isMyTurn && me.jailed) ? 'flex' : 'none';
            document.getElementById('my-controls').style.display = (isMyTurn && me.jailed) ? 'none' : 'block';
            
            document.getElementById('players-scroll').innerHTML = state.players.map((p,i)=>
                `<div class="p-stat ${state.turn===i?'active':''} ${!p.active?'bankrupt':''}" style="border-left:5px solid ${p.color}" onclick="ui.clickPlayer('${p.id}')">
                    <span>${CHARS.find(c=>c.id===p.char).i} ${p.name} ${p.jailed?'üîí':''} ${p.sharkProt>0?'üõ°Ô∏è':''}</span>
                    <span>$${p.money}</span>
                </div>`
            ).join('');
            resizeBoard();
        }
    },
    clickPlayer:(pid) => {
        if(isHost && pid !== myId) {
            selectedTargetId = pid;
            const p = state.players.find(x=>x.id===pid);
            document.getElementById('ht-pname').innerText = p.name;
            document.getElementById('host-tools').style.display='flex';
        }
    },
    clickSpace:(i)=>{
        const s=BD[i]; const pr=state.props[i]; activeIdx = i;
        if(s.t!=='pr' && s.t!=='rr' && s.t!=='ut') return;
        document.getElementById('pm-name').innerText=s.n; document.getElementById('pm-price').innerText=`$${s.p}`; document.getElementById('pm-name').style.background=s.g||'#333';
        const ct=document.getElementById('pm-controls'); ct.innerHTML=''; const meIdx=state.players.findIndex(p=>p.id===myId);
        
        // Show Rent Table
        const tbl = document.getElementById('rent-table-body');
        let html = '';
        if(s.r) {
            const labels = ['Aluguel', '1 Casa', '2 Casas', '3 Casas', '4 Casas', 'Hotel'];
            s.r.forEach((val, k) => html += `<tr><td>${labels[k]}</td><td style="text-align:right">$${val}</td></tr>`);
            html += `<tr style="background:#eee; color:#000;"><td>Custo Const.</td><td style="text-align:right">$${s.h}</td></tr>`;
        } else html = `<tr><td>Aluguel Base</td><td style="text-align:right">$50</td></tr>`;
        tbl.innerHTML = html;

        if(pr){
            if(pr.owner===meIdx){
                if(pr.loan){
                    document.getElementById('pm-loan-info').style.display='block';
                    document.getElementById('pm-debt').innerText=`$${pr.loan.val}`; document.getElementById('pm-turns').innerText=pr.loan.turns;
                    ct.innerHTML=`<button class="btn-game bg-green" onclick="game.act('payLoan', ${i})">PAGAR D√çVIDA</button>`;
                } else {
                    document.getElementById('pm-loan-info').style.display='none';
                    ct.innerHTML=`
                        <div style="display:flex;gap:5px;">
                            <button class="btn-game bg-red" onclick="game.act('mortgage', ${i})">PEGAR EMPR√âSTIMO</button>
                            <button class="btn-game bg-green" onclick="game.act('build', ${i})">+ CASA</button>
                        </div>`;
                }
            } else {
                document.getElementById('pm-loan-info').style.display='none';
                if(state.turn===meIdx && !state.players[meIdx].traded) ct.innerHTML=`<button class="btn-game bg-blue" onclick="ui.closeModal(); trade.start(${i})">COMPRAR DELE</button>`;
                else ct.innerHTML=`<p>Propriedade de ${state.players[pr.owner].name}</p>`;
            }
        } else { document.getElementById('pm-loan-info').style.display='none'; ct.innerHTML='<p>Dispon√≠vel para compra</p>'; }
        document.getElementById('prop-modal').style.display='flex';
    },
    closeModal:()=>{ document.querySelectorAll('.modal-overlay').forEach(e=>{if(e.id!=='screen-lobby')e.style.display='none'}); },
    toast:(m)=>{ const d=document.createElement('div');d.className='toast';d.innerText=m;document.body.appendChild(d);setTimeout(()=>d.remove(),3000); },
    dice:(d1,d2)=>{ 
        const ds=document.getElementById('dice-visual'); ds.classList.add('active');
        const c1=document.getElementById('d1'), c2=document.getElementById('d2');
        c1.innerText=''; c2.innerText=''; c1.className='cube shake'; c2.className='cube shake';
        setTimeout(()=>{ c1.className='cube';c2.className='cube'; c1.innerText=d1; c2.innerText=d2; },1000);
        setTimeout(()=>{ ds.classList.remove('active'); },2500);
    },
    showEmote:(pid, e)=>{
        const idx=state.players.findIndex(p=>p.id===pid); const tok=document.getElementById(`tok${idx}`);
        if(tok){ const el=document.createElement('div'); el.className='emote-float'; el.innerText=e; el.style.left=tok.style.left; el.style.top=tok.style.top; document.getElementById('board').appendChild(el); setTimeout(()=>el.remove(),2000); }
    },
    toggleInv:()=>{
        const m=document.getElementById('inv-modal'); m.style.display='flex';
        const meIdx=state.players.findIndex(p=>p.id===myId);
        document.getElementById('inv-list').innerHTML=state.props.map((p,i)=>{
            if(p && p.owner===meIdx) return `<div style="background:#fff;padding:10px;border-radius:5px;font-weight:bold;display:flex;justify-content:space-between;border:1px solid #ccc;"><span>${BD[i].n}</span> ${p.loan?'<span style="color:red">D√çVIDA</span>':''}</div>`;
        }).join('');
    },
    fx:(k)=>{
        if(k==='shark'){ document.querySelector('.shark-anim').classList.add('active'); setTimeout(()=>document.querySelector('.shark-anim').classList.remove('active'),4000); }
        if(k==='traffic'){ document.querySelector('.traffic-anim').classList.add('active'); setTimeout(()=>document.querySelector('.traffic-anim').classList.remove('active'),2000); }
    },
    clickDeck:(type)=>{
        if(pendingCardType && state.turn === state.players.findIndex(p=>p.id===myId) && type === pendingCardType){
            const deck = type==='ch' ? CARDS_SORTE : CARDS_REVES;
            const card = deck[Math.floor(Math.random()*deck.length)];
            ui.showEvent(type, card.txt);
            game.act('drawCard', {type, card});
            pendingCardType = null;
        }
    },
    showEvent: (type, text) => {
        const c = document.getElementById('card-flip-container'); // FIX V67: Use container ID
        c.style.display='flex';
        const flip = document.getElementById('card-flipper');
        const back = document.getElementById('cf-back-style');
        back.style.background = type==='ch' ? '#2e7d32' : '#c62828'; back.innerText = type==='ch' ? '?' : '!';
        document.getElementById('ev-title').innerText = type==='ch'?'SORTE':'REV√âS'; 
        document.getElementById('ev-desc').innerText = text;
        setTimeout(()=>flip.classList.add('flipped'), 100);
    },
    closeEvent: () => { 
        document.getElementById('card-flip-container').style.display='none'; 
        document.getElementById('card-flipper').classList.remove('flipped'); 
    }
};

function resizeBoard() {
    const el=document.getElementById('board-container'); const area=document.getElementById('board-area'); const hud=document.getElementById('hud-panel');
    if(!el || !area) return;
    const availH = window.innerHeight - (hud?hud.offsetHeight:0);
    const availW = area.offsetWidth;
    const scale = (Math.min(availW, availH)*0.95)/950;
    el.style.transform=`scale(${scale})`;
}
window.addEventListener('resize', resizeBoard);
net.init();
</script>
</body>
</html>
