<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Recife Imobili√°rio: Online (V71.3)</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Titan+One&family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* --- ESTILOS VISUAIS ID√äNTICOS √Ä V68/71 --- */
        :root { --wood: #5d4037; --paper: #fff8e1; --c-blue: #0277bd; --c-red: #d32f2f; --c-green: #2e7d32; --c-yel: #fbc02d; --c-dark: #263238; --board-bg: #c5e1a5; --space-bg: #ffffff; --border-col: #1a1a1a; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Nunito', sans-serif; background: linear-gradient(120deg, #1565c0, #fbc02d, #c62828, #1565c0); background-size: 400% 400%; animation: frevoBG 15s ease infinite; height: 100dvh; width: 100vw; overflow: hidden; display: flex; flex-direction: column; }
        @keyframes frevoBG { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
        h1, h2, h3, button, .brand { font-family: 'Titan One', cursive; letter-spacing: 1px; text-shadow: 2px 2px 0 rgba(0,0,0,0.2); }
        #fx-layer { position: fixed; inset: 0; pointer-events: none; z-index: 8000; overflow: hidden; }
        .shark-anim { position: absolute; bottom: 25%; right: -50vw; font-size: 30vh; filter: drop-shadow(10px 10px 0 #000); transition: 0.1s; display: none; transform: scaleX(-1); }
        .shark-anim.active { display: block; animation: sharkPass 4s linear forwards; }
        @keyframes sharkPass { 0% {right: -50vw;} 100% {right: 120vw;} }
        .traffic-anim { position: absolute; inset: 0; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; font-family: 'Titan One'; color: #ffeb3b; font-size: 3rem; text-align: center; animation: pulseTraffic 0.5s infinite; text-shadow: 0 0 20px red; flex-direction: column; z-index: 8500; }
        .traffic-anim.active { display: flex; }
        @keyframes pulseTraffic { 0%{opacity:0.9;} 100%{opacity:1;} }
        #screen-start, #screen-lobby, #screen-join, #screen-char, #screen-end { position: fixed; inset: 0; z-index: 9999; background: rgba(0,0,0,0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; overflow-y: auto; }
        #screen-end, #screen-lobby, #screen-join, #screen-char { display: none; }
        .card-menu { background: #fff; border: 8px solid var(--c-dark); border-radius: 30px; padding: 25px; text-align: center; width: 90%; max-width: 450px; box-shadow: 0 20px 0 var(--c-yel); margin: auto; }
        .sel-box { margin: 15px 0; text-align: left; }
        input, select { width: 100%; padding: 12px; border: 3px solid var(--c-dark); font-family: 'Nunito'; font-weight: 800; font-size: 1.2rem; border-radius: 10px; text-align: center; text-transform: uppercase;}
        .btn-main { width: 100%; padding: 15px; margin-top: 15px; border: none; border-radius: 50px; font-size: 1.2rem; background: var(--c-green); color: #fff; cursor: pointer; box-shadow: 0 6px 0 #1b5e20; transition: 0.1s; text-transform: uppercase; }
        .btn-main:active { transform: translateY(4px); box-shadow: 0 3px 0 #1b5e20; }
        .btn-sec { background: var(--c-blue); box-shadow: 0 6px 0 #0d47a1; }
        .char-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 15px; max-height: 40vh; overflow-y: auto; }
        .char-opt { border: 2px solid #ccc; border-radius: 12px; padding: 5px; cursor: pointer; background: #fff; font-size: 2rem; text-align: center; }
        .lobby-list { text-align: left; margin: 15px 0; background: #eee; padding: 10px; border-radius: 10px; }
        .lobby-item { padding: 5px; border-bottom: 1px solid #ccc; font-weight: bold; }
        #room-code-display { font-size: 2.5rem; color: var(--c-red); font-family: 'Titan One'; letter-spacing: 5px; margin: 10px 0; user-select: all; cursor: pointer; }
        #game-layout { display: none; width: 100%; height: 100%; overflow: hidden; flex-direction: column; }
        #game-layout.active { display: flex; }
        #board-area { position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.1); flex: 1; width: 100%; min-height: 0; }
        #board-container { position: relative; transform-origin: center center; box-shadow: 0 0 50px rgba(0,0,0,0.5); display: block; }
        #board { width: 900px; height: 1050px; display: grid; grid-template-columns: repeat(11, 1fr); grid-template-rows: repeat(11, 1fr); background: var(--board-bg); border: 4px solid var(--border-col); }
        #hud-panel { background: #fff; display: flex; flex-direction: column; z-index: 5000; box-shadow: 0 -5px 20px rgba(0,0,0,0.2); flex-shrink: 0; width: 100%; border-top: 4px solid var(--c-dark); padding: 10px; padding-bottom: calc(10px + env(safe-area-inset-bottom)); }
        #action-btns { width: 100%; margin-bottom: 5px; }
        #normal-btns, #jail-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; width: 100%; }
        .btn-game { border: none; border-radius: 10px; font-family: 'Titan One'; cursor: pointer; color: #fff; box-shadow: 0 3px 0 rgba(0,0,0,0.3); text-transform: uppercase; position: relative; width: 100%; transition: 0.1s; display: flex; align-items: center; justify-content: center; text-align: center; height: 45px; font-size: 0.9rem; padding: 0 5px; }
        .btn-game:active { transform: translateY(2px); box-shadow: 0 1px 0 rgba(0,0,0,0.3); }
        .btn-game:disabled { background: #cfd8dc !important; color: #b0bec5 !important; box-shadow: none; transform: translateY(2px); cursor: default; opacity: 0.7; }
        .btn-roll { background: var(--c-yel); color: var(--c-dark); }
        .btn-buy { background: var(--c-green); }
        .btn-pass { background: var(--c-red); }
        .btn-trade { background: #1976d2; }
        .btn-card { background: linear-gradient(45deg, #ff9800, #f57c00); animation: pulseBtn 1s infinite; display: none; width: 100%; grid-column: span 2; }
        .hud-top-bar { background: #eceff1; border: 2px solid #b0bec5; border-radius: 8px; padding: 5px 15px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .btn-inv { background: #37474f; color: white; border-radius: 8px; cursor: pointer; border: none; font-weight: 800; text-transform: uppercase; height: 35px; width: 100%; font-size: 0.8rem; }
        .hud-content { display: none; }
        @media (min-width: 900px) {
            #game-layout { flex-direction: row; }
            #hud-panel { width: 380px; height: 100%; border-left: 6px solid var(--c-dark); border-top: none; padding: 0; }
            #board { width: 1300px; height: 1000px; } 
            .hud-content { padding: 20px; display: flex; flex-direction: column; flex: 1; overflow: hidden; }
            .hud-top-bar { padding: 15px; margin: 0; border: none; border-bottom: 2px dashed #cfd8dc; border-radius: 0; order: -1; }
            #action-btns { display: flex; flex-direction: column; gap: 10px; margin-bottom: 10px; padding: 20px; }
            #normal-btns, #jail-btns { display: flex; flex-direction: column; gap: 10px; }
            .btn-game { min-height: 60px; font-size: 1.3rem; padding: 18px; } 
            .btn-inv { display: none; }
            #players-scroll { display: flex; flex-direction: column; margin-bottom: 15px; max-height: 20vh; overflow-y: auto; gap: 5px; padding: 0 10px; border-bottom: 2px dashed #ccc; padding-bottom:10px;}
            #desktop-props-container { display: block; flex: 1; overflow-y: auto; padding-top: 10px; }
        }
        @media (max-width: 899px) {
            #players-scroll, #desktop-props-container { display: none; }
            #mobile-controls-wrapper { display: flex; flex-direction: column; width: 100%; }
        }
        .space { background: var(--space-bg); border: 1px solid var(--border-col); position: relative; display: flex; flex-direction: column; font-size: 0.75rem; font-weight: 800; color: #000; overflow: hidden; }
        .rot-left { transform: rotate(90deg); }
        .rot-top { transform: rotate(180deg); }
        .rot-right { transform: rotate(-90deg); }
        .space-content { width:100%; height:100%; display:flex; flex-direction:column; justify-content:space-between; text-align:center; padding: 2px; }
        .color-strip { height: 20%; width: 100%; border-bottom: 2px solid #000; }
        .sp-name { flex: 1; display: flex; align-items: center; justify-content: center; line-height: 1.1; font-weight: 900; padding:0 2px; }
        .sp-price { font-family: 'Nunito'; font-weight: 700; padding-bottom: 5px; font-size: 0.85rem; }
        .sp-icon { font-size: 2.5rem; display: flex; align-items: center; justify-content: center; height: 100%; }
        .space.owned { border: 4px solid !important; z-index: 5; }
        .center-hub { grid-column: 2/11; grid-row: 2/11; position: relative; background: transparent; display: flex; justify-content: center; align-items: center; flex-direction: column; pointer-events: none; }
        .center-title { font-family: 'Titan One', cursive; color: #1565c0; font-size: 7rem; text-transform: uppercase; line-height: 0.9; text-align: center; transform: rotate(-5deg); text-shadow: 4px 4px 0 #fff, 8px 8px 0 rgba(0,0,0,0.3); display: flex; flex-direction: column; align-items: center; }
        .center-sub { font-size: 2.5rem; color: #d32f2f; -webkit-text-stroke: 1px #fff; }
        .center-icon { font-size: 4rem; margin-top: -20px; filter: drop-shadow(4px 4px 0 rgba(0,0,0,0.3)); }
        .deck { position: absolute; width: 110px; height: 150px; border-radius: 15px; cursor: pointer; box-shadow: 0 10px 0 rgba(0,0,0,0.2), 0 10px 20px rgba(0,0,0,0.4); z-index: 10; display: flex; align-items: center; justify-content: center; text-align: center; font-family: 'Titan One'; font-size: 1.5rem; color: #fff; -webkit-text-stroke: 1px rgba(0,0,0,0.3); pointer-events: auto; border: 2px solid rgba(255,255,255,0.4); transition: transform 0.1s; }
        .deck:active { transform: translateY(4px); box-shadow: 0 6px 0 rgba(0,0,0,0.2); }
        .deck.chance { top: 20%; left: 15%; background: linear-gradient(135deg, #ab47bc, #7b1fa2); transform: rotate(-5deg); }
        .deck.reves { bottom: 20%; right: 15%; background: linear-gradient(135deg, #ffa726, #f57c00); transform: rotate(5deg); }
        .deck-label { font-size: 3rem; opacity: 0.8; }
        .token { width: 50px; height: 50px; position: absolute; z-index: 50; font-size: 3rem; text-align: center; line-height: 50px; transition: all 0.4s; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.6)); pointer-events: none; }
        .token-shield { position: absolute; top:-5px; right:-5px; font-size: 1rem; background: blue; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; border: 1px solid #fff; }
        .build-area { position: absolute; top: 2px; width: 100%; display: flex; justify-content: center; gap: 2px; z-index: 4; }
        .house-3d { width: 12px; height: 12px; background: var(--c-green); border: 1px solid #000; box-shadow: 1px 1px 0 #000; }
        .hotel-3d { width: 18px; height: 18px; background: var(--c-red); border: 1px solid #000; box-shadow: 1px 1px 0 #000; }
        .loan-badge { position: absolute; inset:0; background: rgba(255,0,0,0.3); display: flex; justify-content: center; align-items: center; color: red; font-weight: 900; font-size: 2rem; transform: rotate(-45deg); display:none; pointer-events: none; z-index: 6;}
        .money-display { font-size: 1.4rem; color: var(--c-green); font-family: 'Titan One'; }
        .money-display.debt { color: #d32f2f; animation: pulseRed 1s infinite; }
        @keyframes pulseRed { 0%{opacity:1} 50%{opacity:0.5} 100%{opacity:1} }
        .p-stat { background: #fff; border: 1px solid #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: space-between; font-weight: 700; font-size: 0.8rem; padding: 8px; }
        .p-stat.active { background: #e3f2fd; border: 2px solid var(--c-blue); transform: scale(1.02); }
        .p-stat.bankrupt { opacity: 0.5; text-decoration: line-through; }
        .prop-item { background:#fff; border-left:8px solid #333; padding:10px; border-radius:5px; cursor:pointer; font-weight:bold; display:flex; justify-content:space-between; margin-bottom:5px; border:1px solid #eee; font-size: 0.85rem; align-items: center; transition:0.2s;}
        .prop-item:hover { background: #f5f5f5; transform:translateX(2px); }
        .prop-item.loan { background: #ffebee; border-left-color: #d32f2f !important; }
        .loan-alert { color: #d32f2f; font-size: 0.7rem; display: block; }
        #overlay-layer { position: fixed; inset: 0; pointer-events: none; z-index: 9500; display: flex; justify-content: center; align-items: center; }
        #overlay-bg { position:absolute; inset:0; background:rgba(0,0,0,0.7); pointer-events:auto; display:none; }
        .prop-card { width: 90%; max-width: 400px; background: #fff; border-radius: 20px; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.8); pointer-events: auto; display: none; border: 4px solid var(--c-dark); animation: popIn 0.3s; z-index: 9600; position:relative; }
        .pc-head { padding: 15px; background: var(--c-blue); color: #fff; font-family: 'Titan One'; font-size: 1.4rem; text-align: center; }
        .rent-table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 0.9rem; }
        .rent-table td { padding: 6px 12px; border-bottom: 1px dashed #ddd; font-weight: 800; }
        .card-flip-container { perspective: 1000px; display: none; pointer-events: auto; z-index: 8000; width: 85%; height: 60vh; max-height: 500px; }
        .card-flip { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.6s; }
        .card-flip.flipped { transform: rotateY(180deg); }
        .cf-face { position: absolute; inset: 0; backface-visibility: hidden; border: 6px solid #fff; border-radius: 20px; background: #fff; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .cf-back { background: var(--c-blue); color: #fff; font-family: 'Titan One'; font-size: 5rem; transform: rotateY(0deg); }
        .cf-front { transform: rotateY(180deg); background: #fff; color: var(--c-dark); }
        .dice-stage { position: absolute; display: flex; gap: 20px; pointer-events: none; opacity: 0; top: 30%; transition: 0.2s; z-index: 7000; }
        .dice-stage.active { opacity: 1; }
        .cube { width: 80px; height: 80px; background: #fff; border-radius: 15px; display: grid; place-items: center; font-size: 3rem; font-weight: bold; border: 4px solid var(--c-dark); box-shadow: 0 10px 20px rgba(0,0,0,0.4); font-family: 'Titan One'; }
        .cube.shake { animation: shake 0.1s infinite; }
        @keyframes shake { 0%{transform:rotate(0)} 25%{transform:rotate(8deg)} 75%{transform:rotate(-8deg)} }
        .toast { position: fixed; top: 10%; left: 50%; transform: translateX(-50%); background: #fff; color: #000; padding: 15px 30px; border-radius: 50px; border: 4px solid var(--c-yel); z-index: 9999; animation: slideDown 3s forwards; font-family: 'Titan One'; font-size: 1.2rem; box-shadow: 0 10px 30px rgba(0,0,0,0.4); white-space: nowrap; }
        @keyframes slideDown { 0%{opacity:0;transform:translate(-50%,-50px)} 10%{opacity:1;transform:translate(-50%,0)} 90%{opacity:1} 100%{opacity:0;transform:translate(-50%,-50px)} }
        @keyframes popIn { from{transform:scale(0)} to{transform:scale(1)} }
        #inv-modal, #trade-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:7000; flex-direction:column; padding:20px; align-items: center; justify-content: center; }
        #inv-list { flex:1; overflow-y:auto; width:100%; max-width:500px; margin:0 auto; display:flex; flex-direction:column; gap:8px; }
        .trade-box { background: #fff; width: 95%; max-width: 600px; border-radius: 20px; border: 4px solid var(--c-blue); padding: 15px; max-height: 80vh; overflow-y: auto; display: flex; flex-direction: column; }
        .trade-cols { display: flex; gap: 10px; margin-bottom: 15px; }
        .t-col { flex: 1; border: 1px solid #ccc; padding: 5px; border-radius: 8px; }
        .t-head { font-weight: 900; text-align: center; background: #eee; padding: 5px; border-radius: 5px; margin-bottom: 5px; }
        .t-opt { padding: 5px; display: block; font-size: 0.8rem; border-bottom: 1px solid #eee; }
        #net-status { position:fixed; top:5px; right:5px; background:rgba(0,0,0,0.5); color:#fff; font-size:0.7rem; padding:3px; border-radius:5px; z-index:9999; display:none; }
    </style>
</head>
<body>

<div id="net-status">SALVANDO...</div>
<div id="fx-layer"><div class="shark-anim">ü¶à</div><div class="traffic-anim"><div style="font-size:5rem;">üõë</div><div>ENGARRAFAMENTO!</div></div></div>

<div id="screen-start">
    <div class="card-menu">
        <h1 style="color:var(--c-blue); font-size:3rem; margin:0; line-height:1;">RECIFE IMOBILI√ÅRIO<br><span style="font-size:1.2rem; color:#000;">ONLINE (V71.3)</span></h1>
        <div class="sel-box">
            <label>NOME DE JOGADOR</label>
            <input type="text" id="p-name" placeholder="SEU NOME" maxlength="10">
        </div>
        <div class="sel-box">
            <button class="btn-main" onclick="fb.createRoom()">CRIAR SALA</button>
            <button class="btn-main btn-sec" onclick="fb.screenJoin()">ENTRAR</button>
        </div>
    </div>
</div>

<div id="screen-join" style="display:none;">
    <div class="card-menu">
        <h2 class="brand">ENTRAR NA SALA</h2>
        <div class="sel-box">
            <label>C√ìDIGO DA SALA</label>
            <input type="text" id="join-code" placeholder="C√ìDIGO">
        </div>
        <button class="btn-main" onclick="fb.joinRoom()">ENTRAR</button>
        <button class="btn-main btn-sec" onclick="location.reload()">VOLTAR</button>
    </div>
</div>

<div id="screen-lobby">
    <div class="card-menu">
        <h2 class="brand">LOBBY</h2>
        <div id="room-code-display" onclick="fb.copyCode()">...</div>
        <div class="lobby-list" id="lobby-list"></div>
        <div class="sel-box" id="host-controls">
            <button class="btn-main" onclick="fb.startGame()">INICIAR JOGO</button>
        </div>
        <div id="client-msg" style="display:none">Aguardando Host...</div>
    </div>
</div>

<div id="screen-char">
    <div class="card-menu">
        <h2 class="brand" id="char-title">ESCOLHA SEU PERSONAGEM</h2>
        <div class="char-grid" id="char-grid"></div>
    </div>
</div>

<div id="game-layout">
    <div id="board-area">
        <div id="board-container">
            <div id="board">
                <div class="center-hub"><div class="center-title">RECIFE <span class="center-sub">IMOBILI√ÅRIO</span></div><div class="center-icon">ü¶à‚õ±Ô∏è</div></div>
                <div class="deck chance" id="d-chance" onclick="game.clickDeck('ch')"><div class="deck-label">?</div></div>
                <div class="deck reves" id="d-reves" onclick="game.clickDeck('rev')"><div style="font-size:2rem">üí∞</div></div>
            </div>
        </div>
    </div>
    <div id="hud-panel">
        <div id="mobile-controls-wrapper">
            <div id="action-btns">
                <button id="b-card" class="btn-game btn-card" onclick="game.forceDrawCard()">üé¥ PEGAR CARTA</button>
                <div id="jail-btns" style="display:none; gap:5px; width:100%; height:100%;">
                      <button class="btn-game btn-buy" style="flex:1" onclick="game.payJail()">Pagar $50</button>
                      <button class="btn-game btn-roll" style="flex:1" onclick="game.roll()">Tentar Sorte</button>
                </div>
                <div id="normal-btns" style="display:flex; gap:5px; width:100%; height:100%;">
                    <button id="b-roll" class="btn-game btn-roll" onclick="game.roll()">üé≤ ROLAR</button>
                    <button id="b-buy" class="btn-game btn-buy" disabled onclick="game.buy()">COMPRAR</button>
                    <button id="b-trade" class="btn-game btn-trade" onclick="game.openTrade()">NEGOCIAR</button>
                    <button id="b-pass" class="btn-game btn-pass" disabled onclick="game.pass()">PASSAR</button>
                </div>
            </div>
            <div class="hud-top-bar">
                <div class="turn-badge" id="turn-display">Carregando...</div>
                <div class="money-display" id="p-money">$0</div>
            </div>
            <button class="btn-inv" onclick="ui.toggleInv()">üíº ESCRITURAS</button>
        </div>
        <div class="hud-content"><div id="players-scroll"></div><div id="desktop-props-container"></div></div>
    </div>
</div>

<div id="inv-modal"><h2 style="color:#fff;text-align:center;font-family:'Titan One';">SUAS PROPRIEDADES</h2><div id="inv-list"></div><button class="btn-main" style="margin-top:auto;" onclick="document.getElementById('inv-modal').style.display='none'">FECHAR</button></div>

<div id="trade-modal">
    <div class="trade-box">
        <h2 class="brand" style="text-align:center;">NEGOCIA√á√ÉO</h2>
        <div class="sel-box"><label>COM QUEM?</label><select id="trade-partner" onchange="game.updateTradeUI()"></select></div>
        <div class="trade-cols">
            <div class="t-col"><div class="t-head">EU DOU</div><div style="padding:5px">Cash: $<input type="number" id="trade-money-give" value="0" min="0" style="width:60px"></div><div id="trade-list-give"></div></div>
            <div class="t-col"><div class="t-head">EU RECEBO</div><div id="trade-list-get"></div></div>
        </div>
        <div style="display:flex;gap:10px;">
            <button class="btn-game btn-buy" onclick="game.sendOffer()">ENVIAR PROPOSTA</button>
            <button class="btn-game btn-pass" onclick="document.getElementById('trade-modal').style.display='none'">CANCELAR</button>
        </div>
    </div>
</div>

<div id="trade-accept-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:9999;flex-direction:column;justify-content:center;align-items:center;">
    <div class="trade-box">
        <h2 class="brand">PROPOSTA!</h2>
        <p id="trade-desc">...</p>
        <div style="display:flex;gap:10px;margin-top:20px;">
            <button class="btn-game btn-buy" onclick="game.resolveTrade(true)">ACEITAR</button>
            <button class="btn-game btn-pass" onclick="game.resolveTrade(false)">RECUSAR</button>
        </div>
    </div>
</div>

<div id="overlay-layer">
    <div id="overlay-bg" onclick="ui.closeCard()"></div>
    <div id="dice-visual" class="dice-stage"><div id="d1" class="cube">1</div><div id="d2" class="cube">1</div></div>
    <div class="card-flip-container" id="card-event"><div class="card-flip" id="card-flipper"><div class="cf-face cf-back" id="cf-back-style">?</div><div class="cf-face cf-front"><h2 class="brand" id="ev-title">SORTE</h2><p id="ev-desc">...</p><button class="btn-game btn-roll" style="width:auto;padding:15px;margin-top:30px;color:#000;" onclick="ui.closeEvent()">BELEZA</button></div></div></div>
    <div id="prop-card" class="prop-card">
        <div class="pc-head" id="pc-name">RUA</div>
        <div style="padding:15px;">
            <div style="display:flex;justify-content:space-between;align-items:center;"><div style="font-size:3rem;">üè†</div><div style="text-align:right;"><div style="font-size:0.8rem;color:#666;font-weight:bold;">VALOR</div><div class="brand" style="font-size:2rem;color:var(--c-green);" id="pc-price">$200</div></div></div>
            <table class="rent-table" id="rent-table-body"></table>
            <div id="act-buy" style="display:none;margin-top:10px;"><button class="btn-game btn-buy" onclick="game.confirmBuy()">COMPRAR</button><button class="btn-game" style="background:#546E7A;color:#fff;margin-top:5px;" onclick="ui.closeCard()">N√ÉO QUERO</button></div>
            <div id="act-manage" style="display:none;margin-top:10px;">
                <div style="background:#ffebee;padding:10px;border-radius:5px;margin-bottom:10px;display:none;" id="loan-info"><b style="color:#d32f2f">HIPOTECA</b><br>Pagar: <span id="debt-val"></span></div>
                <div style="display:flex;gap:5px;margin-bottom:5px;"><button id="btn-mtg" class="btn-game btn-roll" onclick="game.mortgage()">HIPOTECAR</button><button id="btn-bld" class="btn-game btn-buy" onclick="game.build()">+ CASA</button></div>
                <button class="btn-game" style="background:#37474F;color:#fff;font-size:0.8rem;padding:10px;" onclick="ui.closeCard()">FECHAR</button>
            </div>
        </div>
    </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBMRA5IwyPyv6YEqG2z4KT1e5jk7B1_Vwc",
  authDomain: "recifeimob-beb6c.firebaseapp.com",
  databaseURL: "https://recifeimob-beb6c-default-rtdb.firebaseio.com",
  projectId: "recifeimob-beb6c",
  storageBucket: "recifeimob-beb6c.firebasestorage.app",
  messagingSenderId: "1063704445620",
  appId: "1:1063704445620:web:a9ccc21171b9e3d16e4de1"
};

let db;
try { firebase.initializeApp(firebaseConfig); db = firebase.database(); } catch(e){}

const CHARS=[{id:'rt',i:'üíÖ',n:'A Ratona'}, {id:'as',i:'üóø',n:'Bilola'}, {id:'bt',i:'üõ∂',n:'Celta'}, {id:'c',i:'ü¶Ä',n:'Caranguejo'}, {id:'s',i:'ü¶à',n:'Tubar√£o'}, {id:'u',i:'‚òÇÔ∏è',n:'Sombrinha'}, {id:'pd',i:'üêÄ',n:'Gabiru'}, {id:'bb',i:'üåΩ',n:'Milho'}, {id:'gl',i:'üêî',n:'Galo'}, {id:'brt',i:'üöå',n:'BRT'}, {id:'bdr',i:'üç•',n:'Bolo Rolo'}, {id:'lu',i:'üêª',n:'La Ursa'}, {id:'hmn',i:'üé©',n:'Meia-Noite'}, {id:'rp',i:'üöî',n:'R√°dio P.'}, {id:'srr',i:'üêö',n:'Sururu'}, {id:'and',i:'üòé',n:'Anderson'}];
const BD=[{t:'st',n:'MARCO ZERO',i:'üö©'}, {t:'pr',g:'#795548',n:'Coque',p:60,h:50,r:[2,10,30,90,160,250]}, {t:'ch',n:'Sorte',i:'üçÄ'}, {t:'pr',g:'#795548',n:'Ibura',p:60,h:50,r:[4,20,60,180,320,450]}, {t:'tx',n:'IPTU',i:'üí∏'}, {t:'rr',n:'Est. Joana B.',p:200,m:100,i:'üöÜ',r:[25,50,100,200]}, {t:'pr',g:'#03a9f4',n:'Agamenon',p:100,h:50,r:[6,30,90,270,400,550]}, {t:'rev',n:'Rev√©s',i:'‚ö†Ô∏è'}, {t:'pr',g:'#03a9f4',n:'Afogados',p:100,h:50,r:[6,30,90,270,400,550]}, {t:'pr',g:'#03a9f4',n:'Mustardinha',p:120,h:50,r:[8,40,100,300,450,600]}, {t:'jl',n:'LEI SECA',i:'üëÆ'}, {t:'pr',g:'#e91e63',n:'Iputinga',p:140,h:100,r:[10,50,150,450,750,950]}, {t:'ut',n:'Celpe',p:150,i:'üí°'}, {t:'pr',g:'#e91e63',n:'Cordeiro',p:140,h:100,r:[10,50,150,450,750,950]}, {t:'pr',g:'#e91e63',n:'V√°rzea',p:160,h:100,r:[12,60,180,500,700,900]}, {t:'rr',n:'Est. Coqueiral',p:200,m:100,i:'üöÜ',r:[25,50,100,200]}, {t:'pr',g:'#ff5722',n:'Rosarinho',p:180,h:100,r:[14,70,200,550,750,950]}, {t:'ch',n:'Sorte',i:'üçÄ'}, {t:'pr',g:'#ff5722',n:'Encruzilhada',p:180,h:100,r:[14,70,200,550,750,950]}, {t:'pr',g:'#ff5722',n:'Torre',p:200,h:100,r:[16,80,220,600,800,1000]}, {t:'pk',n:'Pq. Jaqueira',i:'üå≥'}, {t:'pr',g:'#d32f2f',n:'Aflitos',p:220,h:150,r:[18,90,250,700,875,1050]}, {t:'rev',n:'Rev√©s',i:'‚ö†Ô∏è'}, {t:'pr',g:'#d32f2f',n:'Espinheiro',p:220,h:150,r:[18,90,250,700,875,1050]}, {t:'pr',g:'#d32f2f',n:'Madalena',p:240,h:150,r:[20,100,300,750,925,1100]}, {t:'rr',n:'Est. Barro',p:200,m:100,i:'üöÜ',r:[25,50,100,200]}, {t:'pr',g:'#fbc02d',n:'Gra√ßas',p:260,h:150,r:[22,110,330,800,975,1150]}, {t:'pr',g:'#fbc02d',n:'Po√ßo Panela',p:260,h:150,r:[22,110,330,800,975,1150]}, {t:'ut',n:'Compesa',p:150,i:'üíß'}, {t:'pr',g:'#fbc02d',n:'Casa Forte',p:280,h:150,r:[24,120,360,850,1025,1200]}, {t:'gj',n:'CADEIA!',i:'üöì'}, {t:'pr',g:'#388e3c',n:'Apipucos',p:300,h:200,r:[26,130,390,900,1100,1275]}, {t:'pr',g:'#388e3c',n:'Parnamirim',p:300,h:200,r:[26,130,390,900,1100,1275]}, {t:'ch',n:'Sorte',i:'üçÄ'}, {t:'pr',g:'#388e3c',n:'Paiva',p:320,h:200,r:[28,150,450,1000,1200,1400]}, {t:'rr',n:'Est. Afogados',p:200,m:100,i:'üöÜ',r:[25,50,100,200]}, {t:'rev',n:'Rev√©s',i:'‚ö†Ô∏è'}, {t:'pr',g:'#1565c0',n:'Boa Viagem',p:350,h:200,r:[35,175,500,1100,1300,1500]}, {t:'tx',n:'Taxa',i:'üßæ'}, {t:'pr',g:'#1565c0',n:'Pina',p:400,h:200,r:[50,200,600,1400,1700,2000]}];
const CARDS_SORTE = [{txt:"Acelera! +200",act:'move',val:0},{txt:"Metr√¥ quebrou, Uber p/ Boa Viagem.",act:'warp',dest:37},{txt:"Ganhe $50 de cada.",act:'all',val:50},{txt:"Achou carteira. +$150",val:150},{txt:"Habeas Corpus.",act:'getjail'},{txt:"Deu a louca no GPS. Volte 3.",act:'back',val:3},{txt:"Lucro no Bolo de Rolo. +$50",val:50},{txt:"Vendeu o Celta. +$100",val:100},{txt:"V√° p/ Casa Forte.",act:'warp',dest:29},{txt:"Troco a mais. +$20",val:20},{txt:"Indeniza√ß√£o Compesa. +$100",val:100},{txt:"Promo√ß√£o. +$100",val:100},{txt:"Heran√ßa. +$100",val:100},{txt:"Jogo do Bicho. +$200",val:200},{txt:"Achasse 200 conto!",val:200}];
const CARDS_REVES = [{txt:"IPTU Atrasado. -$50",val:-50},{txt:"Rem√©dios -$100",val:-100},{txt:"Pague reparos.",act:'repairs'},{txt:"Pichou est√°tua. CADEIA!",act:'jail'},{txt:"Festa de Anivers√°rio -$50",val:-50},{txt:"Condom√≠nio. -$100",val:-100},{txt:"Escola. -$150",val:-150},{txt:"Bateu no BRT. -$50",val:-50},{txt:"Doa√ß√£o. -$10",val:-10},{txt:"Assalto. -$100",val:-100},{txt:"Multa. -$15",val:-15},{txt:"Engarrafamento! Perca a vez.",act:'skip'},{txt:"Casamento. -$50",val:-50},{txt:"Taxa de Lixo. -$40",val:-40},{txt:"Lei Seca! CADEIA!",act:'jail'}];

let roomCode = null;
let myId = null;
let players = [];
let props = Array(40).fill(null);
let gameState = { turn: 0, status: 'lobby', lastAction: null };
let amIHost = false;

const SFX = { step: new Audio('https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3'), cash: new Audio('https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3'), slide: new Audio('https://assets.mixkit.co/active_storage/sfx/2572/2572-preview.mp3'), card: new Audio('https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3'), jail: new Audio('https://assets.mixkit.co/active_storage/sfx/1393/1393-preview.mp3'), bad: new Audio('https://assets.mixkit.co/active_storage/sfx/2955/2955-preview.mp3'), good: new Audio('https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3') };
const play = (k) => { try { SFX[k].volume = 0.5; SFX[k].currentTime = 0; SFX[k].play().catch(()=>{}); } catch(e){} };
const sleep = (ms) => new Promise(r => setTimeout(r, ms));

// --- FIREBASE LOGIC ---
const fb = {
    createRoom: () => {
        const name = document.getElementById('p-name').value.toUpperCase().trim();
        if(!name) return alert("Digite seu nome!");
        roomCode = Math.random().toString(36).substring(2,8).toUpperCase();
        myId = 0; amIHost = true;
        
        const initialData = {
            players: [{id: 0, name: name, icon: 'üëë', money: 1000, color: '#d32f2f', pos: 0, active: true, jailed: false, hasJailCard: false}],
            props: Array(40).fill(null),
            state: { turn: 0, status: 'lobby', rolled: false }
        };
        
        db.ref('rooms/' + roomCode).set(initialData).then(() => { fb.enterLobby(); });
    },
    screenJoin: () => {
        const name = document.getElementById('p-name').value.toUpperCase().trim();
        if(!name) return alert("Digite seu nome!");
        document.getElementById('screen-start').style.display='none';
        document.getElementById('screen-join').style.display='flex';
    },
    joinRoom: () => {
        const code = document.getElementById('join-code').value.toUpperCase().trim();
        const name = document.getElementById('p-name').value.toUpperCase().trim();
        if(!code) return;
        
        db.ref('rooms/' + code).get().then((snap) => {
            if(snap.exists()) {
                const data = snap.val();
                if(data.state.status !== 'lobby') return alert("Jogo j√° come√ßou!");
                
                const newId = data.players.length;
                const colors = ['#1976d2','#388e3c','#fbc02d'];
                const newPlayer = {id: newId, name: name, icon: 'üë§', money: 1000, color: colors[(newId-1)%3], pos: 0, active: true, jailed: false, hasJailCard: false};
                
                db.ref('rooms/' + code + '/players/' + newId).set(newPlayer);
                roomCode = code; myId = newId; amIHost = false;
                fb.enterLobby();
            } else alert("Sala n√£o encontrada!");
        });
    },
    enterLobby: () => {
        document.getElementById('screen-start').style.display='none';
        document.getElementById('screen-join').style.display='none';
        document.getElementById('screen-lobby').style.display='flex';
        document.getElementById('room-code-display').innerText = roomCode;
        if(!amIHost) { document.getElementById('host-controls').style.display='none'; document.getElementById('client-msg').style.display='block'; }
        
        db.ref('rooms/' + roomCode).on('value', (snap) => {
            if(!snap.exists()) return alert("Sala fechada.");
            const val = snap.val();
            players = val.players || [];
            props = val.props || Array(40).fill(null);
            gameState = val.state;
            
            // LOBBY UPDATE
            document.getElementById('lobby-list').innerHTML = players.map(p => `<div class="lobby-item">${p.name}</div>`).join('');
            
            // START GAME CHECK
            if(gameState.status === 'char_select') {
                if(document.getElementById('screen-char').style.display === 'none' && document.getElementById('game-layout').style.display === 'none') {
                    fb.screenChar();
                }
                // Host auto-triggers play if all set
                if(amIHost) {
                    const allReady = players.every(p => p.icon !== 'üë§' && p.icon !== 'üëë'); 
                    if(allReady) db.ref('rooms/' + roomCode + '/state').update({status: 'playing'});
                }
            }
            if(gameState.status === 'playing') {
                if(document.getElementById('game-layout').style.display === 'none') ui.initGame();
                ui.sync(); 
            }
            
            // TRADE
            if(val.tradeProposal && val.tradeProposal.to === myId && document.getElementById('trade-accept-modal').style.display === 'none') {
                game.showTradeProposal(val.tradeProposal);
            }
            if(!val.tradeProposal) document.getElementById('trade-accept-modal').style.display = 'none';
        });
    },
    copyCode: () => { navigator.clipboard.writeText(roomCode); alert("Copiado!"); },
    startGame: () => {
        if(players.length < 2) return alert("Precisa de 2 jogadores!");
        db.ref('rooms/' + roomCode + '/state').update({status: 'char_select', turn: 0});
    },
    screenChar: () => {
        document.getElementById('screen-lobby').style.display='none';
        document.getElementById('screen-char').style.display='flex';
        ui.renderCharSelect();
    },
    selectChar: (icon) => {
        players[myId].icon = icon;
        db.ref('rooms/' + roomCode + '/players/' + myId + '/icon').set(icon);
        // Change feedback
        document.getElementById('char-title').innerText = "AGUARDANDO OUTROS...";
    },
    update: (updates) => {
        document.getElementById('net-status').style.display='block';
        db.ref('rooms/' + roomCode).update(updates).then(() => document.getElementById('net-status').style.display='none');
    }
};

const ui = {
    renderCharSelect: () => {
        document.getElementById('char-grid').innerHTML = '';
        CHARS.forEach(c => {
            document.getElementById('char-grid').innerHTML += `<div class="char-opt" onclick="fb.selectChar('${c.i}'); this.style.background='#cfd8dc'"><div class="char-emoji">${c.i}</div></div>`;
        });
    },
    initGame: () => {
        document.getElementById('screen-char').style.display='none';
        document.getElementById('game-layout').classList.add('active');
        ui.buildBoard();
        setTimeout(resizeBoard, 100);
    },
    buildBoard: () => {
        const b = document.getElementById('board');
        BD.forEach((s,i) => {
            const d=document.createElement('div');d.className='space';d.id=`s${i}`;
            let r,c, rotClass;
            if(i<=10){ r=11; c=11-i; rotClass = 'rot-bottom'; } 
            else if(i<=20){ r=11-(i-10); c=1; rotClass = 'rot-left'; } 
            else if(i<=30){ r=1; c=1+(i-20); rotClass = 'rot-top'; } 
            else { r=1+(i-30); c=11; rotClass = 'rot-right'; }
            if(i===0 || i===10 || i===20 || i===30) rotClass = '';
            d.style.gridRow=r; d.style.gridColumn=c;
            const showPrice = (s.t==='pr' || s.t==='rr' || s.t==='ut') && s.p;
            let contentHTML = s.t==='pr' ? `<div class="space-content ${rotClass}"><div class="color-strip" style="background:${s.g}"></div><div class="sp-name">${s.n}</div><div class="sp-price">$${s.p}</div></div><div class="build-area" id="b${i}"></div>` : `<div class="space-content ${rotClass}"><div class="sp-icon">${s.i}</div><div class="sp-name" style="font-size:0.6rem">${s.n}</div>${showPrice ? `<div class="sp-price">$${s.p}</div>` : ''}</div>`;
            d.innerHTML = contentHTML;
            b.appendChild(d);
        });
        for(let i=0; i<4; i++){ const t=document.createElement('div');t.className='token';t.id=`tok${i}`; b.appendChild(t); }
    },
    sync: () => {
        // TOKENS
        players.forEach((p,i) => {
            const t = document.getElementById(`tok${i}`);
            if(!t) return;
            t.style.display = p.active ? 'block' : 'none';
            t.innerHTML = p.icon;
            const s = document.getElementById(`s${p.pos}`);
            if(s) { t.style.left = (s.offsetLeft + 12) + 'px'; t.style.top = (s.offsetTop + 12) + 'px'; }
        });

        // PROPS
        props.forEach((pr,i) => {
            const sp = document.getElementById(`s${i}`);
            const el = document.getElementById(`b${i}`);
            if(pr) { 
                sp.classList.add('owned'); sp.style.borderColor = players[pr.owner].color; 
                if(el) el.innerHTML = pr.level===5 ? '<div class="hotel-3d"></div>' : Array(pr.level).fill('<div class="house-3d"></div>').join('');
            }
        });

        // HUD
        const currentP = players[gameState.turn];
        document.getElementById('turn-display').innerText = `VEZ DE: ${currentP.name}`;
        document.getElementById('turn-display').style.background = currentP.color;
        
        const myP = players[myId];
        document.getElementById('p-money').innerText = `$${myP.money}`;
        
        // CONTROLS
        const isMyTurn = (myId === gameState.turn);
        const btns = document.querySelectorAll('.btn-game');
        btns.forEach(b => b.disabled = true);
        
        document.getElementById('normal-btns').style.display = 'grid';
        document.getElementById('jail-btns').style.display = 'none';
        document.getElementById('b-card').style.display = 'none';

        if(isMyTurn) {
            if(myP.jailed) {
                document.getElementById('normal-btns').style.display='none';
                document.getElementById('jail-btns').style.display='flex';
                if(!gameState.rolled) {
                    document.querySelector('#jail-btns .btn-roll').disabled = false;
                    document.querySelector('#jail-btns .btn-buy').disabled = false;
                } else {
                    document.getElementById('jail-btns').style.display='none';
                    document.getElementById('normal-btns').style.display='grid';
                    document.getElementById('b-pass').disabled = false;
                }
            } else if (gameState.pendingCardType) {
                document.getElementById('normal-btns').style.display='none';
                document.getElementById('b-card').style.display='block';
                document.getElementById('b-card').disabled=false;
            } else {
                if(!gameState.rolled) document.getElementById('b-roll').disabled=false;
                else document.getElementById('b-pass').disabled=false;
                
                if(gameState.rolled && !props[myP.pos] && BD[myP.pos].p && myP.money >= BD[myP.pos].p) {
                    document.getElementById('b-buy').disabled = false;
                }
                if(!gameState.rolled) document.getElementById('b-trade').disabled = false;
            }
        }
        
        // INV LIST
        let html = '';
        props.forEach((pr,i)=>{
            if(pr && pr.owner === myId) html += `<div class="prop-item" onclick="ui.openProp(${i})"><span>${BD[i].n}</span><span>${pr.level>0?'üè†'+pr.level:''}</span></div>`;
        });
        document.getElementById('inv-list').innerHTML = html;
        document.getElementById('desktop-props-container').innerHTML = html;
    },
    openProp: (idx) => {
        const s = BD[idx]; const pr = props[idx];
        document.getElementById('pc-name').innerText=s.n;
        document.getElementById('pc-price').innerText=`$${s.p}`;
        
        document.getElementById('act-buy').style.display = 'none';
        document.getElementById('act-manage').style.display = 'none';
        
        if(!pr && myId === gameState.turn && gameState.rolled && players[myId].pos === idx) document.getElementById('act-buy').style.display='block';
        if(pr && pr.owner === myId) document.getElementById('act-manage').style.display='block';
        
        document.getElementById('prop-card').style.display='block';
        document.getElementById('overlay-bg').style.display='block';
    },
    toggleInv: () => { document.getElementById('inv-modal').style.display = 'flex'; },
    closeCard: () => { document.getElementById('prop-card').style.display='none'; document.getElementById('overlay-bg').style.display='none'; },
    closeEvent: () => { document.getElementById('card-event').style.display='none'; game.applyCard(); }
};

const game = {
    roll: () => {
        const d1 = Math.ceil(Math.random()*6);
        const d2 = Math.ceil(Math.random()*6);
        ui.dice(d1,d2); // Local Visual Only
        
        const p = players[myId];
        let steps = d1+d2;
        
        if(p.jailed) {
            p.jailTurns++;
            if(d1===d2 || p.jailTurns > 3) { p.jailed=false; p.jailTurns=0; p.pos = (p.pos + steps)%40; }
        } else {
            p.pos = (p.pos + steps) % 40;
            if(p.pos < steps && p.active) p.money += 200; 
        }
        
        fb.update({
            [`players/${myId}`]: p,
            'state/rolled': true
        });
    },
    buy: () => { ui.openProp(players[myId].pos); },
    confirmBuy: () => {
        const p = players[myId];
        const idx = p.pos;
        if(p.money >= BD[idx].p) {
            p.money -= BD[idx].p;
            props[idx] = {owner: myId, level: 0, loan: null};
            fb.update({
                [`players/${myId}/money`]: p.money,
                [`props/${idx}`]: props[idx]
            });
            ui.closeCard();
        }
    },
    pass: () => {
        let next = (gameState.turn + 1) % players.length;
        fb.update({
            'state/turn': next,
            'state/rolled': false,
            'state/pendingCardType': null
        });
    },
    clickDeck: (type) => { 
        if(gameState.pendingCardType === type) game.forceDrawCard();
    },
    forceDrawCard: () => {
        const type = gameState.pendingCardType; 
        const deck = type === 'ch' ? CARDS_SORTE : CARDS_REVES;
        const c = deck[Math.floor(Math.random()*deck.length)];
        document.getElementById('ev-title').innerText = type==='ch'?'SORTE':'REV√âS';
        document.getElementById('ev-desc').innerText = c.txt;
        document.getElementById('card-event').style.display='flex';
        game.currentCard = c;
    },
    applyCard: () => {
        const c = game.currentCard;
        const p = players[myId];
        if(c.val) p.money += c.val;
        if(c.act === 'jail') { p.jailed=true; p.pos=10; }
        if(c.act === 'move') { p.pos=0; p.money+=200; }
        fb.update({
            [`players/${myId}`]: p,
            'state/pendingCardType': null
        });
    },
    openTrade: () => {
        const sel = document.getElementById('trade-partner');
        sel.innerHTML = players.map((p,i)=>(i!==myId)?`<option value="${i}">${p.name}</option>`:'').join('');
        document.getElementById('trade-modal').style.display='flex';
        game.updateTradeUI();
    },
    updateTradeUI: () => {
        const targetId = parseInt(document.getElementById('trade-partner').value);
        document.getElementById('trade-list-give').innerHTML = props.map((pr,i)=> pr&&pr.owner===myId ? `<label><input type='checkbox' class='chk-give' value='${i}'> ${BD[i].n}</label>` : '').join('');
        document.getElementById('trade-list-get').innerHTML = props.map((pr,i)=> pr&&pr.owner===targetId ? `<label><input type='radio' name='rad-get' value='${i}'> ${BD[i].n}</label>` : '').join('');
    },
    sendOffer: () => {
        const target = parseInt(document.getElementById('trade-partner').value);
        const giveMoney = parseInt(document.getElementById('trade-money-give').value) || 0;
        const gives = Array.from(document.querySelectorAll('.chk-give:checked')).map(c=>parseInt(c.value));
        const get = document.querySelector('input[name="rad-get"]:checked') ? parseInt(document.querySelector('input[name="rad-get"]:checked').value) : null;
        
        fb.update({
            tradeProposal: { from: myId, to: target, money: giveMoney, gives: gives, get: get }
        });
        document.getElementById('trade-modal').style.display='none';
    },
    showTradeProposal: (prop) => {
        document.getElementById('trade-desc').innerText = `${players[prop.from].name} oferece $${prop.money} + ${prop.gives.length} im√≥veis por ${prop.get ? BD[prop.get].n : 'nada'}.`;
        document.getElementById('trade-accept-modal').style.display='flex';
    },
    resolveTrade: (accepted) => {
        document.getElementById('trade-accept-modal').style.display='none';
        if(accepted) {
            db.ref('rooms/' + roomCode + '/tradeProposal').get().then(snap => {
                const p = snap.val();
                if(!p) return;
                fb.update({tradeProposal: null});
                // Actual trade logic happens here? No, must execute.
                // Re-fetch players to ensure no sync issue
                const p1 = players[p.from];
                const p2 = players[p.to];
                p1.money -= p.money; p2.money += p.money;
                if(p.gives) p.gives.forEach(i => props[i].owner = p.to);
                if(p.get !== undefined && p.get !== null) props[p.get].owner = p.from;
                
                fb.update({
                    [`players/${p.from}`]: p1,
                    [`players/${p.to}`]: p2,
                    props: props
                });
            });
        } else {
            fb.update({tradeProposal: null});
        }
    },
    payJail: () => {
        const p = players[myId];
        if(p.money >= 50) { p.money-=50; p.jailed=false; fb.update({[`players/${myId}`]: p}); }
    },
    mortgage: () => { /* Simplified */ },
    build: () => { /* Simplified */ }
};

function resizeBoard() {
    const el = document.getElementById('board-container');
    const area = document.getElementById('board-area');
    if(!el || !area) return;
    const isMobile = window.innerWidth < 900;
    if (isMobile) {
        const scale = Math.min(window.innerWidth / 900, (window.innerHeight - 100) / 1050) * 0.98;
        el.style.transform = `scale(${scale})`;
    } else {
        const scale = Math.min(area.offsetWidth / 1300, area.offsetHeight / 1000) * 0.95;
        el.style.transform = `scale(${scale})`;
    }
}
window.addEventListener('resize', resizeBoard);
const ui_dice = { dice: (d1, d2) => {
    const ds = document.getElementById('dice-visual'); ds.classList.add('active');
    const c1=document.getElementById('d1'), c2=document.getElementById('d2');
    c1.className='cube shake'; c2.className='cube shake';
    setTimeout(()=>{ c1.className='cube'; c2.className='cube'; void c1.offsetWidth; c1.innerText=d1; c2.innerText=d2; }, 1000);
    setTimeout(()=>{ ds.classList.remove('active'); }, 2000);
}};
ui.dice = ui_dice.dice;
</script>
</body>
</html>
