<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Recife Imobili√°rio: V80 (Reboot)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Titan+One&family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root { --c-blue: #0277bd; --c-red: #d32f2f; --c-green: #2e7d32; --c-yel: #fbc02d; --c-dark: #263238; --bg-grad: linear-gradient(135deg, #1e88e5, #fdd835, #e53935); }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body { 
            margin: 0; padding: 0; font-family: 'Nunito', sans-serif; 
            background: var(--bg-grad); background-size: 400% 400%; animation: bgAnim 15s infinite;
            height: 100dvh; width: 100vw; overflow: hidden; display: flex; flex-direction: column;
        }
        @keyframes bgAnim { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
        
        h1, h2, button { font-family: 'Titan One', cursive; text-transform: uppercase; }

        /* --- TELAS (LOBBY/START) --- */
        .screen { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .hidden { display: none !important; }
        
        .card-box { background: #fff; padding: 25px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; border: 6px solid var(--c-dark); box-shadow: 0 15px 0 rgba(0,0,0,0.2); }
        input, select { width: 100%; padding: 15px; margin: 10px 0; border: 3px solid #000; border-radius: 10px; font-size: 1.1rem; font-weight: bold; font-family: 'Nunito'; }
        
        .btn { width: 100%; padding: 15px; font-size: 1.2rem; border: none; border-radius: 50px; cursor: pointer; margin-top: 10px; color: #fff; box-shadow: 0 5px 0 rgba(0,0,0,0.3); transition: transform 0.1s; }
        .btn:active { transform: translateY(4px); box-shadow: none; }
        .btn-green { background: var(--c-green); }
        .btn-blue { background: var(--c-blue); }
        .btn-red { background: var(--c-red); }
        .btn-yel { background: var(--c-yel); color: #000; }
        
        .char-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 15px 0; max-height: 200px; overflow-y: auto; }
        .char-item { font-size: 2rem; background: #eee; border-radius: 10px; cursor: pointer; border: 2px solid transparent; padding: 5px; }
        .char-item.selected { background: #c8e6c9; border-color: var(--c-green); }
        .char-item.taken { opacity: 0.3; pointer-events: none; }

        /* --- LAYOUT DO JOGO (CSS PURO) --- */
        #game-ui { display: flex; flex-direction: column; width: 100%; height: 100%; }
        
        /* √ÅREA DO TABULEIRO: Quadrado Perfeito Responsivo */
        #board-wrapper {
            flex: 1; position: relative; overflow: hidden;
            display: flex; align-items: center; justify-content: center;
            padding: 10px;
        }
        #board-container {
            /* O segredo: 95% do menor lado da tela */
            width: 95vmin; height: 95vmin; 
            max-width: 800px; max-height: 800px;
            position: relative;
            background: #c5e1a5; border: 4px solid #000;
            display: grid; grid-template-columns: repeat(11, 1fr); grid-template-rows: repeat(11, 1fr);
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }

        /* CELULAS DO TABULEIRO */
        .cell { border: 1px solid #333; position: relative; display: flex; flex-direction: column; font-size: 0.55rem; font-weight: 800; text-align: center; background: #fff; overflow: hidden; cursor: pointer; }
        .cell-top { grid-row: 1; } .cell-bottom { grid-row: 11; }
        .cell-left { grid-column: 1; } .cell-right { grid-column: 11; }
        /* Centro vazio */
        .cell-center { grid-column: 2/11; grid-row: 2/11; background: transparent; border: none; display: flex; justify-content: center; align-items: center; pointer-events: none; }
        
        .color-bar { height: 20%; width: 100%; border-bottom: 1px solid #000; }
        .cell-name { flex: 1; display: flex; align-items: center; justify-content: center; line-height: 1; padding: 1px; }
        .cell-price { padding-bottom: 2px; }
        .cell.owned { border: 3px solid !important; z-index: 2; }

        /* PE√áAS */
        .p-token { position: absolute; width: 80%; height: 80%; z-index: 10; font-size: 2.5vmin; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; pointer-events: none; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .house-dot { width: 8px; height: 8px; background: var(--c-green); border: 1px solid #000; display: inline-block; }
        .hotel-dot { width: 12px; height: 12px; background: var(--c-red); border: 1px solid #000; display: inline-block; }
        .build-slots { position: absolute; top: 0; left: 0; width: 100%; display: flex; justify-content: center; z-index: 5; }

        /* HUD CONTROLS */
        #controls { background: #fff; padding: 10px; border-top: 4px solid #000; display: flex; flex-direction: column; gap: 8px; z-index: 20; }
        .hud-row { display: flex; gap: 10px; }
        .info-bar { display: flex; justify-content: space-between; align-items: center; background: #eee; padding: 8px; border-radius: 8px; font-weight: bold; }
        .turn-badge { background: #333; color: #fff; padding: 4px 10px; border-radius: 4px; font-size: 0.8rem; }
        
        /* DESKTOP MODIFIER */
        @media (min-width: 900px) {
            #game-ui { flex-direction: row; }
            #controls { width: 350px; border-top: none; border-left: 4px solid #000; padding: 20px; height: 100%; }
            #board-wrapper { height: 100vh; }
            .btn { padding: 20px; font-size: 1.3rem; }
        }

        /* MODALS & POPUPS */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 9000; display: none; align-items: center; justify-content: center; }
        .modal-box { background: #fff; width: 90%; max-width: 400px; padding: 20px; border-radius: 15px; border: 4px solid #000; text-align: center; animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popUp { from{transform:scale(0)} to{transform:scale(1)} }
        
        .prop-detail-header { background: var(--c-blue); color: #fff; padding: 15px; margin: -20px -20px 15px -20px; border-radius: 10px 10px 0 0; }
        .rent-tbl { width: 100%; font-size: 0.9rem; margin-bottom: 15px; }
        .rent-tbl td { border-bottom: 1px dashed #ccc; padding: 4px; }
        
        /* FX */
        .dice-anim { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); display: flex; gap: 20px; z-index: 8500; pointer-events: none; display: none; }
        .dice-box { width: 80px; height: 80px; background: #fff; border: 4px solid #000; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 3rem; font-weight: bold; }
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #fff; border: 3px solid var(--c-yel); padding: 10px 20px; border-radius: 30px; font-weight: bold; z-index: 10000; animation: fadeDown 3s forwards; }
        @keyframes fadeDown { 0%{opacity:0;transform:translate(-50%,-20px)} 10%{opacity:1;transform:translate(-50%,0)} 90%{opacity:1} 100%{opacity:0} }

        /* BOTOES DESABILITADOS */
        .btn:disabled { background: #ccc !important; color: #777 !important; cursor: not-allowed; transform: none !important; opacity: 0.6; }
    </style>
</head>
<body>

    <div id="screen-start" class="screen">
        <div class="card-box">
            <h1 style="color:var(--c-blue); margin:0; line-height:1;">RECIFE<br>IMOBILI√ÅRIO<br><span style="font-size:1rem; color:#000;">V80 REBOOT</span></h1>
            <br>
            <input type="text" id="inp-nick" placeholder="Seu Apelido" maxlength="10">
            <button class="btn btn-green" onclick="App.createRoom()">CRIAR SALA</button>
            <hr style="margin:15px 0; border:1px dashed #ccc;">
            <input type="text" id="inp-code" placeholder="C√ìDIGO DA SALA" style="text-transform:uppercase;">
            <button class="btn btn-blue" onclick="App.joinRoom()">ENTRAR</button>
        </div>
    </div>

    <div id="screen-lobby" class="screen hidden">
        <div class="card-box">
            <h2>SALA: <span id="lbl-code" style="color:var(--c-red)"></span></h2>
            <div id="lobby-players" style="text-align:left; background:#eee; padding:10px; border-radius:10px; margin-bottom:10px;"></div>
            <label>ESCOLHA SEU PERSONAGEM:</label>
            <div class="char-grid" id="char-grid"></div>
            <div id="host-panel" class="hidden">
                <button class="btn btn-green" onclick="App.startGame()">INICIAR JOGO</button>
            </div>
            <div id="guest-msg" class="hidden" style="color:#666; font-size:0.8rem;">Aguardando dono da sala...</div>
        </div>
    </div>

    <div id="game-ui" class="hidden">
        <div id="board-wrapper">
            <div id="board-container">
                </div>
        </div>
        
        <div id="controls">
            <div class="info-bar">
                <div id="turn-badge" class="turn-badge">SUA VEZ</div>
                <div id="money-display" style="font-size:1.5rem; color:var(--c-green); font-family:'Titan One';">$1000</div>
            </div>
            
            <div class="hud-row">
                <button id="btn-roll" class="btn btn-yel" onclick="Game.roll()">üé≤ ROLAR</button>
                <button id="btn-buy" class="btn btn-green" onclick="Game.buyProp()" disabled>COMPRAR</button>
            </div>
            <div class="hud-row">
                <button id="btn-trade" class="btn btn-blue" onclick="UI.showTrade()">NEGOCIAR</button>
                <button id="btn-pass" class="btn btn-red" onclick="Game.pass()" disabled>PASSAR</button>
            </div>
            <div style="flex:1; overflow-y:auto; border-top:1px dashed #ccc; margin-top:10px; padding-top:5px;" id="props-list">
                </div>
        </div>
    </div>

    <div id="modal-prop" class="modal-overlay">
        <div class="modal-box">
            <div class="prop-detail-header" id="md-title">NOME DA RUA</div>
            <h1 id="md-price" style="color:var(--c-green); margin:10px 0;">$200</h1>
            <table class="rent-tbl" id="md-table"></table>
            <div id="md-actions-buy">
                <button class="btn btn-green" onclick="Game.confirmBuyModal()">COMPRAR AGORA</button>
                <button class="btn btn-red" onclick="UI.closeModal()">N√ÉO</button>
            </div>
            <div id="md-actions-own" class="hidden">
                <button class="btn btn-blue" onclick="Game.buildHouse()">CONSTRUIR ($<span id="md-cost"></span>)</button>
                <button class="btn btn-red" onclick="UI.closeModal()">FECHAR</button>
            </div>
        </div>
    </div>

    <div id="modal-card" class="modal-overlay">
        <div class="modal-box" style="border-color:var(--c-yel);">
            <h1 id="cd-type" style="color:var(--c-blue)">SORTE</h1>
            <p id="cd-txt" style="font-size:1.2rem; font-weight:bold; margin:20px 0;">Texto da carta...</p>
            <button class="btn btn-yel" onclick="UI.closeCard()">OK, ENTENDI</button>
        </div>
    </div>

    <div id="dice-anim" class="dice-anim">
        <div class="dice-box" id="d1">1</div>
        <div class="dice-box" id="d2">1</div>
    </div>

<script>
// --- 1. CONFIGURA√á√ÉO (FIREBASE) ---
const firebaseConfig = { apiKey: "AIzaSyBMRA5IwyPyv6YEqG2z4KT1e5jk7B1_Vwc", authDomain: "recifeimob-beb6c.firebaseapp.com", databaseURL: "https://recifeimob-beb6c-default-rtdb.firebaseio.com", projectId: "recifeimob-beb6c", storageBucket: "recifeimob-beb6c.firebasestorage.app", messagingSenderId: "1063704445620", appId: "1:1063704445620:web:a9ccc21171b9e3d16e4de1" };
if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// --- 2. DADOS EST√ÅTICOS ---
const CHARS=[{id:'rt',i:'üíÖ'},{id:'as',i:'üóø'},{id:'bt',i:'üõ∂'},{id:'c',i:'ü¶Ä'},{id:'s',i:'ü¶à'},{id:'u',i:'‚òÇÔ∏è'},{id:'pd',i:'üêÄ'},{id:'bb',i:'üåΩ'},{id:'gl',i:'üêî'},{id:'brt',i:'üöå'},{id:'bdr',i:'üç•'},{id:'lu',i:'üêª'},{id:'hmn',i:'üé©'},{id:'rp',i:'üöî'},{id:'srr',i:'üêö'},{id:'and',i:'üòé'}];
const BOARD_DATA=[
    {t:'st',n:'IN√çCIO'},{t:'pr',g:'#795548',n:'Coque',p:60,h:50,r:[2,10,30,90,160]},{t:'ch',n:'Sorte'},{t:'pr',g:'#795548',n:'Ibura',p:60,h:50,r:[4,20,60,180,320]},{t:'tx',n:'IPTU'},{t:'rr',n:'Est. Joana',p:200,r:[25,50,100,200]},{t:'pr',g:'#03a9f4',n:'Agamenon',p:100,h:50,r:[6,30,90,270,400]},{t:'rv',n:'Rev√©s'},{t:'pr',g:'#03a9f4',n:'Afogados',p:100,h:50,r:[6,30,90,270,400]},{t:'pr',g:'#03a9f4',n:'Mustardinha',p:120,h:50,r:[8,40,100,300,450]},
    {t:'jl',n:'CADEIA'},{t:'pr',g:'#e91e63',n:'Iputinga',p:140,h:100,r:[10,50,150,450,750]},{t:'ut',n:'Celpe',p:150},{t:'pr',g:'#e91e63',n:'Cordeiro',p:140,h:100,r:[10,50,150,450,750]},{t:'pr',g:'#e91e63',n:'V√°rzea',p:160,h:100,r:[12,60,180,500,900]},{t:'rr',n:'Est. Coq',p:200,r:[25,50,100,200]},{t:'pr',g:'#ff5722',n:'Rosarinho',p:180,h:100,r:[14,70,200,550,950]},{t:'ch',n:'Sorte'},{t:'pr',g:'#ff5722',n:'Encruzilhada',p:180,h:100,r:[14,70,200,550,950]},{t:'pr',g:'#ff5722',n:'Torre',p:200,h:100,r:[16,80,220,600,1000]},
    {t:'pk',n:'PARQUE'},{t:'pr',g:'#d32f2f',n:'Aflitos',p:220,h:150,r:[18,90,250,700,1050]},{t:'rv',n:'Rev√©s'},{t:'pr',g:'#d32f2f',n:'Espinheiro',p:220,h:150,r:[18,90,250,700,1050]},{t:'pr',g:'#d32f2f',n:'Madalena',p:240,h:150,r:[20,100,300,750,1100]},{t:'rr',n:'Est. Barro',p:200,r:[25,50,100,200]},{t:'pr',g:'#fbc02d',n:'Gra√ßas',p:260,h:150,r:[22,110,330,800,1150]},{t:'pr',g:'#fbc02d',n:'P. Panela',p:260,h:150,r:[22,110,330,800,1150]},{t:'ut',n:'Compesa',p:150},{t:'pr',g:'#fbc02d',n:'Casa Forte',p:280,h:150,r:[24,120,360,850,1200]},
    {t:'gj',n:'V√Å P/ CADEIA'},{t:'pr',g:'#388e3c',n:'Apipucos',p:300,h:200,r:[26,130,390,900,1275]},{t:'pr',g:'#388e3c',n:'Parnamirim',p:300,h:200,r:[26,130,390,900,1275]},{t:'ch',n:'Sorte'},{t:'pr',g:'#388e3c',n:'Paiva',p:320,h:200,r:[28,150,450,1000,1400]},{t:'rr',n:'Est. Afog',p:200,r:[25,50,100,200]},{t:'rv',n:'Rev√©s'},{t:'pr',g:'#1565c0',n:'Boa Viagem',p:350,h:200,r:[35,175,500,1100,1500]},{t:'tx',n:'Taxa'},{t:'pr',g:'#1565c0',n:'Pina',p:400,h:200,r:[50,200,600,1400,2000]}
];
const CARDS = [
    {t:'+200',v:200}, {t:'-50',v:-50}, {t:'V√° p/ Cadeia',a:'jail'}, {t:'Volte 3',a:'back'}, {t:'+100',v:100}, {t:'-100',v:-100}
];

// --- 3. ESTADO GLOBAL ---
let State = {
    room: null, me: null, pid: -1,
    players: [], props: Array(40).fill(null), turn: 0,
    animating: false, rolled: false,
    lastSig: '' // Assinatura para evitar repeti√ß√£o de anima√ß√£o
};

// --- 4. APP (LOBBY) ---
const App = {
    createRoom: () => {
        const n = document.getElementById('inp-nick').value.toUpperCase();
        if(!n) return alert('DIGITE UM NOME!');
        const code = Math.random().toString(36).substring(2,6).toUpperCase();
        State.room = code; State.me = n;
        db.ref('rooms/'+code).set({
            status: 'lobby',
            players: [{name:n, icon:''}]
        });
        App.waitLobby();
    },
    joinRoom: () => {
        const n = document.getElementById('inp-nick').value.toUpperCase();
        const c = document.getElementById('inp-code').value.toUpperCase();
        if(!n || !c) return alert('PREENCHA TUDO!');
        State.me = n; State.room = c;
        db.ref('rooms/'+c).get().then(s => {
            if(s.exists() && s.val().status === 'lobby') {
                const pl = s.val().players || [];
                if(pl.length>=4) return alert('SALA CHEIA');
                pl.push({name:n, icon:''});
                db.ref('rooms/'+c+'/players').set(pl);
                App.waitLobby();
            } else alert('SALA N√ÉO EXISTE');
        });
    },
    waitLobby: () => {
        document.getElementById('screen-start').classList.add('hidden');
        document.getElementById('screen-lobby').classList.remove('hidden');
        document.getElementById('lbl-code').innerText = State.room;
        
        // Render chars
        const g = document.getElementById('char-grid'); g.innerHTML='';
        CHARS.forEach(c => {
            const d = document.createElement('div'); d.className='char-item'; d.innerText=c.i; d.id=`ch-${c.i}`;
            d.onclick = () => { 
                db.ref(`rooms/${State.room}/players/${State.pid}/icon`).set(c.i);
            };
            g.appendChild(d);
        });

        // Listen Lobby
        db.ref('rooms/'+State.room).on('value', s => {
            const d = s.val(); if(!d) return;
            const pl = d.players || [];
            State.pid = pl.findIndex(p => p.name === State.me);
            
            // UI Update
            document.getElementById('lobby-players').innerHTML = pl.map(p => `<div>${p.icon||'?'} ${p.name}</div>`).join('');
            document.querySelectorAll('.char-item').forEach(e => e.classList.remove('taken','selected'));
            pl.forEach((p,i) => {
                if(p.icon) {
                    const el = document.getElementById(`ch-${p.icon}`);
                    if(el) {
                        if(i===State.pid) el.classList.add('selected');
                        else el.classList.add('taken');
                    }
                }
            });

            if(State.pid === 0) document.getElementById('host-panel').classList.remove('hidden');
            else document.getElementById('guest-msg').classList.remove('hidden');

            if(d.status === 'playing') App.startGame(d);
        });
    },
    startGame: () => {
        // Init Game State in DB
        db.ref('rooms/'+State.room).once('value', s => {
            const pl = s.val().players.map((p,i) => ({
                name: p.name, icon: p.icon, money: 1000, pos: 0, jailed: false, id: i, color: ['red','blue','green','yellow'][i]
            }));
            if(pl.some(p=>!p.icon)) return alert('TODOS PRECISAM DE PERSONAGEM');
            db.ref('rooms/'+State.room).update({
                status: 'playing',
                players: pl,
                props: Array(40).fill(null),
                turn: 0,
                lastEvent: {t:'start'}
            });
        });
    },
    startGame: (d) => { // Client side start
        document.getElementById('screen-lobby').classList.add('hidden');
        document.getElementById('game-ui').classList.remove('hidden');
        UI.initBoard();
        
        // GAME LISTENER PRINCIPAL
        db.ref('rooms/'+State.room).on('value', snap => {
            const val = snap.val();
            if(val.status !== 'playing') return;
            Game.sync(val);
        });
    }
};

// --- 5. L√ìGICA DO JOGO (ENGINE) ---
const Game = {
    sync: async (d) => {
        // Atualiza dados brutos
        State.players = d.players || [];
        State.props = d.props || Array(40).fill(null);
        
        // Verifica mudan√ßa de turno
        if(State.turn !== d.turn) {
            State.turn = d.turn;
            State.rolled = false; // Reset local
            State.animating = false; // Reset local
            UI.toast(`VEZ DE ${State.players[State.turn].name}`);
        }

        // Verifica Eventos Visuais (Anima√ß√£o)
        if(d.lastEvent && d.lastEvent.sig !== State.lastSig) {
            State.lastSig = d.lastEvent.sig;
            if(d.lastEvent.t === 'roll') {
                // Toca anima√ß√£o (para quem n√£o jogou)
                if(d.lastEvent.pid !== State.pid) {
                    await UI.animRoll(d.lastEvent.d1, d.lastEvent.d2);
                    await UI.animMove(d.lastEvent.pid, d.lastEvent.path);
                }
            }
        }

        // Atualiza UI final
        UI.render();
    },
    save: () => {
        // Salva estado atual no banco
        db.ref('rooms/'+State.room).update({
            players: State.players,
            props: State.props,
            turn: State.turn
        });
    },
    
    // --- A√á√ïES DO JOGADOR (S√ì EXECUTAM SE FOR MINHA VEZ) ---
    roll: async () => {
        if(State.turn !== State.pid || State.rolled || State.animating) return;
        
        State.animating = true; 
        UI.render(); // Bloqueia bot√µes visualmente

        const d1 = Math.ceil(Math.random()*6);
        const d2 = Math.ceil(Math.random()*6);
        const p = State.players[State.pid];
        
        let path = [];
        let curr = p.pos;
        
        // L√≥gica de Pris√£o simples
        if(p.jailed) {
            if(d1===d2) { p.jailed = false; UI.toast('LIVRE!'); }
            else { UI.toast('PRESO!'); State.rolled = true; State.animating = false; Game.sendRollEvent(d1,d2,[]); return; }
        }

        // Caminho
        for(let i=0; i<(d1+d2); i++) {
            curr = (curr+1)%40;
            path.push(curr);
        }
        
        // 1. Envia evento visual para os outros
        Game.sendRollEvent(d1, d2, path);

        // 2. Toca localmente
        await UI.animRoll(d1, d2);
        await UI.animMove(State.pid, path);

        // 3. Aplica L√≥gica de Chegada
        p.pos = path[path.length-1];
        Game.land(p);

        // 4. Libera estado local
        State.animating = false;
        State.rolled = true; 
        
        // 5. Salva estado
        Game.save();
        UI.render(); // Habilita bot√µes corretos
    },
    sendRollEvent: (d1, d2, path) => {
        db.ref('rooms/'+State.room).update({
            lastEvent: { t:'roll', d1, d2, path, pid:State.pid, sig:Date.now() }
        });
    },
    land: (p) => {
        const s = BOARD_DATA[p.pos];
        const pr = State.props[p.pos];
        
        if(p.pos === 0) { p.money += 200; UI.toast('IN√çCIO +$200'); }
        if(p.pos === 30) { p.pos = 10; p.jailed = true; UI.toast('CADEIA!'); State.rolled = true; return; }

        if(s.t === 'pr' || s.t === 'rr' || s.t === 'ut') {
            if(pr && pr.owner !== State.pid && !pr.loan) {
                // PAGAR ALUGUEL
                let rent = 50; 
                if(s.t==='pr') rent = s.r[pr.level];
                p.money -= rent;
                State.players[pr.owner].money += rent;
                UI.toast(`PAGOU $${rent} DE ALUGUEL`);
            } else if (!pr && p.money >= s.p) {
                // OP√á√ÉO DE COMPRA
                UI.showPropModal(p.pos);
            }
        } else if (s.t === 'ch' || s.t === 'rv') {
            const c = CARDS[Math.floor(Math.random()*CARDS.length)];
            UI.showCard(c);
            if(c.v) p.money += c.v;
            if(c.a === 'jail') { p.pos=10; p.jailed=true; }
            if(c.a === 'back') p.pos -= 3;
        } else if (s.t === 'tx') {
            p.money -= 200; UI.toast('IMPOSTO -$200');
        }
    },
    buyProp: () => {
        // Compra direta via bot√£o HUD (se fechou modal)
        const p = State.players[State.pid];
        const idx = p.pos;
        if(State.props[idx]) return;
        if(p.money >= BOARD_DATA[idx].p) {
            p.money -= BOARD_DATA[idx].p;
            State.props[idx] = { owner: State.pid, level: 0, loan: false };
            UI.toast('COMPRADO!');
            Game.save();
            UI.render(); // Garante atualiza√ß√£o dos bot√µes
        }
    },
    confirmBuyModal: () => {
        Game.buyProp();
        UI.closeModal();
    },
    buildHouse: () => {
        const p = State.players[State.pid];
        const idx = p.pos;
        const s = BOARD_DATA[idx];
        // Valida√ß√£o Simples de Cor: Verifica se eu tenho todas da cor
        const group = BOARD_DATA.map((b,i)=>b.g===s.g?i:-1).filter(i=>i!==-1);
        const monopoly = group.every(i => State.props[i] && State.props[i].owner === State.pid);
        
        if(!monopoly) return alert('PRECISA DO GRUPO INTEIRO!');
        if(p.money >= s.h) {
            p.money -= s.h;
            State.props[idx].level++;
            Game.save();
            UI.closeModal();
            UI.toast('CONSTRU√çDO!');
        }
    },
    pass: () => {
        if(State.turn !== State.pid) return;
        // L√≥gica de Pr√≥ximo
        let next = (State.turn + 1) % State.players.length;
        // (Aqui poderia ter loop para pular falidos, mas vamos simplificar)
        
        // ATUALIZA√á√ÉO AT√îMICA
        db.ref('rooms/'+State.room).update({
            turn: next,
            players: State.players,
            props: State.props
        });
        // Reset local imediato para evitar clique duplo
        State.rolled = false; 
    }
};

// --- 6. UI RENDERER ---
const UI = {
    initBoard: () => {
        const b = document.getElementById('board-container');
        b.innerHTML = '<div class="cell cell-center"><h1 style="transform:rotate(-45deg); font-size:3rem; opacity:0.5;">RECIFE</h1></div>'; // Limpa e p√µe centro
        
        // Gera Casas
        BOARD_DATA.forEach((s,i) => {
            const d = document.createElement('div');
            d.className = 'cell';
            d.id = `cell-${i}`;
            
            // Grid Pos
            if(i<=10) { d.style.gridRow=11; d.style.gridColumn=11-i; } // Sul
            else if(i<=20) { d.style.gridRow=11-(i-10); d.style.gridColumn=1; } // Oeste
            else if(i<=30) { d.style.gridRow=1; d.style.gridColumn=1+(i-20); } // Norte
            else { d.style.gridRow=1+(i-30); d.style.gridColumn=11; } // Leste

            // Conte√∫do
            if(s.t === 'pr' || s.t === 'rr' || s.t === 'ut') {
                d.innerHTML = `
                    <div class="build-slots" id="build-${i}"></div>
                    <div class="color-strip" style="background:${s.g||'#333'}"></div>
                    <div class="cell-name">${s.n}</div>
                    <div class="cell-price">$${s.p}</div>
                `;
                d.onclick = () => UI.showPropModal(i, true); // True = view only
            } else {
                d.innerHTML = `<div class="cell-name" style="font-size:0.8rem">${s.n}</div>`;
            }
            b.appendChild(d);
        });

        // Gera Tokens
        State.players.forEach((p, i) => {
            const t = document.createElement('div');
            t.className = 'p-token';
            t.id = `tok-${i}`;
            t.innerText = p.icon || '‚ôüÔ∏è';
            b.appendChild(t);
        });
        
        UI.updatePositions();
    },
    render: () => {
        // 1. Atualiza Posi√ß√µes Visualmente
        UI.updatePositions();

        // 2. Atualiza HUD
        const me = State.players[State.pid];
        document.getElementById('money-display').innerText = `$${me.money}`;
        document.getElementById('turn-badge').innerText = (State.turn === State.pid) ? "SUA VEZ" : `VEZ DE ${State.players[State.turn].name}`;
        document.getElementById('turn-badge').style.background = (State.turn === State.pid) ? 'var(--c-green)' : '#333';

        // 3. Atualiza Bot√µes (L√≥gica Cr√≠tica)
        const isMyTurn = (State.turn === State.pid);
        const canRoll = isMyTurn && !State.rolled && !State.animating;
        const canBuy = isMyTurn && State.rolled && !State.animating && !State.props[me.pos] && BOARD_DATA[me.pos].p && me.money >= BOARD_DATA[me.pos].p;
        const canPass = isMyTurn && State.rolled && !State.animating;

        document.getElementById('btn-roll').disabled = !canRoll;
        document.getElementById('btn-buy').disabled = !canBuy;
        document.getElementById('btn-pass').disabled = !canPass;

        // 4. Atualiza Tabuleiro (Donos)
        State.props.forEach((pr, i) => {
            const el = document.getElementById(`cell-${i}`);
            const bl = document.getElementById(`build-${i}`);
            if(el) {
                if(pr) {
                    el.classList.add('owned');
                    el.style.borderColor = State.players[pr.owner].color || 'black';
                    if(bl) bl.innerHTML = Array(pr.level).fill('<div class="house-dot"></div>').join('');
                } else {
                    el.classList.remove('owned');
                    el.style.borderColor = '#333';
                    if(bl) bl.innerHTML = '';
                }
            }
        });
        
        // 5. Atualiza Lista
        document.getElementById('props-list').innerHTML = State.props.map((pr,i) => (pr && pr.owner === State.pid) ? `<div class="prop-item">${BOARD_DATA[i].n} ${pr.level>0?'('+pr.level+'üè†)':''}</div>` : '').join('');
    },
    updatePositions: () => {
        State.players.forEach((p, idx) => {
            const el = document.getElementById(`tok-${idx}`);
            const cell = document.getElementById(`cell-${p.pos}`);
            if(el && cell) {
                // C√°lculo simples de centro
                const rect = cell.getBoundingClientRect();
                const parent = document.getElementById('board-container').getBoundingClientRect();
                // Offset manual para n√£o sobrepor totalmente
                const offX = (idx%2)*5; const offY = (idx > 1)*5;
                el.style.left = (cell.offsetLeft + 10 + offX) + 'px';
                el.style.top = (cell.offsetTop + 10 + offY) + 'px';
            }
        });
    },
    animRoll: async (d1, d2) => {
        const el = document.getElementById('dice-anim');
        el.style.display = 'flex';
        // Shake
        for(let i=0; i<10; i++) {
            document.getElementById('d1').innerText = Math.ceil(Math.random()*6);
            document.getElementById('d2').innerText = Math.ceil(Math.random()*6);
            await sleep(100);
        }
        document.getElementById('d1').innerText = d1;
        document.getElementById('d2').innerText = d2;
        await sleep(800);
        el.style.display = 'none';
    },
    animMove: async (pid, path) => {
        // Movimento passo a passo visual apenas
        const el = document.getElementById(`tok-${pid}`);
        // Salva pos real temporariamente para n√£o quebrar sync
        const realPos = State.players[pid].pos; 
        
        for(let pos of path) {
            // Atualiza visualmente local
            State.players[pid].pos = pos;
            UI.updatePositions();
            await sleep(200);
        }
    },
    showPropModal: (idx, viewOnly=false) => {
        const s = BOARD_DATA[idx];
        const pr = State.props[idx];
        document.getElementById('md-title').innerText = s.n;
        document.getElementById('md-price').innerText = `$${s.p}`;
        
        // Tabela Aluguel
        let h = '';
        if(s.r) s.r.forEach((v,k)=> h+=`<tr><td>${k===0?'Aluguel':k+' Casas'}</td><td>$${v}</td></tr>`);
        document.getElementById('md-table').innerHTML = h;

        // Bot√µes
        const isMyTurn = State.turn === State.pid && State.rolled && !State.animating;
        const canBuy = !viewOnly && !pr && isMyTurn && State.players[State.pid].money >= s.p;
        const isMine = pr && pr.owner === State.pid;

        document.getElementById('md-actions-buy').style.display = canBuy ? 'block' : 'none';
        document.getElementById('md-actions-own').style.display = isMine ? 'block' : 'none';
        
        if(isMine) {
            document.getElementById('md-cost').innerText = s.h || '0';
        }

        document.getElementById('modal-prop').style.display='flex';
    },
    closeModal: () => {
        document.getElementById('modal-prop').style.display='none';
    },
    showCard: (c) => {
        document.getElementById('cd-txt').innerText = c.t;
        document.getElementById('modal-card').style.display='flex';
    },
    closeCard: () => { document.getElementById('modal-card').style.display='none'; },
    toast: (msg) => {
        const d = document.createElement('div'); d.className='toast'; d.innerText=msg;
        document.body.appendChild(d); setTimeout(()=>d.remove(), 2500);
    }
};

window.onload = () => {
    // Force CSS render
    UI.updatePositions();
};
</script>
</body>
</html>
