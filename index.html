<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Recife Imobili√°rio: V19 Final</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rye&family=Poppins:wght@400;600;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-grad: radial-gradient(circle at center, #29b6f6, #01579b);
            --wood: #4e342e; --paper: #fff8e1; --gold: #ffca28;
            --frevo-blue: #0277bd; --frevo-red: #c62828; --frevo-green: #2e7d32;
            --shadow-3d: 0 20px 50px rgba(0,0,0,0.6);
        }
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Poppins', sans-serif; background: var(--bg-grad); height: 100vh; overflow: hidden; display: flex; flex-direction: column; perspective: 1000px; transition: filter 2s; }
        h1, h2, h3, button, .brand { font-family: 'Rye', serif; letter-spacing: 1px; text-shadow: 2px 2px 0 rgba(0,0,0,0.3); }

        /* AMBIENTE */
        #rain-canvas { position: fixed; inset: 0; pointer-events: none; z-index: 8000; display: none; }
        .night-mode { filter: brightness(0.6) contrast(1.3); } 
        .night-mode .space { box-shadow: inset 0 0 30px #fbc02d; border-color: #fff; }

        /* --- UI: LOBBY --- */
        #screen-lobby, #screen-char { 
            position: fixed; inset: 0; z-index: 9000; 
            background: url('https://www.transparenttextures.com/patterns/cubes.png'), var(--bg-grad);
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
        }
        .card-menu { 
            background: var(--paper); width: 90%; max-width: 480px; padding: 30px; 
            border: 8px solid var(--wood); border-radius: 15px; text-align: center; 
            box-shadow: var(--shadow-3d); position: relative; animation: popIn 0.5s;
        }
        .input-box { 
            width: 100%; padding: 15px; margin: 10px 0; border: 3px solid var(--wood); 
            font-family: 'Rye'; font-size: 1.2rem; text-align: center; border-radius: 8px; background: #fff;
        }
        .btn-main { 
            width: 100%; padding: 15px; margin-top: 10px; border: none; border-radius: 50px; 
            font-size: 1.2rem; font-weight: 900; text-transform: uppercase; cursor: pointer; 
            box-shadow: 0 6px 0 rgba(0,0,0,0.3); color: white; font-family: 'Rye'; transition: 0.1s; 
        }
        .btn-main:active { transform: translateY(4px); box-shadow: none; }
        
        .bg-b { background: var(--frevo-blue); } .bg-g { background: var(--frevo-green); } .bg-r { background: var(--frevo-red); }

        /* CHARACTERS */
        .char-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 20px 0; }
        .char-opt { 
            background: rgba(255,255,255,0.2); border: 2px solid #fff; border-radius: 10px; padding: 10px; 
            cursor: pointer; transition: 0.3s; text-align: center; position: relative; 
        }
        .char-opt:hover { transform: scale(1.1); background: rgba(255,255,255,0.4); }
        .char-opt.taken { opacity: 0.4; filter: grayscale(1); cursor: not-allowed; transform: none; }
        .char-opt.selected { background: var(--gold); border-color: var(--wood); transform: scale(1.15); color: black; box-shadow: 0 0 15px var(--gold); }
        .char-icon { font-size: 2.5rem; }

        /* --- JOGO --- */
        #game-layout { display: flex; width: 100%; height: 100%; opacity: 0; transition: 1s; pointer-events: none; }
        #game-layout.active { opacity: 1; pointer-events: all; }

        #board-viewport { 
            flex: 1; perspective: 1800px; display: flex; align-items: center; justify-content: center; 
            background: transparent; overflow: hidden; 
        }
        #board { 
            display: grid; grid-template-columns: repeat(11, 85px); grid-template-rows: repeat(11, 85px); 
            background: #f5f5f5; border: 20px solid var(--wood); border-radius: 12px; position: relative; 
            transform-style: preserve-3d; transition: transform 1.2s cubic-bezier(0.2, 0.8, 0.2, 1); 
            box-shadow: var(--shadow-3d); background-image: url('https://www.transparenttextures.com/patterns/white-brick-wall.png'); 
        }
        
        @media (min-width: 900px) { #board { transform: rotateX(30deg) scale(0.9); } }
        @media (max-width: 899px) { #game-layout { flex-direction: column; } #sidebar { order: 2; height: auto; border-top: 8px solid var(--wood); width: 100%; border-left: none; } #board { transform: scale(0.55); margin-bottom: 20px; } }

        /* C√âLULAS */
        .space { 
            border: 1px solid rgba(0,0,0,0.1); background: rgba(255,255,255,0.92); 
            font-size: 0.6rem; text-align: center; position: relative; font-weight: bold; 
            display: flex; flex-direction: column; transition: 0.3s; backface-visibility: hidden; 
        }
        .space:hover { transform: translateZ(15px); z-index: 100; border: 2px solid var(--gold); box-shadow: 0 10px 20px rgba(0,0,0,0.4); }
        .color-bar { height: 25%; border-bottom: 2px solid #333; position: relative; }
        .mortgaged { filter: grayscale(1) opacity(0.6); background: #ccc; }
        .mortgaged::after { content:'HIPOTECADO'; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%) rotate(-45deg); color:red; border:2px solid red; padding:2px; font-size:0.6rem; background: rgba(255,255,255,0.8); }

        /* CONSTRU√á√ïES 3D (CUBOS REAIS) */
        .build-area { position: absolute; top: -8px; left: 0; width: 100%; display: flex; justify-content: center; gap: 2px; transform-style: preserve-3d; }
        .house-3d, .hotel-3d { position: relative; transform-style: preserve-3d; transform: rotateX(-20deg); }
        .house-3d { width: 12px; height: 12px; background: var(--frevo-green); border: 1px solid #1b5e20; box-shadow: 2px 2px 5px rgba(0,0,0,0.5); }
        .hotel-3d { width: 16px; height: 16px; background: var(--frevo-red); border: 1px solid #b71c1c; box-shadow: 2px 2px 5px rgba(0,0,0,0.5); }

        /* CENTRO */
        .center-hub { grid-column: 2/11; grid-row: 2/11; background: #e1f5fe; border: 5px solid var(--wood); display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; overflow: hidden; box-shadow: inset 0 0 50px rgba(0,0,0,0.1); }
        .umbrella-spin { position: absolute; width: 200%; height: 200%; opacity: 0.15; background: conic-gradient(red 0deg 45deg, green 45deg 90deg, yellow 90deg 135deg, blue 135deg 180deg, red 180deg 225deg, green 225deg 270deg, yellow 270deg 315deg, blue 315deg 360deg); animation: spin 25s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* TOKEN */
        .token { width: 50px; height: 50px; position: absolute; z-index: 50; font-size: 2.5rem; text-align: center; line-height: 50px; filter: drop-shadow(0 8px 4px rgba(0,0,0,0.6)); transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform-origin: bottom center; }
        .jump { animation: jump 0.5s; } @keyframes jump { 50% { transform: translateY(-50px) scale(1.2); } }

        /* SIDEBAR HUD */
        #sidebar { width: 360px; background: rgba(255,255,255,0.95); padding: 15px; display: flex; flex-direction: column; z-index: 100; border-left: 8px solid var(--wood); box-shadow: -10px 0 30px rgba(0,0,0,0.4); backdrop-filter: blur(10px); }
        .hud-top { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px dashed #888; padding-bottom: 10px; margin-bottom: 10px; }
        .cash { font-size: 1.6rem; color: var(--frevo-green); font-weight: 900; text-shadow: 1px 1px 0 #fff; }
        .turn-badge { background: #333; color: var(--gold); padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 0.9rem; margin-bottom: 15px; text-align: center; border: 2px solid var(--gold); }

        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        .btn-act { padding: 12px; border: 3px solid #000; border-radius: 8px; font-weight: bold; cursor: pointer; opacity: 0.5; pointer-events: none; transition: 0.2s; text-transform: uppercase; font-size: 0.85rem; background: #eee; color: #555; }
        .btn-act.on { opacity: 1; pointer-events: all; transform: translateY(-3px); box-shadow: 0 4px 0 rgba(0,0,0,0.3); color: #fff; border-color: rgba(0,0,0,0.5); }
        .btn-act.on:active { transform: translateY(0); box-shadow: none; }

        .player-row { background: #fff; padding: 6px 10px; margin-bottom: 5px; border-radius: 6px; border-left: 5px solid #ccc; display: flex; justify-content: space-between; align-items: center; font-weight: 600; font-size: 0.9rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .player-row.active { background: #fff9c4; border-color: var(--gold); transform: scale(1.02); }

        #deed-scroll { flex: 1; overflow-y: auto; background: #fff8e1; border: 2px solid var(--wood); padding: 5px; border-radius: 5px; }
        .deed-item { font-size: 0.8rem; border-bottom: 1px dashed #aaa; padding: 5px; display: flex; justify-content: space-between; align-items: center; background: #fff; margin-bottom: 2px; border-radius: 3px; cursor: pointer; }
        .deed-item:hover { background: #f0f0f0; }
        .build-btn { background: var(--frevo-green); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.7rem; padding: 4px 8px; font-weight: bold; }

        /* OVERLAYS */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 5000; display: none; justify-content: center; align-items: center; flex-direction: column; backdrop-filter: blur(5px); }
        .modal-box { background: #fff; padding: 25px; border-radius: 15px; border: 5px solid var(--gold); text-align: center; width: 90%; max-width: 400px; animation: popIn 0.3s; position: relative; box-shadow: 0 0 50px rgba(255, 215, 0, 0.3); }
        
        #dice-view { pointer-events: none; background: transparent; perspective: 1000px; }
        .dice-container { display: flex; gap: 40px; }
        .cube { width: 90px; height: 90px; position: relative; transform-style: preserve-3d; transition: transform 1.5s cubic-bezier(0.1, 0.9, 0.2, 1); }
        .face { position: absolute; inset: 0; background: #fff; border: 4px solid #000; border-radius: 12px; display: flex; justify-content: center; align-items: center; font-size: 3rem; font-weight: bold; backface-visibility: hidden; box-shadow: inset 0 0 15px rgba(0,0,0,0.2); }
        .face:nth-child(1) { transform: translateZ(45px); } .face:nth-child(6) { transform: rotateX(180deg) translateZ(45px); }
        .face:nth-child(2) { transform: rotateY(90deg) translateZ(45px); } .face:nth-child(5) { transform: rotateY(-90deg) translateZ(45px); }
        .face:nth-child(3) { transform: rotateX(90deg) translateZ(45px); } .face:nth-child(4) { transform: rotateX(-90deg) translateZ(45px); }
        .r1{transform:rotateX(0) rotateY(0)} .r6{transform:rotateX(180deg)} .r2{transform:rotateY(-90deg)} .r5{transform:rotateY(90deg)} .r3{transform:rotateX(-90deg)} .r4{transform:rotateX(90deg)}

        .toast { position: fixed; top: 15%; left: 50%; transform: translateX(-50%); background: #fff; padding: 15px 30px; border: 4px solid var(--frevo-blue); border-radius: 50px; font-weight: bold; z-index: 9999; animation: popIn 0.3s; font-family: 'Rye'; box-shadow: 0 10px 30px rgba(0,0,0,0.4); text-transform: uppercase; }
        .floater { position: absolute; font-size: 4rem; animation: floatUp 3s forwards; z-index: 9999; pointer-events: none; }
        @keyframes popIn { 0%{transform:scale(0)} 80%{transform:scale(1.1)} 100%{transform:scale(1)} }
        @keyframes floatUp { 0% { transform: translateY(0); opacity: 0; } 20% { opacity: 1; } 100% { transform: translateY(-300px); opacity: 0; } }
    </style>
</head>
<body>

<canvas id="rain-canvas"></canvas>

<div id="screen-lobby">
    <h1 style="color:#fff; font-size:3.5rem; margin-bottom:10px;">RECIFE DE OURO</h1>
    <div class="card-menu">
        <h2 style="color:var(--wood); margin:0;">CONCENTRA√á√ÉO</h2>
        <div id="status-net" style="color:var(--frevo-blue); font-weight:bold; margin-bottom:10px; font-size:0.8rem;">üîå Conectando √† rede...</div>
        
        <input id="p-name" class="input-box" placeholder="Seu Apelido" maxlength="12">
        
        <div id="lobby-btns">
            <button id="btn-host" class="btn-main bg-b" onclick="net.host()">CRIAR BLOCO</button>
            <p style="margin:10px; font-weight:bold; color:#aaa;">- OU -</p>
            <input id="host-id" class="input-box" placeholder="C√≥digo da Sala" style="font-size:1rem;">
            <button id="btn-join" class="btn-main bg-g" onclick="net.join()">ENTRAR NO BLOCO</button>
        </div>

        <div id="lobby-wait" style="display:none; border-top:2px dashed #ccc; margin-top:20px; padding-top:10px;">
            <p style="font-weight:bold; color:var(--wood);">SALA: <span id="disp-id" onclick="util.copy()" style="background:#eee; padding:5px; cursor:pointer; font-family:monospace; border:1px solid #000;">...</span></p>
            <div id="plist"></div>
            <p id="msg-wait" style="font-size:0.8rem; color:#d32f2f; display:none;">Aguardando o Mestre...</p>
            <button id="btn-go-char" class="btn-main bg-r" style="display:none;" onclick="net.toChar()">ABRIR ALAS</button>
        </div>
    </div>
</div>

<div id="screen-char" style="display:none;">
    <h1 style="color:var(--gold);">ESCOLHA A FANTASIA</h1>
    <div class="char-grid" id="char-grid"></div>
    <h2 id="char-st" style="color:#fff;">Aguardando...</h2>
    <button id="btn-start" class="btn-main bg-g" style="width:300px; display:none;" onclick="net.startGame()">TOCAR O FREVO!</button>
</div>

<div id="game-layout">
    <div id="board-viewport">
        <div id="board">
            <div class="center-hub">
                <div class="umbrella-spin"></div>
                <h1 style="color:var(--frevo-blue); z-index:2; text-shadow:2px 2px #fff; font-size:3rem; margin:0;">RECIFE</h1>
                <div id="weather-badge" style="z-index:2; background:#fff; padding:5px 15px; border:2px solid #000; border-radius:20px; font-weight:bold;">‚òÄÔ∏è Sol</div>
            </div>
            </div>
    </div>
    
    <div id="sidebar">
        <div class="hud-header">
            <h2 style="margin:0; color:var(--frevo-red);">Pernambuco</h2>
            <div id="my-cash" class="cash">$1500</div>
        </div>
        <div id="turn-msg" class="turn-badge">...</div>
        
        <div class="btn-grid">
            <button id="b-roll" class="btn-act" style="background:var(--gold); color:#000; grid-column:span 2;">üé≤ ROLAR DADOS</button>
            <button id="b-buy" class="btn-act" style="background:var(--frevo-green);">üí∞ COMPRAR</button>
            <button id="b-auc" class="btn-act" style="background:var(--frevo-blue);">üî® LEILOAR</button>
            <button id="b-trd" class="btn-act" style="background:#7b1fa2; color:#fff;">ü§ù NEGOCIAR</button>
            <button id="b-bail" class="btn-act" style="background:#607d8b; color:#fff;">üí∏ SUBORNO</button>
            <button id="b-end" class="btn-act" style="background:var(--frevo-red);">üõë PASSAR</button>
        </div>

        <div style="font-weight:bold; font-size:0.8rem;">Jogadores:</div>
        <div id="hud-list" style="margin-bottom:10px;"></div>
        
        <div style="font-weight:bold; font-size:0.8rem;">Minhas Escrituras:</div>
        <div id="deed-scroll"></div>

        <div style="display:flex; justify-content:space-around; padding-top:10px; border-top:1px dashed #ccc;">
            <span style="font-size:1.5rem; cursor:pointer;" onclick="game.react('üòÇ')">üòÇ</span>
            <span style="font-size:1.5rem; cursor:pointer;" onclick="game.react('üò°')">üò°</span>
            <span style="font-size:1.5rem; cursor:pointer;" onclick="game.react('ü¶à')">ü¶à</span>
            <span style="font-size:1.5rem; cursor:pointer;" onclick="game.react('üëè')">üëè</span>
        </div>
    </div>
</div>

<div id="dice-view" class="overlay">
    <div class="dice-container">
        <div id="d1" class="cube"><div class="face">1</div><div class="face">2</div><div class="face">3</div><div class="face">4</div><div class="face">5</div><div class="face">6</div></div>
        <div id="d2" class="cube"><div class="face">1</div><div class="face">2</div><div class="face">3</div><div class="face">4</div><div class="face">5</div><div class="face">6</div></div>
    </div>
</div>

<div id="card-modal" class="overlay">
    <div class="modal-box">
        <h2 id="cd-h" style="margin:0; padding-bottom:10px; border-bottom:2px solid #000;">Titulo</h2>
        <div id="cd-b" style="padding:20px; font-size:1.2rem;">Info</div>
        <button class="btn-main bg-r" style="margin:0; padding:10px; width:auto;" onclick="document.getElementById('card-modal').style.display='none'">FECHAR</button>
    </div>
</div>

<div id="auc-modal" class="overlay">
    <div class="modal-box">
        <h2>üî® LEIL√ÉO</h2>
        <h3 id="auc-item">Item</h3>
        <p>Lance: <span id="auc-val" style="color:green; font-weight:900; font-size:1.5rem;">$0</span></p>
        <p>L√≠der: <span id="auc-lead">---</span></p>
        <div id="auc-time" style="font-size:3rem; font-weight:900; color:var(--frevo-red);">10</div>
        <button class="btn-main bg-g" style="padding:10px;" onclick="auction.bid()">DAR LANCE (+$10)</button>
    </div>
</div>

<div id="trade-modal" class="overlay">
    <div class="modal-box" style="width:500px; max-width:95%;">
        <h2>ü§ù FEIRA DE TROCAS</h2>
        <select id="trd-who" style="width:100%; padding:10px; font-family:'Poppins'; margin-bottom:15px;"></select>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <div><p>Dou ($)</p><input id="trd-g" type="number" value="0" style="width:80px; padding:5px;"></div>
            <div style="font-size:2rem;">üëâ</div>
            <div><p>Recebo ($)</p><input id="trd-w" type="number" value="0" style="width:80px; padding:5px;"></div>
        </div>
        <button class="btn-main bg-g" onclick="trade.send()">ENVIAR PROPOSTA</button>
        <button class="btn-main bg-r" onclick="document.getElementById('trade-modal').style.display='none'">CANCELAR</button>
    </div>
</div>

<div id="trade-review" class="overlay">
    <div class="modal-box">
        <h2>üì© PROPOSTA!</h2>
        <p id="trd-desc">Fulano quer trocar...</p>
        <div style="display:flex; gap:10px; justify-content:center;">
            <button class="btn-main bg-r" onclick="trade.reply(false)">RECUSAR</button>
            <button class="btn-main bg-g" onclick="trade.reply(true)">ACEITAR</button>
        </div>
    </div>
</div>

<script>
/* DADOS DO RECIFE */
const CHARS=[{id:'cb',i:'ü¶Ä',n:'Caranguejo'},{id:'sk',i:'ü¶à',n:'Tubar√£o'},{id:'um',i:'‚òÇÔ∏è',n:'Sombrinha'},{id:'sn',i:'‚òÄÔ∏è',n:'Sol'},{id:'dr',i:'ü•Å',n:'Tambor'},{id:'cc',i:'ü••',n:'Coco'},{id:'ur',i:'üêª',n:'La Ursa'},{id:'cn',i:'üåΩ',n:'Milho'}];
const BD=[
    {t:'st',n:'MARCO ZERO'}, {t:'pr',g:'#795548',n:'Coque',p:60,h:50,r:[2,10,30,90,160,250]},{t:'ch',n:'Sorte'},{t:'pr',g:'#795548',n:'Ibura',p:60,h:50,r:[4,20,60,180,320,450]},{t:'tx',n:'IPTU',p:200},{t:'rr',n:'Metr√¥ Centro',p:200},{t:'pr',g:'#03a9f4',n:'Santo Amaro',p:100,h:50,r:[6,30,90,270,400,550]},{t:'ch',n:'Rev√©s'},{t:'pr',g:'#03a9f4',n:'Afogados',p:100,h:50,r:[6,30,90,270,400,550]},{t:'pr',g:'#03a9f4',n:'Mustardinha',p:120,h:50,r:[8,40,100,300,450,600]},
    {t:'jl',n:'Tr√¢nsito'}, {t:'pr',g:'#e91e63',n:'Iputinga',p:140,h:100,r:[10,50,150,450,750,950]},{t:'ut',n:'Neoenergia',p:150},{t:'pr',g:'#e91e63',n:'Cordeiro',p:140,h:100,r:[10,50,150,450,750,950]},{t:'pr',g:'#e91e63',n:'V√°rzea',p:160,h:100,r:[12,60,180,500,700,900]},{t:'rr',n:'Metr√¥ Oeste',p:200},{t:'pr',g:'#ff5722',n:'Imbiribeira',p:180,h:100,r:[14,70,200,550,750,950]},{t:'ch',n:'Sorte'},{t:'pr',g:'#ff5722',n:'Encruzilhada',p:180,h:100,r:[14,70,200,550,750,950]},{t:'pr',g:'#ff5722',n:'Torre',p:200,h:100,r:[16,80,220,600,800,1000]},
    {t:'pk',n:'Parque Jaqueira'}, {t:'pr',g:'#d32f2f',n:'Aflitos',p:220,h:150,r:[18,90,250,700,875,1050]},{t:'ch',n:'Rev√©s'},{t:'pr',g:'#d32f2f',n:'Espinheiro',p:220,h:150,r:[18,90,250,700,875,1050]},{t:'pr',g:'#d32f2f',n:'Madalena',p:240,h:150,r:[20,100,300,750,925,1100]},{t:'rr',n:'Via Mangue',p:200},{t:'pr',g:'#fbc02d',n:'Gra√ßas',p:260,h:150,r:[22,110,330,800,975,1150]},{t:'pr',g:'#fbc02d',n:'Po√ßo da Panela',p:260,h:150,r:[22,110,330,800,975,1150]},{t:'ut',n:'Compesa',p:150},{t:'pr',g:'#fbc02d',n:'Casa Forte',p:280,h:150,r:[24,120,360,850,1025,1200]},
    {t:'gj',n:'Blitz!'}, {t:'pr',g:'#388e3c',n:'Apipucos',p:300,h:200,r:[26,130,390,900,1100,1275]},{t:'pr',g:'#388e3c',n:'Parnamirim',p:300,h:200,r:[26,130,390,900,1100,1275]},{t:'ch',n:'Sorte'},{t:'pr',g:'#388e3c',n:'Paiva',p:320,h:200,r:[28,150,450,1000,1200,1400]},{t:'rr',n:'Aeroporto',p:200},{t:'ch',n:'Rev√©s'},{t:'pr',g:'#1565c0',n:'Boa Viagem',p:350,h:200,r:[35,175,500,1100,1300,1500]},{t:'tx',n:'Taxa Luxo',p:100},{t:'pr',g:'#1565c0',n:'Jaqueira',p:400,h:200,r:[50,200,600,1400,1700,2000]}
];
const SFX={dice:new Audio('https://www.soundjay.com/misc/sounds/dice-roll-1.mp3'),cash:new Audio('https://www.soundjay.com/misc/sounds/coins-in-hand-2.mp3'),gavel:new Audio('https://www.soundjay.com/misc/sounds/gavel-1.mp3')};
const play=(k)=>{try{SFX[k].currentTime=0;SFX[k].play().catch(()=>{})}catch(e){}};

/* ESTADO */
let myId=null,hostConn=null,conns=[],isHost=false,me={name:"Player",char:null};
let state={phase:'LOBBY',players:[],turn:0,rolled:false,props:BD.map(()=>({owner:null,mtg:false,level:0})),weather:'sun',doubles:0};
let auc={on:false,item:0,bid:0,lead:null,t:10,tm:null};
let trdOffer=null;

/* REDE ROBUSTA */
const net={
    peer: null,
    init:()=>{
        document.getElementById('status-net').innerText="üîå Conectando ao servidor...";
        // Tenta conectar usando configura√ß√£o padr√£o do PeerJS
        try {
            net.peer = new Peer(null, {
                debug: 2
            });

            net.peer.on('open', id => {
                myId = id;
                console.log('Meu ID:', myId);
                document.getElementById('status-net').innerText="‚úÖ REDE PRONTA! (Recife Online)";
                document.getElementById('status-net').style.color="#4caf50";
            });

            net.peer.on('connection', c => {
                if(isHost){
                    c.on('open', () => c.send({t:'WELCOME', l:state.players}));
                    c.on('data', d => net.host(d, c));
                    c.on('close', () => ui.toast("Algu√©m saiu do bloco!"));
                    conns.push(c);
                }
            });

            net.peer.on('error', e => {
                console.error(e);
                let msg = "Erro na Rede. ";
                if(e.type === 'browser-incompatible') msg += "Navegador incompat√≠vel.";
                else if(e.type === 'disconnected') msg += "Desconectado.";
                else if(e.type === 'network') msg += "Falha de conex√£o. Verifique internet.";
                else if(e.type === 'unavailable-id') msg += "ID indispon√≠vel.";
                else msg += e.type;
                
                document.getElementById('status-net').innerText = "‚ùå ERRO: " + msg;
                document.getElementById('status-net').style.color = "red";
                alert("Erro PeerJS: " + msg + "\nDica: N√£o abra o arquivo com duplo clique. Use um Live Server ou hospede no Vercel/Netlify.");
            });
            
            net.peer.on('disconnected', () => {
                 document.getElementById('status-net').innerText="‚ö†Ô∏è Desconectado. Tentando reconectar...";
                 net.peer.reconnect();
            });

        } catch (err) {
            alert("Falha cr√≠tica ao iniciar PeerJS. Verifique o console.");
        }
    },
    host:()=>{
        if(!myId) return alert("A rede ainda n√£o est√° pronta! Espere o status ficar VERDE.");
        const n=document.getElementById('p-name').value.trim();
        if(!n) return alert("Digite seu apelido, foli√£o!");
        
        isHost=true;
        me.name=n;
        // Host √© o primeiro player
        state.players.push({id:myId, name:n, char:null, money:1500, pos:0, jailed:false, color:'#d32f2f'});
        ui.screen('lobby-wait');
    },
    join:()=>{
        const n=document.getElementById('p-name').value.trim(), id=document.getElementById('host-id').value.trim();
        if(!n || !id) return alert("Preencha seu nome e o c√≥digo da sala!");
        if(!myId) return alert("Aguarde a rede conectar (Status Verde).");

        me.name=n;
        ui.toast("Buscando sala...");
        
        hostConn=net.peer.connect(id);
        
        // Timeout de seguran√ßa se n√£o conectar em 5s
        const tm = setTimeout(() => {
            if(document.getElementById('status-net').innerText.includes("Conectado ao Mestre")) return;
            alert("N√£o foi poss√≠vel conectar ao Mestre. Verifique o ID.");
        }, 5000);

        hostConn.on('open',()=>{
            clearTimeout(tm);
            hostConn.send({t:'JOIN', name:n});
            document.getElementById('status-net').innerText="üîÑ Conectado ao Mestre!";
        });
        
        hostConn.on('data', d => net.cli(d));
        hostConn.on('error', e => alert("Erro na conex√£o com Host: " + e));
    },
    toChar:()=>{if(state.players.length<2)return alert("Precisa de pelo menos 2 jogadores!");net.bc({t:'PHASE',p:'CHARS'});ui.screen('chars');},
    startGame:()=>{if(state.players.some(p=>!p.char))return alert("Todos precisam escolher uma fantasia!");net.bc({t:'PHASE',p:'GAME',st:state});ui.start();},
    
    // L√≥gica do Host recebendo dados
    host:(d,c)=>{
        if(d.t==='JOIN'){
            if(!state.players.find(p=>p.id===c.peer)){
                const cl=['#2196f3','#4caf50','#fbc02d','#7b1fa2'];
                // Adiciona player se n√£o existir
                state.players.push({
                    id:c.peer, 
                    name:d.name, 
                    char:null, 
                    money:1500, 
                    pos:0, 
                    jailed:false, 
                    color:cl[state.players.length%4] || '#000'
                });
                net.bc({t:'UPD',l:state.players});
                ui.rLobby(state.players);
            }
        }
        else if(d.t==='PICK'){const p=state.players.find(x=>x.id===d.pid);if(p){p.char=d.char;net.bc({t:'UPD',l:state.players});ui.rChars();}}
        else if(d.t==='ACT')game.proc(d);
        else if(d.t==='BID')auction.proc(d.pid);
        else if(d.t==='TRD')trade.proc(d);
        else if(d.t==='TRD_R')trade.finalize(d);
        else if(d.t==='MTG')game.mtg(d.i);
        else if(d.t==='BLD')game.build(d.i);
    },
    // L√≥gica do Cliente (Player) recebendo dados
    cli:(d)=>{
        if(d.t==='WELCOME'||d.t==='UPD'){state.players=d.l;if(state.phase==='LOBBY')ui.rLobby(d.l);if(state.phase==='CHARS')ui.rChars();}
        else if(d.t==='PHASE'){state.phase=d.p;if(d.p==='CHARS')ui.screen('chars');if(d.p==='GAME'){state=d.st;ui.start();}}
        else if(d.t==='STATE'){state=d.st;ui.rGame();}
        else if(d.t==='ANIM')ui.dice(d.d1,d.d2);
        else if(d.t==='TOAST')ui.toast(d.m);
        else if(d.t==='SC')ui.card(d.i);
        else if(d.t==='AUC')auction.upd(d.d);
        else if(d.t==='TRD_Q')trade.ask(d.o);
        else if(d.t==='ENV')env.set(d.w);
        else if(d.t==='REACT')ui.reactShow(d.e);
    },
    bc:(m)=>{if(isHost){conns.forEach(c=>c.send(m));if(m.t==='STATE'||m.t==='UPD'){}else net.cli(m);}else hostConn.send(m);}
};

/* GAME LOGIC */
const game={
    act:(a)=>{const d={t:'ACT',act:a,pid:myId};if(isHost)game.proc(d);else hostConn.send(d);},
    proc:(d)=>{
        const idx=state.players.findIndex(p=>p.id===d.pid),p=state.players[idx];
        if(state.turn!==idx)return;
        if(d.act==='roll'){
            if(state.rolled)return;
            const d1=Math.ceil(Math.random()*6),d2=Math.ceil(Math.random()*6);
            net.bc({t:'ANIM',d1,d2});
            setTimeout(()=>{
                let mv=d1+d2;
                if(p.jailed){if(d1===d2){p.jailed=false;game.mv(p,mv);state.rolled=true;}else{p.tj=(p.tj||0)+1;if(p.tj>=3){p.money-=50;p.jailed=false;game.mv(p,mv);}state.rolled=true;}}
                else{if(d1===d2)state.doubles++;else state.doubles=0; if(state.doubles>=3){p.jailed=true;p.pos=10;}else{game.mv(p,mv);if(d1!==d2)state.rolled=true;}}
                net.bc({t:'STATE',st:state});if(isHost)ui.rGame();
            },2500);
        }
        else if(d.act==='buy'){const s=BD[p.pos];if(p.money>=s.p&&state.props[p.pos].owner===null){p.money-=s.p;state.props[p.pos].owner=idx;play('cash');net.bc({t:'TOAST',m:`${p.name} comprou ${s.n}`});net.bc({t:'STATE',st:state});}}
        else if(d.act==='bail'){if(p.jailed&&p.money>=50){p.money-=50;p.jailed=false;state.rolled=true;net.bc({t:'STATE',st:state});}}
        else if(d.act==='auction'){auction.start(p.pos);}
        else if(d.act==='end'){state.turn=(state.turn+1)%state.players.length;state.rolled=false;state.doubles=0;env.chk();net.bc({t:'STATE',st:state});}
    },
    mv:(p,s)=>{
        p.pos+=s;if(p.pos>=40){p.pos-=40;p.money+=200;}
        const pr=state.props[p.pos], bd=BD[p.pos];
        if(bd.t==='pr'||bd.t==='rr'||bd.t==='ut') net.bc({t:'SC',i:p.pos});
        if(pr.owner!==null&&pr.owner!==state.players.indexOf(p)&&!pr.mtg){let r=bd.r?bd.r[pr.level]:50;p.money-=r;state.players[pr.owner].money+=r;play('cash');}
        if(bd.t==='tx')p.money-=bd.p;
        if(['Boa Viagem','Paiva'].some(x=>bd.n.includes(x))&&Math.random()<0.2){p.money-=100;net.bc({t:'TOAST',m:"Tubar√£o te pegou!"});}
    },
    mtg:(i)=>{const pr=state.props[i];if(pr.mtg){if(state.players[pr.owner].money>=BD[i].p*0.6){state.players[pr.owner].money-=BD[i].p*0.6;pr.mtg=false;}}else{state.players[pr.owner].money+=BD[i].p*0.5;pr.mtg=true;}net.bc({t:'STATE',st:state});},
    build:(i)=>{const pr=state.props[i], pl=state.players[pr.owner]; if(pl.money>=BD[i].h && pr.level<5){pl.money-=BD[i].h; pr.level++; net.bc({t:'STATE',st:state}); play('cash');}},
    reqMtg:(i)=>{const d={t:'MTG',i};if(isHost)game.mtg(i);else hostConn.send(d);},
    reqBld:(i)=>{const d={t:'BLD',i};if(isHost)game.build(i);else hostConn.send(d);},
    react:(e)=>{const d={t:'REACT',e};if(isHost)net.bc(d);else hostConn.send(d);}
};

/* SYSTEMS */
const auction={
    start:(i)=>{auc={on:true,item:i,bid:BD[i].p/2,lead:null,t:10};net.bc({t:'AUC',d:auc});auction.tick();},
    tick:()=>{auc.tm=setInterval(()=>{auc.t--;if(auc.t<=0)auction.end();else net.bc({t:'AUC',d:auc});},1000);},
    bid:()=>{hostConn?hostConn.send({t:'BID',pid:myId}):auction.proc(myId);},
    proc:(pid)=>{if(!auc.on)return;auc.bid+=10;auc.lead=pid;auc.t=10;play('gavel');net.bc({t:'AUC',d:auc});},
    end:()=>{clearInterval(auc.tm);auc.on=false;if(auc.lead){const w=state.players.find(p=>p.id===auc.lead),wi=state.players.indexOf(w);w.money-=auc.bid;state.props[auc.item].owner=wi;}net.bc({t:'AUC',d:auc});net.bc({t:'STATE',st:state});},
    upd:(d)=>{const el=document.getElementById('auc-modal');if(!d.on){el.style.display='none';return;}el.style.display='flex';document.getElementById('auc-item').innerText=BD[d.item].n;document.getElementById('auc-val').innerText=`$${d.bid}`;document.getElementById('auc-time').innerText=d.t;}
};
const trade={
    open:()=>{const s=document.getElementById('trd-who');s.innerHTML='';state.players.forEach(p=>{if(p.id!==myId)s.innerHTML+=`<option value="${p.id}">${p.name}</option>`});document.getElementById('trade-modal').style.display='flex';},
    send:()=>{const t=document.getElementById('trd-who').value,g=parseInt(document.getElementById('trd-g').value),w=parseInt(document.getElementById('trd-w').value);const o={f:myId,t:t,g:g,w:w};const d={t:'ACT',act:'trade',o:o};if(isHost)trade.proc({t:'TRD',o});else hostConn.send({t:'TRD',o});document.getElementById('trade-modal').style.display='none';},
    proc:(d)=>{net.bc({t:'TRD_Q',o:d.o});},
    ask:(o)=>{if(o.t===myId){trdOffer=o; document.getElementById('trd-desc').innerText=`Algu√©m oferece $${o.g} e pede $${o.w}. Aceita?`; document.getElementById('trade-review').style.display='flex';}},
    reply:(ok)=>{document.getElementById('trade-review').style.display='none'; const d={t:'TRD_R',o:trdOffer,ok}; if(isHost)trade.finalize(d); else hostConn.send(d);},
    finalize:(d)=>{if(d.ok){const p1=state.players.find(p=>p.id===d.o.f),p2=state.players.find(p=>p.id===d.o.t); p1.money+=d.o.w-d.o.g; p2.money+=d.o.g-d.o.w; net.bc({t:'STATE',st:state});}}
};
const env={
    chk:()=>{if(Math.random()<0.2){state.weather=state.weather==='sun'?'rain':'sun';net.bc({t:'ENV',w:state.weather});}},
    set:(w)=>{const c=document.getElementById('rain-canvas');c.style.display=w==='rain'?'block':'none';document.body.classList.toggle('night-mode',w==='rain');if(w==='rain')env.rain();},
    rain:()=>{const c=document.getElementById('rain-canvas'),x=c.getContext('2d');c.width=innerWidth;c.height=innerHeight;const d=Array(100).fill().map(()=>({x:Math.random()*c.width,y:Math.random()*c.height,s:Math.random()*5+2}));const l=()=>{x.clearRect(0,0,c.width,c.height);x.strokeStyle='#88a';d.forEach(p=>{x.beginPath();x.moveTo(p.x,p.y);x.lineTo(p.x,p.y+p.s);x.stroke();p.y+=p.s;if(p.y>c.height)p.y=0;});requestAnimationFrame(l);};l();}
};

/* UI */
const ui={
    screen:(k)=>{
        document.getElementById('screen-lobby').style.display=k==='lobby'?'flex':'none';
        if(k==='lobby-wait'){document.getElementById('lobby-btns').style.display='none';document.getElementById('lobby-wait').style.display='block';document.getElementById('disp-id').innerText=myId;document.getElementById('btn-go-char').style.display='block';ui.rLobby(state.players);}
        document.getElementById('screen-char').style.display=k==='chars'?'flex':'none';
        document.getElementById('game-layout').classList.toggle('active',k==='game');if(k==='chars')ui.rChars();
    },
    rLobby:(l)=>{document.getElementById('plist').innerHTML=l.map(p=>`<span style="background:#eee;border:1px solid #000;padding:5px;margin:3px;display:inline-block;">${p.name}</span>`).join('');if(!isHost){document.getElementById('lobby-btns').style.display='none';document.getElementById('lobby-wait').style.display='block';document.getElementById('msg-wait').style.display='block';document.getElementById('disp-id').innerText="CONECTADO";}},
    rChars:()=>{const g=document.getElementById('char-grid');g.innerHTML='';CHARS.forEach(c=>{const taken=state.players.find(p=>p.char===c.id),isMe=taken&&taken.id===myId;g.innerHTML+=`<div class="char-opt ${taken?'taken':''} ${isMe?'selected':''}" onclick="${!taken?`ui.pick('${c.id}')`:''}"><div class="char-icon">${c.i}</div>${taken?'':`<div>${c.n}</div>`}</div>`;});const r=state.players.every(p=>p.char);document.getElementById('char-st').innerText=r?"PRONTOS!":"AGUARDANDO...";if(isHost&&r)document.getElementById('btn-start').style.display='block';},
    pick:(id)=>{if(isHost){state.players.find(x=>x.id===myId).char=id;net.bc({t:'UPD',l:state.players});ui.rChars();}else hostConn.send({t:'PICK',pid:myId,char:id});},
    start:()=>{document.getElementById('screen-char').style.display='none';document.getElementById('game-layout').classList.add('active');ui.genBoard();ui.rGame();confetti();ui.binds();env.rain();},
    genBoard:()=>{const b=document.getElementById('board');BD.forEach((s,i)=>{const d=document.createElement('div');d.className='space';d.id=`s${i}`;let r,c;if(i<=10){r=11;c=11-i;}else if(i<=20){r=11-(i-10);c=1;}else if(i<=30){r=1;c=1+(i-20);}else{r=1+(i-30);c=11;}d.style.gridRow=r;d.style.gridColumn=c;d.innerHTML=s.t==='pr'?`<div class="color-bar" style="background:${s.g}"></div><div>${s.n}<br>$${s.p}</div><div class="build-area" id="bld${i}"></div>`:`<div style="margin:auto">${s.n}</div>`;b.appendChild(d);});},
    rGame:()=>{
        const meP=state.players.find(p=>p.id===myId),trn=state.players[state.turn];
        document.getElementById('my-cash').innerText=`$${meP.money}`;document.getElementById('turn-msg').innerText=`Vez de: ${trn.name}`;
        const myT=trn.id===myId,s=BD[meP.pos];
        ui.btn('b-roll',myT&&!state.rolled);ui.btn('b-buy',myT&&state.rolled&&s.t==='pr'&&state.props[meP.pos].owner===null);ui.btn('b-auc',myT&&state.rolled&&s.t==='pr'&&state.props[meP.pos].owner===null);ui.btn('b-bail',myT&&meP.jailed);ui.btn('b-trd',true);ui.btn('b-end',myT&&state.rolled);
        
        document.getElementById('hud-list').innerHTML=state.players.map((p,i)=>{const c=CHARS.find(x=>x.id===p.char);return `<div class="player-row ${state.turn===i?'active':''}"><span>${c.i} ${p.name}</span><span>${p.id===myId?'$'+p.money:'???'}</span></div>`;}).join('');
        document.querySelectorAll('.token').forEach(e=>e.remove());
        state.players.forEach((p,i)=>{
            const c=CHARS.find(x=>x.id===p.char),t=document.createElement('div');t.className='token';t.innerText=c.i;
            const sp=document.getElementById(`s${p.pos}`),br=document.getElementById('board').getBoundingClientRect(),sr=sp.getBoundingClientRect();
            t.style.left=(sr.left-br.left+10+((i%3)*10))+'px';t.style.top=(sr.top-br.top+10+(Math.floor(i/3)*10))+'px';
            document.getElementById('board').appendChild(t);if(state.rolled&&state.turn===i)setTimeout(()=>t.classList.add('jump'),50);
        });
        const dl=document.getElementById('deed-scroll');dl.innerHTML='';
        state.props.forEach((pr,i)=>{
            const sp=document.getElementById(`s${i}`);if(pr.owner!==null)sp.style.border=`4px solid ${state.players[pr.owner].color}`;
            if(pr.mtg)sp.classList.add('mortgaged');else sp.classList.remove('mortgaged');
            const bz=document.getElementById(`bld${i}`);if(bz){bz.innerHTML='';if(pr.level==5)bz.innerHTML='<div class="hotel-3d"></div>';else for(let k=0;k<pr.level;k++)bz.innerHTML+='<div class="house-3d"></div>';}
            if(state.players[pr.owner]?.id===myId){
                const grp=BD[i].g, mono=BD.every((b,x)=>b.g!==grp||state.props[x].owner===state.players.indexOf(meP));
                dl.innerHTML+=`<div class="deed-item" onclick="game.reqMtg(${i})"><span>${BD[i].n} ${pr.mtg?'(Hip.)':''}</span>${!pr.mtg&&mono&&pr.level<5?`<button class="build-btn" onclick="event.stopPropagation();game.reqBld(${i})">+Casa $${BD[i].h}</button>`:''}</div>`;
            }
        });
        if(window.innerWidth>900){ /* Cam Logic */ const rX=30,rZ=0; document.getElementById('board').style.transform=`rotateX(${rX}deg) rotateZ(${rZ}deg) scale(0.9)`; }
    },
    cam:(i)=>{ /* Optional simple zoom/pan logic can go here */ },
    btn:(id,on)=>{const b=document.getElementById(id);if(on){b.classList.add('on');b.disabled=false;}else{b.classList.remove('on');b.disabled=true;}},
    binds:()=>{
        document.getElementById('b-roll').onclick=()=>game.act('roll');document.getElementById('b-buy').onclick=()=>game.act('buy');
        document.getElementById('b-auc').onclick=()=>game.act('auction');document.getElementById('b-bail').onclick=()=>game.act('bail');
        document.getElementById('b-trd').onclick=()=>trade.open();document.getElementById('b-end').onclick=()=>game.act('end');
    },
    dice:(d1,d2)=>{const o=document.getElementById('dice-view');o.style.display='flex';play('dice');const c1=document.querySelector('#d1 .cube'),c2=document.querySelector('#d2 .cube');c1.className='cube';c2.className='cube';void c1.offsetWidth;c1.style.transition='transform 1.5s';c2.style.transition='transform 1.5s';const m=['r1','r2','r3','r4','r5','r6'];setTimeout(()=>{c1.classList.add(m[d1-1]);c2.classList.add(m[d2-1]);},50);setTimeout(()=>o.style.display='none',2500);},
    card:(i)=>{const s=BD[i],el=document.getElementById('card-modal');document.getElementById('cd-h').innerText=s.n;document.getElementById('cd-h').style.background=s.g||'#333';document.getElementById('cd-b').innerHTML=`Pre√ßo: $${s.p}<br>Aluguel Base: $${s.r?s.r[0]:50}<br>Casa: $${s.h||0}`;el.style.display='flex';},
    toast:(m)=>{const d=document.createElement('div');d.className='toast';d.innerText=m;document.body.appendChild(d);setTimeout(()=>d.remove(),3000);},
    reactShow:(e)=>{const d=document.createElement('div');d.className='floater';d.style.left=(Math.random()*80+10)+'%';d.style.top='80%';d.innerText=e;document.body.appendChild(d);setTimeout(()=>d.remove(),3000);}
};
const util={copy:()=>{navigator.clipboard.writeText(myId);alert("Copiado!");}};
// INICIA A M√ÅQUINA
net.init();
</script>
</body>
</html>

