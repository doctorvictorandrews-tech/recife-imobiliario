<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Recife V22: Corrigido</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rye&family=Poppins:wght@400;600;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-grad: radial-gradient(circle at center, #29b6f6, #01579b);
            --wood: #4e342e; --paper: #fff8e1; --gold: #ffca28;
            --frevo-blue: #0277bd; --frevo-red: #c62828; --frevo-green: #2e7d32;
            --shadow-3d: 0 20px 50px rgba(0,0,0,0.6);
        }
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Poppins', sans-serif; background: var(--bg-grad); height: 100vh; overflow: hidden; display: flex; flex-direction: column; perspective: 1000px; }
        h1, h2, button { font-family: 'Rye', serif; letter-spacing: 1px; text-shadow: 2px 2px 0 rgba(0,0,0,0.3); }

        /* LOBBY */
        #screen-lobby, #screen-char { position: fixed; inset: 0; z-index: 9000; background: url('https://www.transparenttextures.com/patterns/cubes.png'), var(--bg-grad); display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .card-menu { background: var(--paper); width: 90%; max-width: 450px; padding: 30px; border: 8px solid var(--wood); border-radius: 15px; text-align: center; box-shadow: var(--shadow-3d); position: relative; }
        .input-box { width: 100%; padding: 15px; margin: 10px 0; border: 3px solid var(--wood); font-family: 'Rye'; font-size: 1.2rem; text-align: center; border-radius: 8px; background: #fff; }
        .btn-main { width: 100%; padding: 15px; margin-top: 10px; border: none; border-radius: 50px; font-size: 1.2rem; font-weight: 900; text-transform: uppercase; cursor: pointer; box-shadow: 0 6px 0 rgba(0,0,0,0.3); color: white; font-family: 'Rye'; transition: 0.1s; }
        .btn-main:active { transform: translateY(4px); box-shadow: none; }
        .bg-b { background: var(--frevo-blue); } .bg-g { background: var(--frevo-green); } .bg-r { background: var(--frevo-red); }

        /* JOGO */
        #game-layout { display: flex; width: 100%; height: 100%; opacity: 0; transition: 1s; pointer-events: none; }
        #game-layout.active { opacity: 1; pointer-events: all; }
        #board-viewport { flex: 1; perspective: 1800px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        #board { display: grid; grid-template-columns: repeat(11, 80px); grid-template-rows: repeat(11, 80px); background: #f5f5f5; border: 20px solid var(--wood); border-radius: 12px; position: relative; transform-style: preserve-3d; transition: transform 1.2s; box-shadow: var(--shadow-3d); background-image: url('https://www.transparenttextures.com/patterns/white-brick-wall.png'); }
        
        .space { border: 1px solid rgba(0,0,0,0.1); background: rgba(255,255,255,0.92); font-size: 0.6rem; text-align: center; position: relative; font-weight: bold; display: flex; flex-direction: column; transition: 0.3s; backface-visibility: hidden; }
        .color-bar { height: 25%; border-bottom: 2px solid #333; position: relative; }
        .center-hub { grid-column: 2/11; grid-row: 2/11; background: #e1f5fe; border: 5px solid var(--wood); display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        
        /* HUD */
        #sidebar { width: 360px; background: rgba(255,255,255,0.95); padding: 15px; display: flex; flex-direction: column; z-index: 100; border-left: 8px solid var(--wood); box-shadow: -10px 0 30px rgba(0,0,0,0.4); backdrop-filter: blur(10px); }
        .btn-act { padding: 12px; border: 3px solid #000; border-radius: 8px; font-weight: bold; cursor: pointer; opacity: 0.5; pointer-events: none; transition: 0.2s; text-transform: uppercase; font-size: 0.85rem; background: #eee; color: #555; }
        .btn-act.on { opacity: 1; pointer-events: all; transform: translateY(-2px); box-shadow: 0 4px 0 rgba(0,0,0,0.3); color: #fff; border-color: rgba(0,0,0,0.5); }
        .btn-act.on:active { transform: translateY(0); box-shadow: none; }

        .token { width: 45px; height: 45px; position: absolute; z-index: 50; font-size: 2.5rem; text-align: center; line-height: 45px; filter: drop-shadow(0 8px 4px rgba(0,0,0,0.6)); transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform-origin: bottom center; }
        .jump { animation: jump 0.5s; } @keyframes jump { 50% { transform: translateY(-50px) scale(1.2); } }

        /* DICE & OVERLAYS */
        #dice-view { position: fixed; inset: 0; pointer-events: none; z-index: 5000; display: none; perspective: 1000px; justify-content: center; align-items: center; }
        .dice-wrap { width: 90px; height: 90px; position: relative; transform-style: preserve-3d; margin: 30px; }
        .cube { width: 100%; height: 100%; position: absolute; transform-style: preserve-3d; transition: transform 1.5s ease-out; }
        .face { position: absolute; inset: 0; background: #fff; border: 4px solid #000; border-radius: 12px; display: flex; justify-content: center; align-items: center; font-size: 3rem; font-weight: bold; backface-visibility: hidden; box-shadow: inset 0 0 15px rgba(0,0,0,0.1); }
        .face:nth-child(1) { transform: translateZ(45px); } .face:nth-child(6) { transform: rotateX(180deg) translateZ(45px); }
        .face:nth-child(2) { transform: rotateY(90deg) translateZ(45px); } .face:nth-child(5) { transform: rotateY(-90deg) translateZ(45px); }
        .face:nth-child(3) { transform: rotateX(90deg) translateZ(45px); } .face:nth-child(4) { transform: rotateX(-90deg) translateZ(45px); }
        .r1{transform:rotateX(0) rotateY(0)} .r6{transform:rotateX(180deg) rotateY(0)} .r2{transform:rotateY(-90deg)} .r5{transform:rotateY(90deg)} .r3{transform:rotateX(-90deg)} .r4{transform:rotateX(90deg)}

        .char-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 20px 0; }
        .char-opt { background: rgba(255,255,255,0.2); border: 2px solid #fff; border-radius: 10px; padding: 10px; cursor: pointer; transition: 0.3s; text-align: center; }
        .char-opt.selected { background: var(--gold); border-color: var(--wood); transform: scale(1.15); color: black; }
        
        #room-code-display { font-family: monospace; font-size: 2rem; background: #fff; padding: 10px; border: 2px dashed #000; cursor: pointer; margin: 10px 0; letter-spacing: 5px; }

        @media (min-width: 900px) { #board { transform: rotateX(30deg) scale(0.9); } }
        @media (max-width: 899px) { #game-layout { flex-direction: column; } #sidebar { order: 2; height: auto; width: 100%; border-left: none; border-top: 8px solid var(--wood); } #board { transform: scale(0.55); margin-bottom: 20px; } }
    </style>
</head>
<body>

<div id="screen-lobby">
    <h1 style="color:#fff; font-size:3.5rem; margin-bottom:10px;">RECIFE DE OURO</h1>
    <div class="card-menu">
        <h2 style="color:var(--wood); margin:0;">CONCENTRAÃ‡ÃƒO</h2>
        
        <input id="p-name" class="input-box" placeholder="Seu Apelido" maxlength="12">
        
        <div id="lobby-btns">
            <button id="btn-host" class="btn-main bg-b" onclick="net.host()">CRIAR BLOCO</button>
            <p style="margin:10px; font-weight:bold; color:#aaa;">- OU -</p>
            <input id="host-id" class="input-box" placeholder="CÃ³digo da Sala (Ex: A1B2)" style="font-size:1rem; text-transform:uppercase;">
            <button id="btn-join" class="btn-main bg-g" onclick="net.join()">ENTRAR NO BLOCO</button>
        </div>

        <div id="lobby-wait" style="display:none; padding-top:10px;">
            <p style="font-weight:bold; color:var(--wood);">CÃ“DIGO DA SALA (Clique p/ copiar):</p>
            <div id="room-code-display" onclick="util.copy()">...</div>
            <p>FoliÃµes na sala:</p>
            <div id="plist" style="font-weight:bold; margin-bottom:15px;"></div>
            <p id="msg-wait" style="font-size:0.8rem; color:#d32f2f; display:none;">Aguardando o Mestre...</p>
            <button id="btn-go-char" class="btn-main bg-r" style="display:none;" onclick="net.toChar()">ABRIR ALAS</button>
        </div>
    </div>
</div>

<div id="screen-char" style="display:none;">
    <div class="card-menu">
        <h1 style="color:var(--wood);">ESCOLHA A FANTASIA</h1>
        <div class="char-grid" id="char-grid"></div>
        <h2 id="char-st" style="color:#666;">Aguardando...</h2>
        <button id="btn-start" class="btn-main bg-g" style="display:none;" onclick="net.startGame()">TOCAR O FREVO!</button>
    </div>
</div>

<div id="game-layout">
    <div id="board-viewport">
        <div id="board">
            <div class="center-hub">
                <h1 style="color:var(--frevo-blue); z-index:2; text-shadow:2px 2px #fff; font-size:3rem; margin:0;">RECIFE</h1>
            </div>
            </div>
    </div>
    
    <div id="sidebar">
        <div class="hud-header">
            <h2 style="margin:0; color:var(--frevo-red);">Pernambuco</h2>
            <div id="my-cash" style="font-size:1.5rem; font-weight:900; color:var(--frevo-green);">$1500</div>
        </div>
        <div id="turn-msg" style="background:#333; color:#fff; padding:5px; text-align:center; border-radius:5px; margin-bottom:10px;">...</div>
        
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:15px;">
            <button id="b-roll" class="btn-act" style="background:var(--gold); color:#000; grid-column:span 2;" onclick="game.act('roll')">ðŸŽ² ROLAR DADOS</button>
            <button id="b-buy" class="btn-act" style="background:var(--frevo-green); color:white;" onclick="game.act('buy')">ðŸ’° COMPRAR</button>
            <button id="b-pass" class="btn-act" style="background:var(--frevo-red); color:white;" onclick="game.act('pass')">ðŸ›‘ PASSAR</button>
        </div>

        <div style="font-weight:bold; font-size:0.8rem;">Jogadores:</div>
        <div id="hud-list" style="margin-bottom:10px;"></div>
        
        <div style="font-weight:bold; font-size:0.8rem;">Minhas Escrituras:</div>
        <div id="deed-list" style="flex:1; overflow-y:auto; background:#fff8e1; border:1px solid #ccc; padding:5px;"></div>
    </div>
</div>

<div id="dice-view">
    <div class="dice-container">
        <div class="dice-wrap"><div id="d1" class="cube"><div class="face">1</div><div class="face">2</div><div class="face">3</div><div class="face">4</div><div class="face">5</div><div class="face">6</div></div></div>
        <div class="dice-wrap"><div id="d2" class="cube"><div class="face">1</div><div class="face">2</div><div class="face">3</div><div class="face">4</div><div class="face">5</div><div class="face">6</div></div></div>
    </div>
</div>

<script>
/* DADOS */
const CHARS=[{id:'cb',i:'ðŸ¦€',n:'Caranguejo'},{id:'sk',i:'ðŸ¦ˆ',n:'TubarÃ£o'},{id:'um',i:'â˜‚ï¸',n:'Sombrinha'},{id:'sn',i:'â˜€ï¸',n:'Sol'},{id:'dr',i:'ðŸ¥',n:'Tambor'},{id:'cc',i:'ðŸ¥¥',n:'Coco'},{id:'ur',i:'ðŸ»',n:'La Ursa'},{id:'cn',i:'ðŸŒ½',n:'Milho'}];
const COLS={br:'#795548',lb:'#03a9f4',pk:'#e91e63',or:'#ff5722',rd:'#d32f2f',yl:'#fbc02d',gr:'#388e3c',bl:'#1565c0'};
const BD=[
    {t:'st',n:'MARCO ZERO'}, {t:'pr',g:'br',n:'Coque',p:60},{t:'ch',n:'Sorte'},{t:'pr',g:'br',n:'Ibura',p:60},{t:'tx',n:'IPTU',p:200},{t:'rr',n:'MetrÃ´'},{t:'pr',g:'lb',n:'Santo Amaro',p:100},{t:'ch',n:'RevÃ©s'},{t:'pr',g:'lb',n:'Afogados',p:100},{t:'pr',g:'lb',n:'Mustardinha',p:120},
    {t:'jl',n:'TrÃ¢nsito'}, {t:'pr',g:'pk',n:'Iputinga',p:140},{t:'ut',n:'Neoenergia',p:150},{t:'pr',g:'pk',n:'Cordeiro',p:140},{t:'pr',g:'pk',n:'VÃ¡rzea',p:160},{t:'rr',n:'MetrÃ´ Oeste'},{t:'pr',g:'or',n:'Imbiribeira',p:180},{t:'ch',n:'Sorte'},{t:'pr',g:'or',n:'Encruzilhada',p:180},{t:'pr',g:'or',n:'Torre',p:200},
    {t:'pk',n:'Parque'}, {t:'pr',g:'rd',n:'Aflitos',p:220},{t:'ch',n:'RevÃ©s'},{t:'pr',g:'rd',n:'Espinheiro',p:220},{t:'pr',g:'rd',n:'Madalena',p:240},{t:'rr',n:'Via Mangue'},{t:'pr',g:'yl',n:'GraÃ§as',p:260},{t:'pr',g:'yl',n:'PoÃ§o',p:260},{t:'ut',n:'Compesa',p:150},{t:'pr',g:'yl',n:'Casa Forte',p:280},
    {t:'gj',n:'Blitz!'}, {t:'pr',g:'gr',n:'Apipucos',p:300},{t:'pr',g:'gr',n:'Parnamirim',p:300},{t:'ch',n:'Sorte'},{t:'pr',g:'gr',n:'Paiva',p:320},{t:'rr',n:'Aeroporto'},{t:'ch',n:'RevÃ©s'},{t:'pr',g:'bl',n:'Boa Viagem',p:350},{t:'tx',n:'Taxa',p:100},{t:'pr',g:'bl',n:'Jaqueira',p:400}
];

let myId=null, hostConn=null, conns=[], isHost=false;
let state={phase:'LOBBY',players:[],turn:0,rolled:false,doubles:0,props:BD.map(()=>({owner:null}))};

/* NET: SHORT ID LOGIC */
function genShortId() { return Math.random().toString(36).substr(2, 4).toUpperCase(); }

const net={
    peer:null,
    init:()=>{
        // For host, we generate a custom short ID immediately
    },
    host:()=>{
        const n=document.getElementById('p-name').value.trim();
        if(!n) return alert("Digite seu nome!");
        
        const shortId = genShortId(); // Gera ID curto (ex: A4F9)
        net.peer = new Peer(shortId); // Tenta registrar ID curto
        
        net.peer.on('open', id => {
            myId = id;
            isHost = true;
            state.players.push({id:myId, name:n, char:null, money:1500, pos:0, jailed:false, color:'#d32f2f'});
            ui.screen('lobby-wait');
        });
        
        net.peer.on('error', e => {
            if(e.type === 'unavailable-id') {
                net.host(); // Try again if taken
            } else alert("Erro Rede: "+e);
        });

        net.peer.on('connection', c => {
            c.on('open', () => c.send({t:'WELCOME', l:state.players}));
            c.on('data', d => net.hostHandler(d, c));
            conns.push(c);
        });
    },
    join:()=>{
        const n=document.getElementById('p-name').value.trim();
        const code=document.getElementById('host-id').value.trim().toUpperCase();
        if(!n || !code) return alert("Preencha nome e cÃ³digo!");
        
        net.peer = new Peer(); // Client gets random ID
        net.peer.on('open', id => {
            myId = id;
            hostConn = net.peer.connect(code);
            hostConn.on('open', () => {
                hostConn.send({t:'JOIN', name:n});
                document.querySelector('.estandarte-card').innerHTML = "<h3>Conectando...</h3>";
            });
            hostConn.on('data', d => net.cliHandler(d));
            hostConn.on('error', e => alert("Erro ao conectar na sala "+code));
        });
    },
    toChar:()=>{if(state.players.length<2)return alert("MÃ­nimo 2 jogadores!"); net.bc({t:'PHASE', p:'CHARS'}); ui.screen('chars');},
    startGame:()=>{if(state.players.some(p=>!p.char))return alert("Todos devem escolher!"); net.bc({t:'PHASE', p:'GAME', st:state}); ui.start();},
    
    hostHandler:(d,c)=>{
        if(d.t==='JOIN'){
            if(!state.players.find(p=>p.id===c.peer)){
                const cl=['#1976d2','#388e3c','#fbc02d','#7b1fa2'];
                state.players.push({id:c.peer, name:d.name, char:null, money:1500, pos:0, jailed:false, color:cl[state.players.length%4]});
                net.bc({t:'UPD', l:state.players}); ui.rLobby(state.players);
            }
        } else if(d.t==='PICK'){
            const p=state.players.find(x=>x.id===d.pid); if(p){ p.char=d.char; net.bc({t:'UPD',l:state.players}); ui.rChars(); }
        } else if(d.t==='ACT') game.proc(d);
    },
    cliHandler:(d)=>{
        if(d.t==='WELCOME'||d.t==='UPD'){ state.players=d.l; if(state.phase==='LOBBY')ui.rLobby(d.l); if(state.phase==='CHARS')ui.rChars(); }
        else if(d.t==='PHASE'){ state.phase=d.p; if(d.p==='CHARS')ui.screen('chars'); if(d.p==='GAME'){state=d.st; ui.start();} }
        else if(d.t==='STATE'){ state=d.st; ui.rGame(); }
        else if(d.t==='ANIM'){ ui.dice(d.d1, d.d2); }
    },
    bc:(m)=>{ if(isHost){conns.forEach(c=>c.send(m));} else {hostConn.send(m);} }
};

/* LOGICA JOGO */
const game = {
    act:(act)=>{ const d={t:'ACT', act:act, pid:myId}; if(isHost) game.proc(d); else hostConn.send(d); },
    proc:(d)=>{
        const idx = state.players.findIndex(p=>p.id===d.pid), p=state.players[idx];
        if(state.turn !== idx) return;

        if(d.act==='roll'){
            if(state.rolled && state.doubles===0) return; // Prevent extra roll unless doubles
            const d1=Math.ceil(Math.random()*6), d2=Math.ceil(Math.random()*6);
            net.bc({t:'ANIM', d1, d2}); 
            if(isHost) ui.dice(d1,d2);

            setTimeout(()=>{
                if(d1===d2) {
                    state.doubles++;
                    if(state.doubles >= 3) {
                        p.jailed = true; p.pos = 10;
                        state.doubles = 0; state.rolled = true; // End turn after jail
                    } else {
                        state.rolled = false; // Allow re-roll
                        game.mv(p, d1+d2);
                    }
                } else {
                    state.doubles = 0;
                    state.rolled = true; // Disable roll, enable pass
                    game.mv(p, d1+d2);
                }
                net.bc({t:'STATE', st:state}); if(isHost) ui.rGame();
            }, 2500);
        }
        else if(d.act==='buy'){
            const s=BD[p.pos];
            if(p.money>=s.p && state.props[p.pos].owner===null){
                p.money-=s.p; state.props[p.pos].owner=idx;
                net.bc({t:'STATE', st:state});
            }
        }
        else if(d.act==='pass'){
            state.rolled = false; state.doubles = 0;
            state.turn = (state.turn + 1) % state.players.length;
            net.bc({t:'STATE', st:state});
        }
        if(isHost) ui.rGame();
    },
    mv:(p,s)=>{
        p.pos += s; if(p.pos>=40){p.pos-=40; p.money+=200;}
        // Rent Logic
        const pr = state.props[p.pos];
        if(pr.owner!==null && pr.owner!==state.players.indexOf(p)){
            let r = BD[p.pos].r ? BD[p.pos].r[0] : 50;
            p.money -= r; state.players[pr.owner].money += r;
        }
    }
};

/* UI */
const ui = {
    screen:(k)=>{
        document.getElementById('screen-lobby').style.display = k==='lobby'||k==='lobby-wait'?'flex':'none';
        if(k==='lobby-wait'){
            document.getElementById('lobby-btns').style.display='none';
            document.getElementById('lobby-wait').style.display='block';
            document.getElementById('disp-id').innerText = myId;
            if(isHost) document.getElementById('btn-go-char').style.display='block';
            ui.rLobby(state.players);
        }
        document.getElementById('screen-char').style.display = k==='chars'?'flex':'none';
        document.getElementById('game-layout').classList.toggle('active', k==='game');
        if(k==='chars') ui.rChars();
    },
    rLobby:(l)=>{
        document.getElementById('plist').innerHTML = l.map(p=>`<span style="background:#eee; padding:5px; margin:2px;">${p.name}</span>`).join('');
        if(!isHost){
            document.getElementById('lobby-btns').style.display='none';
            document.getElementById('lobby-wait').style.display='block';
            document.getElementById('msg-wait').style.display='block';
            document.getElementById('disp-id').innerText = "CONECTADO";
        }
    },
    rChars:()=>{
        const g=document.getElementById('char-grid'); g.innerHTML='';
        CHARS.forEach(c=>{
            const taken=state.players.find(p=>p.char===c.id), isMe=taken&&taken.id===myId;
            g.innerHTML += `<div class="char-opt ${taken?'taken':''} ${isMe?'selected':''}" onclick="${!taken?`ui.pick('${c.id}')`:''}"><div class="char-icon">${c.i}</div><div>${c.n}</div></div>`;
        });
        const r=state.players.every(p=>p.char);
        document.getElementById('char-st').innerText = r ? "PRONTOS!" : "Aguardando...";
        if(isHost && r) document.getElementById('btn-start').style.display='block';
    },
    pick:(id)=>{ if(isHost){state.players.find(x=>x.id===myId).char=id; net.bc({t:'UPD',l:state.players}); ui.rChars();} else hostConn.send({t:'PICK',pid:myId,char:id}); },
    start:()=>{ ui.screen('game'); ui.genBoard(); ui.rGame(); },
    genBoard:()=>{
        const b = document.getElementById('board');
        BD.forEach((s,i)=>{
            const d = document.createElement('div'); d.className='space'; d.id=`s${i}`;
            let r,c; if(i<=10){r=11;c=11-i;} else if(i<=20){r=11-(i-10);c=1;} else if(i<=30){r=1;c=1+(i-20);} else {r=1+(i-30);c=11;}
            d.style.gridRow=r; d.style.gridColumn=c;
            d.innerHTML = s.t==='pr' ? `<div class="color-bar" style="background:${COLS[s.g]}"></div><div>${s.n}<br>$${s.p}</div>` : `<div>${s.n}</div>`;
            b.appendChild(d);
        });
    },
    rGame:()=>{
        const meP = state.players.find(p=>p.id===myId);
        const trnP = state.players[state.turn];
        document.getElementById('my-cash').innerText = `$${meP.money}`;
        document.getElementById('turn-msg').innerText = `Vez de: ${trnP.name}`;
        
        const myT = trnP.id===myId;
        // Fix Doubles Logic in UI: Allow roll if my turn AND (not rolled OR got doubles)
        const canRoll = myT && (!state.rolled || state.doubles > 0);
        document.getElementById('b-roll').className = `btn-act ${canRoll?'on':''}`;
        document.getElementById('b-roll').disabled = !canRoll;
        
        const canPass = myT && state.rolled && state.doubles === 0;
        document.getElementById('b-pass').className = `btn-act ${canPass?'on':''}`;
        
        // Buy Button
        const s = BD[meP.pos];
        const canBuy = myT && state.rolled && s.t==='pr' && state.props[meP.pos].owner===null;
        document.getElementById('b-buy').className = `btn-act ${canBuy?'on':''}`;

        // HUD List
        document.getElementById('hud-list').innerHTML = state.players.map((p,i)=>`
            <div style="background:${state.turn===i?'#fff9c4':'#fff'}; padding:5px; border:1px solid #ccc; margin-bottom:5px;">
                ${CHARS.find(c=>c.id===p.char).i} ${p.name}: ${p.id===myId?'$'+p.money:'???'}
            </div>`
        ).join('');

        // Tokens
        document.querySelectorAll('.token').forEach(e=>e.remove());
        state.players.forEach((p,i)=>{
            const t = document.createElement('div'); t.className='token';
            t.innerText = CHARS.find(c=>c.id===p.char).i;
            const sp = document.getElementById(`s${p.pos}`);
            const br = document.getElementById('board').getBoundingClientRect();
            const sr = sp.getBoundingClientRect();
            t.style.left = (sr.left - br.left + 10 + (i*5)) + 'px';
            t.style.top = (sr.top - br.top + 10 + (i*5)) + 'px';
            document.getElementById('board').appendChild(t);
            if(state.rolled && state.turn===i) setTimeout(()=>t.classList.add('jump'), 50);
        });
        
        // Deeds
        const dl = document.getElementById('deed-list'); dl.innerHTML = '';
        state.props.forEach((pr,i)=>{
            if(pr.owner!==null) document.getElementById(`s${i}`).style.border = `4px solid ${state.players[pr.owner].color}`;
            if(state.players[pr.owner]?.id === myId) dl.innerHTML += `<div class="deed-item">${BD[i].n}</div>`;
        });
    },
    dice:(d1,d2)=>{
        const o=document.getElementById('dice-view'); o.style.display='flex';
        const c1=document.querySelector('#d1 .cube'), c2=document.querySelector('#d2 .cube');
        c1.className='cube'; c2.className='cube'; void c1.offsetWidth;
        c1.style.transition='transform 1.5s'; c2.style.transition='transform 1.5s';
        setTimeout(()=>{ c1.classList.add('r'+d1); c2.classList.add('r'+d2); }, 50);
        setTimeout(()=>{ o.style.display='none'; }, 2500);
    }
};

const util={copy:()=>{navigator.clipboard.writeText(document.getElementById('disp-id').innerText);alert("Copiado!");}};
</script>
</body>
</html>
