<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Recife Imobili√°rio: O Grande Carnaval</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rye&family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Paleta Carnaval & Cordel */
            --paper-bg: #f4e4bc;
            --wood-frame: #5d4037;
            --frevo-red: #d50000;
            --frevo-green: #2e7d32;
            --frevo-yellow: #ffea00;
            --frevo-blue: #2962ff;
            --ink-black: #212121;
        }

        * { box-sizing: border-box; user-select: none; }
        
        body { 
            margin: 0; 
            font-family: 'Roboto', sans-serif; 
            background-color: var(--paper-bg);
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23d7ccc8' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            color: var(--ink-black); 
            height: 100vh; 
            overflow: hidden; 
            display: flex; 
        }

        h1, h2, h3, button { font-family: 'Rye', serif; letter-spacing: 1px; }

        /* --- ANIMA√á√ïES --- */
        @keyframes float { 0%, 100% { transform: translateY(0) rotate(2deg); } 50% { transform: translateY(-10px) rotate(-2deg); } }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 80% { transform: scale(1.1); } 100% { transform: scale(1); opacity: 1; } }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 50% { transform: translateX(5px); } 75% { transform: translateX(-5px); } 100% { transform: translateX(0); } }

        /* --- LOBBY (CORDEL) --- */
        #lobby { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; background-image: url('https://www.transparenttextures.com/patterns/wood-pattern.png'); }
        
        .cordel-card { 
            background: #fff; 
            padding: 40px; 
            width: 90%; 
            max-width: 500px; 
            text-align: center;
            border: 4px solid var(--ink-black);
            box-shadow: 10px 10px 0px var(--ink-black);
            position: relative;
            background-image: radial-gradient(#eee 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        .cordel-img { width: 100px; height: 100px; margin: 0 auto 20px; background: var(--ink-black); mask-image: url('https://upload.wikimedia.org/wikipedia/commons/thumb/b/b1/Bandeira_de_Pernambuco.svg/1200px-Bandeira_de_Pernambuco.svg.png'); mask-size: contain; mask-repeat: no-repeat; mask-position: center; -webkit-mask-image: url('https://upload.wikimedia.org/wikipedia/commons/thumb/b/b1/Bandeira_de_Pernambuco.svg/1200px-Bandeira_de_Pernambuco.svg.png'); -webkit-mask-size: contain; -webkit-mask-repeat: no-repeat; -webkit-mask-position: center; }

        .lobby-btn { 
            width: 100%; padding: 18px; margin-top: 15px; border: 3px solid var(--ink-black); 
            font-size: 1.2rem; cursor: pointer; transition: 0.2s; text-transform: uppercase;
            box-shadow: 5px 5px 0px rgba(0,0,0,0.2); position: relative; overflow: hidden;
        }
        .lobby-btn:active { transform: translate(2px, 2px); box-shadow: 3px 3px 0px rgba(0,0,0,0.2); }
        .btn-host { background: var(--frevo-yellow); color: var(--ink-black); }
        .btn-join { background: var(--frevo-green); color: white; }
        .btn-start { background: var(--frevo-red); color: white; animation: float 3s infinite; }
        
        input { 
            width: 100%; padding: 15px; margin-bottom: 10px; 
            border: 3px solid var(--ink-black); font-family: 'Roboto'; font-size: 1.1rem; 
            background: #fff8e1; border-radius: 0;
        }

        /* --- LAYOUT DO JOGO --- */
        #game-layout { display: flex; width: 100%; height: 100%; opacity: 0; pointer-events: none; transition: opacity 1s; }
        #game-layout.active { opacity: 1; pointer-events: all; }

        /* --- SIDEBAR (O FOLHETO) --- */
        #sidebar { 
            width: 350px; background: #fffde7; display: flex; flex-direction: column; padding: 20px; 
            border-right: 8px solid var(--wood-frame); 
            box-shadow: 10px 0 30px rgba(0,0,0,0.5); z-index: 20; 
            background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23d7ccc8' fill-opacity='0.4' fill-rule='evenodd'%3E%3Ccircle cx='3' cy='3' r='3'/%3E%3Ccircle cx='13' cy='13' r='3'/%3E%3C/g%3E%3C/svg%3E");
        }

        .logo-area { text-align: center; margin-bottom: 10px; border-bottom: 2px dashed var(--wood-frame); padding-bottom: 10px; }
        .logo-area h1 { margin: 0; font-size: 2.5rem; color: var(--frevo-red); text-shadow: 2px 2px var(--frevo-yellow); transform: rotate(-2deg); }

        #turn-display { 
            background: var(--ink-black); color: var(--frevo-yellow); 
            padding: 15px; text-align: center; font-size: 1.2rem; margin-bottom: 10px;
            border: 3px double white; box-shadow: 0 5px 10px rgba(0,0,0,0.3);
        }

        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .ctrl-btn { 
            padding: 12px; border: 3px solid var(--ink-black); font-weight: bold; cursor: pointer; 
            font-size: 0.9rem; text-transform: uppercase; opacity: 0.5; pointer-events: none; 
            transition: 0.2s; box-shadow: 4px 4px 0px rgba(0,0,0,0.2); 
        }
        .ctrl-btn.enabled { opacity: 1; pointer-events: all; transform: translateY(-2px); }
        .ctrl-btn.enabled:active { transform: translateY(0); box-shadow: 2px 2px 0px rgba(0,0,0,0.2); }

        /* Portf√≥lio (Lista de Im√≥veis) */
        #my-portfolio { 
            flex-grow: 1; border: 3px solid var(--wood-frame); background: #fff; margin: 15px 0; 
            padding: 10px; overflow-y: auto; position: relative;
        }
        #my-portfolio::before { content: 'MEUS T√çTULOS üìú'; display: block; text-align: center; font-family: 'Rye'; border-bottom: 2px solid #ccc; margin-bottom: 5px; }
        .port-item { font-size: 0.8rem; padding: 5px; border-bottom: 1px dotted #ccc; display: flex; align-items: center; }
        .dot { width: 12px; height: 12px; border: 1px solid black; margin-right: 8px; }

        /* --- TABULEIRO (A MESA) --- */
        #board-container { 
            flex-grow: 1; display: flex; justify-content: center; align-items: center; 
            background: #263238; position: relative; overflow: hidden;
            background-image: radial-gradient(circle, #37474f 10%, #263238 90%);
        }
        
        #board { 
            display: grid; grid-template-columns: repeat(11, 1fr); grid-template-rows: repeat(11, 1fr); 
            width: 92vh; height: 92vh; background: #fff; border: 15px solid var(--wood-frame); 
            box-shadow: 0 0 50px rgba(0,0,0,0.8); position: relative; 
            border-radius: 5px;
        }

        .space { border: 1px solid #aaa; position: relative; display: flex; flex-direction: column; text-align: center; background: #fff8e1; font-size: 0.6rem; font-weight: bold; }
        .corner { background: #cfd8dc; display: flex; justify-content: center; align-items: center; font-size: 0.8rem; text-align: center; }
        
        .color-header { height: 25%; width: 100%; border-bottom: 2px solid var(--ink-black); position: relative; background-image: repeating-linear-gradient(45deg, transparent, transparent 5px, rgba(255,255,255,0.3) 5px, rgba(255,255,255,0.3) 10px); }
        .space-body { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; padding: 2px; }

        /* CENTRO (SOMBRINHA ANIMADA) */
        .center-decor { 
            grid-column: 2 / 11; grid-row: 2 / 11; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            position: relative; overflow: hidden; background: #e0f7fa; z-index: 1;
            border: 5px solid var(--wood-frame);
        }
        
        /* O EFEITO DA SOMBRINHA GIGANTE GIRANDO NO FUNDO */
        .frevo-bg {
            position: absolute; width: 200%; height: 200%;
            background: conic-gradient(
                var(--frevo-red) 0deg 45deg, 
                var(--frevo-green) 45deg 90deg, 
                var(--frevo-yellow) 90deg 135deg, 
                var(--frevo-blue) 135deg 180deg,
                var(--frevo-red) 180deg 225deg, 
                var(--frevo-green) 225deg 270deg, 
                var(--frevo-yellow) 270deg 315deg, 
                var(--frevo-blue) 315deg 360deg
            );
            opacity: 0.15;
            animation: spin 20s linear infinite;
            z-index: 0;
        }

        .center-content { z-index: 2; text-align: center; background: rgba(255,255,255,0.9); padding: 30px; border-radius: 50%; border: 5px dashed var(--frevo-red); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .center-title { font-size: 4rem; margin: 0; color: var(--frevo-blue); text-shadow: 3px 3px var(--frevo-yellow); -webkit-text-stroke: 1px black; }

        /* TOKENS E CONSTRU√á√ïES */
        .token { 
            width: 35px; height: 35px; position: absolute; z-index: 20; 
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            font-size: 2rem; display: flex; justify-content: center; align-items: center;
            filter: drop-shadow(3px 3px 2px rgba(0,0,0,0.5));
        }
        
        .house { width: 10px; height: 10px; background: var(--frevo-green); border: 1px solid black; display: inline-block; margin: 0 1px; }
        .hotel { width: 14px; height: 14px; background: var(--frevo-red); border: 1px solid black; display: inline-block; }
        .build-row { position: absolute; top: 0; left: 0; width: 100%; text-align: center; z-index: 15; }
        .owner-border { position: absolute; inset: 0; border: 0px solid transparent; pointer-events: none; z-index: 5; }

        /* --- DADOS 3D (O SHOW) --- */
        #dice-stage { position: fixed; inset: 0; pointer-events: none; z-index: 5000; display: none; perspective: 1000px; justify-content: center; align-items: center; }
        .dice-wrap { position: relative; width: 100px; height: 100px; transform-style: preserve-3d; margin: 50px; }
        .cube { width: 100%; height: 100%; position: absolute; transform-style: preserve-3d; transition: transform 1s ease-out; }
        .face { position: absolute; width: 100px; height: 100px; background: #fff; border: 4px solid black; border-radius: 10px; display: flex; justify-content: center; align-items: center; font-size: 3rem; font-weight: bold; backface-visibility: hidden; box-shadow: inset 0 0 20px rgba(0,0,0,0.1); }
        .face:nth-child(1) { transform: translateZ(50px); }
        .face:nth-child(2) { transform: rotateY(180deg) translateZ(50px); }
        .face:nth-child(3) { transform: rotateY(90deg) translateZ(50px); }
        .face:nth-child(4) { transform: rotateY(-90deg) translateZ(50px); }
        .face:nth-child(5) { transform: rotateX(90deg) translateZ(50px); }
        .face:nth-child(6) { transform: rotateX(-90deg) translateZ(50px); }
        
        .anim-roll { animation: tumble 1.5s ease-out forwards; }
        @keyframes tumble { 
            0% { transform: rotateX(720deg) rotateY(360deg) scale(0.1); opacity: 0; } 
            50% { transform: scale(1.2); } 
            100% { transform: rotateX(0) rotateY(0) scale(1); opacity: 1; } 
        }

        /* --- TOASTS CULTURAIS --- */
        .toast-area { position: absolute; top: 10%; width: 100%; text-align: center; pointer-events: none; z-index: 900; }
        .toast { 
            display: inline-block; background: #fff; border: 4px solid var(--frevo-blue); color: black; 
            padding: 15px 30px; font-size: 1.2rem; font-weight: bold; border-radius: 50px; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.3); animation: popIn 0.3s forwards;
            font-family: 'Rye';
        }

        /* --- MODAIS --- */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 2000; justify-content: center; align-items: center; }
        .modal-box { background: var(--paper-bg); padding: 25px; border: 5px solid var(--wood-frame); max-width: 600px; width: 90%; text-align: center; position: relative; box-shadow: 0 0 50px black; }
        
        /* Responsividade Mobile */
        @media (max-width: 900px) {
            body { flex-direction: column; height: auto; overflow-y: auto; }
            #sidebar { width: 100%; order: 2; height: auto; border-right: none; border-top: 10px solid var(--wood-frame); }
            #board-container { height: 95vw; order: 1; }
            #board { width: 100%; height: 100%; border-width: 5px; }
            .token { width: 25px; height: 25px; font-size: 1.5rem; }
        }
    </style>
</head>
<body>

<div id="lobby">
    <div class="cordel-card">
        <div class="cordel-img"></div>
        <h1 style="margin:0; color:var(--frevo-red); font-size:2.5rem; text-shadow:2px 2px #000;">RECIFE IMOBILI√ÅRIO</h1>
        <h3 style="margin-top:5px;">Edi√ß√£o: O Grande Carnaval üéâ</h3>
        
        <div id="lobby-input">
            <input type="text" id="my-name" placeholder="Seu Apelido de Foli√£o" maxlength="10">
            <div style="margin:10px 0; font-weight:bold;">Escolha seu Pe√£o:</div>
            <select id="my-avatar" style="width:100%; padding:10px; font-size:1.2rem; margin-bottom:10px; border:3px solid black;">
                <option value="ü¶Ä">ü¶Ä Caranguejo</option>
                <option value="‚òÇÔ∏è">‚òÇÔ∏è Sombrinha</option>
                <option value="ü¶à">ü¶à Tubar√£o</option>
                <option value="‚òÄÔ∏è">‚òÄÔ∏è Sol</option>
                <option value="ü•Å">ü•Å Tambor</option>
                <option value="üêì">üêì Galo</option>
            </select>
            
            <button class="lobby-btn btn-host" onclick="net.hostGame()">üè† Criar Bloco (Sala)</button>
            <div style="margin:10px; font-weight:bold; color:white;">‚Äî OU ‚Äî</div>
            <input type="text" id="host-id-input" placeholder="C√≥digo do Bloco">
            <button class="lobby-btn btn-join" onclick="net.joinGame()">üîó Entrar na Folia</button>
        </div>

        <div id="lobby-wait" style="display:none;">
            <h2>Bloco Formado!</h2>
            <p>Mande esse c√≥digo pra galera:</p>
            <div style="background:#fff; padding:10px; border:3px dashed black; font-size:1.5rem; font-family:monospace; cursor:pointer;" onclick="ui.copyId()" id="my-id-display">...</div>
            <ul id="lobby-list" style="list-style:none; padding:0; font-size:1.2rem; font-weight:bold;"></ul>
            <button class="lobby-btn btn-start" onclick="net.startGame()">üöÄ COME√áAR O DESFILE</button>
        </div>
    </div>
</div>

<div id="dice-stage">
    <div class="dice-wrap"><div id="cube1" class="cube">
        <div class="face">1</div><div class="face">6</div><div class="face">3</div><div class="face">4</div><div class="face">5</div><div class="face">2</div>
    </div></div>
    <div class="dice-wrap"><div id="cube2" class="cube">
        <div class="face">1</div><div class="face">6</div><div class="face">3</div><div class="face">4</div><div class="face">5</div><div class="face">2</div>
    </div></div>
</div>

<div id="game-layout">
    <div id="board-container">
        <div id="board">
            <div class="center-decor">
                <div class="frevo-bg"></div>
                <div class="center-content">
                    <h1 class="center-title">RECIFE</h1>
                    <h3 style="margin:0;">Imobili√°rio</h3>
                    <div id="weather-badge" style="margin-top:10px; font-weight:bold; background:yellow; padding:5px 10px; border:2px solid black;">‚òÄÔ∏è Sol de Rachar</div>
                </div>
                <div class="toast-area" id="toast-area"></div>
            </div>
            </div>
    </div>

    <div id="sidebar">
        <div class="logo-area">
            <h1>Pernambuco</h1>
            <small style="font-weight:bold;">O Mestre da Cidade</small>
        </div>
        
        <div id="turn-display">Aguardando...</div>
        
        <div id="my-portfolio"></div>

        <div class="action-grid">
            <button id="btn-roll" class="ctrl-btn" style="background:var(--frevo-yellow); color:black; font-size:1.1rem; grid-column:span 2;">üé≤ JOGAR DADOS</button>
            <button id="btn-buy" class="ctrl-btn" style="background:var(--frevo-green); color:white;">üí∞ COMPRAR</button>
            <button id="btn-trade" class="ctrl-btn" style="background:var(--frevo-blue); color:white;">ü§ù NEGOCIAR</button>
            <button id="btn-bail" class="ctrl-btn" style="background:#90a4ae; color:black;">üí∏ FLANELINHA</button>
            <button id="btn-end" class="ctrl-btn" style="background:var(--frevo-red); color:white;">üõë PASSAR</button>
        </div>
        
        <div style="margin-top:15px; border-top:2px dashed black; padding-top:10px;">
            <b style="font-family:'Rye'">Jogadores:</b>
            <div id="players-list"></div>
        </div>
    </div>
</div>

<div id="trade-modal" class="modal-overlay">
    <div class="modal-box">
        <h2>ü§ù Feira de Caruaru (Negocia√ß√£o)</h2>
        <select id="trade-partner" style="padding:10px; width:100%; margin-bottom:10px; font-family:'Rye';"></select>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; text-align:left;">
            <div style="background:#fff; padding:10px; border:1px solid black; height:200px; overflow:auto;">
                <b>Voc√™ d√°:</b><div id="trade-give"></div>
                Cash: $<input id="trade-cash-give" type="number" value="0" style="width:60px;">
            </div>
            <div style="background:#fff; padding:10px; border:1px solid black; height:200px; overflow:auto;">
                <b>Voc√™ quer:</b><div id="trade-want"></div>
                Cash: $<input id="trade-cash-want" type="number" value="0" style="width:60px;">
            </div>
        </div>
        <div style="margin-top:15px; display:flex; gap:10px; justify-content:center;">
            <button class="lobby-btn" style="width:auto; background:#ccc;" onclick="ui.closeTrade()">Cancelar</button>
            <button class="lobby-btn" style="width:auto; background:var(--frevo-green); color:white;" onclick="trade.send()">ENVIAR PROPOSTA</button>
        </div>
    </div>
</div>

<div id="offer-modal" class="modal-overlay">
    <div class="modal-box">
        <h2>üì® Proposta na Mesa!</h2>
        <div id="offer-content" style="background:white; padding:10px; margin:10px 0; text-align:left;"></div>
        <div style="display:flex; gap:10px; justify-content:center;">
            <button class="lobby-btn" style="width:auto; background:var(--frevo-red); color:white;" onclick="trade.reply(false)">N√ÉO QUERO</button>
            <button class="lobby-btn" style="width:auto; background:var(--frevo-green); color:white;" onclick="trade.reply(true)">FECHADO!</button>
        </div>
    </div>
</div>

<script>
/* DADOS DO JOGO */
const COLORS = { brown: '#795548', lightblue: '#03a9f4', pink: '#e91e63', orange: '#ff5722', red: '#d32f2f', yellow: '#fbc02d', green: '#388e3c', blue: '#1565c0' };
const BOARD = [
    {type:'start',name:'MARCO ZERO'}, {type:'prop',group:'brown',name:'Rua da Aurora',price:60,cost:50,rent:[2,10,30,90,160,250]}, {type:'chance',name:'Sorte/Rev√©s'}, {type:'prop',group:'brown',name:'Rua do Imperador',price:60,cost:50,rent:[4,20,60,180,320,450]}, {type:'tax',name:'IPTU',price:200}, {type:'station',name:'Metr√¥ Centro',price:200}, {type:'prop',group:'lightblue',name:'Varadouro',price:100,cost:50,rent:[6,30,90,270,400,550]}, {type:'chance',name:'Sorte/Rev√©s'}, {type:'prop',group:'lightblue',name:'Carmo (Galo)',price:100,cost:50,rent:[6,30,90,270,400,550]}, {type:'prop',group:'lightblue',name:'Alto da S√©',price:120,cost:50,rent:[8,40,100,300,450,600]},
    {type:'jail',name:'Tr√¢nsito Parado'}, {type:'prop',group:'pink',name:'Cordeiro',price:140,cost:100,rent:[10,50,150,450,750,950]}, {type:'utility',name:'Neoenergia',price:150}, {type:'prop',group:'pink',name:'V√°rzea',price:140,cost:100,rent:[10,50,150,450,750,950]}, {type:'prop',group:'pink',name:'Iputinga',price:160,cost:100,rent:[12,60,180,500,700,900]}, {type:'station',name:'Metr√¥ Oeste',price:200}, {type:'prop',group:'orange',name:'Torre',price:180,cost:100,rent:[14,70,200,550,750,950]}, {type:'chance',name:'Sorte/Rev√©s'}, {type:'prop',group:'orange',name:'Madalena',price:180,cost:100,rent:[14,70,200,550,750,950]}, {type:'prop',group:'orange',name:'Gra√ßas',price:200,cost:100,rent:[16,80,220,600,800,1000]},
    {type:'parking',name:'Parque da Jaqueira'}, {type:'prop',group:'red',name:'Espinheiro',price:220,cost:150,rent:[18,90,250,700,875,1050]}, {type:'chance',name:'Sorte/Rev√©s'}, {type:'prop',group:'red',name:'Aflitos',price:220,cost:150,rent:[18,90,250,700,875,1050]}, {type:'prop',group:'red',name:'Casa Forte',price:240,cost:150,rent:[20,100,300,750,925,1100]}, {type:'station',name:'Via Mangue',price:200}, {type:'prop',group:'yellow',name:'Po√ßo da Panela',price:260,cost:150,rent:[22,110,330,800,975,1150]}, {type:'prop',group:'yellow',name:'Apipucos',price:260,cost:150,rent:[22,110,330,800,975,1150]}, {type:'utility',name:'Compesa',price:150}, {type:'prop',group:'yellow',name:'Parnamirim',price:280,cost:150,rent:[24,120,360,850,1025,1200]},
    {type:'gotojail',name:'V√° p/ Tr√¢nsito'}, {type:'prop',group:'green',name:'Imbiribeira',price:300,cost:200,rent:[26,130,390,900,1100,1275]}, {type:'prop',group:'green',name:'Pina',price:300,cost:200,rent:[26,130,390,900,1100,1275]}, {type:'chance',name:'Sorte/Rev√©s'}, {type:'prop',group:'green',name:'Paiva',price:320,cost:200,rent:[28,150,450,1000,1200,1400]}, {type:'station',name:'Aeroporto',price:200}, {type:'chance',name:'Sorte/Rev√©s'}, {type:'prop',group:'blue',name:'Set√∫bal',price:350,cost:200,rent:[35,175,500,1100,1300,1500]}, {type:'tax',name:'Taxa de Luxo',price:100}, {type:'prop',group:'blue',name:'Boa Viagem',price:400,cost:200,rent:[50,200,600,1400,1700,2000]}
];
const CARDS = [ {t:"Ganhou na Loteria!",v:150,type:'money'}, {t:"Multa da CTTU.",v:-50,type:'money'}, {t:"Vendeu Bolo de Rolo.",v:100,type:'money'}, {t:"Reforma no AP.",v:-100,type:'money'}, {t:"Achou dinheiro em Boa Viagem.",v:20,type:'money'}, {t:"Blitz! V√° pro Tr√¢nsito.",type:'jail'}, {t:"V√° para o Carmo (Galo).",type:'move',pos:8}, {t:"Volte 3 casas.",type:'move_back',val:3} ];

/* SOM */
const SOUNDS = { 
    bg: new Audio('https://upload.wikimedia.org/wikipedia/commons/6/6e/Frevo_-_Vassourinhas.ogg'), 
    dice: new Audio('https://www.soundjay.com/misc/sounds/dice-roll-1.mp3'),
    cash: new Audio('https://www.soundjay.com/misc/sounds/coins-in-hand-2.mp3'),
    shark: new Audio('https://www.myinstants.com/media/sounds/tubarao-te-amo.mp3'),
    galo: new Audio('https://www.myinstants.com/media/sounds/hino-do-galo-da-madrugada.mp3')
};
SOUNDS.bg.loop = true; SOUNDS.bg.volume = 0.2;
const playSfx = (k) => { try{ SOUNDS[k].currentTime=0; SOUNDS[k].play().catch(e=>{}); }catch(e){} };
const startMusic = () => { try{ SOUNDS.bg.play().catch(e=>{}); }catch(e){} };

/* REDE E ESTADO */
let myId=null, hostConn=null, conns=[], isHost=false, myName="Foli√£o", myAvatar="ü¶Ä";
let state = { players:[], props:BOARD.map(()=>({owner:null,level:0})), turn:0, rolled:false, doubles:0, weather:'sun', galoCooldown:0 };
let currentOffer = null;

const net = {
    peer: new Peer(null,{debug:1}),
    init:()=>{
        net.peer.on('open',id=>myId=id);
        net.peer.on('connection',c=>{ if(!isHost)return; c.on('data',d=>net.handleData(d,c)); conns.push(c); });
        net.peer.on('error',e=>alert("Erro P2P: "+e));
    },
    hostGame:()=>{
        myName = document.getElementById('my-name').value || "Mestre";
        myAvatar = document.getElementById('my-avatar').value;
        if(!myId) return alert("Aguarde o ID...");
        isHost=true;
        state.players.push({id:myId,name:myName,avatar:myAvatar,color:'#d32f2f',money:1500,pos:0,jailed:false,turnsJailed:0,out:false});
        ui.toLobbyWait();
        startMusic();
    },
    joinGame:()=>{
        myName = document.getElementById('my-name').value || "Visitante";
        myAvatar = document.getElementById('my-avatar').value;
        const id = document.getElementById('host-id-input').value;
        if(!id) return alert("Cole o c√≥digo!");
        hostConn = net.peer.connect(id);
        hostConn.on('open', ()=>{ hostConn.send({type:'JOIN',name:myName,avatar:myAvatar}); document.querySelector('.cordel-card').innerHTML="<h3>Conectado! Aguardando o Mestre...</h3>"; startMusic(); });
        hostConn.on('data', d => net.handleClient(d));
    },
    startGame:()=>{ if(state.players.length<2)return alert("Precisa de 2 foli√µes!"); net.broadcast({type:'START',state:state}); game.start(state); },
    handleData:(d,conn)=>{
        if(d.type==='JOIN'){
            const clrs = ['#1976d2','#388e3c','#fbc02d','#8e24aa'];
            state.players.push({id:conn.peer,name:d.name,avatar:d.avatar,color:clrs[state.players.length%4],money:1500,pos:0,jailed:false,turnsJailed:0,out:false});
            net.broadcast({type:'LOBBY_UPD',list:state.players});
        }
        else if(d.type==='ACT') game.process(d.act,d.val,d.pid);
        else if(d.type==='TRADE_OFFER') trade.process(d.offer);
        else if(d.type==='TRADE_RESP') trade.finish(d.resp);
    },
    handleClient:(d)=>{
        if(d.type==='LOBBY_UPD') ui.updLobby(d.list);
        else if(d.type==='START') game.start(d.state);
        else if(d.type==='STATE') { state=d.state; ui.render(); }
        else if(d.type==='TOAST') ui.toast(d.msg,d.sub);
        else if(d.type==='SFX') playSfx(d.key);
        else if(d.type==='ANIM_DICE') ui.animDice(d.d1, d.d2);
        else if(d.type==='TRADE_SHOW') trade.show(d.offer);
    },
    broadcast:(msg)=>{
        if(isHost){ conns.forEach(c=>c.send(msg)); if(msg.type==='STATE')ui.render(); if(msg.type==='TOAST')ui.toast(msg.msg,msg.sub); if(msg.type==='SFX')playSfx(msg.key); if(msg.type==='ANIM_DICE')ui.animDice(msg.d1,msg.d2); if(msg.type==='TRADE_SHOW')trade.show(msg.offer); }
        else hostConn.send(msg);
    }
};

/* L√ìGICA DO JOGO */
const game = {
    start:(s)=>{ state=s; document.getElementById('lobby').style.display='none'; document.getElementById('game-layout').classList.add('active'); ui.initBoard(); ui.binds(); ui.render(); },
    act:(t,v)=>{ if(isHost) game.process(t,v,myId); else hostConn.send({type:'ACT',act:t,val:v,pid:myId}); },
    process:(act,val,pid)=>{
        const idx = state.players.findIndex(p=>p.id===pid), p = state.players[idx];
        if(state.turn !== idx || p.out) return;

        if(act==='roll'){
            if(state.rolled) return;
            const d1=Math.ceil(Math.random()*6), d2=Math.ceil(Math.random()*6);
            net.broadcast({type:'ANIM_DICE', d1:d1, d2:d2});
            
            setTimeout(()=>{
                if(p.jailed){
                    if(d1===d2){ p.jailed=false; p.turnsJailed=0; net.broadcast({type:'TOAST',msg:"Saiu do Tr√¢nsito!",sub:"Dados iguais"}); game.move(p,d1+d2); state.rolled=true; }
                    else{ p.turnsJailed++; if(p.turnsJailed>=3){ p.money-=50; p.jailed=false; p.turnsJailed=0; net.broadcast({type:'TOAST',msg:"Pagou $50 for√ßado",sub:"Tempo esgotado"}); game.move(p,d1+d2); } else net.broadcast({type:'TOAST',msg:"Continua preso...",sub:`${p.turnsJailed}/3`}); state.rolled=true; }
                } else {
                    if(d1===6&&d2===6&&state.galoCooldown===0){ net.broadcast({type:'TOAST',msg:"üêì GALO DA MADRUGADA!",sub:"Todos pro Centro!"}); net.broadcast({type:'SFX',key:'galo'}); state.players.forEach(pl=>{if(!pl.out){pl.pos=8;pl.money-=50;}}); state.galoCooldown=4; state.rolled=true; }
                    else{
                        if(d1===d2)state.doubles++; else state.doubles=0;
                        if(state.doubles>=3){ net.broadcast({type:'TOAST',msg:"Excesso de Velocidade!",sub:"Preso"}); game.toJail(p); game.endTurn(); return; }
                        game.move(p,d1+d2);
                        if(d1!==d2)state.rolled=true; else net.broadcast({type:'TOAST',msg:"Dados Iguais!",sub:"Jogue de novo"});
                    }
                }
                net.broadcast({type:'STATE',state:state});
            }, 2000); // Wait for anim
        }
        else if(act==='buy'){ const s=BOARD[p.pos]; if(p.money>=s.price && state.props[p.pos].owner===null){ p.money-=s.price; state.props[p.pos].owner=idx; net.broadcast({type:'TOAST',msg:`Comprou ${s.name}`,sub:`-$${s.price}`}); net.broadcast({type:'SFX',key:'cash'}); net.broadcast({type:'STATE',state:state}); }}
        else if(act==='bail'){ if(p.jailed && p.money>=50){ p.money-=50; p.jailed=false; p.turnsJailed=0; state.rolled=false; net.broadcast({type:'TOAST',msg:"Pagou Flanelinha",sub:"Livre"}); net.broadcast({type:'SFX',key:'cash'}); net.broadcast({type:'STATE',state:state}); }}
        else if(act==='end'){ state.turn=(state.turn+1)%state.players.length; while(state.players[state.turn].out)state.turn=(state.turn+1)%state.players.length; state.rolled=false; state.doubles=0; if(state.galoCooldown>0)state.galoCooldown--; if(Math.random()<0.15){ state.weather=state.weather==='sun'?'rain':'sun'; net.broadcast({type:'TOAST',msg:state.weather==='rain'?'üåßÔ∏è Chuva Forte!':'‚òÄÔ∏è O Sol abriu!',sub:state.weather==='rain'?'Alagamentos':'Normal'}); } net.broadcast({type:'STATE',state:state}); }
    },
    move:(p,steps)=>{
        p.pos+=steps; if(p.pos>=40){p.pos-=40;p.money+=200;net.broadcast({type:'TOAST',msg:"13¬∫ Sal√°rio!",sub:"+$200"});}
        const s=BOARD[p.pos], pr=state.props[p.pos];
        if(s.type==='chance'){ const c=CARDS[Math.floor(Math.random()*CARDS.length)]; net.broadcast({type:'TOAST',msg:"Sorte ou Rev√©s",sub:c.t}); if(c.type==='money')p.money+=c.v; else if(c.type==='jail')game.toJail(p); else if(c.type==='move')p.pos=c.pos; else if(c.type==='move_back')p.pos-=c.val; }
        else if(s.type==='gotojail'){ game.toJail(p); net.broadcast({type:'TOAST',msg:"Blitz!",sub:"V√° pro Tr√¢nsito"}); }
        else if(s.type==='tax'){ p.money-=s.price; net.broadcast({type:'TOAST',msg:"Imposto",sub:`-$${s.price}`}); }
        else if(pr.owner!==null && pr.owner!==state.players.indexOf(p)){
            const isFlood=state.weather==='rain'&&(s.group==='green'||s.group==='orange'||s.group==='pink');
            if(isFlood) net.broadcast({type:'TOAST',msg:"Rua Alagada!",sub:"Aluguel Gr√°tis"});
            else{ let r=(s.type==='prop'?s.rent[pr.level]:(s.type==='station'?50:100)); p.money-=r; state.players[pr.owner].money+=r; net.broadcast({type:'TOAST',msg:`Aluguel para ${state.players[pr.owner].name}`,sub:`-$${r}`}); net.broadcast({type:'SFX',key:'cash'}); }
        }
        if(['Boa Viagem','Pina','Paiva'].some(x=>s.name.includes(x))&&Math.random()<0.25){ p.money-=100; net.broadcast({type:'TOAST',msg:"TUBAR√ÉO! ü¶à",sub:"-$100"}); net.broadcast({type:'SFX',key:'shark'}); }
        if(p.money<0) { p.out=true; state.props.forEach(pp=>{if(pp.owner===state.players.indexOf(p)){pp.owner=null;pp.level=0;}}); net.broadcast({type:'TOAST',msg:`${p.name} FALIU!`,sub:"Game Over"}); }
    },
    toJail:(p)=>{ p.pos=10; p.jailed=true; p.turnsJailed=0; state.rolled=true; }
};

/* SISTEMA DE TROCAS */
const trade = {
    openUI:()=>{
        const partner = document.getElementById('trade-partner'); partner.innerHTML='<option value="">Escolha o Parceiro...</option>';
        state.players.forEach((p,i)=>{ if(p.id!==myId && !p.out) partner.innerHTML+=`<option value="${p.id}">${p.name}</option>`; });
        renderTradeList(myId, 'trade-give');
        partner.onchange=()=>{ if(partner.value) renderTradeList(partner.value, 'trade-want'); };
        document.getElementById('trade-modal').style.display='flex';
    },
    send:()=>{
        const to = document.getElementById('trade-partner').value; if(!to)return alert("Escolha algu√©m!");
        const offer = {
            from: myId, to: to,
            gProps: getChecks('trade-give'), gCash: parseInt(document.getElementById('trade-cash-give').value)||0,
            wProps: getChecks('trade-want'), wCash: parseInt(document.getElementById('trade-cash-want').value)||0
        };
        if(isHost) trade.process(offer); else hostConn.send({type:'TRADE_OFFER', offer:offer});
        document.getElementById('trade-modal').style.display='none';
    },
    process:(off)=>{ net.broadcast({type:'TRADE_SHOW',offer:off}, off.to); }, // Should target specific, broad for now
    show:(off)=>{
        if(off.to !== myId) return;
        currentOffer = off;
        const name = state.players.find(p=>p.id===off.from).name;
        let h = `<b>${name} oferece:</b><br>`;
        off.gProps.forEach(i=>h+=`- ${BOARD[i].name}<br>`); if(off.gCash)h+=`- $${off.gCash}<br>`;
        h+=`<hr><b>Em troca de:</b><br>`;
        off.wProps.forEach(i=>h+=`- ${BOARD[i].name}<br>`); if(off.wCash)h+=`- $${off.wCash}`;
        document.getElementById('offer-content').innerHTML=h;
        document.getElementById('offer-modal').style.display='flex';
    },
    reply:(ok)=>{
        document.getElementById('offer-modal').style.display='none';
        const resp = {offer:currentOffer, ok:ok};
        if(isHost) trade.finish(resp); else hostConn.send({type:'TRADE_RESP', resp:resp});
    },
    finish:(r)=>{
        const {offer, ok} = r;
        if(ok){
            const p1 = state.players.find(p=>p.id===offer.from), p2 = state.players.find(p=>p.id===offer.to);
            const idx1 = state.players.indexOf(p1), idx2 = state.players.indexOf(p2);
            p1.money -= offer.gCash; p2.money += offer.gCash;
            p2.money -= offer.wCash; p1.money += offer.wCash;
            offer.gProps.forEach(i=>{state.props[i].owner=idx2;state.props[i].level=0;});
            offer.wProps.forEach(i=>{state.props[i].owner=idx1;state.props[i].level=0;});
            net.broadcast({type:'TOAST',msg:"Neg√≥cio Fechado!",sub:"ü§ù"});
            net.broadcast({type:'STATE',state:state});
        }
    }
};
const renderTradeList=(pid, divId)=>{
    const d=document.getElementById(divId); d.innerHTML='';
    const idx = state.players.findIndex(p=>p.id===pid);
    BOARD.forEach((b,i)=>{ if(b.type==='prop' && state.props[i].owner===idx) d.innerHTML+=`<div><input type="checkbox" value="${i}"> ${b.name}</div>`; });
};
const getChecks=(divId)=>Array.from(document.querySelectorAll(`#${divId} input:checked`)).map(c=>parseInt(c.value));

/* UI */
const ui = {
    initBoard:()=>{
        const b=document.getElementById('board');
        BOARD.forEach((s,i)=>{
            const d=document.createElement('div'); d.id=`space-${i}`;
            let r,c; if(i<=10){r=11;c=11-i;}else if(i<=20){r=11-(i-10);c=1;}else if(i<=30){r=1;c=1+(i-20);}else{r=1+(i-30);c=11;}
            d.style.gridRow=r; d.style.gridColumn=c; d.className=(i%10===0)?'space corner':'space';
            if(s.type==='prop') d.innerHTML=`<div class="color-header" style="background:${COLORS[s.group]}"></div><div class="space-body">${s.name}<br>$${s.price}</div><div class="build-row" id="b-${i}"></div><div class="owner-border" id="brd-${i}"></div>`;
            else d.innerHTML=`<div style="margin:auto;">${s.name}</div>`;
            b.appendChild(d);
        });
    },
    binds:()=>{
        document.getElementById('btn-roll').onclick=()=>game.act('roll');
        document.getElementById('btn-buy').onclick=()=>game.act('buy');
        document.getElementById('btn-trade').onclick=()=>trade.openUI();
        document.getElementById('btn-bail').onclick=()=>game.act('bail');
        document.getElementById('btn-end').onclick=()=>game.act('end');
    },
    render:()=>{
        // Players List
        const pl=document.getElementById('players-list'); pl.innerHTML='';
        state.players.forEach((p,i)=>{ if(p.out)return; pl.innerHTML+=`<div style="border-left:5px solid ${p.color}; background:${state.turn===i?'#fff9c4':'#fff'}; padding:5px; margin:5px 0;">${p.avatar} ${p.name}: $${p.money}</div>`; });
        
        // Buttons & Turn
        const myP=state.players.find(p=>p.id===myId), turn=state.players[state.turn], amITurn=myP && turn.id===myId && !myP.out;
        document.getElementById('turn-display').innerText = `Vez de: ${turn.name} ${turn.avatar}`;
        ui.btn('btn-roll', amITurn && !state.rolled);
        ui.btn('btn-buy', amITurn && state.rolled && !myP.jailed && BOARD[myP.pos].type==='prop' && state.props[myP.pos].owner===null);
        ui.btn('btn-trade', amITurn && !state.rolled);
        ui.btn('btn-bail', amITurn && myP.jailed && !state.rolled);
        ui.btn('btn-end', amITurn && state.rolled);

        // Weather
        document.getElementById('weather-badge').innerText = state.weather==='rain' ? 'üåßÔ∏è Chuva Forte' : '‚òÄÔ∏è Sol de Rachar';
        document.getElementById('board').style.filter = state.weather==='rain' ? 'grayscale(0.6)' : 'none';

        // Tokens & Props
        document.querySelectorAll('.token').forEach(e=>e.remove());
        state.players.forEach((p,i)=>{
            if(p.out)return;
            const t=document.createElement('div'); t.className='token'; t.innerText=p.avatar;
            const sp=document.getElementById(`space-${p.pos}`), br=document.getElementById('board').getBoundingClientRect(), sr=sp.getBoundingClientRect();
            t.style.top=(sr.top-br.top+5+(i*5))+'px'; t.style.left=(sr.left-br.left+5+(i*5))+'px';
            document.getElementById('board').appendChild(t);
        });
        state.props.forEach((pr,i)=>{
            const brd=document.getElementById(`brd-${i}`), bld=document.getElementById(`b-${i}`);
            if(brd){
                brd.style.border = pr.owner!==null ? `4px solid ${state.players[pr.owner].color}` : 'none';
                bld.innerHTML = ''; if(pr.level===5) bld.innerHTML='<div class="hotel"></div>'; else for(let k=0;k<pr.level;k++) bld.innerHTML+='<div class="house"></div>';
            }
        });
        
        // Portfolio
        const pf = document.getElementById('my-portfolio'); pf.innerHTML = '';
        if(myP) {
            const idx = state.players.indexOf(myP);
            BOARD.forEach((b,i)=>{ if(b.type==='prop' && state.props[i].owner===idx) pf.innerHTML+=`<div class="port-item"><div class="dot" style="background:${COLORS[b.group]}"></div>${b.name} (Nv.${state.props[i].level})</div>`; });
        }
    },
    animDice:(d1,d2)=>{
        const stage = document.getElementById('dice-stage'); stage.style.display='flex';
        const c1=document.getElementById('cube1'), c2=document.getElementById('cube2');
        c1.style.animation='none'; c2.style.animation='none';
        c1.offsetHeight; c2.offsetHeight; // trigger reflow
        c1.style.animation = 'tumble 1.5s ease-out forwards'; c2.style.animation = 'tumble 1.5s ease-out forwards';
        playSfx('dice');
        setTimeout(()=>{ stage.style.display='none'; }, 2000);
    },
    btn:(id,on)=>{ const b=document.getElementById(id); if(on){b.classList.add('enabled');b.disabled=false;}else{b.classList.remove('enabled');b.disabled=true;} },
    toast:(m,s)=>{ const d=document.createElement('div'); d.className='toast'; d.innerHTML=`${m}<br><small>${s||''}</small>`; document.getElementById('toast-area').appendChild(d); setTimeout(()=>d.remove(),3000); },
    toLobbyWait:()=>{ document.getElementById('lobby-input').style.display='none'; document.getElementById('lobby-wait').style.display='block'; document.getElementById('my-id-display').innerText=myId; },
    updLobby:(l)=>{ document.getElementById('lobby-list').innerHTML=l.map(p=>`<li>${p.avatar} ${p.name}</li>`).join(''); },
    copyId:()=>{ navigator.clipboard.writeText(myId); alert("Copiado!"); },
    closeTrade:()=>{ document.getElementById('trade-modal').style.display='none'; }
};

net.init();
</script>
</body>
</html>
