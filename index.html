<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Recife Imobili√°rio: Multiplayer Online</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Titan+One&family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --wood: #5d4037; --paper: #fff8e1;
            --c-blue: #0277bd; --c-red: #d32f2f; --c-green: #2e7d32; --c-yel: #fbc02d;
            --c-dark: #263238; --board-bg: #c5e1a5; 
            --space-bg: #ffffff; --border-col: #1a1a1a;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; font-family: 'Nunito', sans-serif; 
            background: linear-gradient(120deg, #1565c0, #fbc02d, #c62828, #1565c0);
            background-size: 400% 400%;
            animation: frevoBG 15s ease infinite;
            height: 100dvh; overflow: hidden; display: flex; flex-direction: column;
        }
        @keyframes frevoBG { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }

        h1, h2, h3, button, .brand, .deck, .token { font-family: 'Titan One', cursive; letter-spacing: 1px; text-shadow: 2px 2px 0 rgba(0,0,0,0.3); }

        /* --- UI MODALS --- */
        #screen-login, #screen-lobby, #screen-char, #screen-end { position: fixed; inset: 0; z-index: 9999; background: rgba(0,0,0,0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; overflow-y: auto; }
        #screen-lobby, #screen-char, #screen-end { display: none; }
        
        .card-menu { background: #fff; border: 8px solid var(--c-dark); border-radius: 30px; padding: 25px; text-align: center; width: 90%; max-width: 450px; box-shadow: 0 20px 0 var(--c-yel); margin: auto; }
        .inp-box { width: 100%; padding: 15px; margin: 10px 0; border: 3px solid var(--c-dark); border-radius: 10px; font-size: 1.2rem; font-family: 'Nunito'; font-weight: 800; text-align: center; }
        .btn-main { width: 100%; padding: 15px; margin-top: 15px; border: none; border-radius: 50px; font-size: 1.5rem; background: var(--c-green); color: #fff; cursor: pointer; box-shadow: 0 6px 0 #1b5e20; transition: 0.1s; text-transform: uppercase; }
        .btn-main:active { transform: translateY(4px); box-shadow: 0 3px 0 #1b5e20; }
        .btn-sec { background: var(--c-blue); box-shadow: 0 6px 0 #01579b; }
        .btn-sec:active { box-shadow: 0 3px 0 #01579b; }

        /* LOBBY & CHAR SELECT */
        .player-list { list-style: none; padding: 0; margin: 20px 0; max-height: 200px; overflow-y: auto; text-align: left; }
        .player-li { background: #eee; margin: 5px 0; padding: 10px; border-radius: 8px; display: flex; justify-content: space-between; font-weight: 800; align-items: center; }
        .player-li.ready { background: #c8e6c9; border: 2px solid var(--c-green); }
        
        .char-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 15px; max-height: 40vh; overflow-y: auto; }
        .char-opt { border: 2px solid #ccc; border-radius: 12px; padding: 10px; cursor: pointer; background: #fff; font-size: 2rem; text-align: center; position: relative; transition: 0.2s; }
        .char-opt.selected { border-color: var(--c-blue); background: #e3f2fd; transform: scale(1.1); z-index: 10; }
        .char-opt.taken { opacity: 0.4; pointer-events: none; filter: grayscale(1); background: #cfd8dc; }
        .char-badge { position: absolute; bottom: -5px; right: -5px; font-size: 0.8rem; background: var(--c-dark); color: #fff; padding: 2px 5px; border-radius: 5px; font-family: 'Nunito'; }

        /* NEGOCIACAO */
        #screen-trade { display: none; position: fixed; inset: 0; z-index: 9800; background: rgba(0,0,0,0.92); flex-direction: column; justify-content: center; align-items: center; }
        .trade-board { background: #fff; border: 6px solid var(--c-dark); border-radius: 20px; width: 95%; max-width: 800px; max-height: 90vh; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 0 50px rgba(0,0,0,0.5); }
        .trade-header { background: var(--c-yel); padding: 15px; text-align: center; font-size: 1.5rem; border-bottom: 4px solid var(--c-dark); }
        .trade-cols { display: flex; flex: 1; overflow: hidden; background: #eee; }
        .trade-side { flex: 1; display: flex; flex-direction: column; border-right: 2px solid #ccc; padding: 10px; }
        .trade-side:last-child { border-right: none; }
        .t-title { text-align: center; font-size: 1.2rem; margin-bottom: 10px; color: var(--c-blue); }
        .t-money-box { display: flex; align-items: center; gap: 5px; background: #fff; padding: 10px; border-radius: 10px; margin-bottom: 10px; border: 2px solid #aaa; }
        .t-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; }
        .t-item { background: #fff; padding: 8px; border-radius: 5px; font-size: 0.85rem; font-weight: bold; cursor: pointer; border: 2px solid transparent; display: flex; justify-content: space-between; }
        .t-item.selected { border-color: var(--c-green); background: #e8f5e9; }
        .t-actions { padding: 15px; background: #fff; border-top: 4px solid var(--c-dark); display: flex; gap: 10px; justify-content: center; }

        /* ANIMATION FX */
        .handshake-anim { position: fixed; inset: 0; pointer-events: none; z-index: 9850; display: none; justify-content: center; align-items: center; font-size: 15rem; animation: shakeHands 1s ease-in-out; text-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        @keyframes shakeHands { 0%{transform: scale(0) rotate(-20deg);} 50%{transform: scale(1.2) rotate(10deg);} 100%{transform: scale(1) rotate(0deg);} }

        /* --- JOGO UI (C√ìDIGO ORIGINAL ADAPTADO) --- */
        #game-layout { display: none; width: 100%; height: 100%; overflow: hidden; flex-direction: column; }
        @media (min-width: 900px) { #game-layout { flex-direction: row; } }
        
        #board-area { position: relative; overflow: auto; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.2); flex: 1; padding: 20px; }
        #board-container { position: relative; transform-origin: center center; }
        #board { width: 100%; height: 100%; display: grid; grid-template-columns: repeat(11, 1fr); grid-template-rows: repeat(11, 1fr); background: var(--board-bg); border: 4px solid var(--border-col); box-shadow: 0 0 50px rgba(0,0,0,0.5); }
        
        #hud-panel { background: #fff; display: flex; flex-direction: column; z-index: 5000; box-shadow: 0 0 30px rgba(0,0,0,0.5); flex-shrink: 0; }
        @media (max-width: 899px) { #hud-panel { width: 100%; padding: 10px; background: #f5f5f5; border-top: 4px solid var(--c-dark); } }
        @media (min-width: 900px) { #hud-panel { width: 380px; height: 100%; border-left: 6px solid var(--c-dark); padding: 0; } }

        /* Componentes do Jogo */
        .space { background: var(--space-bg); border: 1px solid var(--border-col); position: relative; display: flex; flex-direction: column; font-size: 0.75rem; font-weight: 800; color: #000; }
        .rot-left { transform: rotate(90deg); } .rot-top { transform: rotate(180deg); } .rot-right { transform: rotate(-90deg); }
        .space-content { width:100%; height:100%; display:flex; flex-direction:column; justify-content:space-between; text-align:center; padding: 2px; }
        .color-strip { height: 20%; width: 100%; border-bottom: 2px solid #000; }
        .sp-name { flex: 1; display: flex; align-items: center; justify-content: center; line-height: 1.1; font-weight: 900; padding:0 2px; }
        .sp-price { font-family: 'Nunito'; font-weight: 700; padding-bottom: 5px; font-size: 0.85rem; }
        .sp-icon { font-size: 2.5rem; display: flex; align-items: center; justify-content: center; height: 100%; }
        .space.owned { border: 4px solid !important; z-index: 5; }
        
        .token { width: 50px; height: 50px; position: absolute; z-index: 50; font-size: 3rem; text-align: center; line-height: 50px; transition: all 0.4s; pointer-events: none; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.6)); }
        .build-area { position: absolute; top: 2px; width: 100%; display: flex; justify-content: center; gap: 2px; z-index: 4; }
        .house-3d { width: 12px; height: 12px; background: var(--c-green); border: 1px solid #000; }
        .hotel-3d { width: 18px; height: 18px; background: var(--c-red); border: 1px solid #000; }
        .loan-badge { position: absolute; inset:0; background: rgba(255,0,0,0.3); display: flex; justify-content: center; align-items: center; color: red; font-weight: 900; font-size: 2rem; transform: rotate(-45deg); display:none; pointer-events: none; z-index: 6;}
        
        /* Botoes HUD */
        .btn-game { border: none; border-radius: 12px; font-family: 'Titan One'; cursor: pointer; color: #fff; box-shadow: 0 4px 0 rgba(0,0,0,0.2); text-transform: uppercase; width: 100%; transition: 0.1s; display: flex; align-items: center; justify-content: center; text-align: center; padding: 15px; margin-bottom: 5px; }
        .btn-game:active { transform: translateY(2px); box-shadow: 0 2px 0 rgba(0,0,0,0.2); }
        .btn-game:disabled { background: #cfd8dc !important; color: #b0bec5 !important; box-shadow: none; cursor: default; transform: none; }
        .btn-roll { background: var(--c-yel); color: var(--c-dark); }
        .btn-buy { background: var(--c-green); }
        .btn-pass { background: var(--c-red); }
        .btn-trade { background: #7b1fa2; color: #fff; }

        /* Lista Players HUD */
        .p-stat { background: #fff; border: 1px solid #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: space-between; font-weight: 700; font-size: 0.8rem; padding: 8px; margin-bottom: 5px;}
        .p-stat.active-turn { background: #e3f2fd; border: 2px solid var(--c-blue); transform: scale(1.02); }
        
        /* Cards & Overlay */
        #overlay-layer { position: fixed; inset: 0; pointer-events: none; z-index: 9500; display: flex; justify-content: center; align-items: center; }
        #overlay-bg { position:absolute; inset:0; background:rgba(0,0,0,0.7); pointer-events:auto; display:none; }
        .prop-card { width: 90%; max-width: 400px; background: #fff; border-radius: 20px; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.8); pointer-events: auto; display: none; border: 4px solid var(--c-dark); animation: popIn 0.3s; z-index: 9600; position:relative; }
        .pc-head { padding: 15px; background: var(--c-blue); color: #fff; font-family: 'Titan One'; font-size: 1.4rem; text-align: center; }
        @keyframes popIn { from{transform:scale(0)} to{transform:scale(1)} }
        
        /* Utilitarios */
        .toast { position: fixed; top: 10%; left: 50%; transform: translateX(-50%); background: #fff; color: #000; padding: 15px 30px; border-radius: 50px; border: 4px solid var(--c-yel); z-index: 10000; animation: slideDown 3s forwards; font-family: 'Titan One'; font-size: 1.2rem; box-shadow: 0 10px 30px rgba(0,0,0,0.4); white-space: nowrap; text-align: center; }
        @keyframes slideDown { 0%{opacity:0;transform:translate(-50%,-50px)} 10%{opacity:1;transform:translate(-50%,0)} 90%{opacity:1} 100%{opacity:0;transform:translate(-50%,-50px)} }
        
        #inv-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:7000; flex-direction:column; padding:20px; align-items: center; justify-content: center; }
        #inv-list { flex:1; overflow-y:auto; width:100%; max-width:500px; background: #fff; padding: 10px; border-radius: 10px; }
    </style>
</head>
<body>

<div id="screen-login">
    <div class="card-menu">
        <h1 style="color:var(--c-blue); font-size:2.5rem; margin:0; line-height:1;">RECIFE ONLINE<br><span style="font-size:1rem; color:#000;">MULTIPLAYER</span></h1>
        <input type="text" id="my-name" class="inp-box" placeholder="Seu Nome" maxlength="10">
        <hr style="border:1px dashed #ccc; margin: 15px 0;">
        <button class="btn-main" onclick="net.createRoom()">CRIAR SALA</button>
        <p style="font-weight:900; margin:10px;">OU</p>
        <input type="text" id="room-code" class="inp-box" placeholder="C√≥digo da Sala">
        <button class="btn-main btn-sec" onclick="net.joinRoom()">ENTRAR NA SALA</button>
    </div>
</div>

<div id="screen-lobby">
    <div class="card-menu">
        <h2 style="margin:0;">SALA DE ESPERA</h2>
        <div style="background:#fff3e0; padding:10px; border-radius:10px; margin-top:10px; font-weight:bold;">
            C√ìDIGO: <span id="lobby-code" style="font-size:1.5rem; color:var(--c-blue); font-family:'Titan One';">...</span>
            <br><small>(Copiado! Envie aos amigos)</small>
        </div>
        <ul class="player-list" id="lobby-list"></ul>
        <div id="host-ctrl" style="display:none;">
            <button class="btn-main" onclick="net.sendStartCharSelect()">IR PARA SELE√á√ÉO</button>
        </div>
        <div id="client-wait" style="display:block; margin-top:20px; color:#666; font-weight:bold;">
            Aguardando anfitri√£o...
        </div>
    </div>
</div>

<div id="screen-char">
    <div class="card-menu">
        <h2>ESCOLHA SEU BONECO</h2>
        <div class="char-grid" id="char-grid"></div>
        <button id="btn-conf-char" class="btn-main" style="background:#ccc;" disabled onclick="game.confirmChar()">CONFIRMAR</button>
        <p id="char-status" style="font-size:0.9rem; margin-top:10px; font-weight:bold;">...</p>
    </div>
</div>

<div id="screen-trade">
    <div class="handshake-anim">ü§ù</div>
    <div class="trade-board">
        <div class="trade-header">NEGOCIA√á√ÉO</div>
        <div style="padding:10px; text-align:center; background:#fff;">
            <label style="font-weight:bold;">COM QUEM?</label>
            <select id="trade-target" class="inp-box" style="padding:5px; width:auto;" onchange="tradeUI.updateLists()"></select>
        </div>
        <div class="trade-cols">
            <div class="trade-side" style="background:#e3f2fd;">
                <div class="t-title">VOC√ä OFERECE</div>
                <div class="t-money-box">üí∞ <input type="number" id="trade-give-money" value="0" min="0" step="10" style="border:none; width:100%; font-weight:bold;"></div>
                <div class="t-list" id="list-give"></div>
            </div>
            <div class="trade-side" style="background:#ffebee;">
                <div class="t-title">VOC√ä QUER</div>
                <div class="t-money-box">üí∞ <input type="number" id="trade-get-money" value="0" min="0" step="10" style="border:none; width:100%; font-weight:bold;"></div>
                <div class="t-list" id="list-get"></div>
            </div>
        </div>
        <div class="t-actions">
            <button class="btn-game btn-pass" style="width:auto; padding:10px 30px;" onclick="tradeUI.close()">CANCELAR</button>
            <button class="btn-game btn-buy" style="width:auto; padding:10px 30px;" onclick="tradeUI.sendProposal()">ENVIAR PROPOSTA</button>
        </div>
    </div>
</div>

<div id="game-layout">
    <div id="board-area">
        <div id="board-container">
            <div id="board">
                <div class="center-hub" style="grid-column: 2/11; grid-row: 2/11; pointer-events:none; display:flex; justify-content:center; align-items:center; flex-direction:column;">
                     <h1 style="font-size:4rem; color:#546e7a; opacity:0.3; transform:rotate(-45deg);">RECIFE</h1>
                </div>
            </div>
        </div>
    </div>

    <div id="hud-panel">
        <div style="padding:10px; border-bottom:2px solid #ccc; background:#fff; display:flex; justify-content:space-between; align-items:center;">
            <div>
                <div class="turn-badge" id="turn-display" style="background:#333; color:#fff; padding:5px 10px; border-radius:15px; font-size:0.8rem;">AGUARDANDO...</div>
                <div class="money-display" id="p-money" style="font-size:1.5rem; color:var(--c-green); font-weight:900;">$0</div>
            </div>
            <button class="btn-game btn-trade" style="width:auto; padding:8px 15px; font-size:0.8rem;" onclick="tradeUI.open()">ü§ù NEGOCIAR</button>
        </div>

        <div style="flex:1; overflow-y:auto; padding:10px;" id="players-hud-list"></div>

        <div style="padding:10px; background:#eee; display:flex; flex-direction:column; gap:5px;">
            <button id="b-roll" class="btn-game btn-roll" disabled onclick="net.sendAction('ROLL')">üé≤ ROLAR DADOS</button>
            <div style="display:flex; gap:5px;">
                <button id="b-buy" class="btn-game btn-buy" disabled onclick="net.sendAction('BUY')">COMPRAR</button>
                <button id="b-pass" class="btn-game btn-pass" disabled onclick="net.sendAction('PASS')">PASSAR</button>
            </div>
            <button class="btn-game" style="background:#37474f; font-size:0.8rem; margin:0;" onclick="ui.toggleInv()">üíº SUAS ESCRITURAS</button>
        </div>
    </div>
</div>

<div id="overlay-layer">
    <div id="overlay-bg" onclick="ui.closeCard()"></div>
    
    <div id="dice-visual" style="display:flex; gap:20px; pointer-events:none; opacity:0; transition:0.2s;">
        <div id="d1" style="width:80px; height:80px; background:#fff; border:4px solid #000; border-radius:15px; display:grid; place-items:center; font-size:3rem; font-family:'Titan One';">1</div>
        <div id="d2" style="width:80px; height:80px; background:#fff; border:4px solid #000; border-radius:15px; display:grid; place-items:center; font-size:3rem; font-family:'Titan One';">1</div>
    </div>

    <div id="prop-card" class="prop-card">
        <div class="pc-head" id="pc-name">RUA</div>
        <div style="padding:15px;">
            <div style="text-align:center; font-size:2rem; color:var(--c-green);" id="pc-price">$200</div>
            <table style="width:100%; margin:10px 0; font-size:0.9rem; border-collapse:collapse;" id="rent-table-body"></table>
            <div id="act-buy" style="display:none; margin-top:10px;">
                <button class="btn-game btn-buy" onclick="game.confirmBuy()">COMPRAR</button>
                <button class="btn-game" style="background:#546e7a;" onclick="ui.closeCard()">N√ÉO QUERO</button>
            </div>
            <div id="act-manage" style="display:none; margin-top:10px; gap:5px;">
                <button id="btn-mtg" class="btn-game btn-roll" onclick="game.doMortgage()">HIPOTECAR</button>
                <button id="btn-bld" class="btn-game btn-buy" onclick="game.doBuild()">CONSTRUIR</button>
                <button class="btn-game" style="background:#333;" onclick="ui.closeCard()">FECHAR</button>
            </div>
        </div>
    </div>

    <div id="trade-proposal-modal" class="prop-card" style="border-color:#7b1fa2; width:95%; max-width:500px;">
        <div class="pc-head" style="background:#7b1fa2;">PROPOSTA!</div>
        <div style="padding:20px; text-align:center;">
            <h3 id="tp-msg">Jo√£o quer trocar...</h3>
            <div style="display:flex; justify-content:space-between; margin:15px 0;">
                <div style="flex:1; background:#e3f2fd; padding:5px; border-radius:5px;">
                    <small>ELE D√Å:</small><div id="tp-give"></div>
                </div>
                <div style="font-size:2rem; align-self:center;">üîÑ</div>
                <div style="flex:1; background:#ffebee; padding:5px; border-radius:5px;">
                    <small>VOC√ä D√Å:</small><div id="tp-get"></div>
                </div>
            </div>
            <div id="tp-btns" style="display:flex; gap:10px;">
                <button class="btn-game btn-pass" onclick="net.respondTrade(false)">RECUSAR</button>
                <button class="btn-game btn-buy" onclick="net.respondTrade(true)">ACEITAR</button>
            </div>
            <p id="tp-wait" style="display:none; color:#666;">Aguardando resposta...</p>
        </div>
    </div>
</div>

<div id="inv-modal">
    <h2 style="color:#fff;">SEUS BENS</h2>
    <div id="inv-list"></div>
    <button class="btn-main" style="width:auto; margin-top:10px;" onclick="document.getElementById('inv-modal').style.display='none'">FECHAR</button>
</div>

<div id="screen-end">
    <div class="card-menu">
        <h1 id="end-title">FIM DE JOGO</h1>
        <p id="end-msg">...</p>
        <button class="btn-main" onclick="location.reload()">NOVA SALA</button>
    </div>
</div>

<script>
// --- DADOS ---
const CHARS=[
    {id:'rt',i:'üíÖ',n:'A Ratona'}, {id:'as',i:'üóø',n:'Bilola'}, {id:'bt',i:'üõ∂',n:'Celta'}, 
    {id:'c',i:'ü¶Ä',n:'Caranguejo'}, {id:'s',i:'ü¶à',n:'Tubar√£o'}, {id:'u',i:'‚òÇÔ∏è',n:'Sombrinha'}, 
    {id:'pd',i:'üêÄ',n:'Gabiru'}, {id:'bb',i:'üåΩ',n:'Milho'}, {id:'gl',i:'üêî',n:'Galo'}, 
    {id:'brt',i:'üöå',n:'BRT'}, {id:'bdr',i:'üç•',n:'Bolo Rolo'}, {id:'lu',i:'üêª',n:'La Ursa'},
    {id:'hmn',i:'üé©',n:'Meia-Noite'}, {id:'rp',i:'üöî',n:'R√°dio P.'}, {id:'srr',i:'üêö',n:'Sururu'}, {id:'and',i:'üòé',n:'Anderson'}
];

const BD=[
    {t:'st',n:'MARCO ZERO',i:'üö©'}, 
    {t:'pr',g:'#795548',n:'Coque',p:60,h:50,r:[2,10,30,90,160,250]}, 
    {t:'ch',n:'Sorte',i:'üçÄ'}, 
    {t:'pr',g:'#795548',n:'Ibura',p:60,h:50,r:[4,20,60,180,320,450]}, 
    {t:'tx',n:'IPTU',i:'üí∏'},
    {t:'rr',n:'Est. Joana B.',p:200,i:'üöÜ'},
    {t:'pr',g:'#03a9f4',n:'Agamenon',p:100,h:50,r:[6,30,90,270,400,550]},
    {t:'rev',n:'Rev√©s',i:'‚ö†Ô∏è'}, 
    {t:'pr',g:'#03a9f4',n:'Afogados',p:100,h:50,r:[6,30,90,270,400,550]}, 
    {t:'pr',g:'#03a9f4',n:'Mustardinha',p:120,h:50,r:[8,40,100,300,450,600]},
    {t:'jl',n:'LEI SECA',i:'üëÆ'}, 
    {t:'pr',g:'#e91e63',n:'Iputinga',p:140,h:100,r:[10,50,150,450,750,950]}, 
    {t:'ut',n:'Celpe',p:150,i:'üí°'}, 
    {t:'pr',g:'#e91e63',n:'Cordeiro',p:140,h:100,r:[10,50,150,450,750,950]}, 
    {t:'pr',g:'#e91e63',n:'V√°rzea',p:160,h:100,r:[12,60,180,500,700,900]}, 
    {t:'rr',n:'Est. Coqueiral',p:200,i:'üöÜ'}, 
    {t:'pr',g:'#ff5722',n:'Rosarinho',p:180,h:100,r:[14,70,200,550,750,950]}, 
    {t:'ch',n:'Sorte',i:'üçÄ'}, 
    {t:'pr',g:'#ff5722',n:'Encruzilhada',p:180,h:100,r:[14,70,200,550,750,950]}, 
    {t:'pr',g:'#ff5722',n:'Torre',p:200,h:100,r:[16,80,220,600,800,1000]},
    {t:'pk',n:'Pq. Jaqueira',i:'üå≥'}, 
    {t:'pr',g:'#d32f2f',n:'Aflitos',p:220,h:150,r:[18,90,250,700,875,1050]}, 
    {t:'rev',n:'Rev√©s',i:'‚ö†Ô∏è'}, 
    {t:'pr',g:'#d32f2f',n:'Espinheiro',p:220,h:150,r:[18,90,250,700,875,1050]}, 
    {t:'pr',g:'#d32f2f',n:'Madalena',p:240,h:150,r:[20,100,300,750,925,1100]}, 
    {t:'rr',n:'Est. Barro',p:200,i:'üöÜ'}, 
    {t:'pr',g:'#fbc02d',n:'Gra√ßas',p:260,h:150,r:[22,110,330,800,975,1150]}, 
    {t:'pr',g:'#fbc02d',n:'Po√ßo Panela',p:260,h:150,r:[22,110,330,800,975,1150]}, 
    {t:'ut',n:'Compesa',p:150,i:'üíß'}, 
    {t:'pr',g:'#fbc02d',n:'Casa Forte',p:280,h:150,r:[24,120,360,850,1025,1200]},
    {t:'gj',n:'CADEIA!',i:'üöì'}, 
    {t:'pr',g:'#388e3c',n:'Apipucos',p:300,h:200,r:[26,130,390,900,1100,1275]}, 
    {t:'pr',g:'#388e3c',n:'Parnamirim',p:300,h:200,r:[26,130,390,900,1100,1275]}, 
    {t:'ch',n:'Sorte',i:'üçÄ'}, 
    {t:'pr',g:'#388e3c',n:'Paiva',p:320,h:200,r:[28,150,450,1000,1200,1400]}, 
    {t:'rr',n:'Est. Afogados',p:200,i:'üöÜ'}, 
    {t:'rev',n:'Rev√©s',i:'‚ö†Ô∏è'}, 
    {t:'pr',g:'#1565c0',n:'Boa Viagem',p:350,h:200,r:[35,175,500,1100,1300,1500]}, 
    {t:'tx',n:'Taxa',i:'üßæ'}, 
    {t:'pr',g:'#1565c0',n:'Pina',p:400,h:200,r:[50,200,600,1400,1700,2000]}
];

// --- ESTADO GLOBAL ---
let myId = null;
let myName = '';
let isHost = false;
let connHost = null;
let connections = []; // Apenas Host usa
let myCharTemp = null;
let activePropIdx = -1;

// O estado do jogo sincronizado
let gameState = {
    phase: 'LOBBY', // LOBBY, CHAR, GAME
    players: [], // {id, name, char, confirmed, money, pos, jailed, active, color}
    props: Array(40).fill(null), // {ownerId, level, loan}
    turnIdx: 0,
    lastDice: [1,1],
    trade: null // {from, to, offerMoney, offerProps, reqMoney, reqProps}
};

const SFX = {
    step: new Audio('https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3'),
    cash: new Audio('https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3'),
    win: new Audio('https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3')
};
const play = (k) => { try { SFX[k].volume=0.5; SFX[k].currentTime=0; SFX[k].play().catch(()=>{}); } catch(e){} };

// --- REDE (PEERJS) ---
const peer = new Peer(null, { debug: 1 });

const net = {
    createRoom: () => {
        const name = document.getElementById('my-name').value.trim();
        if(!name) return alert('Digite seu nome!');
        myName = name;
        isHost = true;
        
        // Host se adiciona como player
        gameState.players.push({
            id: peer.id, name: myName, char: null, confirmed: false,
            money: 1500, pos: 0, jailed: false, active: true, color: '#f00'
        });
        
        // UI Code
        const code = peer.id; 
        navigator.clipboard.writeText(code);
        document.getElementById('screen-login').style.display='none';
        document.getElementById('screen-lobby').style.display='flex';
        document.getElementById('lobby-code').innerText = code;
        document.getElementById('host-ctrl').style.display='block';
        document.getElementById('client-wait').style.display='none';
        ui.toast("C√≥digo copiado! Mande para os amigos.");
        ui.renderLobby();
        
        // Host ouve conex√µes
        peer.on('connection', (conn) => {
            connections.push(conn);
            conn.on('data', (data) => net.handleData(data, conn.peer));
            conn.on('close', () => { /* Player dropou */ });
            // Manda estado atual pro novo player
            conn.send({ type: 'UPDATE', state: gameState });
        });
    },
    joinRoom: () => {
        const name = document.getElementById('my-name').value.trim();
        const code = document.getElementById('room-code').value.trim();
        if(!name || !code) return alert('Preencha nome e c√≥digo!');
        myName = name;
        isHost = false;
        
        connHost = peer.connect(code);
        connHost.on('open', () => {
            connHost.send({ type: 'JOIN', name: myName });
            document.getElementById('screen-login').style.display='none';
            document.getElementById('screen-lobby').style.display='flex';
        });
        connHost.on('data', (data) => net.handleData(data));
        connHost.on('error', (err) => alert('Erro ao conectar: '+err));
    },
    handleData: (data, senderId) => {
        if(isHost) {
            // L√ìGICA DO HOST (SERVER)
            switch(data.type) {
                case 'JOIN':
                    if(gameState.phase !== 'LOBBY') return;
                    gameState.players.push({
                        id: senderId, name: data.name, char: null, confirmed: false,
                        money: 1500, pos: 0, jailed: false, active: true, color: '#'+Math.floor(Math.random()*16777215).toString(16)
                    });
                    net.broadcastState();
                    break;
                case 'SELECT_CHAR':
                    const p = gameState.players.find(x=>x.id === senderId);
                    if(p && !p.confirmed) { p.char = data.charId; net.broadcastState(); }
                    break;
                case 'CONFIRM_CHAR':
                    const p2 = gameState.players.find(x=>x.id === senderId);
                    if(p2 && p2.char) { p2.confirmed = true; net.broadcastState(); }
                    break;
                case 'ROLL': gameHost.handleRoll(senderId); break;
                case 'BUY': gameHost.handleBuy(senderId); break;
                case 'PASS': gameHost.handlePass(senderId); break;
                case 'TRADE_PROPOSE': gameHost.handleTradePropose(data.offer); break;
                case 'TRADE_RESPONSE': gameHost.handleTradeResponse(senderId, data.accepted); break;
            }
        } else {
            // L√ìGICA DO CLIENTE
            if(data.type === 'UPDATE') {
                gameState = data.state;
                ui.syncState();
            }
        }
    },
    broadcastState: () => {
        if(!isHost) return;
        const msg = { type: 'UPDATE', state: gameState };
        connections.forEach(c => c.send(msg));
        ui.syncState(); // Atualiza a tela do host tamb√©m
    },
    // A√ß√µes do Client enviando para Host
    sendStartCharSelect: () => {
        if(!isHost) return;
        gameState.phase = 'CHAR';
        net.broadcastState();
    },
    sendSelectChar: (charId) => {
        if(isHost) { 
            const p = gameState.players.find(x=>x.id===peer.id);
            if(p && !p.confirmed) p.char = charId;
            net.broadcastState();
        } else connHost.send({type:'SELECT_CHAR', charId: charId});
    },
    sendConfirmChar: () => {
        if(isHost) {
            const p = gameState.players.find(x=>x.id===peer.id);
            if(p && p.char) p.confirmed = true;
            net.broadcastState();
            gameHost.checkAllReady();
        } else connHost.send({type:'CONFIRM_CHAR'});
    },
    sendAction: (act) => {
        if(isHost) {
            if(act==='ROLL') gameHost.handleRoll(peer.id);
            if(act==='BUY') gameHost.handleBuy(peer.id);
            if(act==='PASS') gameHost.handlePass(peer.id);
        } else connHost.send({type:act});
    },
    sendTradeProposal: (offer) => {
        if(isHost) gameHost.handleTradePropose(offer);
        else connHost.send({type:'TRADE_PROPOSE', offer: offer});
    },
    respondTrade: (accepted) => {
        document.getElementById('tp-btns').style.display='none';
        document.getElementById('tp-wait').style.display='block';
        if(isHost) gameHost.handleTradeResponse(peer.id, accepted);
        else connHost.send({type:'TRADE_RESPONSE', accepted: accepted});
    }
};

// --- L√ìGICA DO HOST (GAME ENGINE) ---
const gameHost = {
    checkAllReady: () => {
        const all = gameState.players.every(p => p.confirmed);
        if(all && gameState.players.length > 0) {
            // Iniciar Jogo
            gameState.phase = 'GAME';
            // Shuffle
            gameState.players.sort(() => Math.random() - 0.5);
            gameState.turnIdx = 0;
            net.broadcastState();
        }
    },
    handleRoll: (pid) => {
        if(gameState.players[gameState.turnIdx].id !== pid) return;
        const d1 = Math.ceil(Math.random()*6);
        const d2 = Math.ceil(Math.random()*6);
        gameState.lastDice = [d1, d2];
        const p = gameState.players[gameState.turnIdx];
        
        // Move
        const steps = d1+d2;
        p.pos = (p.pos + steps) % 40;
        if(p.pos < steps) p.money += 200; // Passou inicio
        
        // Verifica aluguel automatico
        const s = BD[p.pos];
        const pr = gameState.props[p.pos];
        if(s.t==='pr' && pr && pr.ownerId !== pid && pr.ownerId && !pr.loan) {
            // Pagar aluguel
            let rent = s.r[pr.level];
            p.money -= rent;
            const owner = gameState.players.find(x=>x.id===pr.ownerId);
            if(owner) owner.money += rent;
        }

        net.broadcastState();
    },
    handleBuy: (pid) => {
        const p = gameState.players[gameState.turnIdx];
        if(p.id !== pid) return;
        const s = BD[p.pos];
        if(!gameState.props[p.pos] && p.money >= s.p) {
            p.money -= s.p;
            gameState.props[p.pos] = { ownerId: pid, level: 0, loan: false };
            net.broadcastState();
        }
    },
    handlePass: (pid) => {
        if(gameState.players[gameState.turnIdx].id !== pid) return;
        gameState.turnIdx = (gameState.turnIdx + 1) % gameState.players.length;
        if(!gameState.players[gameState.turnIdx].active) gameHost.handlePass(gameState.players[gameState.turnIdx].id); // Skip dead
        net.broadcastState();
    },
    handleTradePropose: (offer) => {
        gameState.trade = offer; // {from: id, to: id, offerM, offerP:[], reqM, reqP:[]}
        net.broadcastState();
    },
    handleTradeResponse: (responderId, accepted) => {
        const t = gameState.trade;
        if(!t || t.to !== responderId) return;

        if(accepted) {
            // Execute trade
            const pFrom = gameState.players.find(x=>x.id===t.from);
            const pTo = gameState.players.find(x=>x.id===t.to);
            
            pFrom.money = pFrom.money - t.offerM + t.reqM;
            pTo.money = pTo.money + t.offerM - t.reqM;

            t.offerP.forEach(idx => { if(gameState.props[idx]) gameState.props[idx].ownerId = t.to; });
            t.reqP.forEach(idx => { if(gameState.props[idx]) gameState.props[idx].ownerId = t.from; });
        }
        gameState.trade = null;
        net.broadcastState();
    }
};

// --- UI CONTROLLER ---
const ui = {
    renderLobby: () => {
        const list = document.getElementById('lobby-list');
        list.innerHTML = gameState.players.map(p => 
            `<li class="player-li ${p.confirmed?'ready':''}">${p.name} ${p.id===peer.id?'(Voc√™)':''}</li>`
        ).join('');
    },
    syncState: () => {
        // Roteamento de telas
        if(gameState.phase === 'LOBBY') {
            ui.renderLobby();
        } else if (gameState.phase === 'CHAR') {
            document.getElementById('screen-lobby').style.display='none';
            document.getElementById('screen-char').style.display='flex';
            ui.renderChars();
        } else if (gameState.phase === 'GAME') {
            document.getElementById('screen-char').style.display='none';
            document.getElementById('game-layout').style.display='flex';
            document.getElementById('game-layout').classList.add('active'); // CSS trigger
            ui.renderBoard();
            ui.updateHUD();
            ui.checkTrade();
        }
    },
    renderChars: () => {
        const grid = document.getElementById('char-grid');
        grid.innerHTML = CHARS.map(c => {
            const taker = gameState.players.find(p => p.char === c.id);
            let cls = 'char-opt';
            let badge = '';
            
            if(taker) {
                if(taker.id === peer.id) cls += ' selected';
                else cls += ' taken';
                badge = `<div class="char-badge">${taker.name}</div>`;
            }
            return `<div class="${cls}" onclick="ui.clickChar('${c.id}')">${c.i}${badge}</div>`;
        }).join('');

        const me = gameState.players.find(p => p.id === peer.id);
        const btn = document.getElementById('btn-conf-char');
        if(me && me.char && !me.confirmed) {
            btn.disabled = false; btn.style.background = 'var(--c-green)'; btn.innerText = "CONFIRMAR";
        } else if (me && me.confirmed) {
            btn.disabled = true; btn.style.background = '#ccc'; btn.innerText = "AGUARDANDO...";
        }
        document.getElementById('char-status').innerText = `${gameState.players.filter(p=>p.confirmed).length}/${gameState.players.length} Confirmados`;
    },
    clickChar: (cid) => {
        const me = gameState.players.find(p => p.id === peer.id);
        if(!me.confirmed) net.sendSelectChar(cid);
    },
    renderBoard: () => {
        // Renderizar tabuleiro apenas uma vez ou se necessario
        const b = document.getElementById('board');
        if(b.children.length > 2) { ui.updateTokens(); return; } // J√° montado

        BD.forEach((s,i) => {
            const d=document.createElement('div');d.className='space';d.id=`s${i}`;
            let r,c, rot;
            if(i<=10){ r=11; c=11-i; rot='rot-bottom'; } 
            else if(i<=20){ r=11-(i-10); c=1; rot='rot-left'; } 
            else if(i<=30){ r=1; c=1+(i-20); rot='rot-top'; } 
            else { r=1+(i-30); c=11; rot='rot-right'; }
            if(i%10===0) rot='';
            d.style.gridRow=r; d.style.gridColumn=c;

            if(s.t==='pr') {
                d.innerHTML = `<div class="space-content ${rot}"><div class="color-strip" style="background:${s.g}"></div><div class="sp-name">${s.n}</div><div class="sp-price">$${s.p}</div></div><div class="build-area" id="b${i}"></div>`;
            } else {
                d.innerHTML = `<div class="space-content ${rot}"><div class="sp-icon">${s.i}</div><div class="sp-name" style="font-size:0.6rem">${s.n}</div></div>`;
            }
            d.onclick = () => ui.clickSpace(i);
            b.appendChild(d);
        });
        ui.updateTokens();
    },
    updateTokens: () => {
        // Remover tokens antigos
        document.querySelectorAll('.token').forEach(e=>e.remove());
        const b = document.getElementById('board');
        
        // Mapear posi√ß√µes
        const map = {};
        gameState.players.forEach(p => {
             if(!map[p.pos]) map[p.pos]=[]; map[p.pos].push(p); 
        });

        Object.keys(map).forEach(pos => {
            const arr = map[pos];
            const cell = document.getElementById(`s${pos}`);
            arr.forEach((p, idx) => {
                const t = document.createElement('div');
                t.className='token';
                const charObj = CHARS.find(c=>c.id===p.char);
                t.innerHTML = charObj ? charObj.i : 'üë§';
                
                // Calculo de posi√ß√£o pra n√£o encavalar
                const offset = (idx * 5) - ((arr.length-1)*2.5);
                t.style.left = (cell.offsetLeft + 10 + offset) + 'px';
                t.style.top = (cell.offsetTop + 10 + offset) + 'px';
                b.appendChild(t);
            });
        });

        // Casas
        gameState.props.forEach((pr, i) => {
            const el = document.getElementById(`s${i}`);
            if(!el) return;
            if(pr) {
                const owner = gameState.players.find(p=>p.id===pr.ownerId);
                el.classList.add('owned');
                el.style.borderColor = owner ? owner.color : '#000';
                
                // Build visual
                const be = document.getElementById(`b${i}`);
                if(be) be.innerHTML = pr.level===5 ? '<div class="hotel-3d"></div>' : Array(pr.level).fill('<div class="house-3d"></div>').join('');
            } else {
                el.classList.remove('owned');
                el.style.borderColor = '#1a1a1a';
            }
        });
    },
    updateHUD: () => {
        const curP = gameState.players[gameState.turnIdx];
        const me = gameState.players.find(p => p.id === peer.id);
        
        document.getElementById('turn-display').innerText = `VEZ DE: ${curP.name.toUpperCase()}`;
        document.getElementById('p-money').innerText = `$${me.money}`;
        
        // Lista Lateral
        document.getElementById('players-hud-list').innerHTML = gameState.players.map((p,i) => {
            const charObj = CHARS.find(c=>c.id===p.char);
            return `<div class="p-stat ${gameState.turnIdx===i?'active-turn':''}">
                <div>${charObj?charObj.i:''} ${p.name}</div>
                <div>$${p.money}</div>
            </div>`;
        }).join('');

        // Botoes
        const isMyTurn = (curP.id === peer.id);
        document.getElementById('b-roll').disabled = !isMyTurn;
        document.getElementById('b-pass').disabled = !isMyTurn;
        
        // Visual Dados
        const d1=document.getElementById('d1'); d1.innerText = gameState.lastDice[0];
        const d2=document.getElementById('d2'); d2.innerText = gameState.lastDice[1];
        if(isMyTurn) document.getElementById('dice-visual').style.opacity=1;
    },
    clickSpace: (i) => {
        activePropIdx = i;
        const s = BD[i];
        if(s.t!=='pr') return;
        
        const pr = gameState.props[i];
        document.getElementById('pc-name').innerText = s.n;
        document.getElementById('pc-name').style.background = s.g;
        document.getElementById('pc-price').innerText = `$${s.p}`;
        
        let html = '';
        if(s.r) s.r.forEach((val, k) => html += `<tr><td>${k===0?'Aluguel':k===5?'Hotel':k+' Casa'}</td><td style="text-align:right">$${val}</td></tr>`);
        document.getElementById('rent-table-body').innerHTML = html;
        
        // Bot√µes de a√ß√£o
        const me = gameState.players.find(p => p.id === peer.id);
        const myTurn = gameState.players[gameState.turnIdx].id === peer.id;
        
        const btnBuy = document.getElementById('act-buy');
        const btnMan = document.getElementById('act-manage');
        
        btnBuy.style.display = 'none';
        btnMan.style.display = 'none';

        if(!pr && myTurn && me.pos === i && me.money >= s.p) {
            btnBuy.style.display = 'block';
        }
        if(pr && pr.ownerId === peer.id) {
            btnMan.style.display = 'flex';
        }
        
        document.getElementById('prop-card').style.display = 'block';
        document.getElementById('overlay-bg').style.display = 'block';
    },
    closeCard: () => {
        document.getElementById('prop-card').style.display='none';
        document.getElementById('overlay-bg').style.display='none';
        document.getElementById('inv-modal').style.display='none';
    },
    checkTrade: () => {
        const t = gameState.trade;
        const modal = document.getElementById('trade-proposal-modal');
        const myId = peer.id;

        if(t && t.to === myId) {
            // Eu estou recebendo proposta
            play('step'); // som de alerta
            document.getElementById('overlay-bg').style.display='block';
            modal.style.display='block';
            
            const pFrom = gameState.players.find(p=>p.id===t.from);
            document.getElementById('tp-msg').innerText = `${pFrom.name} quer negociar:`;
            
            let giveHTML = t.offerM > 0 ? `<div>üí∞ $${t.offerM}</div>` : '';
            t.offerP.forEach(idx => giveHTML += `<div>üè† ${BD[idx].n}</div>`);
            document.getElementById('tp-give').innerHTML = giveHTML || 'Nada';

            let getHTML = t.reqM > 0 ? `<div>üí∞ $${t.reqM}</div>` : '';
            t.reqP.forEach(idx => getHTML += `<div>üè† ${BD[idx].n}</div>`);
            document.getElementById('tp-get').innerHTML = getHTML || 'Nada';

            document.getElementById('tp-btns').style.display='flex';
            document.getElementById('tp-wait').style.display='none';

            // Anima√ß√£o de Handshake para todos
            document.querySelector('.handshake-anim').style.display='flex';
            setTimeout(()=>document.querySelector('.handshake-anim').style.display='none', 2000);

        } else if (t && t.from === myId) {
            // Eu enviei, estou esperando
            // (Poderia mostrar um toast aqui)
        } else {
            modal.style.display='none';
            if(document.getElementById('prop-card').style.display==='none') document.getElementById('overlay-bg').style.display='none';
        }
    },
    toast: (m) => {
        const d=document.createElement('div');d.className='toast';d.innerText=m;
        document.body.appendChild(d); setTimeout(()=>d.remove(),3000);
    },
    toggleInv: () => {
        const d = document.getElementById('inv-modal');
        d.style.display = 'flex';
        const list = document.getElementById('inv-list');
        const me = peer.id;
        list.innerHTML = gameState.props.map((pr, i) => {
            if(pr && pr.ownerId === me) return `<div style="padding:10px; border-bottom:1px solid #eee;">${BD[i].n} (N√≠vel ${pr.level})</div>`;
        }).join('') || 'Sem propriedades.';
    }
};

const game = {
    confirmChar: () => {
        net.sendConfirmChar();
        document.getElementById('btn-conf-char').disabled=true;
        document.getElementById('btn-conf-char').innerText = "ESPERANDO...";
    },
    confirmBuy: () => {
        net.sendAction('BUY');
        ui.closeCard();
    }
};

// --- NEGOCIA√á√ÉO UI ---
const tradeUI = {
    selectedGiveProps: [],
    selectedGetProps: [],
    
    open: () => {
        document.getElementById('screen-trade').style.display = 'flex';
        // Popula select de jogadores (menos eu)
        const sel = document.getElementById('trade-target');
        sel.innerHTML = gameState.players.filter(p => p.id !== peer.id).map(p => 
            `<option value="${p.id}">${p.name}</option>`
        ).join('');
        tradeUI.updateLists();
    },
    close: () => {
        document.getElementById('screen-trade').style.display = 'none';
        tradeUI.selectedGiveProps = [];
        tradeUI.selectedGetProps = [];
    },
    updateLists: () => {
        const targetId = document.getElementById('trade-target').value;
        const myPropsDiv = document.getElementById('list-give');
        const theirPropsDiv = document.getElementById('list-get');
        
        // Meus bens
        myPropsDiv.innerHTML = gameState.props.map((pr, i) => {
            if(pr && pr.ownerId === peer.id) {
                const isSel = tradeUI.selectedGiveProps.includes(i);
                return `<div class="t-item ${isSel?'selected':''}" onclick="tradeUI.toggle(true, ${i})">${BD[i].n}</div>`;
            }
        }).join('');

        // Bens dele
        theirPropsDiv.innerHTML = gameState.props.map((pr, i) => {
            if(pr && pr.ownerId === targetId) {
                const isSel = tradeUI.selectedGetProps.includes(i);
                return `<div class="t-item ${isSel?'selected':''}" onclick="tradeUI.toggle(false, ${i})">${BD[i].n}</div>`;
            }
        }).join('');
    },
    toggle: (isMine, idx) => {
        const arr = isMine ? tradeUI.selectedGiveProps : tradeUI.selectedGetProps;
        const i = arr.indexOf(idx);
        if(i > -1) arr.splice(i, 1); else arr.push(idx);
        tradeUI.updateLists();
    },
    sendProposal: () => {
        const offer = {
            from: peer.id,
            to: document.getElementById('trade-target').value,
            offerM: parseInt(document.getElementById('trade-give-money').value) || 0,
            offerP: tradeUI.selectedGiveProps,
            reqM: parseInt(document.getElementById('trade-get-money').value) || 0,
            reqP: tradeUI.selectedGetProps
        };
        net.sendTradeProposal(offer);
        tradeUI.close();
        ui.toast("Proposta enviada!");
    }
};

</script>
</body>
</html>
