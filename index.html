<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Recife Imobili√°rio - O Mestre da Cidade</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lobster&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Paleta Recife Solar & Cultural */
            --bg-texture: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23fff8e1"/><path d="M0 0l10 10m90-10l-10 10m-90 90l10-10m90 10l-10-10" stroke="%23ffe0b2" stroke-width="2"/></svg>');
            --panel-bg: #fffde7; /* Bege claro */
            --board-bg: #e1f5fe; /* Azul c√©u */
            --accent: #ffc107; /* Amarelo Sol */
            --primary: #0277bd; /* Azul Oceano */
            --secondary: #d32f2f; /* Vermelho Terra */
            --text-dark: #37474f;
            --wood-border: #795548;
            --green-success: #388e3c;
        }

        * { box-sizing: border-box; user-select: none; }
        body { margin: 0; font-family: 'Roboto', sans-serif; background: var(--bg-texture); color: var(--text-dark); height: 100vh; overflow: hidden; display: flex; }
        h1, h2, h3 { font-family: 'Lobster', cursive; color: var(--primary); text-shadow: 1px 1px #fff; }

        /* --- LOBBY (Visual de Cabine de Praia) --- */
        #lobby { position: fixed; inset: 0; background: rgba(255, 248, 225, 0.95); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; border: 20px solid var(--primary); }
        .lobby-card { background: white; padding: 40px; border-radius: 15px; width: 90%; max-width: 500px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); border: 3px solid var(--accent); }
        .lobby-btn { width: 100%; padding: 15px; margin-top: 12px; border: none; font-weight: bold; border-radius: 8px; cursor: pointer; font-size: 18px; transition: 0.3s; text-transform: uppercase; box-shadow: 0 4px #999; }
        .lobby-btn:active { transform: translateY(4px); box-shadow: 0 0 #999; }
        .btn-host { background: var(--primary); color: white; }
        .btn-join { background: var(--green-success); color: white; }
        input { width: 100%; padding: 15px; margin-bottom: 10px; border: 2px solid var(--primary); border-radius: 8px; font-size: 16px; background: #f0f8ff; }

        /* --- LAYOUT PRINCIPAL --- */
        #game-layout { display: flex; width: 100%; height: 100%; opacity: 0; pointer-events: none; transition: opacity 0.8s ease-out; }
        #game-layout.active { opacity: 1; pointer-events: all; }

        /* --- SIDEBAR (Painel de Controle Cultural) --- */
        #sidebar { width: 340px; background: var(--panel-bg); display: flex; flex-direction: column; padding: 15px; border-right: 6px solid var(--wood-border); box-shadow: 5px 0 20px rgba(0,0,0,0.2); z-index: 20; background-image: linear-gradient(to bottom, rgba(255,255,255,0.8), rgba(255,255,255,0.95)), url('https://www.transparenttextures.com/patterns/arabesque.png'); }
        
        .header-logo h2 { margin: 0; font-size: 2.2rem; text-align: center; color: var(--secondary); -webkit-text-stroke: 1px var(--accent); }
        
        #turn-indicator { background: var(--primary); color: #fff; padding: 12px; border-radius: 8px; text-align: center; font-weight: bold; margin: 15px 0; font-size: 1.1rem; border: 2px solid var(--accent); box-shadow: 0 4px 0 rgba(0,0,0,0.2); }
        .my-turn-anim { animation: pulseTurn 1.5s infinite; background: var(--accent) !important; color: var(--text-dark) !important; border-color: var(--primary) !important; }
        @keyframes pulseTurn { 0% { transform: scale(1); } 50% { transform: scale(1.03); } 100% { transform: scale(1); } }

        /* Portf√≥lio Persistente */
        #my-portfolio { background: #fff; border: 2px solid var(--wood-border); border-radius: 8px; padding: 10px; flex-grow: 1; overflow-y: auto; margin-bottom: 15px; }
        #my-portfolio h3 { margin: 0 0 10px 0; font-size: 1.2rem; text-align: center; border-bottom: 2px dashed var(--accent); padding-bottom: 5px; }
        .portfolio-item { display: flex; align-items: center; font-size: 0.85rem; padding: 4px 0; border-bottom: 1px solid #eee; }
        .color-dot { width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; border: 1px solid rgba(0,0,0,0.2); }

        .action-grid { display: grid; gap: 10px; grid-template-columns: 1fr 1fr; }
        .ctrl-btn { padding: 15px; border: none; border-radius: 8px; font-weight: bold; color: white; cursor: pointer; opacity: 0.6; pointer-events: none; transition: 0.2s; font-size: 0.9rem; text-transform: uppercase; box-shadow: 0 3px rgba(0,0,0,0.3); }
        .ctrl-btn.enabled { opacity: 1; pointer-events: all; transform: translateY(-3px); box-shadow: 0 6px rgba(0,0,0,0.3); }
        .ctrl-btn.enabled:active { transform: translateY(0); box-shadow: 0 2px rgba(0,0,0,0.3); }
        #btn-roll { grid-column: span 2; font-size: 1.1rem; background: var(--accent); color: var(--text-dark); }
        
        #players-list { height: 120px; overflow-y: auto; border-top: 2px solid var(--wood-border); padding-top: 10px; }
        .player-row { background: #fff; padding: 8px 12px; margin-bottom: 6px; border-radius: 20px; display: flex; justify-content: space-between; border: 2px solid transparent; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .player-row.current { border-color: var(--accent); background: #fffde7; }

        /* --- TABULEIRO (Vibrante e Solar) --- */
        #board-container { flex-grow: 1; display: flex; justify-content: center; align-items: center; background: var(--primary); position: relative; overflow: hidden; background-image: radial-gradient(circle at center, var(--primary) 0%, #01579b 100%); }
        #board { display: grid; grid-template-columns: repeat(11, 1fr); grid-template-rows: repeat(11, 1fr); width: 92vh; height: 92vh; background: var(--board-bg); border: 12px solid var(--wood-border); position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.5); border-radius: 4px; }

        .space { border: 1px solid #b0bec5; position: relative; display: flex; flex-direction: column; font-size: 0.65rem; color: var(--text-dark); font-weight: bold; text-align: center; background: white; transition: 0.3s; }
        .corner { background: #eceff1; display: flex; justify-content: center; align-items: center; font-size: 0.85rem; text-align: center; background-image: url('data:image/svg+xml;utf8,<svg width="20" height="20" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h20v20H0z" fill="none"/><path d="M2 2l16 16M18 2L2 18" stroke="%23cfd8dc" stroke-width="1"/></svg>'); }
        .color-bar { height: 22%; width: 100%; border-bottom: 2px solid rgba(0,0,0,0.2); position: relative; }
        
        /* Constru√ß√µes (Casas/Hoteis) */
        .build-slots { position: absolute; top: -4px; left: 0; width: 100%; display: flex; justify-content: center; gap: 3px; z-index: 15; }
        .house { width: 12px; height: 12px; background: var(--green-success); border: 2px solid white; border-radius: 2px; box-shadow: 1px 1px 3px rgba(0,0,0,0.4); }
        .hotel { width: 16px; height: 14px; background: var(--secondary); border: 2px solid white; border-radius: 2px; box-shadow: 1px 1px 3px rgba(0,0,0,0.4); }
        .owner-border { position: absolute; inset: 0; border: 0px solid transparent; pointer-events: none; z-index: 5; transition: border-width 0.3s; }

        /* Pe√µes (Tokens) */
        .token { width: 26px; height: 26px; border-radius: 50%; position: absolute; z-index: 20; border: 3px solid white; box-shadow: 4px 4px 8px rgba(0,0,0,0.5); transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); background-image: linear-gradient(135deg, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0) 100%); }

        /* Centro do Tabuleiro */
        .center-decor { grid-column: 2 / 11; grid-row: 2 / 11; display: flex; flex-direction: column; justify-content: center; align-items: center; opacity: 1; text-align: center; background: url('https://upload.wikimedia.org/wikipedia/commons/thumb/b/b1/Bandeira_de_Pernambuco.svg/800px-Bandeira_de_Pernambuco.svg.png') no-repeat center center; background-size: cover; z-index: 1; border: 4px solid var(--wood-border); box-shadow: inset 0 0 20px rgba(0,0,0,0.2); position: relative; }
        .center-overlay { position: absolute; inset: 0; background: rgba(255,255,255,0.85); z-index: -1; }
        .toast-area { position: absolute; top: 15%; left: 50%; transform: translateX(-50%); z-index: 100; pointer-events: none; width: 80%; }
        .toast { background: rgba(255,255,255,0.95); color: var(--text-dark); padding: 12px 25px; border-radius: 30px; margin-bottom: 8px; animation: toastAnim 4s forwards; font-weight: bold; text-align: center; border: 3px solid var(--accent); box-shadow: 0 5px 15px rgba(0,0,0,0.2); font-size: 1.1rem; }
        @keyframes toastAnim { 0% { opacity: 0; transform: translateY(30px) scale(0.8); } 10% { opacity: 1; transform: translateY(0) scale(1.05); } 20% { transform: scale(1); } 85% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-50px); } }

        /* --- OVERLAYS (Dados e Modais) --- */
        #dice-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 5000; display: none; justify-content: center; align-items: center; perspective: 1000px; }
        .dice-container { display: flex; gap: 50px; }
        .die { width: 120px; height: 120px; background: white; border-radius: 20px; border: 4px solid var(--primary); display: flex; justify-content: center; align-items: center; font-size: 4rem; color: var(--secondary); box-shadow: 0 10px 30px rgba(0,0,0,0.4); font-weight: bold; }
        .die-anim { animation: rollDice 1.5s ease-out forwards; }
        @keyframes rollDice { 0% { transform: rotateX(720deg) rotateY(360deg) translateY(-200px) scale(0.5); opacity: 0; } 60% { transform: translateY(20px); } 80% { transform: translateY(-10px); } 100% { transform: rotateX(0) rotateY(0) translateY(0) scale(1); opacity: 1; } }

        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 2000; justify-content: center; align-items: center; padding: 20px; }
        .modal-box { background: var(--panel-bg); color: var(--text-dark); padding: 30px; border-radius: 15px; width: 600px; max-width: 95%; max-height: 90vh; overflow-y: auto; border: 4px solid var(--accent); box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        
        /* Trade UI */
        .trade-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .trade-col { background: white; padding: 15px; border-radius: 10px; border: 2px solid #eee; height: 300px; overflow-y: auto; }
        .trade-col h4 { text-align: center; color: var(--primary); margin: 0 0 10px 0; }
        .prop-select-item { display: flex; align-items: center; padding: 5px; border-bottom: 1px solid #eee; }
        .prop-select-item input { width: auto; margin-right: 10px; }

        /* Responsivo */
        @media (max-width: 900px) {
            body { flex-direction: column; height: auto; overflow: auto; }
            #sidebar { width: 100%; height: auto; order: 2; border-right: none; border-top: 6px solid var(--wood-border); }
            #board-container { height: 95vw; order: 1; padding: 10px; }
            #board { width: 100%; height: 100%; border-width: 6px; }
            #my-portfolio { max-height: 200px; }
            .action-grid { grid-template-columns: repeat(3, 1fr); }
            #btn-roll { grid-column: span 3; }
            .die { width: 80px; height: 80px; font-size: 2.5rem; border-width: 3px; }
        }
    </style>
</head>
<body>

<div id="lobby">
    <div class="lobby-card">
        <h1 style="font-size: 2.5rem; margin-bottom: 10px;">Recife Imobili√°rio</h1>
        <h3 style="color: var(--secondary); margin-top: 0;">O Mestre da Cidade</h3>
        
        <div id="lobby-start">
            <input type="text" id="my-name" placeholder="Seu Apelido Recifense" maxlength="12">
            <button class="lobby-btn btn-host" onclick="net.hostGame()">üè† Criar Minha Sala</button>
            <div style="margin:15px 0; color:#999; font-weight:bold;">‚Äî OU ‚Äî</div>
            <input type="text" id="host-id-input" placeholder="Cole o C√≥digo da Sala">
            <button class="lobby-btn btn-join" onclick="net.joinGame()">üîó Entrar na Sala</button>
        </div>

        <div id="lobby-waiting" style="display:none;">
            <h3 style="color:var(--green-success);">Sala Pronta!</h3>
            <p>Toque no c√≥digo abaixo para copiar e mande para a galera:</p>
            <div style="background:#fff; padding:15px; font-family:monospace; font-size:1.4rem; cursor:pointer; border:3px dashed var(--accent); color:var(--primary); font-weight:bold;" onclick="ui.copyId()" id="my-id-display">Gerando...</div>
            <p style="margin-bottom:5px;">Jogadores na fila:</p>
            <ul id="players-lobby-list" style="list-style:none; padding:0; font-weight:bold; font-size:1.1rem; color:var(--primary);"></ul>
            <button class="lobby-btn btn-host" style="background:var(--secondary); margin-top:20px;" onclick="net.startGame()">üî• INICIAR JOGO üî•</button>
        </div>
    </div>
</div>

<div id="dice-overlay">
    <div class="dice-container">
        <div id="die-1" class="die">?</div>
        <div id="die-2" class="die">?</div>
    </div>
</div>

<div id="game-layout">
    <div id="board-container">
        <div id="board">
            <div class="center-decor">
                <div class="center-overlay"></div>
                <h1 style="margin:0; font-size:3.5rem; color:var(--secondary); -webkit-text-stroke: 1px #fff; transform: rotate(-5deg);">RECIFE</h1>
                <h2 style="margin:0; font-size:1.8rem; color:var(--primary);">Imobili√°rio</h2>
                <div id="weather-badge" style="background:var(--accent); color:var(--text-dark); padding:8px 20px; border-radius:20px; border:3px solid #fff; font-weight:bold; margin-top:15px; box-shadow:0 5px 15px rgba(0,0,0,0.1);">‚òÄÔ∏è Sol de Rachar</div>
                <div class="toast-area" id="toast-area"></div>
            </div>
            </div>
    </div>

    <div id="sidebar">
        <div class="header-logo">
            <h2>Pernambuco</h2>
        </div>
        
        <div id="turn-indicator">Aguardando in√≠cio...</div>

        <div id="my-portfolio">
            <h3>Meus Im√≥veis üè†</h3>
            <div id="portfolio-list">
                <p style="text-align:center; color:#999; font-style:italic;">Voc√™ ainda n√£o possui im√≥veis.</p>
            </div>
        </div>

        <div class="action-grid">
            <button id="btn-roll" class="ctrl-btn">üé≤ ROLAR DADOS</button>
            <button id="btn-buy" class="ctrl-btn" style="background:var(--green-success);">üí∞ COMPRAR</button>
            <button id="btn-trade" class="ctrl-btn" style="background:var(--primary);">ü§ù NEGOCIAR</button>
            <button id="btn-bail" class="ctrl-btn" style="background:var(--text-dark);">üí∏ FLANELINHA ($50)</button>
            <button id="btn-end" class="ctrl-btn" style="background:var(--secondary);">üõë PASSAR VEZ</button>
        </div>

        <div style="margin-top:15px; font-weight:bold; color:var(--primary);">Jogadores & Saldo:</div>
        <div id="players-list"></div>
    </div>
</div>

<div id="trade-modal" class="modal-overlay">
    <div class="modal-box" style="width:700px;">
        <h3>ü§ù Central de Neg√≥cios</h3>
        <div style="margin-bottom:15px;">
            Negociar com: <select id="trade-partner" style="padding:8px; font-size:1rem; border-radius:5px;"></select>
        </div>
        <div class="trade-grid">
            <div class="trade-col">
                <h4>O que VOC√ä oferece:</h4>
                <div id="trade-my-props"></div>
                <div style="margin-top:15px;">
                    Dinheiro: $<input type="number" id="trade-my-cash" value="0" min="0" style="width:80px; padding:5px;">
                </div>
            </div>
            <div class="trade-col" style="background:#e3f2fd;">
                <h4>O que voc√™ QUER:</h4>
                <div id="trade-their-props"></div>
                <div style="margin-top:15px;">
                    Dinheiro: $<input type="number" id="trade-their-cash" value="0" min="0" style="width:80px; padding:5px;">
                </div>
            </div>
        </div>
        <div style="display:flex; gap:10px; justify-content:flex-end;">
             <button class="lobby-btn" style="background:#999; width:auto;" onclick="ui.closeModal('trade-modal')">Cancelar</button>
             <button class="lobby-btn btn-host" style="width:auto;" onclick="trade.sendOffer()">ENVIAR PROPOSTA</button>
        </div>
    </div>
</div>

<div id="offer-modal" class="modal-overlay">
    <div class="modal-box" style="border-color:var(--primary);">
        <h3>üì® Proposta Recebida!</h3>
        <div id="offer-details" style="background:white; padding:15px; border-radius:10px; margin:15px 0; text-align:left;"></div>
        <div style="display:flex; gap:10px;">
             <button class="lobby-btn btn-host" style="background:var(--secondary);" onclick="trade.respond(false)">RECUSAR ‚ùå</button>
             <button class="lobby-btn btn-join" onclick="trade.respond(true)">ACEITAR ‚úÖ</button>
        </div>
    </div>
</div>

<script>
/* --- CONSTANTES & DADOS (Recife Theme) --- */
const COLORS = { brown: '#8d6e63', lightblue: '#29b6f6', pink: '#f06292', orange: '#ff7043', red: '#e53935', yellow: '#fff176', green: '#66bb6a', blue: '#1565c0' };
const CARDS = [ {t:"Ganhou na Loteria!",v:150,type:'money'}, {t:"Multa da CTTU.",v:-50,type:'money'}, {t:"Vendeu Bolo de Rolo.",v:100,type:'money'}, {t:"Reforma no AP.",v:-100,type:'money'}, {t:"Achou dinheiro em Boa Viagem.",v:20,type:'money'}, {t:"Blitz! V√° pro Tr√¢nsito.",type:'jail'}, {t:"V√° para o Marco Zero (Carmo).",type:'move',pos:8}, {t:"Volte 3 casas.",type:'move_back',val:3} ];
const BOARD = [
    {type:'start',name:'PARTIDA',price:0}, {type:'prop',group:'brown',name:'Rua da Aurora',price:60,cost:50,rent:[2,10,30,90,160,250]}, {type:'chance',name:'Sorte/Rev√©s'}, {type:'prop',group:'brown',name:'Rua do Imperador',price:60,cost:50,rent:[4,20,60,180,320,450]}, {type:'tax',name:'IPTU',price:200}, {type:'station',name:'Metr√¥ Centro',price:200}, {type:'prop',group:'lightblue',name:'Varadouro',price:100,cost:50,rent:[6,30,90,270,400,550]}, {type:'chance',name:'Sorte/Rev√©s'}, {type:'prop',group:'lightblue',name:'Marco Zero (Carmo)',price:100,cost:50,rent:[6,30,90,270,400,550]}, {type:'prop',group:'lightblue',name:'Alto da S√©',price:120,cost:50,rent:[8,40,100,300,450,600]},
    {type:'jail',name:'Tr√¢nsito Parado'}, {type:'prop',group:'pink',name:'Cordeiro',price:140,cost:100,rent:[10,50,150,450,750,950]}, {type:'utility',name:'Neoenergia',price:150}, {type:'prop',group:'pink',name:'V√°rzea',price:140,cost:100,rent:[10,50,150,450,750,950]}, {type:'prop',group:'pink',name:'Iputinga',price:160,cost:100,rent:[12,60,180,500,700,900]}, {type:'station',name:'Metr√¥ Oeste',price:200}, {type:'prop',group:'orange',name:'Torre',price:180,cost:100,rent:[14,70,200,550,750,950]}, {type:'chance',name:'Sorte/Rev√©s'}, {type:'prop',group:'orange',name:'Madalena',price:180,cost:100,rent:[14,70,200,550,750,950]}, {type:'prop',group:'orange',name:'Gra√ßas',price:200,cost:100,rent:[16,80,220,600,800,1000]},
    {type:'parking',name:'Parque da Jaqueira'}, {type:'prop',group:'red',name:'Espinheiro',price:220,cost:150,rent:[18,90,250,700,875,1050]}, {type:'chance',name:'Sorte/Rev√©s'}, {type:'prop',group:'red',name:'Aflitos',price:220,cost:150,rent:[18,90,250,700,875,1050]}, {type:'prop',group:'red',name:'Casa Forte',price:240,cost:150,rent:[20,100,300,750,925,1100]}, {type:'station',name:'Via Mangue',price:200}, {type:'prop',group:'yellow',name:'Po√ßo da Panela',price:260,cost:150,rent:[22,110,330,800,975,1150]}, {type:'prop',group:'yellow',name:'Apipucos',price:260,cost:150,rent:[22,110,330,800,975,1150]}, {type:'utility',name:'Compesa',price:150}, {type:'prop',group:'yellow',name:'Parnamirim',price:280,cost:150,rent:[24,120,360,850,1025,1200]},
    {type:'gotojail',name:'V√° p/ Tr√¢nsito'}, {type:'prop',group:'green',name:'Imbiribeira',price:300,cost:200,rent:[26,130,390,900,1100,1275]}, {type:'prop',group:'green',name:'Pina',price:300,cost:200,rent:[26,130,390,900,1100,1275]}, {type:'chance',name:'Sorte/Rev√©s'}, {type:'prop',group:'green',name:'Paiva',price:320,cost:200,rent:[28,150,450,1000,1200,1400]}, {type:'station',name:'Aeroporto',price:200}, {type:'chance',name:'Sorte/Rev√©s'}, {type:'prop',group:'blue',name:'Set√∫bal',price:350,cost:200,rent:[35,175,500,1100,1300,1500]}, {type:'tax',name:'Taxa de Luxo',price:100}, {type:'prop',group:'blue',name:'Boa Viagem',price:400,cost:200,rent:[50,200,600,1400,1700,2000]}
];
const AUDIO = { dice: new Audio('https://www.soundjay.com/misc/sounds/dice-roll-1.mp3'), cash: new Audio('https://www.soundjay.com/misc/sounds/coins-in-hand-2.mp3'), bell: new Audio('https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3'), shark: new Audio('https://www.myinstants.com/media/sounds/tubarao-te-amo.mp3'), galo: new Audio('https://www.myinstants.com/media/sounds/hino-do-galo-da-madrugada.mp3') };
function playSound(k){try{AUDIO[k].currentTime=0;AUDIO[k].play().catch(()=>{});}catch(e){}}

/* --- ESTADO & REDE --- */
let myId=null, hostConn=null, conns=[], isHost=false, myName="Player";
let state = { players:[], props:BOARD.map(()=>({owner:null,level:0})), turn:0, rolled:false, doubles:0, weather:'sun', galoCooldown:0 };
let currentOffer = null; // Para armazenar proposta recebida

const net = {
    peer: new Peer(null,{debug:1}),
    init:()=>{
        net.peer.on('open',id=>myId=id);
        net.peer.on('connection',c=>{ if(!isHost)return; c.on('data',d=>net.handleData(d,c)); conns.push(c); });
        net.peer.on('error',e=>alert("Erro P2P: "+e));
    },
    hostGame:()=>{ myName=document.getElementById('my-name').value||"Host"; if(!myId)return alert("Gerando ID..."); isHost=true; state.players.push({id:myId,name:myName,color:'#d32f2f',money:1500,pos:0,jailed:false,turnsJailed:0,out:false}); ui.toLobbyWait(); },
    joinGame:()=>{ myName=document.getElementById('my-name').value||"Guest"; const id=document.getElementById('host-id-input').value; if(!id)return alert("Cole o ID!"); hostConn=net.peer.connect(id); hostConn.on('open',()=>{ hostConn.send({type:'JOIN',name:myName}); document.querySelector('.lobby-card').innerHTML="<h3>Conectado! Aguardando Host...</h3>"; }); hostConn.on('data',d=>net.handleClient(d)); },
    startGame:()=>{ if(state.players.length<2)return alert("M√≠nimo 2 jogadores!"); net.broadcast({type:'START',state:state}); game.start(state); },
    handleData:(d,conn)=>{ // HOST receives
        if(d.type==='JOIN'){ const cls=['#1976d2','#388e3c','#fbc02d','#8e24aa','#e64a19']; state.players.push({id:conn.peer,name:d.name,color:cls[state.players.length%5],money:1500,pos:0,jailed:false,turnsJailed:0,out:false}); net.broadcast({type:'LOBBY_UPD',list:state.players}); }
        else if(d.type==='ACT') game.process(d.act,d.val,d.pid);
        else if(d.type==='TRADE_OFFER') trade.processOffer(d.offer);
        else if(d.type==='TRADE_RESP') trade.processResponse(d.resp);
    },
    handleClient:(d)=>{ // CLIENT receives
        if(d.type==='LOBBY_UPD') ui.updateLobby(d.list);
        else if(d.type==='START') game.start(d.state);
        else if(d.type==='STATE') { state=d.state; ui.render(); }
        else if(d.type==='TOAST') ui.toast(d.msg,d.sub);
        else if(d.type==='SOUND') playSound(d.key);
        else if(d.type==='DICE_ANIM') ui.playDiceAnim(d.d1, d.d2);
        else if(d.type==='TRADE_SHOW') trade.showOffer(d.offer);
    },
    broadcast:(msg)=>{ if(isHost){ conns.forEach(c=>c.send(msg)); if(msg.type==='STATE')ui.render(); if(msg.type==='TOAST')ui.toast(msg.msg,msg.sub); if(msg.type==='SOUND')playSound(msg.key); if(msg.type==='DICE_ANIM')ui.playDiceAnim(msg.d1,msg.d2); if(msg.type==='TRADE_SHOW')trade.showOffer(msg.offer); } else hostConn.send(msg); },
    sendTo: (pid, msg) => { if(isHost) { if(pid===myId) net.handleClient(msg); else conns.find(c=>c.peer===pid)?.send(msg); }}
};

/* --- ENGINE --- */
const game = {
    start:(s)=>{ state=s; document.getElementById('lobby').style.display='none'; document.getElementById('game-layout').classList.add('active'); ui.initBoard(); ui.setupButtons(); ui.render(); },
    act:(t,v)=>{ if(isHost) game.process(t,v,myId); else hostConn.send({type:'ACT',act:t,val:v,pid:myId}); },
    process:(act,val,pid)=>{
        const pIdx=state.players.findIndex(p=>p.id===pid), p=state.players[pIdx];
        if(state.turn!==pIdx || p.out) return;

        if(act==='roll'){
            if(state.rolled)return;
            const d1=Math.ceil(Math.random()*6), d2=Math.ceil(Math.random()*6);
            net.broadcast({type:'DICE_ANIM', d1:d1, d2:d2}); // Trigger animation first
            
            setTimeout(() => { // Process logic after animation
                if(p.jailed){
                    if(d1===d2){ p.jailed=false; p.turnsJailed=0; net.broadcast({type:'TOAST',msg:"Saiu do Tr√¢nsito!",sub:"Dados iguais"}); game.move(p,d1+d2); state.rolled=true; }
                    else{ p.turnsJailed++; if(p.turnsJailed>=3){ p.money-=50; p.jailed=false; p.turnsJailed=0; net.broadcast({type:'TOAST',msg:"Pagou $50 e saiu",sub:"Tempo esgotado"}); game.move(p,d1+d2); } else net.broadcast({type:'TOAST',msg:"Continua preso...",sub:`${p.turnsJailed}/3`}); state.rolled=true; }
                } else {
                    if(d1===6&&d2===6&&state.galoCooldown===0){ net.broadcast({type:'TOAST',msg:"üêì GALO DA MADRUGADA!",sub:"Todos pro Centro!"}); net.broadcast({type:'SOUND',key:'galo'}); state.players.forEach(pl=>{if(!pl.out){pl.pos=8;pl.money-=50;}}); state.galoCooldown=4; state.rolled=true; }
                    else{
                        if(d1===d2)state.doubles++; else state.doubles=0;
                        if(state.doubles>=3){ net.broadcast({type:'TOAST',msg:"Excesso de Velocidade!",sub:"Preso"}); game.toJail(p); game.endTurn(); return; }
                        game.move(p,d1+d2);
                        if(d1!==d2)state.rolled=true; else net.broadcast({type:'TOAST',msg:"Dados Iguais!",sub:"Jogue de novo"});
                    }
                }
                net.broadcast({type:'STATE',state:state});
            }, 2000); // Sync with animation duration
        }
        else if(act==='buy'){ const spot=BOARD[p.pos]; if(p.money>=spot.price && state.props[p.pos].owner===null){ p.money-=spot.price; state.props[p.pos].owner=pIdx; net.broadcast({type:'TOAST',msg:`${p.name} comprou ${spot.name}`,sub:`-$${spot.price}`}); net.broadcast({type:'SOUND',key:'cash'}); net.broadcast({type:'STATE',state:state}); }}
        else if(act==='bail'){ if(p.jailed && p.money>=50){ p.money-=50; p.jailed=false; p.turnsJailed=0; state.rolled=false; net.broadcast({type:'TOAST',msg:"Pagou o Flanelinha",sub:"Livre"}); net.broadcast({type:'SOUND',key:'cash'}); net.broadcast({type:'STATE',state:state}); }}
        else if(act==='end'){ game.endTurn(); net.broadcast({type:'STATE',state:state}); }
    },
    move:(p,steps)=>{
        p.pos+=steps; if(p.pos>=40){p.pos-=40;p.money+=200;net.broadcast({type:'TOAST',msg:"13¬∫ Sal√°rio!",sub:"+$200"});}
        const spot=BOARD[p.pos], prop=state.props[p.pos];
        if(spot.type==='chance'){ const c=CARDS[Math.floor(Math.random()*CARDS.length)]; net.broadcast({type:'TOAST',msg:"Sorte ou Rev√©s",sub:c.t}); if(c.type==='money')p.money+=c.v; else if(c.type==='jail')game.toJail(p); else if(c.type==='move')p.pos=c.pos; else if(c.type==='move_back')p.pos-=c.val; }
        else if(spot.type==='gotojail'){ net.broadcast({type:'TOAST',msg:"Blitz!",sub:"V√° pro Tr√¢nsito"}); game.toJail(p); return; }
        else if(spot.type==='tax'){ p.money-=spot.price; net.broadcast({type:'TOAST',msg:"Pagou Imposto",sub:`-$${spot.price}`}); }
        else if(prop.owner!==null && prop.owner!==state.players.indexOf(p)){
            const isFlood=state.weather==='rain'&&(spot.group==='green'||spot.group==='orange'||spot.group==='pink');
            if(isFlood) net.broadcast({type:'TOAST',msg:"Rua Alagada!",sub:"Aluguel Gr√°tis"});
            else{ let r=(spot.type==='prop'?spot.rent[prop.level]:(spot.type==='station'?50:100)); p.money-=r; state.players[prop.owner].money+=r; net.broadcast({type:'TOAST',msg:`Pagou Aluguel a ${state.players[prop.owner].name}`,sub:`-$${r}`}); net.broadcast({type:'SOUND',key:'cash'}); }
        }
        if(['Boa Viagem','Pina','Paiva'].some(s=>spot.name.includes(s))&&Math.random()<0.25){ p.money-=100; net.broadcast({type:'TOAST',msg:"TUBAR√ÉO! ü¶à",sub:"Mordida: -$100"}); net.broadcast({type:'SOUND',key:'shark'}); }
        if(p.money<0) game.bankrupt(p);
    },
    toJail:(p)=>{ p.pos=10; p.jailed=true; p.turnsJailed=0; state.rolled=true; net.broadcast({type:'SOUND',key:'bell'}); },
    bankrupt:(p)=>{ p.out=true; state.props.forEach(pr=>{if(pr.owner===state.players.indexOf(p)){pr.owner=null;pr.level=0;}}); net.broadcast({type:'TOAST',msg:`${p.name} FALIU!`,sub:"Game Over"}); },
    endTurn:()=>{ state.turn=(state.turn+1)%state.players.length; while(state.players[state.turn].out)state.turn=(state.turn+1)%state.players.length; state.rolled=false; state.doubles=0; if(state.galoCooldown>0)state.galoCooldown--;
        if(Math.random()<0.15){ state.weather=state.weather==='sun'?'rain':'sun'; net.broadcast({type:'TOAST',msg:state.weather==='rain'?'üåßÔ∏è Chuva Forte!':'‚òÄÔ∏è O Sol abriu!',sub:state.weather==='rain'?'Alagamentos':'Normal'}); }
        net.broadcast({type:'SOUND',key:'bell'}); }
};

/* --- TRADE SYSTEM (Novo) --- */
const trade = {
    openUI: () => {
        const myP = state.players.find(p=>p.id===myId), myIdx = state.players.indexOf(myP);
        const partnerSel = document.getElementById('trade-partner');
        partnerSel.innerHTML = '<option value="">Selecione...</option>';
        state.players.forEach((p,i) => { if(i!==myIdx && !p.out) partnerSel.innerHTML += `<option value="${p.id}">${p.name}</option>`; });
        
        const renderProps = (pid, containerId) => {
            const container = document.getElementById(containerId); container.innerHTML = '';
            BOARD.forEach((b,i) => { if(b.type==='prop' && state.props[i].owner === state.players.findIndex(p=>p.id===pid)) {
                container.innerHTML += `<div class="prop-select-item"><input type="checkbox" value="${i}"> <span style="color:${COLORS[b.group]}">‚ñ†</span> ${b.name}</div>`;
            }});
        };
        renderProps(myId, 'trade-my-props');
        partnerSel.onchange = () => { if(partnerSel.value) renderProps(partnerSel.value, 'trade-their-props'); else document.getElementById('trade-their-props').innerHTML=''; };
        document.getElementById('trade-my-cash').value=0; document.getElementById('trade-their-cash').value=0;
        ui.openModal('trade-modal');
    },
    sendOffer: () => {
        const targetId = document.getElementById('trade-partner').value;
        if(!targetId) return alert("Selecione um parceiro!");
        const getChecked = (cid) => Array.from(document.querySelectorAll(`#${cid} input:checked`)).map(cb=>parseInt(cb.value));
        const offer = {
            from: myId, to: targetId,
            offerProps: getChecked('trade-my-props'), offerCash: parseInt(document.getElementById('trade-my-cash').value)||0,
            wantProps: getChecked('trade-their-props'), wantCash: parseInt(document.getElementById('trade-their-cash').value)||0
        };
        if(isHost) trade.processOffer(offer); else hostConn.send({type:'TRADE_OFFER', offer:offer});
        ui.closeModal('trade-modal'); alert("Proposta enviada!");
    },
    processOffer: (offer) => { // Host only
        // Basic validation (check funds/ownership again) - simplified here
        net.sendTo(offer.to, {type:'TRADE_SHOW', offer:offer});
    },
    showOffer: (offer) => { // Target only
        currentOffer = offer;
        const fromName = state.players.find(p=>p.id===offer.from).name;
        let html = `<p><b>${fromName}</b> oferece:</p><ul>`;
        offer.offerProps.forEach(idx => html += `<li>${BOARD[idx].name}</li>`);
        if(offer.offerCash > 0) html += `<li>$${offer.offerCash}</li>`;
        html += `</ul><p>Em troca de:</p><ul>`;
        offer.wantProps.forEach(idx => html += `<li>${BOARD[idx].name}</li>`);
        if(offer.wantCash > 0) html += `<li>$${offer.wantCash}</li>`;
        html += `</ul>`;
        document.getElementById('offer-details').innerHTML = html;
        ui.openModal('offer-modal');
    },
    respond: (accepted) => {
        ui.closeModal('offer-modal');
        if(isHost) trade.processResponse({offer:currentOffer, accepted:accepted});
        else hostConn.send({type:'TRADE_RESP', resp:{offer:currentOffer, accepted:accepted}});
    },
    processResponse: (resp) => { // Host executes trade
        const off = resp.offer;
        const pFrom = state.players.find(p=>p.id===off.from), pTo = state.players.find(p=>p.id===off.to);
        const idxFrom = state.players.indexOf(pFrom), idxTo = state.players.indexOf(pTo);
        
        if(resp.accepted) {
            pFrom.money -= off.offerCash; pTo.money += off.offerCash;
            pTo.money -= off.wantCash; pFrom.money += off.wantCash;
            off.offerProps.forEach(idx => { state.props[idx].owner = idxTo; state.props[idx].level = 0; }); // Reset buildings on trade
            off.wantProps.forEach(idx => { state.props[idx].owner = idxFrom; state.props[idx].level = 0; });
            net.broadcast({type:'TOAST', msg:"Neg√≥cio Fechado!", sub:`Entre ${pFrom.name} e ${pTo.name}`});
            net.broadcast({type:'STATE', state:state});
        } else {
            net.sendTo(off.from, {type:'TOAST', msg:"Proposta Recusada", sub:`por ${pTo.name}`});
        }
        currentOffer = null;
    }
};

/* --- UI & ANIMATIONS --- */
const ui = {
    initBoard:()=>{
        const b=document.getElementById('board');
        BOARD.forEach((s,i)=>{
            const d=document.createElement('div'); d.id=`space-${i}`;
            let r,c; if(i<=10){r=11;c=11-i;}else if(i<=20){r=11-(i-10);c=1;}else if(i<=30){r=1;c=1+(i-20);}else{r=1+(i-30);c=11;}
            d.style.gridRow=r; d.style.gridColumn=c; d.className=(i%10===0)?'space corner':'space';
            if(s.type==='prop'){ d.innerHTML=`<div class="color-bar" style="background:${COLORS[s.group]}"></div><div style="flex-grow:1;display:flex;flex-direction:column;justify-content:center;">${s.name}<br>$${s.price}</div><div class="build-slots" id="build-${i}"></div><div class="owner-border" id="border-${i}"></div>`; }
            else{ d.innerHTML=`<div style="margin:auto;">${s.name}</div>`; }
            b.appendChild(d);
        });
    },
    setupButtons: () => {
        document.getElementById('btn-roll').onclick = () => game.act('roll');
        document.getElementById('btn-buy').onclick = () => game.act('buy');
        document.getElementById('btn-trade').onclick = () => trade.openUI();
        document.getElementById('btn-bail').onclick = () => game.act('bail');
        document.getElementById('btn-end').onclick = () => game.act('end');
    },
    render:()=>{
        const pList=document.getElementById('players-list'); pList.innerHTML='';
        state.players.forEach((p,i)=>{ if(p.out)return; const r=document.createElement('div'); r.className=`player-row ${state.turn===i?'current':''}`; r.style.borderLeftColor=p.color; r.innerHTML=`<span>${p.name} ${state.turn===i?'(Vez)':''}</span> <b>$${p.money}</b>`; pList.appendChild(r); });
        
        const myP=state.players.find(p=>p.id===myId), amITurn=myP&&state.players[state.turn].id===myId&&!myP.out;
        const ind=document.getElementById('turn-indicator'); ind.innerText=`Vez de: ${state.players[state.turn].name}`;
        if(amITurn) ind.classList.add('my-turn-anim'); else ind.classList.remove('my-turn-anim');

        ui.btn('btn-roll', amITurn && !state.rolled);
        ui.btn('btn-buy', amITurn && state.rolled && !myP.jailed && BOARD[myP.pos].type==='prop' && state.props[myP.pos].owner===null);
        ui.btn('btn-trade', amITurn && !state.rolled); // Can trade before rolling
        ui.btn('btn-end', amITurn && state.rolled);
        ui.btn('btn-bail', amITurn && myP.jailed && !state.rolled);

        document.getElementById('weather-badge').innerText = state.weather==='rain'?'üåßÔ∏è Chuva Forte':'‚òÄÔ∏è Sol de Rachar';
        document.getElementById('board').style.filter = state.weather==='rain'?'grayscale(0.5) contrast(1.1)':'none';

        document.querySelectorAll('.token').forEach(e=>e.remove());
        state.players.forEach((p,i)=>{ if(p.out)return; const t=document.createElement('div'); t.className='token'; t.style.background=p.color;
            const s=document.getElementById(`space-${p.pos}`), bR=document.getElementById('board').getBoundingClientRect(), sR=s.getBoundingClientRect();
            t.style.top=(sR.top-bR.top+10+(i*3))+'px'; t.style.left=(sR.left-bR.left+5+(i*3))+'px'; document.getElementById('board').appendChild(t); });

        state.props.forEach((pr,i)=>{
            const border=document.getElementById(`border-${i}`), build=document.getElementById(`build-${i}`);
            if(border){ border.style.border=pr.owner!==null?`4px solid ${state.players[pr.owner].color}`:'none';
            build.innerHTML=''; if(pr.level===5)build.innerHTML='<div class="hotel"></div>'; else for(let k=0;k<pr.level;k++)build.innerHTML+='<div class="house"></div>'; }
        });
        ui.updatePortfolio();
    },
    updatePortfolio: () => {
        const myP = state.players.find(p=>p.id===myId); if(!myP) return;
        const myIdx = state.players.indexOf(myP);
        const list = document.getElementById('portfolio-list'); list.innerHTML = '';
        let hasProps = false;
        BOARD.forEach((b, i) => {
            if(b.type === 'prop' && state.props[i].owner === myIdx) {
                hasProps = true;
                list.innerHTML += `<div class="portfolio-item"><div class="color-dot" style="background:${COLORS[b.group]}"></div> ${b.name} (Nv. ${state.props[i].level})</div>`;
            }
        });
        if(!hasProps) list.innerHTML = '<p style="text-align:center; color:#999; font-style:italic; font-size:0.8rem;">Voc√™ ainda n√£o possui im√≥veis.</p>';
    },
    playDiceAnim: (d1, d2) => {
        const overlay = document.getElementById('dice-overlay');
        const die1 = document.getElementById('die-1');
        const die2 = document.getElementById('die-2');
        die1.innerText = '?'; die2.innerText = '?';
        overlay.style.display = 'flex';
        die1.classList.add('die-anim'); die2.classList.add('die-anim');
        playSound('dice');
        setTimeout(() => { die1.innerText = d1; die2.innerText = d2; }, 1000);
        setTimeout(() => {
            overlay.style.display = 'none';
            die1.classList.remove('die-anim'); die2.classList.remove('die-anim');
        }, 2500);
    },
    btn:(id,on)=>{ const b=document.getElementById(id); if(on){b.classList.add('enabled');b.disabled=false;}else{b.classList.remove('enabled');b.disabled=true;} },
    toast:(msg,sub)=>{ const a=document.getElementById('toast-area'), e=document.createElement('div'); e.className='toast'; e.innerHTML=`<div>${msg}</div><small>${sub||''}</small>`; a.appendChild(e); setTimeout(()=>e.remove(),4000); },
    openModal: (id) => document.getElementById(id).style.display = 'flex',
    closeModal: (id) => document.getElementById(id).style.display = 'none',
    toLobbyWait:()=>{ document.getElementById('lobby-start').style.display='none'; document.getElementById('lobby-waiting').style.display='block'; document.getElementById('my-id-display').innerText=myId; },
    updateLobby:(l)=>{ document.getElementById('players-lobby-list').innerHTML=l.map(p=>`<li>üë§ ${p.name}</li>`).join(''); },
    copyId:()=>{ navigator.clipboard.writeText(myId); alert("Copiado!"); }
};

net.init();
</script>
</body>
</html>
