<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Recife Imobili√°rio: V15 Ultimate</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rye&family=Poppins:wght@400;600;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-carnaval: linear-gradient(135deg, #ff9800 0%, #f44336 50%, #9c27b0 100%);
            --wood: #3e2723; --paper: #fff8e1; --glass: rgba(255, 255, 255, 0.95);
            --gold: #ffca28; --frevo-blue: #0277bd; --shadow-deep: 0 30px 60px rgba(0,0,0,0.6);
        }
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Poppins', sans-serif; background: var(--bg-carnaval); height: 100vh; overflow: hidden; display: flex; flex-direction: column; transition: filter 2s; }
        h1, h2, h3, .brand { font-family: 'Rye', serif; letter-spacing: 1px; text-shadow: 2px 2px 0px rgba(0,0,0,0.2); }

        /* AMBIENTE */
        #rain-canvas { position: fixed; inset: 0; pointer-events: none; z-index: 8000; display: none; }
        .night-mode { filter: brightness(0.6) contrast(1.2); }

        /* --- LOBBY & CHARS --- */
        #screen-lobby, #screen-char { position: fixed; inset: 0; z-index: 9000; background: url('https://www.transparenttextures.com/patterns/cubes.png'), var(--bg-carnaval); display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .estandarte-card { background: var(--paper); width: 90%; max-width: 450px; padding: 30px; border: 8px solid var(--wood); border-radius: 10px 10px 50px 50px; text-align: center; box-shadow: var(--shadow-deep); position: relative; }
        .input-recife { width: 100%; padding: 15px; margin: 10px 0; border: 3px solid var(--wood); font-family: 'Rye'; font-size: 1.1rem; text-align: center; border-radius: 8px; }
        .btn-frevo { width: 100%; padding: 15px; margin-top: 10px; border: none; border-radius: 50px; font-size: 1.2rem; font-weight: 900; text-transform: uppercase; cursor: pointer; box-shadow: 0 5px 0 rgba(0,0,0,0.2); color: white; font-family: 'Rye'; transition: transform 0.1s; }
        .btn-frevo:active { transform: translateY(4px); box-shadow: none; }
        .bg-blue { background: #0288d1; } .bg-green { background: #43a047; } .bg-red { background: #d32f2f; }

        .char-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 20px 0; }
        .char-opt { background: rgba(255,255,255,0.2); border: 2px solid #fff; border-radius: 10px; padding: 10px; cursor: pointer; transition: 0.3s; text-align: center; }
        .char-opt.taken { opacity: 0.4; filter: grayscale(1); cursor: not-allowed; }
        .char-opt.selected { background: var(--gold); transform: scale(1.1); border-color: var(--wood); color: black; }
        .char-icon { font-size: 2.5rem; }

        /* --- JOGO --- */
        #game-layout { display: flex; width: 100%; height: 100%; opacity: 0; transition: 1s; pointer-events: none; }
        #game-layout.active { opacity: 1; pointer-events: all; }
        
        #board-viewport { flex: 1; perspective: 1500px; display: flex; align-items: center; justify-content: center; background: radial-gradient(circle at center, #4fc3f7, #01579b); overflow: hidden; }
        #board { display: grid; grid-template-columns: repeat(11, 80px); grid-template-rows: repeat(11, 80px); background: #f5f5f5; border: 20px solid var(--wood); border-radius: 12px; position: relative; transform-style: preserve-3d; transition: transform 1s; box-shadow: var(--shadow-deep); background-image: url('https://www.transparenttextures.com/patterns/white-brick-wall.png'); }
        
        .space { border: 1px solid rgba(0,0,0,0.1); background: rgba(255,255,255,0.9); font-size: 0.6rem; text-align: center; position: relative; font-weight: bold; display: flex; flex-direction: column; transition: 0.3s; }
        .space:hover { transform: translateZ(10px); z-index: 10; border: 2px solid var(--gold); }
        .color-bar { height: 25%; border-bottom: 2px solid #333; }
        
        .center-hub { grid-column: 2/11; grid-row: 2/11; background: #e1f5fe; border: 5px solid var(--wood); display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; overflow: hidden; }
        .umbrella-spin { position: absolute; width: 200%; height: 200%; opacity: 0.1; background: conic-gradient(red 0deg 45deg, green 45deg 90deg, yellow 90deg 135deg, blue 135deg 180deg, red 180deg 225deg, green 225deg 270deg, yellow 270deg 315deg, blue 315deg 360deg); animation: spin 20s linear infinite; }
        
        .token { width: 45px; height: 45px; position: absolute; z-index: 50; font-size: 2.5rem; text-align: center; line-height: 45px; filter: drop-shadow(0 10px 5px rgba(0,0,0,0.5)); transition: all 0.4s ease-in-out; transform-origin: bottom center; }
        .jump { animation: jump 0.4s; } @keyframes jump { 50% { transform: translateY(-40px) scale(1.1); } }

        /* HUD */
        #sidebar { width: 360px; background: rgba(255,255,255,0.95); padding: 15px; display: flex; flex-direction: column; z-index: 100; border-left: 8px solid var(--wood); box-shadow: -10px 0 30px rgba(0,0,0,0.3); }
        .btn-game { padding: 10px; border: 3px solid #000; border-radius: 5px; font-weight: bold; cursor: pointer; opacity: 0.5; pointer-events: none; transition: 0.2s; text-transform: uppercase; font-size: 0.8rem; }
        .btn-game.on { opacity: 1; pointer-events: all; transform: translateY(-2px); box-shadow: 0 4px 0 rgba(0,0,0,0.3); }
        .btn-game.on:active { transform: translateY(0); box-shadow: none; }

        .p-card { background: #fff; padding: 8px; margin-bottom: 5px; border-radius: 5px; border-left: 5px solid #ccc; display: flex; justify-content: space-between; font-weight: 600; font-size: 0.9rem; }
        .p-card.active { background: #fff9c4; transform: scale(1.02); border-color: var(--gold); }

        /* SCROLL PROPRIEDADES */
        #my-deeds { flex: 1; overflow-y: auto; border: 1px solid #ccc; background: #fff8e1; margin-bottom: 10px; padding: 5px; }
        .deed-row { font-size: 0.8rem; border-bottom: 1px dashed #aaa; padding: 3px; }

        /* REA√á√ïES */
        .react-bar { display: flex; justify-content: space-around; margin-top: 10px; border-top: 2px dashed #ccc; padding-top: 10px; }
        .react-btn { font-size: 1.5rem; cursor: pointer; transition: 0.2s; }
        .react-btn:hover { transform: scale(1.3); }

        /* OVERLAYS */
        #overlay-layer { position: fixed; inset: 0; pointer-events: none; z-index: 5000; display: flex; justify-content: center; align-items: center; }
        
        /* DADOS 3D */
        #dice-wrap { display: none; gap: 50px; perspective: 1000px; }
        .cube { width: 90px; height: 90px; position: relative; transform-style: preserve-3d; transition: transform 1.5s cubic-bezier(0.1, 0.9, 0.2, 1); }
        .face { position: absolute; width: 100%; height: 100%; background: #fff; border: 4px solid #000; border-radius: 12px; display: flex; justify-content: center; align-items: center; font-size: 3rem; font-weight: bold; backface-visibility: hidden; box-shadow: inset 0 0 15px rgba(0,0,0,0.1); }
        .face:nth-child(1) { transform: translateZ(45px); } .face:nth-child(6) { transform: rotateX(180deg) translateZ(45px); }
        .face:nth-child(2) { transform: rotateY(90deg) translateZ(45px); } .face:nth-child(5) { transform: rotateY(-90deg) translateZ(45px); }
        .face:nth-child(3) { transform: rotateX(90deg) translateZ(45px); } .face:nth-child(4) { transform: rotateX(-90deg) translateZ(45px); }
        .show-1 { transform: rotateX(0deg) rotateY(0deg); } .show-6 { transform: rotateX(180deg) rotateY(0deg); }
        .show-2 { transform: rotateY(-90deg); } .show-5 { transform: rotateY(90deg); }
        .show-3 { transform: rotateX(-90deg); } .show-4 { transform: rotateX(90deg); }

        /* CARD ZOOM */
        #card-zoom { display: none; pointer-events: auto; background: rgba(0,0,0,0.7); position: fixed; inset: 0; z-index: 6000; justify-content: center; align-items: center; }
        .big-card { width: 300px; background: #fff; border-radius: 15px; border: 4px solid #fff; box-shadow: 0 0 50px rgba(0,0,0,0.8); overflow: hidden; animation: popIn 0.3s; }
        .bc-head { padding: 20px; text-align: center; color: white; font-family: 'Rye'; font-size: 1.5rem; text-shadow: 1px 1px 0 #000; }
        .bc-body { padding: 20px; font-size: 1.1rem; }

        /* TRADE MODAL */
        #trade-modal { display: none; pointer-events: auto; position: fixed; inset: 0; z-index: 7000; background: rgba(0,0,0,0.9); flex-direction: column; justify-content: center; align-items: center; }
        .trade-box { background: #fff; padding: 20px; border-radius: 10px; width: 90%; max-width: 600px; border: 5px solid var(--frevo-blue); }

        /* ANIMA√á√ïES GERAIS */
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes popIn { 0%{transform:scale(0)} 80%{transform:scale(1.1)} 100%{transform:scale(1)} }
        .floater { position: absolute; font-size: 4rem; animation: floatUp 3s forwards; z-index: 9999; }
        @keyframes floatUp { 0% { transform: translateY(0); opacity: 0; } 20% { opacity: 1; } 100% { transform: translateY(-300px); opacity: 0; } }

        @media (min-width: 900px) { #board { transform: rotateX(25deg) scale(0.85); } }
        @media (max-width: 899px) { #game-layout { flex-direction: column; } #sidebar { order: 2; height: auto; border-top: 8px solid var(--wood); width: 100%; } #board { transform: scale(0.55); margin-bottom: 20px; } }
    </style>
</head>
<body>

<canvas id="rain-canvas"></canvas>

<div id="screen-lobby">
    <h1 style="color:#fff; font-size:3rem; margin-bottom:10px;">RECIFE DE OURO</h1>
    <div class="estandarte-card">
        <h2 style="color:var(--wood); margin:0;">CONCENTRA√á√ÉO</h2>
        <input id="p-name" class="input-recife" placeholder="Apelido do Foli√£o" maxlength="12">
        <div id="lobby-controls">
            <button class="btn-frevo bg-blue" onclick="net.host()">CRIAR BLOCO</button>
            <p style="margin:10px; font-weight:bold; color:#aaa;">- OU -</p>
            <input id="host-id" class="input-recife" placeholder="C√≥digo da Sala" style="font-size:0.9rem;">
            <button class="btn-frevo bg-green" onclick="net.join()">ENTRAR NO BLOCO</button>
        </div>
        <div id="lobby-status" style="display:none; margin-top:20px; border-top: 2px dashed #ccc; padding-top:10px;">
            <p style="font-weight:bold; color:var(--frevo-blue);">Sala: <span id="disp-id" onclick="util.copy()" style="background:#eee; padding:5px; cursor:pointer;">...</span></p>
            <div id="player-list-area"></div>
            <p id="host-msg" style="font-size:0.8rem; color:#d32f2f; display:none;">Aguardando o Mestre iniciar...</p>
            <button id="btn-phase-1" class="btn-frevo bg-red" style="display:none;" onclick="net.toChar()">ABRIR ALAS (Escolher Pe√£o)</button>
        </div>
    </div>
</div>

<div id="screen-char" style="display:none;">
    <h1 style="color:var(--gold);">ESCOLHA A FANTASIA</h1>
    <div class="char-grid" id="char-grid"></div>
    <h2 id="char-status" style="color:#fff;">Aguardando...</h2>
    <button id="btn-start-game" class="btn-frevo bg-green" style="width:300px; display:none;" onclick="net.startGame()">TOCAR O FREVO!</button>
</div>

<div id="game-layout">
    <div id="board-viewport">
        <div id="board">
            <div class="center-hub">
                <div class="umbrella-spin"></div>
                <h1 style="color:var(--frevo-blue); z-index:2; text-shadow:2px 2px #fff; font-size:3rem; margin:0;">RECIFE</h1>
                <div id="weather-badge" style="z-index:2; background:#fff; padding:5px; border:2px solid #000; border-radius:10px;">‚òÄÔ∏è Sol</div>
            </div>
            </div>
    </div>
    
    <div id="sidebar">
        <div style="display:flex; justify-content:space-between; padding-bottom:10px; margin-bottom:10px; border-bottom:2px dashed #000;">
            <h2 style="margin:0; color:#d32f2f;">Pernambuco</h2>
            <div id="my-cash" style="font-size:1.5rem; font-weight:900; color:#388e3c;">$1500</div>
        </div>
        <div id="turn-msg" style="background:#333; color:#ffd700; text-align:center; padding:5px; border-radius:5px; font-weight:bold; margin-bottom:10px;">...</div>
        
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px;">
            <button id="b-roll" class="btn-game" style="background:var(--gold); color:#000; grid-column:span 2;">üé≤ ROLAR</button>
            <button id="b-buy" class="btn-game" style="background:#43a047; color:#fff;">üí∞ COMPRAR</button>
            <button id="b-trade" class="btn-game" style="background:var(--frevo-blue); color:#fff;">ü§ù NEGOCIAR</button>
            <button id="b-bail" class="btn-game" style="background:#607d8b; color:#fff;">üí∏ SUBORNO</button>
            <button id="b-end" class="btn-game" style="background:#d32f2f; color:#fff;">üõë PASSAR</button>
        </div>

        <div style="font-weight:bold; font-size:0.8rem;">Jogadores:</div>
        <div id="hud-list" style="margin-bottom:10px;"></div>
        
        <div style="font-weight:bold; font-size:0.8rem;">Minhas Escrituras:</div>
        <div id="my-deeds"></div>

        <div class="react-bar">
            <div class="react-btn" onclick="game.react('üòÇ')">üòÇ</div>
            <div class="react-btn" onclick="game.react('üò°')">üò°</div>
            <div class="react-btn" onclick="game.react('ü¶à')">ü¶à</div>
            <div class="react-btn" onclick="game.react('üëè')">üëè</div>
        </div>
    </div>
</div>

<div id="overlay-layer">
    <div id="dice-wrap" style="display:none;">
        <div id="d1" class="cube"><div class="face">1</div><div class="face">2</div><div class="face">3</div><div class="face">4</div><div class="face">5</div><div class="face">6</div></div>
        <div id="d2" class="cube"><div class="face">1</div><div class="face">2</div><div class="face">3</div><div class="face">4</div><div class="face">5</div><div class="face">6</div></div>
    </div>
</div>

<div id="card-zoom">
    <div class="big-card">
        <div class="bc-head" id="card-h">Nome</div>
        <div class="bc-body" id="card-b">Detalhes</div>
        <button class="btn-frevo bg-red" style="width:100%; margin:0;" onclick="document.getElementById('card-zoom').style.display='none'">FECHAR</button>
    </div>
</div>

<div id="trade-modal">
    <div class="trade-box">
        <h2>ü§ù Feira de Caruaru</h2>
        <select id="trade-target" style="width:100%; padding:10px; margin-bottom:10px;"></select>
        <div style="display:flex; justify-content:space-between; font-size:2rem;">
            <div>ü§ë <input id="trade-give" type="number" value="0" style="width:80px;"></div>
            <div>üëâ</div>
            <div>üí∞ <input id="trade-want" type="number" value="0" style="width:80px;"></div>
        </div>
        <button class="btn-frevo bg-green" onclick="trade.send()">ENVIAR PROPOSTA</button>
        <button class="btn-frevo bg-red" onclick="document.getElementById('trade-modal').style.display='none'">CANCELAR</button>
    </div>
</div>

<script>
/* DADOS */
const CHARS=[{id:'crab',i:'ü¶Ä',n:'Caranguejo'},{id:'shark',i:'ü¶à',n:'Tubar√£o'},{id:'umb',i:'‚òÇÔ∏è',n:'Sombrinha'},{id:'sun',i:'‚òÄÔ∏è',n:'Sol'},{id:'drum',i:'ü•Å',n:'Tambor'},{id:'coco',i:'ü••',n:'Coco'},{id:'ursa',i:'üêª',n:'La Ursa'},{id:'corn',i:'üåΩ',n:'Milho'}];
const BD=[{t:'st',n:'MARCO ZERO'},{t:'pr',g:'#795548',n:'Aurora',p:60,r:[2,10]},{t:'ch',n:'Sorte'},{t:'pr',g:'#795548',n:'Imperador',p:60,r:[4,20]},{t:'tx',n:'IPTU',p:200},{t:'rr',n:'Metr√¥'},{t:'pr',g:'#03a9f4',n:'Varadouro',p:100,r:[6,30]},{t:'ch',n:'Rev√©s'},{t:'pr',g:'#03a9f4',n:'Carmo',p:100,r:[6,30]},{t:'pr',g:'#03a9f4',n:'Alto da S√©',p:120,r:[8,40]},{t:'jl',n:'Tr√¢nsito'},{t:'pr',g:'#e91e63',n:'Cordeiro',p:140,r:[10,50]},{t:'ut',n:'Neoenergia',p:150},{t:'pr',g:'#e91e63',n:'V√°rzea',p:140,r:[10,50]},{t:'pr',g:'#e91e63',n:'Iputinga',p:160,r:[12,60]},{t:'rr',n:'Metr√¥ Oeste'},{t:'pr',g:'#ff5722',n:'Torre',p:180,r:[14,70]},{t:'ch',n:'Sorte'},{t:'pr',g:'#ff5722',n:'Madalena',p:180,r:[14,70]},{t:'pr',g:'#ff5722',n:'Gra√ßas',p:200,r:[16,80]},{t:'pk',n:'Jaqueira'},{t:'pr',g:'#d32f2f',n:'Espinheiro',p:220,r:[18,90]},{t:'ch',n:'Rev√©s'},{t:'pr',g:'#d32f2f',n:'Aflitos',p:220,r:[18,90]},{t:'pr',g:'#d32f2f',n:'Casa Forte',p:240,r:[20,100]},{t:'rr',n:'Via Mangue'},{t:'pr',g:'#fbc02d',n:'Po√ßo',p:260,r:[22,110]},{t:'pr',g:'#fbc02d',n:'Apipucos',p:260,r:[22,110]},{t:'ut',n:'Compesa',p:150},{t:'pr',g:'#fbc02d',n:'Parnamirim',p:280,r:[24,120]},{t:'gj',n:'Blitz!'},{t:'pr',g:'#388e3c',n:'Imbiribeira',p:300,r:[26,130]},{t:'pr',g:'#388e3c',n:'Pina',p:300,r:[26,130]},{t:'ch',n:'Sorte'},{t:'pr',g:'#388e3c',n:'Paiva',p:320,r:[28,150]},{t:'rr',n:'Aeroporto'},{t:'ch',n:'Rev√©s'},{t:'pr',g:'#1565c0',n:'Set√∫bal',p:350,r:[35,175]},{t:'tx',n:'Taxa',p:100},{t:'pr',g:'#1565c0',n:'Boa Viagem',p:400,r:[50,200]}];
const SFX={dice:new Audio('https://www.soundjay.com/misc/sounds/dice-roll-1.mp3'),cash:new Audio('https://www.soundjay.com/misc/sounds/coins-in-hand-2.mp3')};
const play=(k)=>{try{SFX[k].currentTime=0;SFX[k].play().catch(()=>{})}catch(e){}};

/* STATE */
let myId=null, hostConn=null, conns=[], isHost=false, me={name:"Foli√£o",char:null};
let state={phase:'LOBBY',players:[],turn:0,rolled:false,props:BD.map(()=>({owner:null})), weather:'sun'};

/* NET */
const net={
    peer:new Peer(null,{debug:1}),
    init:()=>{net.peer.on('open',id=>myId=id);net.peer.on('connection',c=>{if(isHost){c.on('open',()=>c.send({t:'WELCOME',l:state.players}));c.on('data',d=>net.host(d,c));conns.push(c);}});},
    host:()=>{const n=document.getElementById('p-name').value.trim();if(!n)return;isHost=true;me.name=n;state.players.push({id:myId,name:n,char:null,money:1500,pos:0,jailed:false});ui.screen('lobby-wait');},
    join:()=>{const n=document.getElementById('p-name').value.trim(),id=document.getElementById('host-id').value.trim();if(!n||!id)return;me.name=n;hostConn=net.peer.connect(id);hostConn.on('open',()=>{hostConn.send({t:'JOIN',name:n});document.getElementById('lobby-controls').innerHTML="<h3>Conectando...</h3>";});hostConn.on('data',d=>net.cli(d));},
    toChar:()=>{if(state.players.length<2)return alert("M√≠nimo 2!");net.bc({t:'PHASE',p:'CHARS'});ui.screen('chars');},
    startGame:()=>{if(state.players.some(p=>!p.char))return alert("Escolham!");net.bc({t:'PHASE',p:'GAME',st:state});ui.start();},
    host:(d,c)=>{
        if(d.t==='JOIN'){if(!state.players.find(p=>p.id===c.peer)){state.players.push({id:c.peer,name:d.name,char:null,money:1500,pos:0,jailed:false});net.bc({t:'UPD',l:state.players});ui.rLobby(state.players);}}
        else if(d.t==='PICK'){const p=state.players.find(x=>x.id===d.pid);if(p){p.char=d.char;net.bc({t:'UPD',l:state.players});ui.rChars();}}
        else if(d.t==='ACT')game.proc(d);
        else if(d.t==='TRD')trade.proc(d);
    },
    cli:(d)=>{
        if(d.t==='WELCOME'||d.t==='UPD'){state.players=d.l;if(state.phase==='LOBBY')ui.rLobby(d.l);if(state.phase==='CHARS')ui.rChars();}
        else if(d.t==='PHASE'){state.phase=d.p;if(d.p==='CHARS')ui.screen('chars');if(d.p==='GAME'){state=d.st;ui.start();}}
        else if(d.t==='STATE'){state=d.st;ui.rGame();}
        else if(d.t==='ANIM')ui.dice(d.d1,d.d2);
        else if(d.t==='TOAST')ui.toast(d.m);
        else if(d.t==='SHOW_CARD')ui.card(d.i);
        else if(d.t==='REACT')ui.reactShow(d.e);
        else if(d.t==='TRD_SHOW')trade.show(d.o);
    },
    bc:(m)=>{if(isHost){conns.forEach(c=>c.send(m));if(m.t==='UPD'||m.t==='STATE'){}}else hostConn.send(m);}
};

/* GAME */
const game={
    act:(a)=>{const d={t:'ACT',act:a,pid:myId};if(isHost)game.proc(d);else hostConn.send(d);},
    proc:(d)=>{
        const idx=state.players.findIndex(p=>p.id===d.pid),p=state.players[idx];
        if(state.turn!==idx)return;
        if(d.act==='roll'){
            if(state.rolled)return;
            const d1=Math.ceil(Math.random()*6),d2=Math.ceil(Math.random()*6);
            net.bc({t:'ANIM',d1,d2});if(isHost)ui.dice(d1,d2);
            setTimeout(()=>{
                let mv=d1+d2;
                if(p.jailed){if(d1===d2){p.jailed=false;game.mv(p,mv);state.rolled=true;}else state.rolled=true;}
                else{game.mv(p,mv);if(d1!==d2)state.rolled=true;}
                net.bc({t:'STATE',st:state});if(isHost)ui.rGame();
            },2500);
        }
        else if(d.act==='buy'){const s=BD[p.pos];if(p.money>=s.p&&state.props[p.pos].owner===null){p.money-=s.p;state.props[p.pos].owner=idx;play('cash');net.bc({t:'TOAST',m:`${p.name} comprou ${s.n}`});net.bc({t:'STATE',st:state});}}
        else if(d.act==='bail'){if(p.jailed&&p.money>=50){p.money-=50;p.jailed=false;state.rolled=true;net.bc({t:'STATE',st:state});}}
        else if(d.act==='end'){state.turn=(state.turn+1)%state.players.length;state.rolled=false;env.chk();net.bc({t:'STATE',st:state});}
        if(isHost)ui.rGame();
    },
    mv:(p,s)=>{
        p.pos+=s;if(p.pos>=40){p.pos-=40;p.money+=200;}
        const pr=state.props[p.pos];
        if(pr.owner!==null&&pr.owner!==state.players.indexOf(p)){let r=BD[p.pos].r?BD[p.pos].r[0]:50;p.money-=r;state.players[pr.owner].money+=r;}
        if(BD[p.pos].t==='pr') net.bc({t:'SHOW_CARD',i:p.pos});
    },
    react:(e)=>{const d={t:'REACT',e};if(isHost)net.bc(d);else hostConn.send(d);}
};

/* TRADE */
const trade={
    open:()=>{const s=document.getElementById('trade-target');s.innerHTML='';state.players.forEach(p=>{if(p.id!==myId)s.innerHTML+=`<option value="${p.id}">${p.name}</option>`});document.getElementById('trade-modal').style.display='flex';},
    send:()=>{
        const t=document.getElementById('trade-target').value, g=parseInt(document.getElementById('trade-give').value), w=parseInt(document.getElementById('trade-want').value);
        const o={f:myId,t:t,g:g,w:w};
        const d={t:'ACT',act:'trade',o:o}; if(isHost)trade.proc({t:'TRD',o});else hostConn.send({t:'TRD',o});
        document.getElementById('trade-modal').style.display='none';
    },
    proc:(d)=>{net.bc({t:'TRD_SHOW',o:d.o});},
    show:(o)=>{if(o.t===myId){if(confirm(`Troca: Receber $${o.g} por Pagar $${o.w}?`)){const me=state.players.find(p=>p.id===myId),him=state.players.find(p=>p.id===o.f);me.money+=o.g-o.w;him.money+=o.w-o.g;game.act('end');} }}
};

/* ENV */
const env={
    chk:()=>{if(Math.random()<0.1){state.weather=state.weather==='sun'?'rain':'sun';}},
    rain:()=>{
        const c=document.getElementById('rain-canvas'),ctx=c.getContext('2d');c.width=window.innerWidth;c.height=window.innerHeight;
        const d=Array(100).fill().map(()=>({x:Math.random()*c.width,y:Math.random()*c.height,s:Math.random()*5+2}));
        const draw=()=>{
            ctx.clearRect(0,0,c.width,c.height);
            if(state.weather==='rain'){c.style.display='block';document.body.classList.add('night-mode');ctx.strokeStyle='rgba(174,194,224,0.5)';d.forEach(p=>{ctx.beginPath();ctx.moveTo(p.x,p.y);ctx.lineTo(p.x,p.y+p.s);ctx.stroke();p.y+=p.s;if(p.y>c.height)p.y=0;});}
            else{c.style.display='none';document.body.classList.remove('night-mode');}
            requestAnimationFrame(draw);
        };draw();
    }
};

/* UI */
const ui={
    screen:(k)=>{document.getElementById('screen-lobby').style.display=k==='lobby'?'flex':'none';if(k==='lobby-wait'){document.getElementById('lobby-controls').style.display='none';document.getElementById('lobby-status').style.display='block';document.getElementById('disp-id').innerText=myId;document.getElementById('btn-phase-1').style.display='block';ui.rLobby(state.players);}document.getElementById('screen-char').style.display=k==='chars'?'flex':'none';document.getElementById('game-layout').classList.toggle('active',k==='game');if(k==='chars')ui.rChars();},
    rLobby:(l)=>{document.getElementById('player-list-area').innerHTML=l.map(p=>`<span style="background:#fff;border:1px solid #000;padding:5px;margin:5px;display:inline-block;">${p.name}</span>`).join('');if(!isHost){document.getElementById('lobby-controls').style.display='none';document.getElementById('lobby-status').style.display='block';document.getElementById('host-msg').style.display='block';document.getElementById('disp-id').innerText="Conectado!";}},
    rChars:()=>{const g=document.getElementById('char-grid');g.innerHTML='';CHARS.forEach(c=>{const taken=state.players.find(p=>p.char===c.id),isMe=taken&&taken.id===myId;g.innerHTML+=`<div class="char-opt ${taken?'taken':''} ${isMe?'selected':''}" onclick="${!taken?`ui.pick('${c.id}')`:''}"><div class="char-icon">${c.i}</div><div>${c.n}</div>${taken?`<small>${taken.name}</small>`:''}</div>`;});const r=state.players.every(p=>p.char);document.getElementById('char-status').innerText=r?"Prontos!":"Aguardando...";if(isHost&&r)document.getElementById('btn-start-game').style.display='block';},
    pick:(id)=>{if(isHost){state.players.find(x=>x.id===myId).char=id;net.bc({t:'UPD',l:state.players});ui.rChars();}else hostConn.send({t:'PICK',pid:myId,char:id});},
    start:()=>{document.getElementById('screen-char').style.display='none';document.getElementById('game-layout').classList.add('active');ui.genBoard();ui.rGame();confetti();ui.binds();env.rain();},
    genBoard:()=>{const b=document.getElementById('board');BD.forEach((s,i)=>{const d=document.createElement('div');d.className='space';d.id=`s${i}`;let r,c;if(i<=10){r=11;c=11-i;}else if(i<=20){r=11-(i-10);c=1;}else if(i<=30){r=1;c=1+(i-20);}else{r=1+(i-30);c=11;}d.style.gridRow=r;d.style.gridColumn=c;d.innerHTML=s.t==='pr'?`<div class="color-bar" style="background:${s.g}"></div><div>${s.n}<br>$${s.p}</div>`:`<div style="margin:auto">${s.n}</div>`;b.appendChild(d);});},
    rGame:()=>{
        const meP=state.players.find(p=>p.id===myId),trn=state.players[state.turn];
        document.getElementById('my-cash').innerText=`$${meP.money}`;document.getElementById('turn-msg').innerText=`Vez de: ${trn.name}`;
        const myT=trn.id===myId,s=BD[meP.pos];
        ui.btn('b-roll',myT&&!state.rolled);ui.btn('b-buy',myT&&state.rolled&&s.t==='pr'&&state.props[meP.pos].owner===null);ui.btn('b-trade',myT);ui.btn('b-bail',myT&&meP.jailed);ui.btn('b-end',myT&&state.rolled);
        document.getElementById('hud-list').innerHTML=state.players.map((p,i)=>{const c=CHARS.find(x=>x.id===p.char);return `<div class="p-card ${state.turn===i?'active':''}"><span>${c.i} ${p.name}</span><span>${p.id===myId?'$'+p.money:'???'}</span></div>`;}).join('');
        document.querySelectorAll('.token').forEach(e=>e.remove());state.players.forEach((p,i)=>{const c=CHARS.find(x=>x.id===p.char),t=document.createElement('div');t.className='token';t.innerText=c.i;const sp=document.getElementById(`s${p.pos}`),br=document.getElementById('board').getBoundingClientRect(),sr=sp.getBoundingClientRect();t.style.left=(sr.left-br.left+10+((i%3)*10))+'px';t.style.top=(sr.top-br.top+10+(Math.floor(i/3)*10))+'px';document.getElementById('board').appendChild(t);if(state.rolled&&state.turn===i)setTimeout(()=>t.classList.add('jump'),50);});
        state.props.forEach((pr,i)=>{if(pr.owner!==null)document.getElementById(`s${i}`).style.border=`4px solid ${state.players[pr.owner].color||'#000'}`;});
        const md=document.getElementById('my-deeds');md.innerHTML='';state.props.forEach((pr,i)=>{if(state.players[pr.owner]?.id===myId)md.innerHTML+=`<div class="deed-row">${BD[i].n}</div>`});
    },
    btn:(id,on)=>{const b=document.getElementById(id);if(on){b.classList.add('on');b.disabled=false;}else{b.classList.remove('on');b.disabled=true;}},
    binds:()=>{document.getElementById('b-roll').onclick=()=>game.act('roll');document.getElementById('b-buy').onclick=()=>game.act('buy');document.getElementById('b-trade').onclick=()=>trade.open();document.getElementById('b-bail').onclick=()=>game.act('bail');document.getElementById('b-end').onclick=()=>game.act('end');},
    dice:(d1,d2)=>{const o=document.getElementById('dice-wrap');o.style.display='flex';play('dice');const c1=document.querySelector('#d1'),c2=document.querySelector('#d2');c1.style.transition='none';c2.style.transition='none';c1.className='cube';c2.className='cube';void c1.offsetWidth;c1.style.transition='transform 1.5s';c2.style.transition='transform 1.5s';const m=['show-1','show-2','show-3','show-4','show-5','show-6'];setTimeout(()=>{c1.classList.add(m[d1-1]);c2.classList.add(m[d2-1]);},50);setTimeout(()=>o.style.display='none',2500);},
    card:(i)=>{const s=BD[i],ov=document.getElementById('card-zoom');document.getElementById('card-h').innerText=s.n;document.getElementById('card-h').style.background=s.g||'#333';document.getElementById('card-b').innerHTML=`Pre√ßo: $${s.p}<br>Aluguel: $${s.r?s.r[0]:50}`;ov.style.display='flex';},
    toast:(m)=>{const d=document.createElement('div');d.className='floater';d.innerText=m;document.body.appendChild(d);setTimeout(()=>d.remove(),3000);},
    reactShow:(e)=>{const d=document.createElement('div');d.className='floater';d.style.left=(Math.random()*80+10)+'%';d.style.top='80%';d.innerText=e;document.body.appendChild(d);setTimeout(()=>d.remove(),3000);}
};
const util={copy:()=>{navigator.clipboard.writeText(myId);alert("Copiado!");}};
net.init();
</script>
</body>
</html>
