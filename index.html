<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Recife Imobili√°rio: Multiplayer Completo</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Titan+One&family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* --- CSS ORIGINAL (VISUAL V65.1) --- */
        :root {
            --wood: #5d4037; --paper: #fff8e1;
            --c-blue: #0277bd; --c-red: #d32f2f; --c-green: #2e7d32; --c-yel: #fbc02d;
            --c-dark: #263238; --board-bg: #c5e1a5; 
            --space-bg: #ffffff; --border-col: #1a1a1a;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; font-family: 'Nunito', sans-serif; 
            background: linear-gradient(120deg, #1565c0, #fbc02d, #c62828, #1565c0);
            background-size: 400% 400%;
            animation: frevoBG 15s ease infinite;
            height: 100dvh; overflow: hidden; display: flex; flex-direction: column;
        }
        @keyframes frevoBG { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }

        h1, h2, h3, button, .brand { font-family: 'Titan One', cursive; letter-spacing: 1px; text-shadow: 2px 2px 0 rgba(0,0,0,0.3); }

        /* FX LAYERS */
        #fx-layer { position: fixed; inset: 0; pointer-events: none; z-index: 8000; overflow: hidden; }
        .shark-anim { position: absolute; bottom: 25%; right: -50vw; font-size: 30vh; filter: drop-shadow(10px 10px 0 #000); transition: 0.1s; display: none; transform: scaleX(-1); }
        .shark-anim.active { display: block; animation: sharkPass 4s linear forwards; }
        @keyframes sharkPass { 0% {right: -50vw;} 100% {right: 120vw;} }
        .traffic-anim { position: absolute; inset: 0; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; font-family: 'Titan One'; color: #ffeb3b; font-size: 3rem; text-align: center; animation: pulseTraffic 0.5s infinite; text-shadow: 0 0 20px red; flex-direction: column; z-index: 8500; }
        .traffic-anim.active { display: flex; }
        @keyframes pulseTraffic { 0%{opacity:0.9;} 100%{opacity:1;} }

        /* MODAIS DE REDE E LOBBY */
        #screen-login, #screen-lobby, #screen-char, #screen-end, #screen-trade { position: fixed; inset: 0; z-index: 9999; background: rgba(0,0,0,0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; overflow-y: auto; }
        #screen-lobby, #screen-char, #screen-end, #screen-trade { display: none; }

        .card-menu { background: #fff; border: 8px solid var(--c-dark); border-radius: 30px; padding: 25px; text-align: center; width: 90%; max-width: 450px; box-shadow: 0 20px 0 var(--c-yel); margin: auto; }
        .inp-box { width: 100%; padding: 15px; margin: 10px 0; border: 3px solid var(--c-dark); border-radius: 10px; font-size: 1.2rem; font-family: 'Nunito'; font-weight: 800; text-align: center; }
        .btn-main { width: 100%; padding: 15px; margin-top: 15px; border: none; border-radius: 50px; font-size: 1.5rem; background: var(--c-green); color: #fff; cursor: pointer; box-shadow: 0 6px 0 #1b5e20; transition: 0.1s; text-transform: uppercase; }
        .btn-main:active { transform: translateY(4px); box-shadow: 0 3px 0 #1b5e20; }
        .btn-sec { background: var(--c-blue); box-shadow: 0 6px 0 #01579b; }

        /* LOBBY LISTAS */
        .player-list { list-style: none; padding: 0; margin: 20px 0; max-height: 200px; overflow-y: auto; text-align: left; }
        .player-li { background: #eee; margin: 5px 0; padding: 10px; border-radius: 8px; display: flex; justify-content: space-between; font-weight: 800; align-items: center; }
        .player-li.ready { background: #c8e6c9; border: 2px solid var(--c-green); }
        .char-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 15px; max-height: 40vh; overflow-y: auto; }
        .char-opt { border: 2px solid #ccc; border-radius: 12px; padding: 10px; cursor: pointer; background: #fff; font-size: 2rem; text-align: center; position: relative; transition: 0.2s; }
        .char-opt.selected { border-color: var(--c-blue); background: #e3f2fd; transform: scale(1.1); z-index: 10; }
        .char-opt.taken { opacity: 0.4; pointer-events: none; filter: grayscale(1); background: #cfd8dc; }

        /* --- LAYOUT JOGO --- */
        #game-layout { display: none; width: 100%; height: 100%; overflow: hidden; }
        #game-layout.active { display: flex; }

        /* TABULEIRO E C√ÇMERA */
        #board-area { position: relative; overflow: auto; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.2); flex: 1; padding: 20px; }
        #board-container { position: relative; transform-origin: center center; }
        #board { width: 100%; height: 100%; display: grid; grid-template-columns: repeat(11, 1fr); grid-template-rows: repeat(11, 1fr); background: var(--board-bg); border: 4px solid var(--border-col); box-shadow: 0 0 50px rgba(0,0,0,0.5); }

        /* HUD */
        #hud-panel { background: #fff; display: flex; flex-direction: column; z-index: 5000; box-shadow: 0 0 30px rgba(0,0,0,0.5); flex-shrink: 0; }
        
        /* RESPONSIBILIDADE */
        @media (max-width: 899px) {
            #game-layout { flex-direction: column; }
            #board-container { width: 900px; height: 1250px; }
            #hud-panel { width: 100%; padding: 10px; background: #f5f5f5; border-top: 4px solid var(--c-dark); }
            .hud-content { display: none; }
            #mobile-controls { display:flex; flex-direction:column; gap:5px; }
            .hud-top-bar { display:flex; justify-content:space-between; align-items:center; background:#fff; padding:10px; border-radius:10px; border:2px solid #ccc; }
        }
        @media (min-width: 900px) {
            #game-layout { flex-direction: row; }
            #hud-panel { width: 380px; height: 100%; border-left: 6px solid var(--c-dark); padding: 0; }
            #board-container { width: 1300px; height: 1000px; }
            #mobile-controls { display:none; }
            .hud-top-bar { padding: 15px; background: #eceff1; border-bottom: 2px dashed #cfd8dc; display: flex; justify-content: space-between; align-items: center; }
            .hud-content { padding: 20px; display: flex; flex-direction: column; flex: 1; overflow: hidden; }
        }

        /* SPACE DESIGN */
        .space { background: var(--space-bg); border: 1px solid var(--border-col); position: relative; display: flex; flex-direction: column; font-size: 0.75rem; font-weight: 800; color: #000; }
        .rot-left { transform: rotate(90deg); } .rot-top { transform: rotate(180deg); } .rot-right { transform: rotate(-90deg); }
        .space-content { width:100%; height:100%; display:flex; flex-direction:column; justify-content:space-between; text-align:center; padding: 2px; }
        .color-strip { height: 20%; width: 100%; border-bottom: 2px solid #000; }
        .sp-name { flex: 1; display: flex; align-items: center; justify-content: center; line-height: 1.1; font-weight: 900; padding:0 2px; }
        .sp-price { font-family: 'Nunito'; font-weight: 700; padding-bottom: 5px; font-size: 0.85rem; }
        .sp-icon { font-size: 2.5rem; display: flex; align-items: center; justify-content: center; height: 100%; }
        .space.owned { border: 4px solid !important; z-index: 5; }

        /* CENTER HUB & DECKS (RESTAURADOS) */
        .center-hub { grid-column: 2/11; grid-row: 2/11; position: relative; background: transparent; display: flex; justify-content: center; align-items: center; flex-direction: column; pointer-events: none; }
        .brennand-tower { position: relative; display: flex; flex-direction: column; align-items: center; filter: drop-shadow(10px 10px 20px rgba(0,0,0,0.5)); transform: scale(1.5); }
        .bt-head { font-size: 5rem; line-height: 0.6; z-index: 2; color: #546e7a; text-shadow: 2px 2px 0 #000; }
        .bt-body { width: 40px; height: 180px; background: linear-gradient(90deg, #37474f, #78909c, #37474f); border: 2px solid #000; border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: space-around; z-index: 1; margin-top: -10px; }
        .bt-ring { width: 100%; height: 5px; background: #000; }
        .bt-base { width: 100px; height: 40px; background: #5d4037; border: 3px solid #000; border-radius: 5px; margin-top: -5px; display: flex; justify-content: center; align-items: center; color: #fff; font-size: 0.6rem; font-family:'Titan One'; }

        .deck { position: absolute; width: 110px; height: 150px; border-radius: 15px; cursor: pointer; box-shadow: 0 10px 0 rgba(0,0,0,0.2), 0 10px 20px rgba(0,0,0,0.4); z-index: 10; display: flex; align-items: center; justify-content: center; text-align: center; font-family: 'Titan One'; font-size: 1.5rem; color: #fff; -webkit-text-stroke: 1px rgba(0,0,0,0.3); pointer-events: auto; border: 2px solid rgba(255,255,255,0.4); transition: transform 0.1s; }
        .deck:active { transform: translateY(4px); box-shadow: 0 6px 0 rgba(0,0,0,0.2); }
        .deck.chance { top: 20%; left: 15%; background: linear-gradient(135deg, #ab47bc, #7b1fa2); transform: rotate(-5deg); }
        .deck.reves { bottom: 20%; right: 15%; background: linear-gradient(135deg, #ffa726, #f57c00); transform: rotate(5deg); }
        .deck-label { font-size: 3rem; opacity: 0.8; }

        /* TOKENS & BUILDINGS */
        .token { width: 50px; height: 50px; position: absolute; z-index: 50; font-size: 3rem; text-align: center; line-height: 50px; transition: top 0.2s linear, left 0.2s linear; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.6)); pointer-events: none; }
        .build-area { position: absolute; top: 2px; width: 100%; display: flex; justify-content: center; gap: 2px; z-index: 4; }
        .house-3d { width: 12px; height: 12px; background: var(--c-green); border: 1px solid #000; box-shadow: 1px 1px 0 #000; }
        .hotel-3d { width: 18px; height: 18px; background: var(--c-red); border: 1px solid #000; box-shadow: 1px 1px 0 #000; }

        /* UI ELEMENTS */
        .turn-badge { background: var(--c-dark); color: #fff; padding: 5px 15px; border-radius: 20px; font-size: 0.9rem; font-family: 'Titan One'; }
        .money-display { font-size: 1.6rem; color: var(--c-green); font-family: 'Titan One'; }
        
        .btn-game { border: none; border-radius: 12px; font-family: 'Titan One'; cursor: pointer; color: #fff; box-shadow: 0 4px 0 rgba(0,0,0,0.2); text-transform: uppercase; position: relative; width: 100%; transition: 0.1s; display: flex; align-items: center; justify-content: center; text-align: center; padding: 15px; margin-bottom: 5px; }
        .btn-game:active { transform: translateY(2px); box-shadow: 0 2px 0 rgba(0,0,0,0.2); }
        .btn-game:disabled { background: #cfd8dc !important; color: #b0bec5 !important; box-shadow: none; transform: translateY(2px); cursor: default; }
        .btn-roll { background: var(--c-yel); color: var(--c-dark); }
        .btn-buy { background: var(--c-green); }
        .btn-pass { background: var(--c-red); }
        .btn-trade { background: #7b1fa2; color: #fff; }

        .p-stat { background: #fff; border: 1px solid #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: space-between; font-weight: 700; font-size: 0.8rem; padding: 8px; margin-bottom: 5px; }
        .p-stat.active-turn { background: #e3f2fd; border: 2px solid var(--c-blue); transform: scale(1.02); }

        /* OVERLAYS */
        #overlay-layer { position: fixed; inset: 0; pointer-events: none; z-index: 9500; display: flex; justify-content: center; align-items: center; }
        #overlay-bg { position:absolute; inset:0; background:rgba(0,0,0,0.7); pointer-events:auto; display:none; }
        .prop-card { width: 90%; max-width: 400px; background: #fff; border-radius: 20px; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.8); pointer-events: auto; display: none; border: 4px solid var(--c-dark); animation: popIn 0.3s; z-index: 9600; position:relative; }
        .pc-head { padding: 15px; background: var(--c-blue); color: #fff; font-family: 'Titan One'; font-size: 1.4rem; text-align: center; }
        @keyframes popIn { from{transform:scale(0)} to{transform:scale(1)} }

        /* DADOS (BOLINHAS) & ANIMA√á√ÉO */
        #dice-container { position: absolute; top:35%; left:50%; transform:translateX(-50%); display:flex; gap:20px; z-index: 7000; pointer-events: none; opacity: 0; transition: opacity 0.2s; }
        .die-box { width: 80px; height: 80px; background: #fff; border-radius: 12px; border: 4px solid var(--c-dark); box-shadow: 0 10px 20px rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; }
        .die-face { display: grid; width: 100%; height: 100%; padding: 8px; grid-template-columns: 1fr 1fr 1fr; grid-template-rows: 1fr 1fr 1fr; }
        .dot { background: var(--c-dark); border-radius: 50%; width: 12px; height: 12px; align-self: center; justify-self: center; }
        .shake-dice { animation: shakeAnim 0.5s infinite; }
        @keyframes shakeAnim { 0%{transform:rotate(0deg);} 25%{transform:rotate(10deg);} 75%{transform:rotate(-10deg);} }

        /* TOAST E INVENT√ÅRIO */
        .toast { position: fixed; top: 10%; left: 50%; transform: translateX(-50%); background: #fff; color: #000; padding: 15px 30px; border-radius: 50px; border: 4px solid var(--c-yel); z-index: 10000; animation: slideDown 3s forwards; font-family: 'Titan One'; font-size: 1.2rem; box-shadow: 0 10px 30px rgba(0,0,0,0.4); white-space: nowrap; text-align: center; }
        @keyframes slideDown { 0%{opacity:0;transform:translate(-50%,-50px)} 10%{opacity:1;transform:translate(-50%,0)} 90%{opacity:1} 100%{opacity:0;transform:translate(-50%,-50px)} }
        
        #inv-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:7000; flex-direction:column; padding:20px; align-items: center; justify-content: center; }
        #inv-list { flex:1; overflow-y:auto; width:100%; max-width:500px; background: #fff; padding: 10px; border-radius: 10px; display: flex; flex-direction: column; gap: 5px; }

        /* TRADE UI */
        .trade-board { background: #fff; border: 6px solid var(--c-dark); border-radius: 20px; width: 95%; max-width: 800px; max-height: 90vh; display: flex; flex-direction: column; overflow: hidden; }
        .trade-cols { display: flex; flex: 1; overflow: hidden; background: #eee; }
        .trade-side { flex: 1; display: flex; flex-direction: column; border-right: 2px solid #ccc; padding: 10px; }
        .t-item { background: #fff; padding: 8px; border-radius: 5px; font-size: 0.85rem; font-weight: bold; cursor: pointer; border: 2px solid transparent; }
        .t-item.selected { border-color: var(--c-green); background: #e8f5e9; }
        .handshake-anim { position: fixed; inset: 0; pointer-events: none; z-index: 9850; display: none; justify-content: center; align-items: center; font-size: 15rem; animation: shakeHands 1s ease-in-out; text-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        @keyframes shakeHands { 0%{transform: scale(0) rotate(-20deg);} 50%{transform: scale(1.2) rotate(10deg);} 100%{transform: scale(1) rotate(0deg);} }
    </style>
</head>
<body>

<div id="fx-layer">
    <div class="shark-anim">ü¶à</div>
    <div class="traffic-anim"><div style="font-size:5rem;">üõë</div><div>ENGARRAFAMENTO!</div></div>
</div>

<div id="screen-login">
    <div class="card-menu">
        <h1 style="color:var(--c-blue); font-size:2.5rem; margin:0; line-height:1;">RECIFE ONLINE<br><span style="font-size:1rem; color:#000;">MULTIPLAYER</span></h1>
        <input type="text" id="my-name" class="inp-box" placeholder="Seu Nome" maxlength="10">
        <hr style="border:1px dashed #ccc; margin: 15px 0;">
        <button class="btn-main" onclick="net.createRoom()">CRIAR SALA</button>
        <p style="font-weight:900; margin:10px;">OU</p>
        <input type="text" id="room-code" class="inp-box" placeholder="C√≥digo da Sala">
        <button class="btn-main btn-sec" onclick="net.joinRoom()">ENTRAR NA SALA</button>
    </div>
</div>

<div id="screen-lobby">
    <div class="card-menu">
        <h2 style="margin:0;">SALA DE ESPERA</h2>
        <div style="background:#fff3e0; padding:10px; border-radius:10px; margin-top:10px; font-weight:bold;">
            C√ìDIGO: <span id="lobby-code" style="font-size:1.5rem; color:var(--c-blue); font-family:'Titan One';">...</span>
            <br><small>(Copiado! Envie aos amigos)</small>
        </div>
        <ul class="player-list" id="lobby-list"></ul>
        <div id="host-ctrl" style="display:none;">
            <button class="btn-main" onclick="net.sendStartCharSelect()">IR PARA SELE√á√ÉO</button>
        </div>
        <div id="client-wait" style="display:block; margin-top:20px; color:#666; font-weight:bold;">
            Aguardando anfitri√£o...
        </div>
    </div>
</div>

<div id="screen-char">
    <div class="card-menu">
        <h2>ESCOLHA SEU BONECO</h2>
        <div class="char-grid" id="char-grid"></div>
        <button id="btn-conf-char" class="btn-main" style="background:#ccc;" disabled onclick="game.confirmChar()">CONFIRMAR</button>
        <p id="char-status" style="font-size:0.9rem; margin-top:10px; font-weight:bold;">...</p>
    </div>
</div>

<div id="screen-trade">
    <div class="handshake-anim">ü§ù</div>
    <div class="trade-board">
        <div class="trade-header">NEGOCIA√á√ÉO</div>
        <div style="padding:10px; text-align:center; background:#fff;">
            <label style="font-weight:bold;">COM QUEM?</label>
            <select id="trade-target" class="inp-box" style="padding:5px; width:auto;" onchange="tradeUI.updateLists()"></select>
        </div>
        <div class="trade-cols">
            <div class="trade-side" style="background:#e3f2fd;">
                <div class="t-title" style="text-align:center; font-weight:bold; color:var(--c-blue)">VOC√ä OFERECE</div>
                <div style="padding:5px;">üí∞ <input type="number" id="trade-give-money" value="0" min="0" step="10" style="width:80px;"></div>
                <div class="t-list" id="list-give"></div>
            </div>
            <div class="trade-side" style="background:#ffebee;">
                <div class="t-title" style="text-align:center; font-weight:bold; color:var(--c-red)">VOC√ä QUER</div>
                <div style="padding:5px;">üí∞ <input type="number" id="trade-get-money" value="0" min="0" step="10" style="width:80px;"></div>
                <div class="t-list" id="list-get"></div>
            </div>
        </div>
        <div style="padding:15px; background:#fff; display:flex; gap:10px; justify-content:center;">
            <button class="btn-game btn-pass" style="width:auto; padding:10px 30px;" onclick="tradeUI.close()">CANCELAR</button>
            <button class="btn-game btn-buy" style="width:auto; padding:10px 30px;" onclick="tradeUI.sendProposal()">ENVIAR PROPOSTA</button>
        </div>
    </div>
</div>

<div id="game-layout">
    <div id="board-area">
        <div id="board-container">
            <div id="board">
                <div class="center-hub">
                    <div class="brennand-tower">
                        <div class="bt-head">üå∑</div>
                        <div class="bt-body">
                            <div class="bt-ring"></div><div class="bt-ring"></div><div class="bt-ring"></div>
                        </div>
                        <div class="bt-base">RECIFE</div>
                    </div>
                </div>
                <div class="deck chance" onclick="game.clickDeck('ch')"><div class="deck-label">?</div></div>
                <div class="deck reves" onclick="game.clickDeck('rev')"><div style="font-size:2rem">üí∞</div></div>
            </div>
        </div>
    </div>

    <div id="hud-panel">
        <div id="mobile-controls"> <div style="display:flex; justify-content:space-between; align-items:center; padding:10px; background:#fff;">
                <div>
                     <div class="turn-badge" id="turn-display-mob">Sua Vez</div>
                     <div class="money-display" id="p-money-mob">$500</div>
                </div>
                <button class="btn-inv" style="width:auto;" onclick="ui.toggleInv()">üíº</button>
            </div>
        </div>

        <div class="hud-top-bar">
            <div>
                <div class="turn-badge" id="turn-display">AGUARDANDO...</div>
                <div class="money-display" id="p-money" style="font-weight:900;">$500</div>
            </div>
            <button class="btn-game btn-trade" style="width:auto; padding:8px 15px; font-size:0.8rem;" onclick="tradeUI.open()">ü§ù NEGOCIAR</button>
        </div>

        <div class="hud-content">
            <div style="flex:1; overflow-y:auto; padding:5px;" id="players-hud-list"></div>
            <div id="desktop-props-container"></div>
        </div>

        <div style="padding:10px; background:#eee; display:flex; flex-direction:column; gap:5px;">
            <button id="b-roll" class="btn-game btn-roll" disabled onclick="net.sendAction('ROLL')">üé≤ ROLAR DADOS</button>
            <div style="display:flex; gap:5px;">
                <button id="b-buy" class="btn-game btn-buy" disabled onclick="net.sendAction('BUY')">COMPRAR</button>
                <button id="b-pass" class="btn-game btn-pass" disabled onclick="net.sendAction('PASS')">PASSAR</button>
            </div>
            <button class="btn-game" style="background:#37474f; font-size:0.8rem; margin:0;" onclick="ui.toggleInv()">üíº SUAS ESCRITURAS</button>
        </div>
    </div>
</div>

<div id="overlay-layer">
    <div id="overlay-bg" onclick="ui.closeCard()"></div>
    
    <div id="dice-container">
        <div id="d1-box" class="die-box"><div class="die-face" id="d1-face"></div></div>
        <div id="d2-box" class="die-box"><div class="die-face" id="d2-face"></div></div>
    </div>

    <div id="prop-card" class="prop-card">
        <div class="pc-head" id="pc-name">RUA</div>
        <div style="padding:15px;">
            <div style="text-align:center; font-size:2rem; color:var(--c-green);" id="pc-price">$200</div>
            <table style="width:100%; margin:10px 0; font-size:0.9rem; border-collapse:collapse;" id="rent-table-body"></table>
            <div id="act-buy" style="display:none; margin-top:10px;">
                <button class="btn-game btn-buy" onclick="game.confirmBuy()">COMPRAR</button>
                <button class="btn-game" style="background:#546e7a;" onclick="ui.closeCard()">N√ÉO QUERO</button>
            </div>
            <div id="act-manage" style="display:none; margin-top:10px; gap:5px;">
                <button class="btn-game" style="background:#333;" onclick="ui.closeCard()">FECHAR</button>
            </div>
        </div>
    </div>
    
    <div class="prop-card" id="card-event" style="text-align:center; border-color:#ab47bc;">
        <div class="pc-head" id="ev-title" style="background:#ab47bc;">SORTE</div>
        <div style="padding:20px;">
             <p id="ev-desc" style="font-size:1.5rem; font-weight:bold;">...</p>
             <button class="btn-game btn-roll" style="color:#000;" onclick="ui.closeEvent()">BELEZA</button>
        </div>
    </div>

    <div id="trade-proposal-modal" class="prop-card" style="border-color:#7b1fa2; width:95%; max-width:500px;">
        <div class="pc-head" style="background:#7b1fa2;">PROPOSTA!</div>
        <div style="padding:20px; text-align:center;">
            <h3 id="tp-msg">...</h3>
            <div style="display:flex; justify-content:space-between; margin:15px 0;">
                <div style="flex:1; background:#e3f2fd; padding:5px; border-radius:5px;">
                    <small>ELE D√Å:</small><div id="tp-give"></div>
                </div>
                <div style="font-size:2rem; align-self:center;">üîÑ</div>
                <div style="flex:1; background:#ffebee; padding:5px; border-radius:5px;">
                    <small>VOC√ä D√Å:</small><div id="tp-get"></div>
                </div>
            </div>
            <div id="tp-btns" style="display:flex; gap:10px;">
                <button class="btn-game btn-pass" onclick="net.respondTrade(false)">RECUSAR</button>
                <button class="btn-game btn-buy" onclick="net.respondTrade(true)">ACEITAR</button>
            </div>
            <p id="tp-wait" style="display:none; color:#666;">Aguardando resposta...</p>
        </div>
    </div>
</div>

<div id="inv-modal">
    <h2 style="color:#fff;">SEUS BENS</h2>
    <div id="inv-list"></div>
    <button class="btn-main" style="width:auto; margin-top:10px;" onclick="document.getElementById('inv-modal').style.display='none'">FECHAR</button>
</div>

<div id="screen-end">
    <div class="card-menu">
        <h1 id="end-title">FIM DE JOGO</h1>
        <p id="end-msg">...</p>
        <button class="btn-main" onclick="location.reload()">NOVA SALA</button>
    </div>
</div>

<script>
// --- BASE DE DADOS E CONFIG ---
const CHARS=[
    {id:'rt',i:'üíÖ',n:'A Ratona'}, {id:'as',i:'üóø',n:'Bilola'}, {id:'bt',i:'üõ∂',n:'Celta'}, 
    {id:'c',i:'ü¶Ä',n:'Caranguejo'}, {id:'s',i:'ü¶à',n:'Tubar√£o'}, {id:'u',i:'‚òÇÔ∏è',n:'Sombrinha'}, 
    {id:'pd',i:'üêÄ',n:'Gabiru'}, {id:'bb',i:'üåΩ',n:'Milho'}, {id:'gl',i:'üêî',n:'Galo'}, 
    {id:'brt',i:'üöå',n:'BRT'}, {id:'bdr',i:'üç•',n:'Bolo Rolo'}, {id:'lu',i:'üêª',n:'La Ursa'},
    {id:'hmn',i:'üé©',n:'Meia-Noite'}, {id:'rp',i:'üöî',n:'R√°dio P.'}, {id:'srr',i:'üêö',n:'Sururu'}, {id:'and',i:'üòé',n:'Anderson'}
];

const BD=[
    {t:'st',n:'MARCO ZERO',i:'üö©'}, 
    {t:'pr',g:'#795548',n:'Coque',p:60,h:50,r:[2,10,30,90,160,250]}, 
    {t:'ch',n:'Sorte',i:'üçÄ'}, 
    {t:'pr',g:'#795548',n:'Ibura',p:60,h:50,r:[4,20,60,180,320,450]}, 
    {t:'tx',n:'IPTU',i:'üí∏'},
    {t:'rr',n:'Est. Joana B.',p:200,i:'üöÜ'},
    {t:'pr',g:'#03a9f4',n:'Agamenon',p:100,h:50,r:[6,30,90,270,400,550]},
    {t:'rev',n:'Rev√©s',i:'‚ö†Ô∏è'}, 
    {t:'pr',g:'#03a9f4',n:'Afogados',p:100,h:50,r:[6,30,90,270,400,550]}, 
    {t:'pr',g:'#03a9f4',n:'Mustardinha',p:120,h:50,r:[8,40,100,300,450,600]},
    {t:'jl',n:'LEI SECA',i:'üëÆ'}, 
    {t:'pr',g:'#e91e63',n:'Iputinga',p:140,h:100,r:[10,50,150,450,750,950]}, 
    {t:'ut',n:'Celpe',p:150,i:'üí°'}, 
    {t:'pr',g:'#e91e63',n:'Cordeiro',p:140,h:100,r:[10,50,150,450,750,950]}, 
    {t:'pr',g:'#e91e63',n:'V√°rzea',p:160,h:100,r:[12,60,180,500,700,900]}, 
    {t:'rr',n:'Est. Coqueiral',p:200,i:'üöÜ'}, 
    {t:'pr',g:'#ff5722',n:'Rosarinho',p:180,h:100,r:[14,70,200,550,750,950]}, 
    {t:'ch',n:'Sorte',i:'üçÄ'}, 
    {t:'pr',g:'#ff5722',n:'Encruzilhada',p:180,h:100,r:[14,70,200,550,750,950]}, 
    {t:'pr',g:'#ff5722',n:'Torre',p:200,h:100,r:[16,80,220,600,800,1000]},
    {t:'pk',n:'Pq. Jaqueira',i:'üå≥'}, 
    {t:'pr',g:'#d32f2f',n:'Aflitos',p:220,h:150,r:[18,90,250,700,875,1050]}, 
    {t:'rev',n:'Rev√©s',i:'‚ö†Ô∏è'}, 
    {t:'pr',g:'#d32f2f',n:'Espinheiro',p:220,h:150,r:[18,90,250,700,875,1050]}, 
    {t:'pr',g:'#d32f2f',n:'Madalena',p:240,h:150,r:[20,100,300,750,925,1100]}, 
    {t:'rr',n:'Est. Barro',p:200,i:'üöÜ'}, 
    {t:'pr',g:'#fbc02d',n:'Gra√ßas',p:260,h:150,r:[22,110,330,800,975,1150]}, 
    {t:'pr',g:'#fbc02d',n:'Po√ßo Panela',p:260,h:150,r:[22,110,330,800,975,1150]}, 
    {t:'ut',n:'Compesa',p:150,i:'üíß'}, 
    {t:'pr',g:'#fbc02d',n:'Casa Forte',p:280,h:150,r:[24,120,360,850,1025,1200]},
    {t:'gj',n:'CADEIA!',i:'üöì'}, 
    {t:'pr',g:'#388e3c',n:'Apipucos',p:300,h:200,r:[26,130,390,900,1100,1275]}, 
    {t:'pr',g:'#388e3c',n:'Parnamirim',p:300,h:200,r:[26,130,390,900,1100,1275]}, 
    {t:'ch',n:'Sorte',i:'üçÄ'}, 
    {t:'pr',g:'#388e3c',n:'Paiva',p:320,h:200,r:[28,150,450,1000,1200,1400]}, 
    {t:'rr',n:'Est. Afogados',p:200,i:'üöÜ'}, 
    {t:'rev',n:'Rev√©s',i:'‚ö†Ô∏è'}, 
    {t:'pr',g:'#1565c0',n:'Boa Viagem',p:350,h:200,r:[35,175,500,1100,1300,1500]}, 
    {t:'tx',n:'Taxa',i:'üßæ'}, 
    {t:'pr',g:'#1565c0',n:'Pina',p:400,h:200,r:[50,200,600,1400,1700,2000]}
];

const CARDS_SORTE = [{txt:"Achasse 200 conto! +200", val:200}, {txt:"Ganhasse na rifa! +50", val:50}, {txt:"V√≥ deu dinheiro. +100", val:100}];
const CARDS_REVES = [{txt:"Multa na Agamenon. -50", val:-50}, {txt:"Perdeu a carteira. -100", val:-100}];

// --- ESTADO DO JOGO ---
let myId = null, myName = '', isHost = false, connHost = null, connections = [];
let gameState = {
    phase: 'LOBBY', 
    players: [], 
    props: Array(40).fill(null),
    turnIdx: 0,
    lastDice: [1,1],
    trade: null,
    // Turn Flags
    canRoll: false,
    canBuy: false,
    canPass: false
};

const SFX = {
    step: new Audio('https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3'),
    cash: new Audio('https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3'),
    win: new Audio('https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3'),
    dice: new Audio('https://assets.mixkit.co/active_storage/sfx/2572/2572-preview.mp3'),
    bad: new Audio('https://assets.mixkit.co/active_storage/sfx/2955/2955-preview.mp3')
};
const play = (k) => { try { SFX[k].volume=0.5; SFX[k].currentTime=0; SFX[k].play().catch(()=>{}); } catch(e){} };
const sleep = (ms) => new Promise(r => setTimeout(r, ms));

function resizeBoard() {
    const el = document.getElementById('board-container');
    const area = document.getElementById('board-area');
    if(!el || !area) return;
    const w = area.offsetWidth;
    const h = area.offsetHeight;
    const minDim = Math.min(w, h) * 0.95; 
    const scale = minDim / 950; 
    el.style.transform = `scale(${scale})`;
}
window.addEventListener('resize', resizeBoard);

// --- PEERJS (REDE) ---
const peer = new Peer(null, { debug: 1 });

const net = {
    createRoom: () => {
        const name = document.getElementById('my-name').value.trim();
        if(!name) return alert('Digite seu nome!');
        myName = name; isHost = true;
        
        gameState.players.push({
            id: peer.id, name: myName, char: null, confirmed: false,
            money: 500, pos: 0, active: true, color: '#f00', protection: false
        });
        
        const code = peer.id; 
        navigator.clipboard.writeText(code);
        document.getElementById('screen-login').style.display='none';
        document.getElementById('screen-lobby').style.display='flex';
        document.getElementById('lobby-code').innerText = code;
        document.getElementById('host-ctrl').style.display='block';
        document.getElementById('client-wait').style.display='none';
        ui.toast("C√≥digo copiado! Mande para os amigos.");
        ui.renderLobby();
        
        peer.on('connection', (conn) => {
            connections.push(conn);
            conn.on('data', (data) => net.handleData(data, conn.peer));
            conn.send({ type: 'UPDATE', state: gameState });
        });
    },
    joinRoom: () => {
        const name = document.getElementById('my-name').value.trim();
        const code = document.getElementById('room-code').value.trim();
        if(!name || !code) return alert('Preencha nome e c√≥digo!');
        myName = name; isHost = false;
        
        connHost = peer.connect(code);
        connHost.on('open', () => {
            connHost.send({ type: 'JOIN', name: myName });
            document.getElementById('screen-login').style.display='none';
            document.getElementById('screen-lobby').style.display='flex';
        });
        connHost.on('data', (data) => net.handleData(data));
        connHost.on('error', (err) => alert('Erro: '+err));
    },
    handleData: (data, senderId) => {
        if(isHost) {
            // --- HOST LOGIC ---
            if(data.type === 'JOIN' && gameState.phase === 'LOBBY') {
                gameState.players.push({
                    id: senderId, name: data.name, char: null, confirmed: false,
                    money: 500, pos: 0, active: true, color: '#'+Math.floor(Math.random()*16777215).toString(16), protection: false
                });
                net.broadcastState();
            }
            if(data.type === 'SELECT_CHAR') {
                const p = gameState.players.find(x=>x.id === senderId);
                if(p && !p.confirmed) { p.char = data.charId; net.broadcastState(); }
            }
            if(data.type === 'CONFIRM_CHAR') {
                const p = gameState.players.find(x=>x.id === senderId);
                if(p && p.char) { p.confirmed = true; net.broadcastState(); gameHost.checkAllReady(); }
            }
            if(data.type === 'ROLL') gameHost.handleRoll(senderId);
            if(data.type === 'BUY') gameHost.handleBuy(senderId);
            if(data.type === 'PASS') gameHost.handlePass(senderId);
            if(data.type === 'DRAW_CARD') gameHost.handleDrawCard(senderId, data.deckType);
            
            if(data.type === 'TRADE_PROPOSE') gameHost.handleTradePropose(data.offer);
            if(data.type === 'TRADE_RESPONSE') gameHost.handleTradeResponse(senderId, data.accepted);

        } else {
            // --- CLIENT LOGIC ---
            if(data.type === 'UPDATE') {
                gameState = data.state;
                ui.syncState();
            }
            if(data.type === 'EVENT_ROLL') {
                ui.animateDiceAndMove(data.d1, data.d2, data.playerId, data.targetPos);
            }
            if(data.type === 'EVENT_CARD') {
                ui.showEvent(data.ctype, data.msg);
            }
            if(data.type === 'FX') {
                if(data.anim === 'traffic') { document.querySelector('.traffic-anim').classList.add('active'); setTimeout(()=>document.querySelector('.traffic-anim').classList.remove('active'), 2000); }
                if(data.anim === 'shark') { document.querySelector('.shark-anim').classList.add('active'); setTimeout(()=>document.querySelector('.shark-anim').classList.remove('active'), 4000); }
            }
        }
    },
    broadcastState: () => {
        if(!isHost) return;
        const msg = { type: 'UPDATE', state: gameState };
        connections.forEach(c => c.send(msg));
        ui.syncState();
    },
    broadcastEvent: (type, payload) => {
        if(!isHost) return;
        const msg = { type: type, ...payload };
        connections.forEach(c => c.send(msg));
        // Host roda o evento localmente
        if(type === 'EVENT_ROLL') ui.animateDiceAndMove(payload.d1, payload.d2, payload.playerId, payload.targetPos);
        if(type === 'EVENT_CARD') ui.showEvent(payload.ctype, payload.msg);
        if(type === 'FX') {
            if(payload.anim === 'traffic') { document.querySelector('.traffic-anim').classList.add('active'); setTimeout(()=>document.querySelector('.traffic-anim').classList.remove('active'), 2000); }
            if(payload.anim === 'shark') { document.querySelector('.shark-anim').classList.add('active'); setTimeout(()=>document.querySelector('.shark-anim').classList.remove('active'), 4000); }
        }
    },
    // Client Actions
    sendStartCharSelect: () => { if(isHost) { gameState.phase='CHAR'; net.broadcastState(); } },
    sendSelectChar: (cid) => { if(isHost) net.handleData({type:'SELECT_CHAR', charId:cid}, peer.id); else connHost.send({type:'SELECT_CHAR', charId:cid}); },
    sendConfirmChar: () => { if(isHost) net.handleData({type:'CONFIRM_CHAR'}, peer.id); else connHost.send({type:'CONFIRM_CHAR'}); },
    sendAction: (act) => { if(isHost) { if(act==='ROLL') gameHost.handleRoll(peer.id); if(act==='BUY') gameHost.handleBuy(peer.id); if(act==='PASS') gameHost.handlePass(peer.id); } else connHost.send({type:act}); },
    sendDrawCard: (deckType) => { if(isHost) gameHost.handleDrawCard(peer.id, deckType); else connHost.send({type:'DRAW_CARD', deckType: deckType}); },
    sendTradeProposal: (off) => { if(isHost) gameHost.handleTradePropose(off); else connHost.send({type:'TRADE_PROPOSE', offer:off}); },
    respondTrade: (acc) => { 
        document.getElementById('tp-btns').style.display='none'; document.getElementById('tp-wait').style.display='block';
        if(isHost) gameHost.handleTradeResponse(peer.id, acc); else connHost.send({type:'TRADE_RESPONSE', accepted:acc}); 
    }
};

// --- GAME HOST LOGIC (O C√âREBRO) ---
const gameHost = {
    checkAllReady: () => {
        if(gameState.players.every(p => p.confirmed) && gameState.players.length>0) {
            gameState.phase = 'GAME';
            gameState.players.sort(() => Math.random() - 0.5);
            gameState.turnIdx = 0;
            gameState.canRoll = true; gameState.canBuy = false; gameState.canPass = false;
            net.broadcastState();
        }
    },
    handleRoll: (pid) => {
        const p = gameState.players[gameState.turnIdx];
        if(p.id !== pid || !gameState.canRoll) return;

        // 1. Calcular Dados e Posi√ß√£o
        const d1 = Math.ceil(Math.random()*6);
        const d2 = Math.ceil(Math.random()*6);
        gameState.lastDice = [d1, d2];
        const steps = d1+d2;
        const oldPos = p.pos;
        const newPos = (p.pos + steps) % 40;
        
        // 2. Avisar a todos para ANIMAR (Visual apenas)
        net.broadcastEvent('EVENT_ROLL', { d1, d2, playerId: pid, targetPos: newPos });

        // 3. Atualizar Estado L√≥gico (Silenciosamente)
        p.pos = newPos;
        if(newPos < oldPos) p.money += 200; // Passou inicio

        // Eventos de Casa Especial
        const s = BD[p.pos];
        if(s.n === "Agamenon") {
             const chk = Math.ceil(Math.random()*6);
             if(chk<=3) { net.broadcastEvent('FX',{anim:'traffic'}); p.money-=50; }
        }
        if(s.n === "Boa Viagem" || s.n === "Paiva") {
             const chk = Math.ceil(Math.random()*6);
             if(chk<=2 && !p.protection) { net.broadcastEvent('FX',{anim:'shark'}); p.money-=100; }
        }

        const pr = gameState.props[p.pos];
        if(s.t==='pr' && pr && pr.ownerId !== pid && !pr.loan) {
            let rent = s.r[pr.level];
            p.money -= rent;
            const owner = gameState.players.find(x=>x.id===pr.ownerId);
            if(owner) owner.money += rent;
        }

        const isDouble = (d1 === d2);
        gameState.canRoll = isDouble; 
        gameState.canPass = !isDouble; 
        gameState.canBuy = (s.t==='pr' || s.t==='rr' || s.t==='ut') && !pr && p.money >= s.p;
        
        // Espera a anima√ß√£o acabar para enviar o estado novo (Sync)
        setTimeout(() => net.broadcastState(), 4000); 
    },
    handleBuy: (pid) => {
        const p = gameState.players[gameState.turnIdx];
        if(p.id !== pid || !gameState.canBuy) return;
        const s = BD[p.pos];
        if(!gameState.props[p.pos] && p.money >= s.p) {
            p.money -= s.p;
            gameState.props[p.pos] = { ownerId: pid, level: 0, loan: false };
            gameState.canBuy = false; 
            net.broadcastState();
        }
    },
    handlePass: (pid) => {
        if(gameState.players[gameState.turnIdx].id !== pid || !gameState.canPass) return;
        
        let loop=0;
        do {
            gameState.turnIdx = (gameState.turnIdx + 1) % gameState.players.length;
            loop++;
        } while(!gameState.players[gameState.turnIdx].active && loop < gameState.players.length);

        gameState.canRoll = true; gameState.canBuy = false; gameState.canPass = false;
        net.broadcastState();
    },
    handleDrawCard: (pid, type) => {
        const p = gameState.players[gameState.turnIdx];
        if(p.id !== pid) return;
        
        const deck = type==='ch' ? CARDS_SORTE : CARDS_REVES;
        const card = deck[Math.floor(Math.random()*deck.length)];
        
        net.broadcastEvent('EVENT_CARD', { ctype: type==='ch'?'sorte':'vixe', msg: card.txt });
        
        if(card.val) p.money += card.val;
        gameState.canPass = true; // Libera passar ap√≥s carta
        setTimeout(() => net.broadcastState(), 1000);
    },
    handleTradePropose: (off) => { gameState.trade = off; net.broadcastState(); },
    handleTradeResponse: (rid, acc) => {
        const t = gameState.trade;
        if(t && t.to === rid) {
            if(acc) {
                const p1 = gameState.players.find(x=>x.id===t.from);
                const p2 = gameState.players.find(x=>x.id===t.to);
                p1.money = p1.money - t.offerM + t.reqM;
                p2.money = p2.money + t.offerM - t.reqM;
                t.offerP.forEach(idx => { if(gameState.props[idx]) gameState.props[idx].ownerId = t.to; });
                t.reqP.forEach(idx => { if(gameState.props[idx]) gameState.props[idx].ownerId = t.from; });
            }
            gameState.trade = null; net.broadcastState();
        }
    }
};

// --- UI (INTERFACE E ANIMA√á√ÉO) ---
const ui = {
    renderLobby: () => {
        document.getElementById('lobby-list').innerHTML = gameState.players.map(p => 
            `<li class="player-li ${p.confirmed?'ready':''}">${p.name} ${p.id===peer.id?'(Voc√™)':''}</li>`
        ).join('');
    },
    syncState: () => {
        if(gameState.phase === 'LOBBY') ui.renderLobby();
        else if (gameState.phase === 'CHAR') {
            document.getElementById('screen-lobby').style.display='none';
            document.getElementById('screen-char').style.display='flex';
            ui.renderChars();
        } else if (gameState.phase === 'GAME') {
            document.getElementById('screen-char').style.display='none';
            document.getElementById('game-layout').style.display='flex';
            document.getElementById('game-layout').classList.add('active');
            resizeBoard();
            ui.renderBoard();
            ui.updateHUD();
            ui.checkTrade();
        }
    },
    renderChars: () => {
        const me = gameState.players.find(p=>p.id===peer.id);
        document.getElementById('char-grid').innerHTML = CHARS.map(c => {
            const taken = gameState.players.find(p=>p.char===c.id);
            let cls = 'char-opt', badge = '';
            if(taken) {
                if(taken.id===peer.id) cls += ' selected'; else cls += ' taken';
                badge = `<div class="char-badge">${taken.name}</div>`;
            }
            return `<div class="${cls}" onclick="ui.clickChar('${c.id}')">${c.i}${badge}</div>`;
        }).join('');
        const btn = document.getElementById('btn-conf-char');
        if(me && me.char && !me.confirmed) { btn.disabled=false; btn.style.background='var(--c-green)'; btn.innerText="CONFIRMAR"; }
        else if(me && me.confirmed) { btn.disabled=true; btn.style.background='#ccc'; btn.innerText="AGUARDANDO..."; }
        document.getElementById('char-status').innerText = `${gameState.players.filter(p=>p.confirmed).length}/${gameState.players.length} Confirmados`;
    },
    clickChar: (cid) => {
        const me = gameState.players.find(p=>p.id===peer.id);
        if(!me.confirmed) net.sendSelectChar(cid);
    },
    renderBoard: () => {
        const b = document.getElementById('board');
        if(b.children.length > 5) { ui.updateTokens(); return; } // J√° montado (tem torres e decks)
        
        BD.forEach((s,i) => {
            const d=document.createElement('div');d.className='space';d.id=`s${i}`;
            let r,c, rot;
            if(i<=10){ r=11; c=11-i; rot='rot-bottom'; } else if(i<=20){ r=11-(i-10); c=1; rot='rot-left'; } 
            else if(i<=30){ r=1; c=1+(i-20); rot='rot-top'; } else { r=1+(i-30); c=11; rot='rot-right'; }
            if(i%10===0) rot='';
            d.style.gridRow=r; d.style.gridColumn=c;
            if(s.t==='pr') d.innerHTML = `<div class="space-content ${rot}"><div class="color-strip" style="background:${s.g}"></div><div class="sp-name">${s.n}</div><div class="sp-price">$${s.p}</div></div><div class="build-area" id="b${i}"></div>`;
            else d.innerHTML = `<div class="space-content ${rot}"><div class="sp-icon">${s.i}</div><div class="sp-name" style="font-size:0.6rem">${s.n}</div></div>`;
            d.onclick = () => ui.clickSpace(i);
            b.appendChild(d);
        });
        ui.updateTokens();
    },
    // ANIMA√á√ÉO DE MOVIMENTO REALISTA
    animateDiceAndMove: async (d1, d2, pid, targetPos) => {
        // 1. Mostrar e Agitar Dados
        const diceCont = document.getElementById('dice-container');
        const d1Face = document.getElementById('d1-face');
        const d2Face = document.getElementById('d2-face');
        
        diceCont.style.opacity = 1;
        document.getElementById('d1-box').classList.add('shake-dice');
        document.getElementById('d2-box').classList.add('shake-dice');
        play('dice');

        await sleep(1000); // Suspense
        
        document.getElementById('d1-box').classList.remove('shake-dice');
        document.getElementById('d2-box').classList.remove('shake-dice');
        
        d1Face.innerHTML = ui.getDots(d1);
        d2Face.innerHTML = ui.getDots(d2);

        await sleep(800); 
        diceCont.style.opacity = 0;

        // 2. Mover o Pe√£o Pulo a Pulo
        // Encontrar posi√ß√£o atual visual
        const p = gameState.players.find(x=>x.id===pid);
        const el = document.getElementById(`tok_${pid}`);
        
        // No client, o gameState pode j√° ter atualizado a pos se a rede foi r√°pida, 
        // mas precisamos calcular visualmente do ponto anterior.
        // Truque: Calcular "reverso" baseando nos dados
        let steps = d1+d2;
        let startPos = targetPos - steps;
        if(startPos < 0) startPos += 40;
        
        let curr = startPos; 
        
        // Loop de pulo
        for(let i=0; i<steps; i++) {
            curr = (curr + 1) % 40;
            ui.forceTokenPos(pid, curr);
            play('step');
            await sleep(250);
        }
    },
    getDots: (n) => {
        let map = [];
        if(n===1) map=[5]; if(n===2) map=[1,9]; if(n===3) map=[1,5,9];
        if(n===4) map=[1,3,7,9]; if(n===5) map=[1,3,5,7,9]; if(n===6) map=[1,3,4,6,7,9];
        let html = '';
        for(let i=1; i<=9; i++) { html += map.includes(i) ? '<div class="dot"></div>' : '<div></div>'; }
        return html;
    },
    forceTokenPos: (pid, pos) => {
        const el = document.getElementById(`tok_${pid}`);
        const cell = document.getElementById(`s${pos}`);
        if(el && cell) {
            el.style.left = (cell.offsetLeft + 10) + 'px';
            el.style.top = (cell.offsetTop + 10) + 'px';
        }
    },
    updateTokens: () => {
        // Redesenhar todos
        document.querySelectorAll('.token').forEach(e=>e.remove());
        const b = document.getElementById('board');
        
        gameState.players.forEach((p) => {
            const t = document.createElement('div');
            t.className='token';
            t.id = `tok_${p.id}`;
            const charObj = CHARS.find(c=>c.id===p.char);
            t.innerHTML = charObj ? charObj.i : 'üë§';
            b.appendChild(t);
            ui.forceTokenPos(p.id, p.pos);
        });

        // Casas
        gameState.props.forEach((pr, i) => {
            const el = document.getElementById(`s${i}`);
            if(!el) return;
            if(pr) {
                const owner = gameState.players.find(p=>p.id===pr.ownerId);
                el.classList.add('owned');
                el.style.borderColor = owner ? owner.color : '#000';
                const be = document.getElementById(`b${i}`);
                if(be) be.innerHTML = pr.level===5 ? '<div class="hotel-3d"></div>' : Array(pr.level).fill('<div class="house-3d"></div>').join('');
            } else {
                el.classList.remove('owned');
                el.style.borderColor = '#1a1a1a';
            }
        });
    },
    updateHUD: () => {
        const curP = gameState.players[gameState.turnIdx];
        const me = gameState.players.find(p => p.id === peer.id);
        
        // Desktop e Mobile updates
        const turnTxt = `VEZ DE: ${curP.name.toUpperCase()}`;
        document.getElementById('turn-display').innerText = turnTxt;
        if(document.getElementById('turn-display-mob')) document.getElementById('turn-display-mob').innerText = turnTxt;
        
        document.getElementById('p-money').innerText = `$${me.money}`;
        if(document.getElementById('p-money-mob')) document.getElementById('p-money-mob').innerText = `$${me.money}`;
        
        document.getElementById('players-hud-list').innerHTML = gameState.players.map((p,i) => {
            const charObj = CHARS.find(c=>c.id===p.char);
            return `<div class="p-stat ${gameState.turnIdx===i?'active-turn':''}">
                <div>${charObj?charObj.i:''} ${p.name}</div>
                <div>$${p.money}</div>
            </div>`;
        }).join('');

        const isMyTurn = (curP.id === peer.id);
        
        document.getElementById('b-roll').disabled = !(isMyTurn && gameState.canRoll);
        document.getElementById('b-buy').disabled = !(isMyTurn && gameState.canBuy);
        document.getElementById('b-pass').disabled = !(isMyTurn && gameState.canPass);
    },
    clickSpace: (i) => {
        const s = BD[i]; if(s.t!=='pr') return;
        const pr = gameState.props[i];
        document.getElementById('pc-name').innerText = s.n;
        document.getElementById('pc-name').style.background = s.g;
        document.getElementById('pc-price').innerText = `$${s.p}`;
        
        let html = '';
        if(s.r) s.r.forEach((val, k) => html += `<tr><td>${k===0?'Aluguel':k===5?'Hotel':k+' Casa'}</td><td style="text-align:right">$${val}</td></tr>`);
        document.getElementById('rent-table-body').innerHTML = html;
        
        const me = gameState.players.find(p=>p.id===peer.id);
        const myTurn = (gameState.players[gameState.turnIdx].id === peer.id);
        const btnBuy = document.getElementById('act-buy');
        
        btnBuy.style.display = 'none';
        // Bot√£o comprar s√≥ aparece se for minha vez, eu tiver grana e eu estiver na casa
        if(myTurn && gameState.canBuy && me.pos === i) btnBuy.style.display = 'block';

        document.getElementById('prop-card').style.display = 'block';
        document.getElementById('overlay-bg').style.display = 'block';
    },
    toggleInv: () => {
        const d = document.getElementById('inv-modal'); d.style.display = 'flex';
        const me = peer.id;
        document.getElementById('inv-list').innerHTML = gameState.props.map((pr, i) => {
            if(pr && pr.ownerId === me) return `<div class="t-item" onclick="ui.clickSpace(${i})">${BD[i].n} (N√≠vel ${pr.level})</div>`;
        }).join('') || '<div style="background:#fff; padding:10px; border-radius:5px;">Sem propriedades.</div>';
    },
    showEvent: (type, msg) => {
        play('dice'); // Som de card
        const card = document.getElementById('card-event');
        const title = document.getElementById('ev-title');
        title.innerText = type.toUpperCase();
        title.style.background = type==='sorte' ? '#ab47bc' : '#ffa726';
        document.getElementById('ev-desc').innerText = msg;
        document.getElementById('overlay-bg').style.display='block';
        card.style.display='block';
    },
    closeEvent: () => {
        document.getElementById('card-event').style.display='none';
        document.getElementById('overlay-bg').style.display='none';
    },
    closeCard: () => {
        document.getElementById('prop-card').style.display='none';
        document.getElementById('card-event').style.display='none';
        document.getElementById('overlay-bg').style.display='none';
        document.getElementById('inv-modal').style.display='none';
    }
};

const game = {
    confirmChar: () => { net.sendConfirmChar(); document.getElementById('btn-conf-char').innerText = "ESPERANDO..."; },
    confirmBuy: () => { net.sendAction('BUY'); ui.closeCard(); },
    clickDeck: (type) => {
        // Verifica se √© minha vez e se estou em casa de sorte/reves
        const me = gameState.players.find(p=>p.id===peer.id);
        const curP = gameState.players[gameState.turnIdx];
        if(curP.id !== peer.id) return;
        
        const s = BD[me.pos];
        if((s.t==='ch' && type==='ch') || (s.t==='rev' && type==='rev')) {
             net.sendDrawCard(type);
        }
    }
};

// TRADE UI (Negocia√ß√£o)
const tradeUI = {
    selectedGiveProps: [], selectedGetProps: [],
    open: () => {
        document.getElementById('screen-trade').style.display = 'flex';
        const sel = document.getElementById('trade-target');
        sel.innerHTML = gameState.players.filter(p => p.id !== peer.id).map(p => `<option value="${p.id}">${p.name}</option>`).join('');
        tradeUI.updateLists();
    },
    close: () => { document.getElementById('screen-trade').style.display = 'none'; tradeUI.selectedGiveProps=[]; tradeUI.selectedGetProps=[]; },
    updateLists: () => {
        const targetId = document.getElementById('trade-target').value;
        const myPropsDiv = document.getElementById('list-give');
        const theirPropsDiv = document.getElementById('list-get');
        myPropsDiv.innerHTML = gameState.props.map((pr, i) => {
            if(pr && pr.ownerId === peer.id) {
                const isSel = tradeUI.selectedGiveProps.includes(i);
                return `<div class="t-item ${isSel?'selected':''}" onclick="tradeUI.toggle(true, ${i})">${BD[i].n}</div>`;
            }
        }).join('');
        theirPropsDiv.innerHTML = gameState.props.map((pr, i) => {
            if(pr && pr.ownerId === targetId) {
                const isSel = tradeUI.selectedGetProps.includes(i);
                return `<div class="t-item ${isSel?'selected':''}" onclick="tradeUI.toggle(false, ${i})">${BD[i].n}</div>`;
            }
        }).join('');
    },
    toggle: (isMine, idx) => {
        const arr = isMine ? tradeUI.selectedGiveProps : tradeUI.selectedGetProps;
        const i = arr.indexOf(idx); if(i > -1) arr.splice(i, 1); else arr.push(idx);
        tradeUI.updateLists();
    },
    sendProposal: () => {
        const offer = {
            from: peer.id, to: document.getElementById('trade-target').value,
            offerM: parseInt(document.getElementById('trade-give-money').value) || 0, offerP: tradeUI.selectedGiveProps,
            reqM: parseInt(document.getElementById('trade-get-money').value) || 0, reqP: tradeUI.selectedGetProps
        };
        net.sendTradeProposal(offer); tradeUI.close(); ui.toast("Proposta enviada!");
    }
};
</script>
</body>
</html>
