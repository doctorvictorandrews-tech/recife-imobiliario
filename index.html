// ======================================================================
// 1. CONFIGURA√á√ÉO DO MAPA (NOMES CORRIGIDOS)
// ======================================================================

// Supondo que voc√™ tenha um array de objetos para as casas/propriedades
const casas = [
    { id: 0, nome: "Marco Zero", tipo: "inicio" },
    
    // ... casas 1 a 4 ...

    // SUBSTITUI√á√ÉO 1: Santo Amaro virou Av. Agamenon Magalh√£es
    { id: 5, nome: "Av. Agamenon Magalh√£es", preco: 200, aluguel: 20, dono: null, tipo: "propriedade" },
    
    // ... outras casas ...

    // IBURA PERMANECE O MESMO
    { id: 8, nome: "Ibura", preco: 100, aluguel: 6, dono: null, tipo: "propriedade" },

    // ... outras casas ...

    // SUBSTITUI√á√ÉO 2: Antiga Agamenon virou Imbiribeira
    { id: 10, nome: "Imbiribeira", preco: 220, aluguel: 22, dono: null, tipo: "propriedade" },

    // Exemplo de casa que n√£o compra (para teste do bug)
    { id: 12, nome: "Lei Seca", valor: 150, tipo: "imposto" }, 

    { id: 15, nome: "Galo da Madrugada", tipo: "evento_galo" },
    
    { id: 20, nome: "Cadeia", tipo: "prisao" }
];

// Vari√°veis Globais de Controle
let jogadorAtualIndex = 0;
let dadosIguais = false; // Controle crucial para o bug de repeti√ß√£o
let aguardandoDecisao = false; // Para impedir cliques extras

// ======================================================================
// 2. SISTEMA DE DADOS E MOVIMENTO
// ======================================================================

function jogarDados() {
    // Bloqueia bot√£o para evitar clique duplo
    const btn = document.getElementById("btn-jogar-dados");
    btn.disabled = true; 
    btn.style.display = "none"; 

    const d1 = Math.floor(Math.random() * 6) + 1;
    const d2 = Math.floor(Math.random() * 6) + 1;
    const soma = d1 + d2;

    // Verifica e armazena se foi dados iguais
    dadosIguais = (d1 === d2);
    
    console.log(`Dados: ${d1} e ${d2}. Iguais? ${dadosIguais}`);
    exibirAnimacaoDados(d1, d2); // Sua fun√ß√£o visual

    // Movimenta√ß√£o
    let jogador = jogadores[jogadorAtualIndex];

    // Se estiver preso, l√≥gica de pris√£o (simplificada aqui)
    if (jogador.preso) {
        if (dadosIguais) {
            jogador.preso = false;
            exibirMensagem("Sorte! Tirou dados iguais e saiu da pris√£o!");
            moverJogador(jogador, soma);
        } else {
            exibirMensagem("Continua preso...");
            // Se n√£o saiu, perde a vez (mesmo dados iguais n√£o joga de novo se falhar na pris√£o)
            dadosIguais = false; 
            finalizarJogada();
        }
    } else {
        moverJogador(jogador, soma);
    }
}

function moverJogador(jogador, passos) {
    // L√≥gica simples de movimento circular
    jogador.posicao += passos;
    if (jogador.posicao >= casas.length) {
        jogador.posicao -= casas.length;
        jogador.saldo += 200; // Passou pelo in√≠cio
    }

    atualizarPosicaoVisual(jogador); // Sua fun√ß√£o que move o pino
    
    // Ap√≥s mover, verifica onde caiu
    setTimeout(() => {
        verificarCasa(jogador);
    }, 1000); // Pequeno delay para anima√ß√£o
}

// ======================================================================
// 3. L√ìGICA DE INTERA√á√ÉO COM A CASA (CORRIGIDA)
// ======================================================================

function verificarCasa(jogador) {
    const casa = casas[jogador.posicao];
    exibirMensagem(`Voc√™ caiu em: ${casa.nome}`);

    // CASO 1: Propriedade Compr√°vel
    if (casa.tipo === "propriedade") {
        if (casa.dono === null) {
            // Se tem dinheiro, oferece compra
            if (jogador.saldo >= casa.preco) {
                aguardandoDecisao = true;
                mostrarBotoesCompra(true); // Exibe Sim/N√£o
            } else {
                exibirMensagem("Saldo insuficiente para comprar.");
                finalizarJogada(); // CORRE√á√ÉO: N√£o trava, finaliza
            }
        } else if (casa.dono !== jogador.id) {
            pagarAluguel(jogador, casa);
            finalizarJogada(); // CORRE√á√ÉO: Pagou, vida que segue
        } else {
            exibirMensagem("Esta propriedade j√° √© sua.");
            finalizarJogada();
        }
    } 
    // CASO 2: Imposto / Lei Seca (Onde travava antes)
    else if (casa.tipo === "imposto") {
        jogador.saldo -= casa.valor;
        exibirMensagem(`Voc√™ pagou R$ ${casa.valor} na Lei Seca/Imposto.`);
        atualizarSaldoVisual();
        finalizarJogada(); // CORRE√á√ÉO: Chama a fun√ß√£o centralizadora
    }
    // CASO 3: Galo da Madrugada
    else if (casa.tipo === "evento_galo") {
        eventoGaloPassou(); 
        // A fun√ß√£o do Galo chamar√° finalizarJogada() no final dela
    }
    // CASO 4: Pris√£o / Visitante / In√≠cio
    else {
        if (casa.tipo === "prisao") {
            jogador.preso = true;
            exibirMensagem("Voc√™ foi PRESO!");
            dadosIguais = false; // Se for preso, perde o direito de jogar de novo
        }
        finalizarJogada();
    }
}

// ======================================================================
// 4. CORRE√á√ÉO DO GALO (APENAS JOGADOR DA VEZ)
// ======================================================================

function eventoGaloPassou() {
    // CORRE√á√ÉO: N√£o usamos loop (for/forEach). Pegamos apenas o atual.
    let jogador = jogadores[jogadorAtualIndex];
    
    exibirMensagem(`O GALO PASSOU! üêî ${jogador.nome} foi levado ao Marco Zero!`);
    
    // Teleporta
    jogador.posicao = 0; 
    atualizarPosicaoVisual(jogador);

    // B√¥nus
    jogador.saldo += 200;
    atualizarSaldoVisual();

    // Segue o fluxo
    finalizarJogada();
}

// ======================================================================
// 5. RESPOSTA DA COMPRA (CORRE√á√ÉO DO TRAVAMENTO "N√ÉO QUERO")
// ======================================================================

function responderCompra(querComprar) {
    if (!aguardandoDecisao) return; // Seguran√ßa

    mostrarBotoesCompra(false); // Esconde bot√µes
    aguardandoDecisao = false;

    const casa = casas[jogadores[jogadorAtualIndex].posicao];

    if (querComprar) {
        realizarCompra(jogadores[jogadorAtualIndex], casa); // Sua l√≥gica de compra
        exibirMensagem(`Parab√©ns! Voc√™ comprou ${casa.nome}`);
    } else {
        exibirMensagem("Voc√™ decidiu n√£o comprar.");
    }

    // CORRE√á√ÉO CRUCIAL: Independente se comprou ou n√£o,
    // chamamos finalizarJogada para verificar os dados iguais.
    finalizarJogada();
}

// ======================================================================
// 6. FINALIZAR JOGADA (O CORA√á√ÉO DA CORRE√á√ÉO)
// ======================================================================
// Esta fun√ß√£o decide se passa a vez ou se joga novamente.
// Ela centraliza tudo para evitar bugs.

function finalizarJogada() {
    let jogador = jogadores[jogadorAtualIndex];

    // Se tirou dados iguais E n√£o est√° preso
    if (dadosIguais && !jogador.preso) {
        exibirMensagem(`DADOS IGUAIS! üé≤üé≤ ${jogador.nome} joga novamente!`);
        
        // CORRE√á√ÉO: Reabilita o bot√£o para o MESMO jogador
        // N√ÉO chama proximoTurno()
        const btn = document.getElementById("btn-jogar-dados");
        btn.disabled = false;
        btn.style.display = "block";
        
    } else {
        // Vida normal, passa para o pr√≥ximo
        proximoTurno();
    }
}

// ======================================================================
// 7. PR√ìXIMO TURNO (CORRE√á√ÉO DO "JOGAR SOZINHO")
// ======================================================================

function proximoTurno() {
    // Avan√ßa o √≠ndice
    jogadorAtualIndex++;
    if (jogadorAtualIndex >= jogadores.length) {
        jogadorAtualIndex = 0;
    }

    let proximoJogador = jogadores[jogadorAtualIndex];
    
    // Atualiza interface indicando de quem √© a vez
    document.getElementById("nome-jogador-vez").innerText = proximoJogador.nome;
    exibirMensagem(`√â a vez de ${proximoJogador.nome}`);

    // CORRE√á√ÉO: Apenas libera o bot√£o. O JOGO FICA EM PAUSA AQUI.
    // O usu√°rio OBRIGATORIAMENTE tem que clicar para jogar.
    const btn = document.getElementById("btn-jogar-dados");
    btn.disabled = false;
    btn.style.display = "block";
    
    // NUNCA CHAME jogarDados() AQUI DENTRO!
}
